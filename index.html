<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0EA5E9" />
  <meta name="color-scheme" content="light" />
  <title>„Å™„Çè„Å®„Å≥Ê§úÂÆö„Ç¢„Éó„É™Ôºà„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ÂØæÂøúÁâàÔºâ</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind (CDN) -->
  <script>
    tailwind = window.tailwind || {};
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            rounded: ['"M PLUS Rounded 1c"', 'ui-sans-serif', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial'],
          },
          boxShadow: {
            soft: '0 10px 30px rgba(2, 132, 199, .10)',
            pop: '0 18px 45px rgba(15, 23, 42, .18)',
          },
          keyframes: {
            floaty: { '0%,100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-6px)' } },
            wiggle: { '0%,100%': { transform: 'rotate(0deg)' }, '25%': { transform: 'rotate(-2deg)' }, '75%': { transform: 'rotate(2deg)' } },
            fadeUp: { from: { opacity: 0, transform: 'translateY(10px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
          },
          animation: {
            floaty: 'floaty 3.6s ease-in-out infinite',
            wiggle: 'wiggle .35s ease-in-out',
            fadeUp: 'fadeUp .25s ease-out forwards',
          }
        }
      }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Import Map -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
  </script>

  <style>
    :root{
      --sky-50: #f0f9ff;
      --sky-100:#e0f2fe;
      --sky-200:#bae6fd;
      --sky-500:#0ea5e9;
      --emerald-50:#ecfdf5;
      --slate-900:#0f172a;
    }

    html,body{ height:100%; }
    body{
      font-family: 'M PLUS Rounded 1c', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
      padding-bottom: calc(92px + env(safe-area-inset-bottom));
      touch-action: manipulation;
      overflow-x:hidden;
    }

    /* „Åµ„Çì„Çè„ÇäËÉåÊôØÔºàÈõ≤ÔºÜ„Ç≠„É©„Ç≠„É©Ôºâ */
    body::before{
      content:"";
      position:fixed;
      inset:-40px;
      z-index:-1;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(14,165,233,.14), transparent 60%),
        radial-gradient(900px 500px at 80% 0%, rgba(16,185,129,.10), transparent 58%),
        radial-gradient(700px 500px at 50% 30%, rgba(236,72,153,.06), transparent 60%),
        radial-gradient(4px 4px at 20% 30%, rgba(251,191,36,.45) 40%, transparent 41%),
        radial-gradient(3px 3px at 70% 40%, rgba(56,189,248,.35) 40%, transparent 41%),
        radial-gradient(3px 3px at 40% 70%, rgba(34,197,94,.25) 40%, transparent 41%),
        linear-gradient(to bottom, #f0f9ff, #ffffff 45%, #ecfdf5);
      filter:saturate(1.05);
    }

    /* Sticky columns */
    .sticky-col { position: sticky; left: 0; background-color: white; z-index: 10; border-right: 2px solid #e2e8f0; }
    .sticky-header { position: sticky; top: 0; z-index: 20; background: #f8fafc; }
    .sticky-corner { position: sticky; left: 0; top: 0; z-index: 30; background: #f8fafc; border-right: 2px solid #e2e8f0; }

    /* Scrollbar */
    .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 999px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    * { scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9; }

    /* Pop-in */
    @keyframes popIn { 0% { transform: scale(0.86); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    .animate-popIn { animation: popIn 0.38s cubic-bezier(0.175, 0.885, 0.32, 1.2) forwards; }

    /* Confetti-like background */
    @keyframes confetti { 0% { background-position: 0 0; } 100% { background-position: 120px 120px; } }
    .bg-confetti{
      background-image:
        radial-gradient(#FCD34D 20%, transparent 20%),
        radial-gradient(#F87171 20%, transparent 20%),
        radial-gradient(#60A5FA 18%, transparent 18%),
        radial-gradient(#34D399 18%, transparent 18%);
      background-color: #ffffff;
      background-position: 0 0, 60px 60px, 30px 90px, 90px 30px;
      background-size: 120px 120px;
      animation: confetti 4s linear infinite;
    }

    /* number spin */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }

    /* Canvas */
    #confetti-canvas { position: fixed; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998; }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ animation-duration:0.01ms !important; animation-iteration-count:1 !important; transition-duration:0.01ms !important; scroll-behavior:auto !important; }
      .bg-confetti{ animation:none !important; }
    }
  </style>
</head>

<body class="text-slate-800 select-none">
  <canvas id="confetti-canvas"></canvas>
  <div id="root"></div>

  <script type="text/babel" data-type="module" id="app-script">
    import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import {
      Trophy, Medal, Star, Calendar, Activity, RefreshCw, ChevronUp, ChevronDown, CheckCircle,
      User, Award, School, Home, ArrowLeft, RotateCcw, Pencil, Settings, Save, AlertCircle,
      Download, FileDown, Target, X, Copy, Flame, CalendarDays, Upload, Check, Trash2,
      Volume2, VolumeX, ClipboardList, BarChart3, Sparkles
    } from 'lucide-react';

    // --- ÂÆöÊï∞ ---
    const IS_TEACHER_MODE = true;
    const DATA_VERSION = "2024-v8-custom-level-names";
    const STORAGE = {
      user: 'nawatobi_user',
      daily: 'nawatobi_daily_records',
      max: 'nawatobi_max_records',
      history: 'nawatobi_history',
      levels: 'nawatobi_levels',
      names: 'nawatobi_trick_names',
      version: 'nawatobi_version',
      goals: 'nawatobi_goals',
      achievements: 'nawatobi_achievements',
      sound: 'nawatobi_sound',
      onboarded: 'nawatobi_onboarded',
      certId: 'nawatobi_cert_id'
    };

    const TRICK_IDS = ['mae','ushiro','kataashi','kakeashi','kakeashi_ushiro','nibyoushi','aya','aya_ushiro','kousa','kousa_ushiro','niju','aya_niju','sokushin','kousa_niju','niju_ushiro','zengo_kousa','sanju'];

    // Ë°®Á§∫ÂêçÔºàÂúßÁ∏ÆÔºâ
    const DEFAULT_TRICK_NAMES = {
      low:{mae:'„Çä„Çá„ÅÜ„ÅÇ„Åó„Å®„Å≥',ushiro:'„Çä„Çá„ÅÜ„ÅÇ„Åó„Å®„Å≥Ôºà„ÅÜ„Åó„ÇçÔºâ',kataashi:'„Åã„Åü„ÅÇ„Åó„Å®„Å≥',kakeashi:'„Åã„Åë„ÅÇ„Åó„Å®„Å≥',kakeashi_ushiro:'„Åã„Åë„ÅÇ„Åó„Å®„Å≥Ôºà„ÅÜ„Åó„ÇçÔºâ',nibyoushi:'Ôºí„Å≥„Çá„ÅÜ„Åó„Å®„Å≥',aya:'„ÅÇ„ÇÑ„Å®„Å≥',aya_ushiro:'„ÅÇ„ÇÑ„Å®„Å≥Ôºà„ÅÜ„Åó„ÇçÔºâ',kousa:'„Åì„ÅÜ„Åï„Å®„Å≥',kousa_ushiro:'„Åì„ÅÜ„Åï„Å®„Å≥Ôºà„ÅÜ„Åó„ÇçÔºâ',niju:'Ôºí„Åò„ÇÖ„ÅÜ„Å®„Å≥',aya_niju:'„ÅÇ„ÇÑÔºí„Åò„ÇÖ„ÅÜ„Å®„Å≥',sokushin:'„Åù„Åè„Åó„Çì„Å®„Å≥',kousa_niju:'„Åì„ÅÜ„ÅïÔºí„Åò„ÇÖ„ÅÜ„Å®„Å≥',niju_ushiro:'Ôºí„Åò„ÇÖ„ÅÜ„Å®„Å≥Ôºà„ÅÜ„Åó„ÇçÔºâ',zengo_kousa:'„Åú„Çì„Åî„Åì„ÅÜ„Åï„Å®„Å≥',sanju:'Ôºì„Åò„ÇÖ„ÅÜ„Å®„Å≥'},
      mid:{mae:'„Çä„Çá„ÅÜË∂≥„Å®„Å≥',ushiro:'„Çä„Çá„ÅÜË∂≥„Å®„Å≥ÔºàÂæå„ÇçÔºâ',kataashi:'„Åã„ÅüË∂≥„Å®„Å≥',kakeashi:'„Åã„ÅëË∂≥„Å®„Å≥',kakeashi_ushiro:'„Åã„ÅëË∂≥„Å®„Å≥ÔºàÂæå„ÇçÔºâ',nibyoushi:'Ôºí„Å≥„Çá„ÅÜ„Åó„Å®„Å≥',aya:'„ÅÇ„ÇÑ„Å®„Å≥',aya_ushiro:'„ÅÇ„ÇÑ„Å®„Å≥ÔºàÂæå„ÇçÔºâ',kousa:'‰∫§„Åï„Å®„Å≥',kousa_ushiro:'‰∫§„Åï„Å®„Å≥ÔºàÂæå„ÇçÔºâ',niju:'Ôºí„Åò„ÇÖ„ÅÜ„Å®„Å≥',aya_niju:'„ÅÇ„ÇÑÔºí„Åò„ÇÖ„ÅÜ„Å®„Å≥',sokushin:'ÂÅ¥ÊåØ„Å®„Å≥',kousa_niju:'‰∫§„ÅïÔºí„Åò„ÇÖ„ÅÜ„Å®„Å≥',niju_ushiro:'Ôºí„Åò„ÇÖ„ÅÜ„Å®„Å≥ÔºàÂæå„ÇçÔºâ',zengo_kousa:'ÂâçÂæå‰∫§„Åï„Å®„Å≥',sanju:'Ôºì„Åò„ÇÖ„ÅÜ„Å®„Å≥'},
      high:{mae:'‰∏°Ë∂≥„Å®„Å≥',ushiro:'‰∏°Ë∂≥„Å®„Å≥ÔºàÂæå„ÇçÔºâ',kataashi:'ÁâáË∂≥„Å®„Å≥',kakeashi:'„Åã„ÅëË∂≥„Å®„Å≥',kakeashi_ushiro:'„Åã„ÅëË∂≥„Å®„Å≥ÔºàÂæå„ÇçÔºâ',nibyoushi:'Ôºí„Å≥„Çá„ÅÜ„Åó„Å®„Å≥',aya:'„ÅÇ„ÇÑ„Å®„Å≥',aya_ushiro:'„ÅÇ„ÇÑ„Å®„Å≥ÔºàÂæå„ÇçÔºâ',kousa:'‰∫§Â∑Æ„Å®„Å≥',kousa_ushiro:'‰∫§Â∑Æ„Å®„Å≥ÔºàÂæå„ÇçÔºâ',niju:'ÔºíÈáç„Å®„Å≥',aya_niju:'„ÅÇ„ÇÑÔºíÈáç„Å®„Å≥',sokushin:'ÂÅ¥„Åó„Çì„Å®„Å≥',kousa_niju:'‰∫§Â∑ÆÔºíÈáç„Å®„Å≥',niju_ushiro:'ÔºíÈáç„Å®„Å≥„ÅÜ„Åó„Çç',zengo_kousa:'ÂâçÂæå‰∫§Â∑Æ„Å®„Å≥',sanju:'ÔºìÈáç„Å®„Å≥'}
    };

    const TRICK_COLORS = {
      mae:'bg-blue-100 text-blue-600 border-blue-200',
      ushiro:'bg-indigo-100 text-indigo-600 border-indigo-200',
      kataashi:'bg-teal-100 text-teal-600 border-teal-200',
      kakeashi:'bg-green-100 text-green-600 border-green-200',
      kakeashi_ushiro:'bg-emerald-100 text-emerald-600 border-emerald-200',
      nibyoushi:'bg-cyan-100 text-cyan-600 border-cyan-200',
      aya:'bg-yellow-100 text-yellow-700 border-yellow-200',
      aya_ushiro:'bg-amber-100 text-amber-700 border-amber-200',
      kousa:'bg-orange-100 text-orange-600 border-orange-200',
      kousa_ushiro:'bg-red-100 text-red-600 border-red-200',
      niju:'bg-pink-100 text-pink-600 border-pink-200',
      aya_niju:'bg-purple-100 text-purple-600 border-purple-200',
      sokushin:'bg-lime-100 text-lime-600 border-lime-200',
      kousa_niju:'bg-rose-100 text-rose-600 border-rose-200',
      niju_ushiro:'bg-fuchsia-100 text-fuchsia-600 border-fuchsia-200',
      zengo_kousa:'bg-violet-100 text-violet-600 border-violet-200',
      sanju:'bg-slate-100 text-slate-600 border-slate-200',
    };

    // „Éá„Éï„Ç©„É´„ÉàÁ¥öÂà§ÂÆö„Éá„Éº„ÇøÔºàÂúßÁ∏ÆÔºö‰∏≠Ë∫´„ÅØÂêå„ÅòÔºâ
    const DEFAULT_LEVELS_DATA = {
      low:[
        {level:20,reqs:{mae:1,kataashi:1}},{level:19,reqs:{mae:5,kataashi:4}},{level:18,reqs:{mae:10,ushiro:1,kataashi:8,kakeashi:2}},
        {level:17,reqs:{mae:15,ushiro:3,kataashi:12,kakeashi:8}},{level:16,reqs:{mae:20,ushiro:5,kataashi:16,kakeashi:16}},
        {level:15,reqs:{mae:25,ushiro:7,kataashi:20,kakeashi:24}},{level:14,reqs:{mae:30,ushiro:10,kakeashi:30,kakeashi_ushiro:2,nibyoushi:4}},
        {level:13,reqs:{mae:35,ushiro:12,kakeashi:35,kakeashi_ushiro:4,nibyoushi:8}},{level:12,reqs:{mae:40,ushiro:15,kakeashi:40,kakeashi_ushiro:8,nibyoushi:12}},
        {level:11,reqs:{mae:45,ushiro:20,kakeashi:45,kakeashi_ushiro:12,nibyoushi:16}},{level:10,reqs:{mae:50,ushiro:25,kakeashi:50,kakeashi_ushiro:16,nibyoushi:20}},
        {level:9,reqs:{mae:55,ushiro:30,kakeashi:55,kakeashi_ushiro:20,nibyoushi:24}},{level:8,reqs:{mae:60,ushiro:35,kakeashi:60,kakeashi_ushiro:24,nibyoushi:28}},
        {level:7,reqs:{mae:65,ushiro:40,kakeashi:65,kousa:1,niju:1,aya:2}},{level:6,reqs:{mae:70,ushiro:45,kakeashi:70,kousa:2,niju:2,aya:4}},
        {level:5,reqs:{mae:75,ushiro:50,kakeashi:75,kousa:3,niju:3,aya:6}},{level:4,reqs:{mae:80,ushiro:55,kakeashi:80,kousa:4,niju:4,aya:8}},
        {level:3,reqs:{mae:85,ushiro:60,kakeashi:85,kousa:6,niju:5,aya:12}},{level:2,reqs:{mae:90,ushiro:65,kakeashi:90,kousa:8,niju:6,aya:16}},
        {level:1,reqs:{mae:100,ushiro:70,kakeashi:100,kousa:10,niju:7,aya:24}}
      ],
      mid:[
        {level:20,reqs:{mae:2,nibyoushi:4}},{level:19,reqs:{mae:7,nibyoushi:8}},{level:18,reqs:{mae:10,ushiro:1,nibyoushi:12,kakeashi:4}},
        {level:17,reqs:{mae:15,ushiro:3,nibyoushi:16,kakeashi:10}},{level:16,reqs:{mae:20,ushiro:5,nibyoushi:20,kakeashi:20}},
        {level:15,reqs:{mae:30,ushiro:10,nibyoushi:40,kakeashi:30}},{level:14,reqs:{mae:40,ushiro:20,kakeashi:40,kakeashi_ushiro:2,aya:2}},
        {level:13,reqs:{mae:50,ushiro:30,kakeashi:50,kakeashi_ushiro:8,aya:4}},{level:12,reqs:{mae:60,ushiro:40,kakeashi:60,kakeashi_ushiro:12,aya:6}},
        {level:11,reqs:{mae:70,ushiro:50,kakeashi:70,kakeashi_ushiro:16,aya:8}},{level:10,reqs:{mae:80,ushiro:60,kakeashi:80,kakeashi_ushiro:20,aya:10}},
        {level:9,reqs:{mae:90,ushiro:80,kakeashi:90,kakeashi_ushiro:24,aya:12}},{level:8,reqs:{mae:100,ushiro:100,kakeashi:100,kakeashi_ushiro:28,aya:14}},
        {level:7,reqs:{mae:110,ushiro:110,kousa:1,kousa_ushiro:1,niju:1,aya_ushiro:2,aya_niju:1}},
        {level:6,reqs:{mae:120,ushiro:120,kousa:5,kousa_ushiro:3,niju:2,aya_ushiro:4,aya_niju:2}},
        {level:5,reqs:{mae:130,ushiro:130,kousa:10,kousa_ushiro:5,niju:5,aya_ushiro:6,aya_niju:3}},
        {level:4,reqs:{mae:140,ushiro:140,kousa:15,kousa_ushiro:8,niju:8,aya_ushiro:8,aya_niju:4}},
        {level:3,reqs:{mae:160,ushiro:160,kousa:20,kousa_ushiro:10,niju:10,aya_ushiro:10,aya_niju:6}},
        {level:2,reqs:{mae:180,ushiro:180,kousa:25,kousa_ushiro:15,niju:12,aya_ushiro:12,aya_niju:8}},
        {level:1,reqs:{mae:200,ushiro:200,kousa_ushiro:30,niju:20,aya_niju:20,kousa_niju:3,niju_ushiro:7,sanju:3}}
      ],
      high:[
        {level:20,reqs:{mae:3,nibyoushi:4,kakeashi:3}},{level:19,reqs:{mae:8,nibyoushi:8,kakeashi:8}},
        {level:18,reqs:{mae:15,ushiro:3,nibyoushi:12,kakeashi:15,aya:2}},{level:17,reqs:{mae:20,ushiro:8,nibyoushi:20,kakeashi:20,aya:4}},
        {level:16,reqs:{mae:30,ushiro:15,nibyoushi:40,kakeashi:30,aya:8}},{level:15,reqs:{mae:40,ushiro:20,nibyoushi:60,kakeashi:40,aya:14}},
        {level:14,reqs:{mae:50,ushiro:30,kakeashi:50,kakeashi_ushiro:10,aya:20,kousa:1,niju:2,aya_ushiro:2}},
        {level:13,reqs:{mae:60,ushiro:40,kakeashi:60,kakeashi_ushiro:20,aya:25,kousa:5,niju:4,aya_ushiro:4}},
        {level:12,reqs:{mae:70,ushiro:50,kakeashi:70,kakeashi_ushiro:30,aya:30,kousa:10,niju:8,aya_ushiro:8}},
        {level:11,reqs:{mae:80,ushiro:60,kakeashi:80,kakeashi_ushiro:40,aya:35,kousa:15,niju:12,aya_ushiro:12}},
        {level:10,reqs:{mae:90,ushiro:70,kakeashi:90,kakeashi_ushiro:60,aya:40,kousa:20,kousa_ushiro:1,niju:16,aya_ushiro:16}},
        {level:9,reqs:{mae:100,ushiro:80,kakeashi:100,kakeashi_ushiro:80,aya:45,kousa:25,kousa_ushiro:3,niju:20,aya_ushiro:20}},
        {level:8,reqs:{mae:120,ushiro:100,kakeashi:120,kakeashi_ushiro:100,aya:50,kousa:30,kousa_ushiro:5,niju:24,aya_ushiro:24}},
        {level:7,reqs:{mae:140,ushiro:110,kousa_ushiro:3,niju:8,aya_niju:1,sokushin:4,niju_ushiro:1,zengo_kousa:1}},
        {level:6,reqs:{mae:150,ushiro:120,kousa_ushiro:5,niju:10,aya_niju:3,sokushin:8,niju_ushiro:2,zengo_kousa:5}},
        {level:5,reqs:{mae:160,ushiro:130,kousa_ushiro:8,niju:12,aya_niju:5,sokushin:12,niju_ushiro:3,zengo_kousa:10}},
        {level:4,reqs:{mae:170,ushiro:140,kousa_ushiro:10,niju:14,aya_niju:8,sokushin:24,niju_ushiro:4,zengo_kousa:20}},
        {level:3,reqs:{mae:180,ushiro:160,kousa_ushiro:15,niju:16,aya_niju:10,kousa_niju:1,niju_ushiro:5,sanju:1}},
        {level:2,reqs:{mae:190,ushiro:180,kousa_ushiro:20,niju:18,aya_niju:15,kousa_niju:2,niju_ushiro:6,sanju:2}},
        {level:1,reqs:{mae:200,ushiro:200,kousa_ushiro:30,niju:20,aya_niju:20,kousa_niju:3,niju_ushiro:7,sanju:3}}
      ]
    };

    // --- Á•ùÊó•Âà§ÂÆöÔºàÁ∞°ÊòìÔºâ ---
    function isJapaneseHoliday(date){
      const y=date.getFullYear(), m=date.getMonth()+1, d=date.getDate(), w=date.getDay();
      if(m===1&&d===1) return true;
      if(m===2&&d===11) return true;
      if(m===2&&d===23) return true;
      if(m===3&&d===Math.floor(20.8431+0.242194*(y-1980)-Math.floor((y-1980)/4))) return true;
      if(m===4&&d===29) return true;
      if(m===5&&(d===3||d===4||d===5)) return true;
      if(m===8&&d===11) return true;
      if(m===9&&d===Math.floor(23.2488+0.242194*(y-1980)-Math.floor((y-1980)/4))) return true;
      if(m===11&&(d===3||d===23)) return true;
      const isNthMonday=(n)=> (w===1 && Math.floor((d-1)/7)===(n-1));
      if(m===1&&isNthMonday(2)) return true;
      if(m===7&&isNthMonday(3)) return true;
      if(m===9&&isNthMonday(3)) return true;
      if(m===10&&isNthMonday(2)) return true;
      if(w===1){ const yest=new Date(date); yest.setDate(d-1); if(isJapaneseHoliday(yest)) return true; }
      return false;
    }

    const toLocalDateKey=(d=new Date())=>{
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,'0');
      const day=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    };

    // --- Sound ---
    const createSound=()=>{
      let audioCtx=null;
      const getCtx=()=>{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; };
      const playTone=(freq,type,duration)=>{
        try{
          const ctx=getCtx();
          if(ctx.state==='suspended') ctx.resume();
          const osc=ctx.createOscillator();
          const gain=ctx.createGain();
          osc.type=type;
          osc.frequency.setValueAtTime(freq,ctx.currentTime);
          gain.gain.setValueAtTime(0.08,ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+duration);
          osc.connect(gain); gain.connect(ctx.destination);
          osc.start(); osc.stop(ctx.currentTime+duration);
        }catch(e){}
      };
      return {
        click:()=>playTone(600,'sine',0.08),
        success:()=>{ playTone(800,'sine',0.08); setTimeout(()=>playTone(1200,'sine',0.14),90); },
        fanfare:()=>{ [523.25,659.25,783.99,1046.50].forEach((f,i)=>setTimeout(()=>playTone(f,'triangle',0.5),i*140)); }
      };
    };

    // --- Confetti Canvas ---
    class ConfettiEffect{
      constructor(canvas){
        this.canvas=canvas;
        this.ctx=canvas?.getContext('2d');
        this.particles=[];
        this.isAnimating=false;
        this._onResize=this.resize.bind(this);
        this.resize();
        window.addEventListener('resize',this._onResize);
      }
      resize(){ if(!this.canvas) return; this.canvas.width=window.innerWidth; this.canvas.height=window.innerHeight; }
      destroy(){
        window.removeEventListener('resize',this._onResize);
        this.particles=[]; this.isAnimating=false;
        if(this.ctx) this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
      }
      createParticles(){
        const colors=['#FF6B6B','#4ECDC4','#FFE66D','#FF9F43','#54A0FF','#A78BFA'];
        const cx=window.innerWidth/2, cy=window.innerHeight/2;
        for(let i=0;i<140;i++){
          this.particles.push({x:cx,y:cy,vx:(Math.random()-0.5)*12,vy:(Math.random()-0.5)*12-6,size:Math.random()*7+4,color:colors[Math.floor(Math.random()*colors.length)],rotation:Math.random()*360,dr:(Math.random()-0.5)*12});
        }
      }
      animate(){
        if(!this.ctx||!this.canvas) return;
        if(this.particles.length===0){ this.isAnimating=false; this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height); return; }
        this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
        for(let i=this.particles.length-1;i>=0;i--){
          const p=this.particles[i];
          p.x+=p.vx; p.y+=p.vy; p.vy+=0.22; p.rotation+=p.dr;
          this.ctx.save();
          this.ctx.translate(p.x,p.y);
          this.ctx.rotate(p.rotation*Math.PI/180);
          this.ctx.fillStyle=p.color;
          this.ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size);
          this.ctx.restore();
          if(p.y>this.canvas.height+40) this.particles.splice(i,1);
        }
        requestAnimationFrame(()=>this.animate());
      }
      start(){ this.createParticles(); if(!this.isAnimating){ this.isAnimating=true; this.animate(); } }
    }

    // --- Â∞èÁâ©UI ---
    function Toast({ toast, onClose }){
      if(!toast) return null;
      const styles={
        info:'border-sky-200 bg-white/95 text-slate-700',
        success:'border-emerald-200 bg-white/95 text-slate-700',
        warning:'border-yellow-200 bg-white/95 text-slate-700',
        error:'border-red-200 bg-white/95 text-slate-700'
      };
      const dot={
        info:'bg-sky-500',
        success:'bg-emerald-500',
        warning:'bg-yellow-500',
        error:'bg-red-500'
      };
      return (
        <div className="fixed left-0 right-0 bottom-[84px] z-[9999] px-4" role="status" aria-live="polite">
          <div className={`max-w-md mx-auto rounded-2xl border-2 shadow-pop backdrop-blur-md ${styles[toast.variant] || styles.info} animate-popIn`}>
            <div className="p-4 flex items-start gap-3">
              <div className={`w-3 h-3 rounded-full mt-1.5 ${dot[toast.variant] || dot.info}`} />
              <div className="flex-1">
                <div className="font-extrabold text-sm flex items-center gap-2">
                  {toast.emoji ? <span className="text-lg">{toast.emoji}</span> : null}
                  <span>{toast.title}</span>
                </div>
                {toast.message ? <div className="text-xs font-bold text-slate-500 mt-1 whitespace-pre-line">{toast.message}</div> : null}
              </div>
              <button onClick={onClose} className="p-2 rounded-xl hover:bg-slate-100 active:scale-95" aria-label="Èñâ„Åò„Çã">
                <X size={18} className="text-slate-400"/>
              </button>
            </div>
          </div>
        </div>
      );
    }

    function ProgressBar({ pct }){
      const p = Math.max(0, Math.min(100, pct || 0));
      return (
        <div className="w-full h-3 bg-slate-100 rounded-full overflow-hidden border border-slate-200">
          <div className="h-full bg-sky-400" style={{ width: `${p}%` }} />
        </div>
      );
    }

    // --- App ---
    function App(){
      const [user,setUser]=useState({grade:1,classVal:'',number:'',name:'',isRegistered:true});
      const [records,setRecords]=useState({});
      const [dailyRecords,setDailyRecords]=useState({});
      const [maxRecords,setMaxRecords]=useState({});
      const [history,setHistory]=useState({});
      const [activeTab,setActiveTab]=useState('home');

      const [showConfetti,setShowConfetti]=useState(false);
      const [targetDate,setTargetDate]=useState(toLocalDateKey(new Date()));

      const [levelsData,setLevelsData]=useState(DEFAULT_LEVELS_DATA);
      const [trickNames,setTrickNames]=useState(DEFAULT_TRICK_NAMES);
      const [settingTab,setSettingTab]=useState('low');

      const [goals,setGoals]=useState({});
      const [achievements,setAchievements]=useState([]);

      const [showGoalSettings,setShowGoalSettings]=useState(false);
      const [pendingGoalUpdate,setPendingGoalUpdate]=useState(null);
      const [showImportModal,setShowImportModal]=useState(false);
      const [importText,setImportText]=useState('');
      const [showCopyModal,setShowCopyModal]=useState(false);
      const [copyModalMessage,setCopyModalMessage]=useState('');
      const [deleteTargetDate,setDeleteTargetDate]=useState(null);
      const [showDeleteModal,setShowDeleteModal]=useState(false);
      const [dateEditTarget,setDateEditTarget]=useState(null);
      const [showDateEditModal,setShowDateEditModal]=useState(false);

      // ‚òÖ UIÂº∑ÂåñÔºö„Çµ„Ç¶„É≥„ÉâON/OFF„ÉªÂàùÂõûÊ°àÂÜÖ„Éª„Éà„Éº„Çπ„Éà
      const [soundOn,setSoundOn]=useState(()=> {
        const v=localStorage.getItem(STORAGE.sound);
        return v===null ? true : v==='1';
      });
      const [toast,setToast]=useState(null);
      const [showOnboard,setShowOnboard]=useState(()=> localStorage.getItem(STORAGE.onboarded)!=='1');

      const fileInputRef=useRef(null);
      const soundRef=useRef(null);
      const confettiRef=useRef(null);

      const notify=useCallback((variant,title,message,emoji='')=>{
        setToast({variant,title,message,emoji});
        window.clearTimeout(window.__nawatobi_toast_timer);
        window.__nawatobi_toast_timer=window.setTimeout(()=>setToast(null), 3400);
      },[]);

      const tap=useCallback((type='click')=>{
        try{
          if(navigator.vibrate){
            if(type==='click') navigator.vibrate(8);
            else if(type==='success') navigator.vibrate([12,40,12]);
            else if(type==='fanfare') navigator.vibrate([18,60,18,60,18]);
          }
        }catch(e){}
        try{
          if(!soundOn) return;
          if(!soundRef.current) return;
          if(type==='click') soundRef.current.click();
          if(type==='success') soundRef.current.success();
          if(type==='fanfare') soundRef.current.fanfare();
        }catch(e){}
      },[soundOn]);

      useEffect(()=> localStorage.setItem(STORAGE.sound, soundOn?'1':'0'), [soundOn]);

      useEffect(()=>{
        soundRef.current=createSound();
        const canvas=document.getElementById('confetti-canvas');
        confettiRef.current=new ConfettiEffect(canvas);

        const savedUser=localStorage.getItem(STORAGE.user);
        const savedDaily=localStorage.getItem(STORAGE.daily);
        const savedMax=localStorage.getItem(STORAGE.max);
        const savedHistory=localStorage.getItem(STORAGE.history);
        const savedLevels=localStorage.getItem(STORAGE.levels);
        const savedNames=localStorage.getItem(STORAGE.names);
        const savedVersion=localStorage.getItem(STORAGE.version);
        const savedGoals=localStorage.getItem(STORAGE.goals);
        const savedAchievements=localStorage.getItem(STORAGE.achievements);

        const isOldVersion=savedVersion!==DATA_VERSION;

        if(savedUser) setUser({...JSON.parse(savedUser),isRegistered:true});
        if(savedHistory) setHistory(JSON.parse(savedHistory));

        let initialDaily={};
        if(savedDaily){ initialDaily=JSON.parse(savedDaily); setDailyRecords(initialDaily); }

        // UTC„Ç∫„É¨ÊïëÊ∏à
        const localToday=toLocalDateKey(new Date());
        const utcToday=new Date().toISOString().split('T')[0];
        if(utcToday!==localToday){
          if(initialDaily[utcToday]&&!initialDaily[localToday]){
            initialDaily[localToday]=initialDaily[utcToday];
            delete initialDaily[utcToday];
            setDailyRecords({...initialDaily});
            localStorage.setItem(STORAGE.daily,JSON.stringify(initialDaily));
          }
          const h=savedHistory?JSON.parse(savedHistory):{};
          if(h[utcToday]&&!h[localToday]){
            h[localToday]=true; delete h[utcToday];
            setHistory({...h});
            localStorage.setItem(STORAGE.history,JSON.stringify(h));
          }
        }

        if(initialDaily[localToday]) setRecords(initialDaily[localToday]);

        if(savedMax){
          setMaxRecords(JSON.parse(savedMax));
        }else if(localStorage.getItem('nawatobi_records')){
          const initialMax=JSON.parse(localStorage.getItem('nawatobi_records'));
          setMaxRecords(initialMax);
          localStorage.setItem(STORAGE.max,JSON.stringify(initialMax));
        }

        if(isOldVersion){
          setLevelsData(DEFAULT_LEVELS_DATA);
          setTrickNames(DEFAULT_TRICK_NAMES);
          localStorage.setItem(STORAGE.levels,JSON.stringify(DEFAULT_LEVELS_DATA));
          localStorage.setItem(STORAGE.names,JSON.stringify(DEFAULT_TRICK_NAMES));
          localStorage.setItem(STORAGE.version,DATA_VERSION);
        }else{
          if(savedLevels) setLevelsData(JSON.parse(savedLevels));
          if(savedNames) setTrickNames(JSON.parse(savedNames));
        }

        if(savedGoals) setGoals(JSON.parse(savedGoals));
        if(savedAchievements) setAchievements(JSON.parse(savedAchievements));

        // Ë®ºÊòéÊõ∏IDÔºà5-6Âπ¥Âêë„ÅëË°®Á§∫„ÅÆÂÆâÂÆöÂåñÔºâ
        if(!localStorage.getItem(STORAGE.certId)){
          localStorage.setItem(STORAGE.certId, Math.random().toString(36).slice(2, 11).toUpperCase());
        }

        return ()=>{ confettiRef.current?.destroy?.(); };
      },[]);

      useEffect(()=> localStorage.setItem(STORAGE.user,JSON.stringify(user)),[user]);
      useEffect(()=> localStorage.setItem(STORAGE.daily,JSON.stringify(dailyRecords)),[dailyRecords]);
      useEffect(()=> localStorage.setItem('nawatobi_records',JSON.stringify(records)),[records]);
      useEffect(()=> localStorage.setItem(STORAGE.max,JSON.stringify(maxRecords)),[maxRecords]);
      useEffect(()=> localStorage.setItem(STORAGE.history,JSON.stringify(history)),[history]);
      useEffect(()=> localStorage.setItem(STORAGE.goals,JSON.stringify(goals)),[goals]);
      useEffect(()=> localStorage.setItem(STORAGE.achievements,JSON.stringify(achievements)),[achievements]);

      useEffect(()=>{
        if(dailyRecords[targetDate]) setRecords(dailyRecords[targetDate]);
        else setRecords({});
      },[targetDate,dailyRecords]);

      const gradeCategory=useMemo(()=>{
        if(user.grade<=2) return 'low';
        if(user.grade<=4) return 'mid';
        return 'high';
      },[user.grade]);

      const currentLevelSet=useMemo(()=>{
        return (levelsData[gradeCategory]||[])
          .map(l=>({ ...l, name: l.name!==undefined ? l.name : `${l.level}Á¥ö` }))
          .filter(l=>l.name!=='');
      },[gradeCategory,levelsData]);

      const displayTricks=useMemo(()=>{
        const activeTricks=new Set();
        (levelsData[gradeCategory]||[]).forEach(l=>{
          if(l.name==='') return;
          if(l.reqs) Object.entries(l.reqs).forEach(([k,v])=>{ if(v>0) activeTricks.add(k); });
        });
        return TRICK_IDS.filter(id=>activeTricks.has(id)).map(id=>({
          id,
          color: TRICK_COLORS[id],
          label: (trickNames?.[gradeCategory]?.[id]) || DEFAULT_TRICK_NAMES[gradeCategory][id],
          name: id
        }));
      },[gradeCategory,trickNames,levelsData]);

      const clearedLevels=useMemo(()=>{
        return currentLevelSet.filter(lvl=>{
          return Object.entries(lvl.reqs||{}).every(([trickId,requiredCount])=>{
            const currentCount=maxRecords[trickId]||0;
            if(!requiredCount||requiredCount<=0) return true;
            return currentCount>=requiredCount;
          });
        }).map(l=>l.level);
      },[maxRecords,currentLevelSet]);

      const nextLevels=useMemo(()=>{
        const allLevels=(levelsData[gradeCategory]||[])
          .map(l=>({ ...l, name: l.name!==undefined ? l.name : `${l.level}Á¥ö` }))
          .filter(l=>l.name!=='');
        return allLevels.filter(lvl=>!clearedLevels.includes(lvl.level));
      },[gradeCategory,levelsData,clearedLevels]);

      const currentBestLevel=useMemo(()=>{
        if(clearedLevels.length===0) return null;
        const minLevel=Math.min(...clearedLevels);
        return currentLevelSet.find(l=>l.level===minLevel);
      },[clearedLevels,currentLevelSet]);

      const goalTitle=useMemo(()=>{
        if(user.grade<=2) return "„Å§„Åé„ÅÆ „ÇÇ„Åè„Å≤„Çá„ÅÜ Ôºà„Åç„ÇÖ„ÅÜ „Å® „Çè„Åñ „ÅÆ „Åã„ÅÑ„Åô„ÅÜÔºâ";
        return "Ê¨°„ÅÆ ÁõÆÊ®ô ÔºàÁ¥ö„Å® ÊäÄ„ÅÆ ÂõûÊï∞Ôºâ";
      },[user.grade]);

      const getTrickLevel=useCallback((trickId)=>{
        const count=maxRecords[trickId]||0;
        if(!count||count<=0) return null;
        const levels=levelsData[gradeCategory]||[];
        const passed=levels.filter(l=>{
          if(l.name==='') return false;
          if(!l.reqs) return false;
          const req=l.reqs[trickId];
          return req!==undefined && req!==null && req>0 && count>=req;
        });
        if(passed.length===0) return null;
        return Math.min(...passed.map(l=>l.level));
      },[levelsData,gradeCategory,maxRecords]);

      const calculateBestLevel=(currentRecords,category)=>{
        if(!levelsData||!levelsData[category]) return 999;
        const levels=levelsData[category];
        const cleared=levels.filter(lvl=>{
          if(lvl.name==='') return false;
          if(!lvl.reqs) return true;
          return Object.entries(lvl.reqs).every(([trickId,requiredCount])=>{
            const count=currentRecords[trickId]||0;
            if(!requiredCount||requiredCount<=0) return true;
            return count>=requiredCount;
          });
        }).map(l=>l.level);
        if(cleared.length===0) return 999;
        return Math.min(...cleared);
      };

      const calculateLevelForCount=useCallback((trickId,count)=>{
        if(!count||count<=0) return null;
        const levels=levelsData[gradeCategory]||[];
        const passed=levels.filter(l=>{
          if(l.name==='') return false;
          if(!l.reqs) return false;
          const req=l.reqs[trickId];
          return req!==undefined && req!==null && req>0 && count>=req;
        });
        if(passed.length===0) return null;
        return Math.min(...passed.map(l=>l.level));
      },[levelsData,gradeCategory]);

      const totals=useMemo(()=>{
        const t={};
        displayTricks.forEach(s=>(t[s.id]=0));
        Object.values(dailyRecords).forEach(dayObj=>{
          if(!dayObj) return;
          displayTricks.forEach(s=>{
            const v=parseInt(dayObj[s.id]||0);
            t[s.id]+=isNaN(v)?0:v;
          });
        });
        return t;
      },[dailyRecords,displayTricks]);

      const defaultGoalForTrick=useCallback((trickId)=>{
        try{
          const levels=levelsData[gradeCategory]||[];
          let maxReq=0;
          levels.forEach(l=>{
            if(l.name==='') return;
            const req=l?.reqs?.[trickId];
            if(req && req>maxReq) maxReq=req;
          });
          let g=Math.max(200, maxReq*20);
          g=Math.min(10000,g);
          return g||1000;
        }catch(e){ return 1000; }
      },[levelsData,gradeCategory]);

      useEffect(()=>{
        if(!displayTricks||displayTricks.length===0) return;
        setGoals(prev=>{
          const next={...prev};
          let changed=false;
          displayTricks.forEach(s=>{
            if(!next[s.id]||next[s.id]<=0){ next[s.id]=defaultGoalForTrick(s.id); changed=true; }
          });
          return changed ? next : prev;
        });
      },[displayTricks,defaultGoalForTrick]);

      const isGoalAchievedOnce=useCallback((trickId,goalValue)=>{
        const key=`goal-${trickId}-${goalValue}`;
        return achievements.includes(key);
      },[achievements]);

      const markGoalAchieved=useCallback((trickId,goalValue)=>{
        const key=`goal-${trickId}-${goalValue}`;
        setAchievements(prev=>(prev.includes(key)?prev:[...prev,key]));
      },[]);

      const checkAndTriggerGoalUpdate=useCallback((trickId,totalValue)=>{
        const currentGoal=goals[trickId]||defaultGoalForTrick(trickId);
        if(totalValue>=currentGoal){
          if(!isGoalAchievedOnce(trickId,currentGoal)){
            markGoalAchieved(trickId,currentGoal);
            tap('fanfare');
            confettiRef.current?.start?.();
            const nextGoal=Math.ceil(currentGoal*1.2);
            setPendingGoalUpdate({trickId,oldGoal:currentGoal,newGoal:nextGoal});
          }
        }
      },[goals,defaultGoalForTrick,isGoalAchievedOnce,markGoalAchieved,tap]);

      // ‚òÖ Ê¨°„ÅÆÁ¥ö ÈÄ≤„ÅøÂÖ∑ÂêàÔºà„Éõ„Éº„É†/ÂÖ•Âäõ„Å´Ë°®Á§∫Ôºâ
      const nextTargetLevel=useMemo(()=> (nextLevels && nextLevels.length>0) ? nextLevels[0] : null, [nextLevels]);

      const nextProgress=useMemo(()=>{
        if(!nextTargetLevel || !nextTargetLevel.reqs) return { pct: 100, done: 0, total: 0, items: [], levelName: '' };
        const entries=Object.entries(nextTargetLevel.reqs).filter(([,v])=>v>0);
        const items=entries.map(([trickId,need])=>{
          const trick=displayTricks.find(t=>t.id===trickId);
          const label=trick?.label || trickId;
          const have=maxRecords[trickId]||0;
          const ok=have>=need;
          return { trickId, label, need, have, ok };
        });
        const total=items.length;
        const done=items.filter(i=>i.ok).length;
        const pct= total>0 ? Math.floor((done/total)*100) : 0;
        return { pct, done, total, items, levelName: nextTargetLevel.name || `${nextTargetLevel.level}Á¥ö` };
      },[nextTargetLevel,displayTricks,maxRecords]);

      // ‚òÖ ÈÄ£Á∂öË®òÈå≤Ôºà„Éò„ÉÉ„ÉÄ„Éº„Å´Â∞è„Åï„ÅèË°®Á§∫Ôºâ
      const streak=useMemo(()=>{
        const toKey=(d)=>toLocalDateKey(d);
        const now=new Date();
        let count=0;
        let isTodayDone=false;
        const todayKey=toKey(now);

        if(history[todayKey]){
          count=1; isTodayDone=true;
          const d=new Date(now);
          while(true){
            d.setDate(d.getDate()-1);
            const done=history[toKey(d)];
            if(done) count++;
            else{
              const isWeH=d.getDay()===0||d.getDay()===6||isJapaneseHoliday(d);
              if(!isWeH) break;
            }
          }
        }else{
          const d=new Date(now); d.setDate(d.getDate()-1);
          let check=new Date(d);
          while(true){
            const done=history[toKey(check)];
            if(done) count++;
            else{
              const isWeH=check.getDay()===0||check.getDay()===6||isJapaneseHoliday(check);
              if(!isWeH) break;
            }
            check.setDate(check.getDate()-1);
          }
        }
        return { count, isTodayDone };
      },[history]);

      // --- „Ç≥„Éî„ÉºÔºàÂÖ•Âäõ‰∏≠„ÅÆ1Ë°åÔºâ ---
      const handleCopyToClipboard=()=>{
        tap('click');
        const header=['ÂêçÂâç','ÁèæÂú®„ÅÆÁ¥ö',...displayTricks.map(t=>t.label)].join('\t');
        const currentLevelName=currentBestLevel?currentBestLevel.name:'„Å™„Åó';
        const row=[(user.name||'ÂêçÁÑ°„Åó'), currentLevelName];
        displayTricks.forEach(trick=>{
          const count=records[trick.id]||0;
          const level=calculateLevelForCount(trick.id,parseInt(count||0));
          row.push(level?`${count}(${level}Á¥ö)`:`${count}`);
        });
        const textToCopy=header+'\n'+row.join('\t');

        const okMessage=()=>{
          setCopyModalMessage('Ë®òÈå≤„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ\nExcel„ÇÑ„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
          setShowCopyModal(true);
          tap('success');
        };
        const doCopyFallback=()=>{
          const ta=document.createElement("textarea");
          ta.value=textToCopy;
          ta.style.position="fixed";
          ta.style.left="-9999px";
          ta.style.top="0";
          document.body.appendChild(ta);
          ta.focus(); ta.select();
          try{
            const ok=document.execCommand('copy');
            document.body.removeChild(ta);
            ok ? okMessage() : notify('error','„Ç≥„Éî„Éº„Å´Â§±Êïó','„Åì„ÅÆÁ´ØÊú´„Åß„ÅØ„Ç≥„Éî„Éº„Åß„Åç„Å™„ÅÑ„Åì„Å®„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ','‚ö†Ô∏è');
          }catch(err){
            document.body.removeChild(ta);
            notify('error','„Ç≥„Éî„Éº„Å´Â§±Êïó','„Åì„ÅÆÁ´ØÊú´„Åß„ÅØ„Ç≥„Éî„Éº„Åß„Åç„Å™„ÅÑ„Åì„Å®„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ','‚ö†Ô∏è');
          }
        };

        if(navigator.clipboard && window.isSecureContext){
          navigator.clipboard.writeText(textToCopy).then(okMessage).catch(doCopyFallback);
        }else{
          doCopyFallback();
        }
      };

      // --- ‰∏ÄË¶ßË°®„Ç≥„Éî„ÉºÔºàÂÖ®Êó•Ôºâ ---
      const exportAllAsTSV=useCallback(()=>{
        tap('click');
        const dates=Object.keys(dailyRecords).sort((a,b)=>new Date(a)-new Date(b));
        if(dates.length===0){ notify('warning','„Åæ„Å†Ë®òÈå≤„Åå„Å™„ÅÑ„Çà','ÂÖ•Âäõ„Åó„Å¶„Åã„ÇâË©¶„Åó„Å¶„Å≠ÔºÅ','üìù'); return; }
        const headers=['Êó•‰ªò',...displayTricks.map(t=>t.label)];
        const rows=[headers.join('\t')];
        const totalRow={}; displayTricks.forEach(t=>totalRow[t.id]=0);
        dates.forEach(dateKey=>{
          const dayObj=dailyRecords[dateKey]||{};
          const row=[dateKey];
          displayTricks.forEach(t=>{
            const v=parseInt(dayObj[t.id]||0)||0;
            totalRow[t.id]+=v;
            row.push(v);
          });
          rows.push(row.join('\t'));
        });
        const totalLine=['ÂêàË®à']; displayTricks.forEach(t=>totalLine.push(totalRow[t.id]||0));
        rows.push(totalLine.join('\t'));
        const textToCopy=rows.join('\n');

        const okMessage=()=>{
          setCopyModalMessage('‰∏ÄË¶ßË°®„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ\n„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Åß Ctrl+VÔºàË≤º„Çä‰ªò„ÅëÔºâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
          setShowCopyModal(true);
          tap('success');
        };

        const doCopyFallback=()=>{
          const ta=document.createElement('textarea');
          ta.value=textToCopy;
          ta.style.position='fixed';
          ta.style.left='-9999px';
          document.body.appendChild(ta);
          ta.focus(); ta.select();
          try{
            const ok=document.execCommand('copy');
            document.body.removeChild(ta);
            ok ? okMessage() : notify('error','„Ç≥„Éî„Éº„Å´Â§±Êïó','Ë≤º„Çä‰ªò„Åë„Åå„Åß„Åç„Å™„ÅÑÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ','‚ö†Ô∏è');
          }catch(e){
            document.body.removeChild(ta);
            notify('error','„Ç≥„Éî„Éº„Å´Â§±Êïó','Ë≤º„Çä‰ªò„Åë„Åå„Åß„Åç„Å™„ÅÑÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ','‚ö†Ô∏è');
          }
        };

        if(navigator.clipboard && window.isSecureContext){
          navigator.clipboard.writeText(textToCopy).then(okMessage).catch(doCopyFallback);
        }else{
          doCopyFallback();
        }
      },[dailyRecords,displayTricks,tap,notify]);

      // --- „Ç§„É≥„Éù„Éº„ÉàÔºàTSVË≤º„Çä‰ªò„ÅëÔºâ ---
      const executeImport=useCallback(()=>{
        tap('click');
        const text=importText;
        if(!text.trim()){ notify('warning','„Éá„Éº„Çø„ÅåÁ©∫„Å†„Çà','„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Åã„Çâ„Ç≥„Éî„Éº„Åó„Å¶Ë≤º„Çä‰ªò„Åë„Å¶„Å≠„ÄÇ','üì•'); return; }
        try{
          const lines=text.trim().split(/\r?\n/);
          if(lines.length<2){ notify('error','ÂΩ¢Âºè„Åå„Å°„Åå„ÅÜ„Åã„ÇÇ','1Ë°åÁõÆ„Å´Ë¶ãÂá∫„Åó„ÄÅ2Ë°åÁõÆ‰ª•Èôç„Å´„Éá„Éº„Çø„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ','‚ö†Ô∏è'); return; }
          const headers=lines[0].split('\t');
          const idxByTrick={};
          displayTricks.forEach(trick=>{
            const idx=headers.indexOf(trick.label);
            if(idx!==-1) idxByTrick[trick.id]=idx;
          });

          let newDaily={...dailyRecords};
          let newMax={...maxRecords};
          let newHistory={...history};
          let importedCount=0;

          for(let i=1;i<lines.length;i++){
            const cols=lines[i].split('\t');
            const dateStr=cols[0];
            if(!dateStr || dateStr.includes('ÂêàË®à')) continue;
            if(!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) continue;

            if(!newDaily[dateStr]) newDaily[dateStr]={};
            let anyPositive=false;

            displayTricks.forEach(trick=>{
              const idx=idxByTrick[trick.id];
              if(idx===undefined) return;
              if(idx<cols.length){
                const val=parseInt(cols[idx]);
                if(!isNaN(val)){
                  newDaily[dateStr][trick.id]=val;
                  if(val>0) anyPositive=true;
                  if((newMax[trick.id]||0)<val) newMax[trick.id]=val;
                }
              }
            });

            if(anyPositive) newHistory[dateStr]=true;
            importedCount++;
          }

          setDailyRecords(newDaily);
          setMaxRecords(newMax);
          setHistory(newHistory);
          localStorage.setItem(STORAGE.daily,JSON.stringify(newDaily));
          localStorage.setItem(STORAGE.max,JSON.stringify(newMax));
          localStorage.setItem(STORAGE.history,JSON.stringify(newHistory));

          setShowImportModal(false);
          setImportText('');
          notify('success','Âæ©ÂÖÉ„Åß„Åç„Åü„ÇàÔºÅ',`${importedCount}‰ª∂„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ`,'üéâ');
          tap('success');
        }catch(e){
          console.error(e);
          notify('error','Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº','„Éá„Éº„ÇøÂΩ¢Âºè„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ','‚ö†Ô∏è');
        }
      },[importText,displayTricks,dailyRecords,maxRecords,history,tap,notify]);

      // --- Á¢∫ÂÆöÔºàÁ¥öÂà§ÂÆöÔºãÁõÆÊ®ô„ÉÅ„Çß„ÉÉ„ÇØÔºâ ---
      const handleConfirmRecord=(trickId)=>{
        tap('click');

        const currentCount=parseInt(records[trickId]||0);
        const currentMax=maxRecords[trickId]||0;

        const currentCategory=user.grade<=2?'low':user.grade<=4?'mid':'high';
        const oldBestLevel=calculateBestLevel(maxRecords,currentCategory);

        let nextMaxRecords={...maxRecords};
        let isNewRecord=false;

        const newDailyRecords={...dailyRecords};
        if(!newDailyRecords[targetDate]) newDailyRecords[targetDate]={};
        newDailyRecords[targetDate][trickId]=currentCount;

        setDailyRecords(newDailyRecords);
        localStorage.setItem(STORAGE.daily,JSON.stringify(newDailyRecords));

        if(currentCount>currentMax){
          nextMaxRecords[trickId]=currentCount;
          setMaxRecords(nextMaxRecords);
          localStorage.setItem(STORAGE.max,JSON.stringify(nextMaxRecords));
          isNewRecord=true;
        }

        const newHistory={...history,[targetDate]:true};
        setHistory(newHistory);
        localStorage.setItem(STORAGE.history,JSON.stringify(newHistory));

        const newBestLevel=calculateBestLevel(nextMaxRecords,currentCategory);

        const newTotal=(()=>{
          let t=0;
          Object.values(newDailyRecords).forEach(dayObj=>{
            if(!dayObj) return;
            t+=(parseInt(dayObj[trickId]||0)||0);
          });
          return t;
        })();
        checkAndTriggerGoalUpdate(trickId,newTotal);

        if(newBestLevel<oldBestLevel){
          setShowConfetti(true);
          tap('fanfare');
          confettiRef.current?.start?.();
        }else if(isNewRecord){
          const t=displayTricks.find(x=>x.id===trickId);
          tap('success');
          notify('success','Ëá™Â∑±„Éô„Çπ„ÉàÊõ¥Êñ∞ÔºÅ',`„Äå${t?t.label:trickId}„Äç„Åå ${currentCount}Âõû„Å´„Å™„Å£„Åü„ÇàÔºÅ`,'üèÖ');
        }else{
          tap('success');
          notify('info','‰øùÂ≠ò„Åó„Åü„Çà',`„Äå${displayTricks.find(x=>x.id===trickId)?.label||trickId}„Äç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ`,'‚úÖ');
        }
      };

      const updateRecord=(trickId,count)=> setRecords(prev=>({ ...prev, [trickId]: count }));

      // --- Ë®≠ÂÆöÔºàÂÖàÁîü„É¢„Éº„ÉâÔºâ ---
      const handleSaveSettings=()=>{
        localStorage.setItem(STORAGE.levels,JSON.stringify(levelsData));
        localStorage.setItem(STORAGE.names,JSON.stringify(trickNames));
        localStorage.setItem(STORAGE.version,DATA_VERSION);
        notify('success','‰øùÂ≠ò„Åó„Åü„Çà','„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„Å´Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ','üíæ');
        tap('success');
      };

      const handleDownloadJson=()=>{
        tap('click');
        const data={levelsData,trickNames,version:DATA_VERSION};
        const jsonStr=JSON.stringify(data,null,2);
        const blob=new Blob([jsonStr],{type:'application/json'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download=`nawatobi-settings-${toLocalDateKey(new Date())}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
        notify('info','„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ','Ë®≠ÂÆöJSON„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü„ÄÇ','‚¨áÔ∏è');
      };

      const handleUploadJson=(event)=>{
        const file=event.target.files[0];
        if(!file) return;
        tap('click');
        const reader=new FileReader();
        reader.onload=(e)=>{
          try{
            const data=JSON.parse(e.target.result);
            if(data.levelsData && data.trickNames){
              setLevelsData(data.levelsData);
              setTrickNames(data.trickNames);
              localStorage.setItem(STORAGE.levels,JSON.stringify(data.levelsData));
              localStorage.setItem(STORAGE.names,JSON.stringify(data.trickNames));
              localStorage.setItem(STORAGE.version,DATA_VERSION);
              notify('success','Âæ©ÂÖÉ„Åß„Åç„Åü„Çà','Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ','üéâ');
              tap('success');
            }else{
              notify('error','ÁÑ°Âäπ„Å™„Éï„Ç°„Ç§„É´','„Åì„ÅÆJSON„ÅØ‰Ωø„Åà„Åæ„Åõ„Çì„ÄÇ','‚ö†Ô∏è');
            }
          }catch(error){
            console.error(error);
            notify('error','Ë™≠„ÅøËæº„ÅøÂ§±Êïó','JSON„ÅÆÂΩ¢Âºè„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ','‚ö†Ô∏è');
          }
        };
        reader.readAsText(file);
        event.target.value='';
      };

      const handleExportHtml=()=>{
        tap('click');
        const scriptContent=document.getElementById('app-script').textContent;
        const newLevelsDataStr='const DEFAULT_LEVELS_DATA = '+JSON.stringify(levelsData,null,2)+';';
        const newTrickNamesStr='const DEFAULT_TRICK_NAMES = '+JSON.stringify(trickNames,null,2)+';';
        const newVersionStr='const DATA_VERSION = "'+DATA_VERSION+'-custom-'+Date.now()+'";';
        let newScriptContent=scriptContent
          .replace(/const DEFAULT_LEVELS_DATA = \{[\s\S]*?\};/, newLevelsDataStr)
          .replace(/const DEFAULT_TRICK_NAMES = \{[\s\S]*?\};/, newTrickNamesStr)
          .replace(/const DATA_VERSION = ".*?";/, newVersionStr)
          .replace('const IS_TEACHER_MODE = true;', 'const IS_TEACHER_MODE = false;');

        const htmlContent =
'<!DOCTYPE html>\n<html lang="ja">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>„Å™„Çè„Å®„Å≥Ê§úÂÆö„Ç¢„Éó„É™Ôºà'+new Date().toLocaleDateString()+'ÁâàÔºâ</title>\n  <script src="https://cdn.tailwindcss.com"><\\/script>\n  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">\n  <script src="https://unpkg.com/@babel/standalone/babel.min.js"><\\/script>\n  <script type="importmap">\n    {\n      "imports": {\n        "react": "https://esm.sh/react@18.2.0",\n        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",\n        "lucide-react": "https://esm.sh/lucide-react@0.292.0"\n      }\n    }\n  <\\/script>\n  <style>\n    body{font-family:\\'M PLUS Rounded 1c\\', -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom:96px; touch-action:manipulation;}\n    .sticky-col{position:sticky;left:0;background-color:white;z-index:10;border-right:2px solid #e2e8f0;}\n    .sticky-header{position:sticky;top:0;z-index:20;background:#f8fafc;}\n    .sticky-corner{position:sticky;left:0;top:0;z-index:30;background:#f8fafc;border-right:2px solid #e2e8f0;}\n    .custom-scrollbar::-webkit-scrollbar{height:8px;width:8px;}\n    .custom-scrollbar::-webkit-scrollbar-track{background:#f1f5f9;}\n    .custom-scrollbar::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:4px;}\n    .custom-scrollbar::-webkit-scrollbar-thumb:hover{background:#94a3b8;}\n    @keyframes popIn{0%{transform:scale(0.8);opacity:0;}100%{transform:scale(1);opacity:1;}}\n    .animate-popIn{animation:popIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275) forwards;}\n    @keyframes confetti{0%{background-position:0 0;}100%{background-position:100px 100px;}}\n    .bg-confetti{background-image:radial-gradient(#FCD34D 20%, transparent 20%), radial-gradient(#F87171 20%, transparent 20%); background-color:#fff; background-position:0 0, 50px 50px; background-size:100px 100px; animation:confetti 4s linear infinite;}\n    input[type=\"number\"]::-webkit-outer-spin-button,input[type=\"number\"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}\n    input[type=\"number\"]{-moz-appearance:textfield;}\n    #confetti-canvas{position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:9998;}\n  </style>\n</head>\n<body class=\"bg-sky-50 text-slate-800 select-none\">\n  <canvas id=\"confetti-canvas\"></canvas>\n  <div id=\"root\"></div>\n  <script type=\"text/babel\" data-type=\"module\" id=\"app-script\">\n'+
newScriptContent +
'\n  <\\/script>\n</body>\n</html>';

        const blob=new Blob([htmlContent],{type:'text/html'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download=`nawatobi-custom-${toLocalDateKey(new Date())}.html`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
        notify('success','Êõ∏„ÅçÂá∫„ÅóOK','ÂÖêÁ´•ÈÖç‰ªòÁî®HTML„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü„ÄÇ','üìÑ');
      };

      const handleResetSettings=()=>{
        tap('click');
        if(window.confirm('Êú¨ÂΩì„Å´ÂàùÊúüË®≠ÂÆöÔºàÂ§ßÈò™Â∫ú„É¢„Éá„É´Ôºâ„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü „Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Åó„ÅüÂÜÖÂÆπ„ÅØÊ∂à„Åà„Å¶„Åó„Åæ„ÅÑ„Åæ„Åô„ÄÇ')){
          setLevelsData(DEFAULT_LEVELS_DATA);
          setTrickNames(DEFAULT_TRICK_NAMES);
          localStorage.removeItem(STORAGE.levels);
          localStorage.removeItem(STORAGE.names);
          localStorage.removeItem(STORAGE.version);
          notify('info','ÂàùÊúüÂåñ','ÂàùÊúüË®≠ÂÆö„Å´Êàª„Åó„Åæ„Åó„Åü„ÄÇ','üîÅ');
          window.location.reload();
        }
      };

      const handleReset=()=>{
        tap('click');
        if(window.confirm('Êú¨ÂΩì„Å´Ë®òÈå≤„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶ÊúÄÂàù„Åã„ÇâÂßã„ÇÅ„Åæ„Åô„ÅãÔºüË®≠ÂÆö„ÅØ‰øùÊåÅ„Åï„Çå„Åæ„Åô„ÄÇ')){
          setRecords({}); setDailyRecords({}); setMaxRecords({}); setHistory({});
          localStorage.removeItem('nawatobi_records');
          localStorage.removeItem(STORAGE.daily);
          localStorage.removeItem(STORAGE.max);
          localStorage.removeItem(STORAGE.history);
          localStorage.removeItem(STORAGE.goals);
          localStorage.removeItem(STORAGE.achievements);
          window.location.reload();
        }
      };

      const sortedDates=useMemo(()=> Object.keys(dailyRecords).sort((a,b)=>new Date(a)-new Date(b)), [dailyRecords]);

      const openDateEdit=(oldDate)=>{ tap('click'); setDateEditTarget({oldDate,newDate:oldDate}); setShowDateEditModal(true); };

      const applyDateEdit=()=>{
        tap('click');
        const oldDate=dateEditTarget?.oldDate;
        const newDate=dateEditTarget?.newDate;
        if(!oldDate||!newDate) return;
        if(oldDate===newDate){ setShowDateEditModal(false); return; }
        if(dailyRecords[newDate]){
          notify('warning','‰∏äÊõ∏„Åç„Åß„Åç„Å™„ÅÑ„Çà','„Åù„ÅÆÊó•‰ªò„ÅØ„Åô„Åß„Å´„ÅÇ„Çä„Åæ„Åô„ÄÇÂà•„ÅÆÊó•„ÇíÈÅ∏„Çì„Åß„Å≠„ÄÇ','‚ö†Ô∏è');
          return;
        }
        const nextDaily={...dailyRecords};
        nextDaily[newDate]=nextDaily[oldDate];
        delete nextDaily[oldDate];

        const nextHistory={...history};
        if(nextHistory[oldDate]){ nextHistory[newDate]=true; delete nextHistory[oldDate]; }

        setDailyRecords(nextDaily);
        setHistory(nextHistory);
        if(targetDate===oldDate) setTargetDate(newDate);
        setShowDateEditModal(false);
        tap('success');
        notify('success','Êó•‰ªò„ÇíÂ§âÊõ¥„Åó„Åü„Çà',`${oldDate} ‚Üí ${newDate}`,'üìÖ');
      };

      const openDeleteDay=(dateKey)=>{ tap('click'); setDeleteTargetDate(dateKey); setShowDeleteModal(true); };

      const executeDeleteDay=()=>{
        tap('click');
        const d=deleteTargetDate;
        if(!d) return;
        const nextDaily={...dailyRecords}; delete nextDaily[d];
        const nextHistory={...history}; delete nextHistory[d];
        setDailyRecords(nextDaily);
        setHistory(nextHistory);
        if(targetDate===d){ setTargetDate(toLocalDateKey(new Date())); }
        setShowDeleteModal(false);
        setDeleteTargetDate(null);
        tap('success');
        notify('success','ÂâäÈô§„Åó„Åü„Çà',`${d} „ÅÆË®òÈå≤„ÇíÊ∂à„Åó„Åæ„Åó„Åü„ÄÇ`,'üóëÔ∏è');
      };

      const handleLevelReqChange=(category,levelIndex,trickId,value)=>{
        const newData={...levelsData};
        const val=parseInt(value);
        if(isNaN(val)||val<=0){
          if(newData[category][levelIndex].reqs) delete newData[category][levelIndex].reqs[trickId];
        }else{
          if(!newData[category][levelIndex].reqs) newData[category][levelIndex].reqs={};
          newData[category][levelIndex].reqs[trickId]=val;
        }
        setLevelsData(newData);
      };

      const handleTrickNameChange=(category,trickId,newName)=>{
        const newNames={...trickNames};
        newNames[category][trickId]=newName;
        setTrickNames(newNames);
      };

      const handleLevelNameChange=(category,levelIndex,newName)=>{
        const newData={...levelsData};
        newData[category][levelIndex].name=newName;
        setLevelsData(newData);
      };

      const saveGoalSettings=()=>{ tap('success'); setShowGoalSettings(false); notify('success','‰øùÂ≠ò„Åó„Åü„Çà','ÁõÆÊ®ô„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ','üéØ'); };

      const confirmGoalUpdate=()=>{
        if(!pendingGoalUpdate) return;
        tap('success');
        setGoals(prev=>({ ...prev, [pendingGoalUpdate.trickId]: pendingGoalUpdate.newGoal }));
        setPendingGoalUpdate(null);
        notify('success','Ê¨°„ÅÆÁõÆÊ®ô„Å´„Åó„Åü„Çà',`+20% „Åß„ÉÅ„É£„É¨„É≥„Ç∏ÔºÅ`,'üöÄ');
      };
      const closeGoalUpdate=()=>{ tap('click'); setPendingGoalUpdate(null); };

      // ÂàùÂõû„Ç¨„Ç§„ÉâOK
      const closeOnboard=()=>{
        tap('success');
        localStorage.setItem(STORAGE.onboarded,'1');
        setShowOnboard(false);
        notify('info','„Çπ„Çø„Éº„ÉàÔºÅ','„Åï„Å£„Åù„ÅèË®òÈå≤„Åó„Å¶„Åø„Çà„ÅÜ„ÄÇ','‚ú®');
      };

      // ---------------------------
      // Ë®≠ÂÆöÁîªÈù¢ÔºàÂÖàÁîüÁî®Ôºâ
      // ---------------------------
      if(activeTab==='settings' && IS_TEACHER_MODE){
        return (
          <div className="min-h-screen font-rounded text-slate-800 pb-24">
            <header className="bg-slate-900 text-white p-4 sticky top-0 z-30 shadow-md flex items-center justify-between">
              <div className="flex items-center gap-2">
                <button onClick={()=>{ tap('click'); setActiveTab('home'); }} className="p-2 hover:bg-white/10 rounded-full transition-colors active:scale-95">
                  <ArrowLeft size={20} />
                </button>
                <h1 className="text-lg font-extrabold flex items-center gap-2">
                  <Settings size={20} />
                  Ê§úÂÆöË°®‰ΩúÊàêÔºàÂÖàÁîüÁî®Ôºâ
                </h1>
              </div>
              <div className="flex gap-2">
                <input type="file" ref={fileInputRef} style={{display:'none'}} accept=".json" onChange={handleUploadJson} />
                <button onClick={()=>{ tap('click'); fileInputRef.current.click(); }} className="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-2 rounded-xl font-extrabold flex items-center gap-1 shadow-sm active:scale-95 transition-all text-xs sm:text-sm">
                  <Upload size={18} /><span className="hidden sm:inline">Ë®≠ÂÆöË™≠Ëæº(JSON)</span>
                </button>
                <button onClick={handleDownloadJson} className="bg-orange-600 hover:bg-orange-500 text-white px-3 py-2 rounded-xl font-extrabold flex items-center gap-1 shadow-sm active:scale-95 transition-all text-xs sm:text-sm">
                  <Download size={18} /><span className="hidden sm:inline">Ë®≠ÂÆö‰øùÂ≠ò(JSON)</span>
                </button>
                <button onClick={handleExportHtml} className="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 rounded-xl font-extrabold flex items-center gap-1 shadow-sm active:scale-95 transition-all text-xs sm:text-sm">
                  <FileDown size={18} /><span className="hidden sm:inline">ÂÖêÁ´•ÈÖç‰ªòÁî®</span>Êõ∏„ÅçÂá∫„Åó
                </button>
                <button onClick={handleSaveSettings} className="bg-sky-600 hover:bg-sky-500 text-white px-4 py-2 rounded-xl font-extrabold flex items-center gap-2 shadow-soft active:scale-95 transition-all text-sm">
                  <Save size={18} /> ‰øùÂ≠ò
                </button>
              </div>
            </header>

            <main className="p-4 max-w-full overflow-hidden">
              <div className="bg-white p-4 rounded-2xl shadow-soft border-2 border-slate-100 mb-4">
                <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                  {[{id:'low',label:'1„Éª2Âπ¥Áî®'},{id:'mid',label:'3„Éª4Âπ¥Áî®'},{id:'high',label:'5„Éª6Âπ¥Áî®'}].map(tab=>(
                    <button key={tab.id} onClick={()=>{ tap('click'); setSettingTab(tab.id); }}
                      className={`px-4 py-2 rounded-full font-extrabold whitespace-nowrap transition-colors ${settingTab===tab.id?'bg-slate-900 text-white':'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                      {tab.label}
                    </button>
                  ))}
                </div>

                <div className="text-sm text-slate-500 mb-2 flex items-start gap-2">
                  <AlertCircle size={16} className="mt-0.5" />
                  <span>
                    Á∏¶Ëª∏„ÅåÁ¥ö„ÄÅÊ®™Ëª∏„ÅåÊäÄ„Åß„Åô„ÄÇÂøÖË¶Å„Å™ÂõûÊï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÁ©∫Ê¨Ñ„ÅØ„Äå„Å™„Åó„ÄçÔºâ„ÄÇ<br/>
                    <strong>Á¥ö„ÅÆÂêçÂâçÔºà‰æãÔºö20Á¥öÔºâ„ÇíÁ©∫Ê¨Ñ„Å´„Åô„Çã„Å®„ÄÅ„Åù„ÅÆÁ¥ö„ÅØ‰∏ÄË¶ß„Å´Ë°®Á§∫„Åï„Çå„Å™„Åè„Å™„Çä„Åæ„ÅôÔºàÁÑ°ÂäπÂåñÔºâ„ÄÇ</strong><br/>
                    ÊäÄ„ÅÆÂêçÂâçÔºà„Éò„ÉÉ„ÉÄ„ÉºÔºâ„ÇÇÂ§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ
                  </span>
                </div>
              </div>

              <div className="bg-white rounded-2xl shadow-soft border-2 border-slate-100 overflow-hidden relative">
                <div className="overflow-x-auto custom-scrollbar">
                  <table className="w-full text-sm text-left border-collapse">
                    <thead className="bg-slate-100 text-slate-700 font-extrabold sticky top-0 z-20">
                      <tr>
                        <th className="p-3 border-b border-slate-200 min-w-[80px] text-center sticky-col">Á¥ö</th>
                        {TRICK_IDS.map(trickId=>(
                          <th key={trickId} className="p-2 border-b border-r border-slate-200 min-w-[110px] align-bottom">
                            <input
                              type="text"
                              value={trickNames[settingTab][trickId]}
                              onChange={(e)=>handleTrickNameChange(settingTab,trickId,e.target.value)}
                              className="bg-transparent border-b border-dashed border-slate-300 focus:border-sky-500 focus:outline-none text-center w-full font-extrabold text-xs py-1 select-text"
                            />
                          </th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {levelsData[settingTab].map((levelData,idx)=>(
                        <tr key={levelData.level} className="hover:bg-slate-50 border-b border-slate-100 last:border-0">
                          <td className="p-2 font-extrabold text-center bg-slate-50 sticky-col text-slate-700">
                            <input
                              type="text"
                              value={levelData.name!==undefined?levelData.name:`${levelData.level}Á¥ö`}
                              onChange={(e)=>handleLevelNameChange(settingTab,idx,e.target.value)}
                              className={`w-full bg-transparent text-center focus:outline-none border-b border-transparent focus:border-sky-500 transition-colors select-text ${levelData.name===''?'bg-red-50 text-red-300':''}`}
                              placeholder={`${levelData.level}Á¥ö`}
                            />
                          </td>
                          {TRICK_IDS.map(trickId=>{
                            const count=(levelData.reqs && levelData.reqs[trickId]) ? levelData.reqs[trickId] : '';
                            return (
                              <td key={trickId} className="p-1 border-r border-slate-100 text-center">
                                <input
                                  type="number"
                                  min="0"
                                  value={count}
                                  onChange={(e)=>handleLevelReqChange(settingTab,idx,trickId,e.target.value)}
                                  className={`w-full text-center p-1 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-400 ${count?'font-extrabold text-sky-700 bg-sky-50':'text-slate-300'} select-text`}
                                  placeholder="-"
                                />
                              </td>
                            );
                          })}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              <div className="mt-8 text-center">
                <button onClick={handleResetSettings} className="text-red-400 hover:text-red-600 underline text-xs font-extrabold flex items-center justify-center gap-1 mx-auto">
                  <RotateCcw size={12} /> Ë®≠ÂÆö„ÇíÂàùÊúüÂÄ§„Å´Êàª„Åô
                </button>
              </div>
            </main>

            <Toast toast={toast} onClose={()=>setToast(null)} />
          </div>
        );
      }

      // ---------------------------
      // „É°„Ç§„É≥ÁîªÈù¢
      // ---------------------------
      const navItems = [
        { id:'home', label:'„Éõ„Éº„É†', icon: Home },
        { id:'input', label:'„Åç„Çç„Åè', icon: Pencil },
        { id:'stats', label:'„ÇÇ„Åè„Å≤„Çá„ÅÜ', icon: BarChart3 },
        { id:'cert', label:'„Å´„Çì„Å¶„ÅÑ', icon: Award },
        { id:'history', label:'„Åå„Çì„Å∞„Çä', icon: ClipboardList },
      ];
      if(IS_TEACHER_MODE) navItems.push({ id:'settings', label:'ÂÖàÁîü', icon: Settings });

      return (
        <div className="min-h-screen font-rounded text-slate-800 pb-28 selection:bg-yellow-200">

          {/* ÂàùÂõû„Ç¨„Ç§„Éâ */}
          {showOnboard && (
            <div className="fixed inset-0 z-[9999] bg-black/50 flex items-center justify-center p-4">
              <div className="bg-white rounded-3xl p-6 w-full max-w-md border-4 border-sky-200 shadow-pop relative overflow-hidden animate-popIn">
                <div className="absolute inset-0 bg-gradient-to-b from-sky-50 to-white -z-10"></div>
                <div className="text-center">
                  <div className="text-5xl mb-2">ü™¢‚ú®</div>
                  <h3 className="text-2xl font-black text-sky-700">„Çà„ÅÜ„Åì„ÅùÔºÅ</h3>
                  <p className="text-sm font-extrabold text-slate-500 mt-1">3„Çπ„ÉÜ„ÉÉ„Éó„Åß „Åô„Åê„Åß„Åç„Çã„Çà</p>
                </div>
                <div className="mt-4 space-y-3">
                  <div className="p-3 rounded-2xl bg-sky-50 border border-sky-100 flex gap-3">
                    <div className="w-10 h-10 rounded-2xl bg-sky-500 text-white flex items-center justify-center font-black">1</div>
                    <div>
                      <div className="font-black text-slate-700">„Å™„Åæ„Åà„ÇíÂÖ•„Çå„Çã</div>
                      <div className="text-xs font-bold text-slate-500">Â≠¶Âπ¥„ÉªÁµÑ„ÉªÁï™„ÇÇÂÖ•„Çå„Çâ„Çå„Çã„Çà</div>
                    </div>
                  </div>
                  <div className="p-3 rounded-2xl bg-emerald-50 border border-emerald-100 flex gap-3">
                    <div className="w-10 h-10 rounded-2xl bg-emerald-500 text-white flex items-center justify-center font-black">2</div>
                    <div>
                      <div className="font-black text-slate-700">ÂõûÊï∞„ÇíÂÖ•Âäõ ‚Üí „Åë„Å£„Å¶„ÅÑ</div>
                      <div className="text-xs font-bold text-slate-500">Ëá™Â∑±„Éô„Çπ„Éà„ÅØËá™Âãï„ÅßÊõ¥Êñ∞ÔºÅ</div>
                    </div>
                  </div>
                  <div className="p-3 rounded-2xl bg-yellow-50 border border-yellow-200 flex gap-3">
                    <div className="w-10 h-10 rounded-2xl bg-yellow-400 text-white flex items-center justify-center font-black">3</div>
                    <div>
                      <div className="font-black text-slate-700">„ÇÇ„Åè„Å≤„Çá„ÅÜÔºÜ„Åå„Çì„Å∞„ÇäË°®</div>
                      <div className="text-xs font-bold text-slate-500">„Çå„Çì„Åû„ÅèË®òÈå≤„ÇÑ„Ç≥„Éî„Éº„ÇÇ„ÅÇ„Çã„Çà</div>
                    </div>
                  </div>
                </div>
                <button onClick={closeOnboard} className="mt-5 w-full bg-sky-500 hover:bg-sky-600 text-white font-extrabold py-3 rounded-2xl shadow-soft active:scale-95">
                  „Çè„Åã„Å£„ÅüÔºÅ „ÅØ„Åò„ÇÅ„Çã
                </button>
              </div>
            </div>
          )}

          {/* „Éà„Éº„Çπ„Éà */}
          <Toast toast={toast} onClose={()=>setToast(null)} />

          {/* „Ç≥„Éî„ÉºÊàêÂäü„É¢„Éº„ÉÄ„É´ */}
          {showCopyModal && (
            <div className="fixed inset-0 z-[9999] bg-black/50 flex items-center justify-center p-4">
              <div className="bg-white rounded-3xl p-6 w-full max-w-sm border-4 border-sky-300 shadow-pop relative text-center animate-popIn">
                <div className="text-5xl mb-3">üìã</div>
                <h3 className="text-xl font-extrabold text-sky-600 mb-2">„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ</h3>
                <p className="text-sm text-slate-600 mb-5 font-extrabold leading-relaxed whitespace-pre-line">
                  {copyModalMessage || 'Ë≤º„Çä‰ªò„Åë„Å¶‰Ωø„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'}
                </p>
                <button onClick={()=>{ tap('click'); setShowCopyModal(false); }} className="bg-sky-500 text-white font-extrabold py-3 px-8 rounded-2xl shadow-soft hover:bg-sky-600 transition w-full active:scale-95">
                  OK
                </button>
              </div>
            </div>
          )}

          {/* ÁõÆÊ®ôÈÅîÊàê‚ÜíÊ¨°ÁõÆÊ®ôÊèêÊ°à„É¢„Éº„ÉÄ„É´ */}
          {pendingGoalUpdate && (
            <div className="fixed inset-0 z-[9999] bg-black/60 flex items-center justify-center p-4">
              <div className="bg-white rounded-3xl p-6 w-full max-w-sm border-4 border-yellow-300 shadow-pop relative overflow-hidden animate-popIn">
                <div className="absolute inset-0 bg-yellow-50 -z-10"></div>
                <button onClick={closeGoalUpdate} className="absolute top-3 right-3 text-slate-400 hover:text-slate-600 bg-slate-100 rounded-full p-2 active:scale-95">
                  <X size={20} />
                </button>
                <div className="text-6xl mb-4 text-center">üéä</div>
                <h3 className="text-2xl font-black text-orange-600 mb-2 text-center">ÁõÆÊ®ôÈÅîÊàêÔºÅ</h3>
                <p className="text-center font-extrabold text-slate-700 mb-4">„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ</p>

                <div className="bg-white p-4 rounded-2xl border border-orange-200 mb-5 text-center shadow-soft">
                  <div className="text-sm text-slate-500 font-extrabold mb-1">Ê¨°„ÅÆÁõÆÊ®ô</div>
                  <div className="text-lg font-black text-sky-600 mb-2">
                    {displayTricks.find(t=>t.id===pendingGoalUpdate.trickId)?.label || '„Åì„ÅÆÁ®ÆÁõÆ'}
                  </div>
                  <div className="flex items-center justify-center gap-2 text-xl font-black text-orange-600">
                    <span className="line-through text-slate-400 text-base">{pendingGoalUpdate.oldGoal}</span>
                    <span>‚Üí</span>
                    <span className="text-3xl">{pendingGoalUpdate.newGoal}</span>
                    <span className="text-sm">Âõû</span>
                  </div>
                  <div className="text-xs text-orange-400 font-black mt-1">(20% UP!)</div>
                </div>

                <p className="text-center font-extrabold text-slate-600 mb-4">„Å´Â§âÊõ¥„Åó„Åæ„Åô„ÅãÔºü</p>
                <div className="flex gap-3">
                  <button onClick={closeGoalUpdate} className="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-extrabold py-3 rounded-2xl transition active:scale-95">„ÅÑ„ÅÑ„Åà</button>
                  <button onClick={confirmGoalUpdate} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-extrabold py-3 rounded-2xl shadow-soft transition active:scale-95">„ÅØ„ÅÑ</button>
                </div>
              </div>
            </div>
          )}

          {/* „Ç§„É≥„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´ */}
          {showImportModal && (
            <div className="fixed inset-0 z-[9999] bg-black/50 flex items-center justify-center p-4">
              <div className="bg-white rounded-3xl p-6 w-full max-w-lg border-4 border-emerald-300 shadow-pop relative flex flex-col max-h-[90vh] animate-popIn">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-xl font-black text-emerald-600">üì• Ë®òÈå≤„ÇíÂæ©ÂÖÉÔºà„Ç§„É≥„Éù„Éº„ÉàÔºâ</h3>
                  <button onClick={()=>{ tap('click'); setShowImportModal(false); }} className="text-slate-400 hover:text-slate-600 text-2xl font-black bg-slate-100 rounded-full w-9 h-9 flex items-center justify-center active:scale-95">√ó</button>
                </div>
                <p className="text-xs text-slate-500 mb-2 font-bold">
                  „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÅÆ„Éá„Éº„ÇøÔºà<span className="font-black">Êó•‰ªò</span>Ôºã<span className="font-black">Á®ÆÁõÆÂàó</span>Ôºâ„Çí„Ç≥„Éî„Éº„Åó„Å¶„ÄÅ„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                </p>
                <textarea
                  value={importText}
                  onChange={(e)=>setImportText(e.target.value)}
                  className="w-full h-44 border-2 border-slate-200 rounded-2xl p-3 text-xs font-mono bg-slate-50 mb-4 focus:ring-2 focus:ring-emerald-400 outline-none resize-none"
                  placeholder="Ôºà‰æãÔºâ&#10;Êó•‰ªò\t„Åæ„Åà„Å®„Å≥\t„ÅÜ„Åó„Çç„Å®„Å≥&#10;2026-01-10\t10\t5&#10;2026-01-11\t12\t0"
                />
                <div className="flex gap-3 shrink-0">
                  <button onClick={()=>{ tap('click'); setShowImportModal(false); }} className="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-extrabold py-3 rounded-2xl transition active:scale-95">„Ç≠„É£„É≥„Çª„É´</button>
                  <button onClick={executeImport} className="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-extrabold py-3 rounded-2xl shadow-soft transition active:scale-95">Ë™≠„ÅøËæº„ÇÄ</button>
                </div>
              </div>
            </div>
          )}

          {/* Êó•‰ªòÂâäÈô§„É¢„Éº„ÉÄ„É´ */}
          {showDeleteModal && (
            <div className="fixed inset-0 z-[9999] bg-black/50 flex items-center justify-center p-4">
              <div className="bg-white rounded-3xl p-6 w-full max-w-xs border-4 border-slate-200 shadow-pop animate-popIn">
                <h3 className="text-lg font-black text-slate-800 mb-2 text-center">„Åì„ÅÆÊó•„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü</h3>
                <p className="text-sm text-slate-500 mb-5 text-center font-bold">„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ</p>
                <div className="flex gap-3">
                  <button onClick={()=>{ tap('click'); setShowDeleteModal(false); setDeleteTargetDate(null); }} className="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-extrabold py-2.5 rounded-2xl active:scale-95">„Ç≠„É£„É≥„Çª„É´</button>
                  <button onClick={executeDeleteDay} className="flex-1 bg-red-500 hover:bg-red-600 text-white font-extrabold py-2.5 rounded-2xl shadow-soft active:scale-95">Ê∂à„Åô</button>
                </div>
              </div>
            </div>
          )}

          {/* Êó•‰ªòÂ§âÊõ¥„É¢„Éº„ÉÄ„É´ */}
          {showDateEditModal && dateEditTarget && (
            <div className="fixed inset-0 z-[9999] bg-black/50 flex items-center justify-center p-4">
              <div className="bg-white rounded-3xl p-6 w-full max-w-sm border-4 border-orange-200 shadow-pop animate-popIn">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-xl font-black text-orange-600 flex items-center gap-2">
                    <CalendarDays size={18}/> Êó•‰ªò„ÇíÂ§âÊõ¥
                  </h3>
                  <button onClick={()=>{ tap('click'); setShowDateEditModal(false); }} className="text-slate-400 hover:text-slate-600 text-2xl font-black bg-slate-100 rounded-full w-9 h-9 flex items-center justify-center active:scale-95">√ó</button>
                </div>
                <div className="text-xs text-slate-500 font-black mb-2">ÁèæÂú®Ôºö{dateEditTarget.oldDate}</div>
                <div className="bg-orange-50 border border-orange-200 rounded-2xl p-3 mb-4">
                  <input
                    type="date"
                    value={dateEditTarget.newDate}
                    onChange={(e)=>setDateEditTarget(prev=>({ ...prev, newDate:e.target.value }))}
                    className="w-full px-3 py-2 rounded-xl border border-slate-200 font-black text-slate-700"
                  />
                  <div className="text-[11px] text-orange-600 font-black mt-2">
                    ‚Äª „Åô„Åß„Å´„ÅÇ„ÇãÊó•‰ªò„Å´„ÅØÂ§âÊõ¥„Åß„Åç„Åæ„Åõ„ÇìÔºà‰∏äÊõ∏„ÅçÈò≤Ê≠¢Ôºâ
                  </div>
                </div>
                <div className="flex gap-3">
                  <button onClick={()=>{ tap('click'); setShowDateEditModal(false); }} className="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-extrabold py-3 rounded-2xl active:scale-95">„Ç≠„É£„É≥„Çª„É´</button>
                  <button onClick={applyDateEdit} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-extrabold py-3 rounded-2xl shadow-soft active:scale-95">Â§âÊõ¥„Åô„Çã</button>
                </div>
              </div>
            </div>
          )}

          {/* „Éò„ÉÉ„ÉÄ„Éº */}
          <header className="sticky top-0 z-20">
            <div className="bg-white/85 backdrop-blur-md border-b border-sky-100 shadow-soft">
              <div className="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
                <div className="flex items-center gap-2">
                  <div className="bg-yellow-400 p-2 rounded-2xl text-white shadow-soft animate-floaty">
                    <Activity size={20} strokeWidth={2.5} />
                  </div>
                  <div className="leading-tight">
                    <h1 className="text-base font-black text-sky-700">„Å™„Çè„Å®„Å≥„Éû„Çπ„Çø„Éº</h1>
                    <div className="flex items-center gap-2 text-[11px] font-black text-slate-500">
                      <span className="inline-flex items-center gap-1 bg-orange-50 border border-orange-200 px-2 py-0.5 rounded-full">
                        <Flame size={14} className="text-orange-500" /> {streak.count}Êó•
                      </span>
                      {nextTargetLevel ? (
                        <span className="hidden sm:inline">„Å§„ÅéÔºö{nextProgress.levelName}Ôºà{nextProgress.done}/{nextProgress.total}Ôºâ</span>
                      ) : (
                        <span className="hidden sm:inline">„Åô„Åπ„Å¶„ÇØ„É™„Ç¢ÔºÅ</span>
                      )}
                    </div>
                  </div>
                </div>

                <div className="flex items-center gap-2">
                  <button
                    onClick={()=>{ tap('click'); setSoundOn(v=>!v); notify('info', soundOn?'„Çµ„Ç¶„É≥„ÉâOFF':'„Çµ„Ç¶„É≥„ÉâON', '„ÅÑ„Å§„Åß„ÇÇÂàá„ÇäÊõø„Åà„Åß„Åç„Åæ„Åô„ÄÇ', soundOn?'üîá':'üîä'); }}
                    className="p-2 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 active:scale-95"
                    title="„Çµ„Ç¶„É≥„ÉâÂàá„ÇäÊõø„Åà"
                    aria-label="„Çµ„Ç¶„É≥„ÉâÂàá„ÇäÊõø„Åà"
                  >
                    {soundOn ? <Volume2 size={18} className="text-slate-600"/> : <VolumeX size={18} className="text-slate-400"/>}
                  </button>

                  <div className="text-right">
                    <div className="text-[10px] text-slate-400 font-black">„Åí„Çì„Åñ„ÅÑ„ÅÆ„Åç„ÇÖ„ÅÜ</div>
                    <div className="text-xl font-black text-pink-500 leading-none">
                      {currentBestLevel ? currentBestLevel.name : '‚Äï'}
                    </div>
                  </div>
                </div>
              </div>

              {nextTargetLevel && (
                <div className="max-w-2xl mx-auto px-4 pb-3">
                  <div className="bg-sky-50/70 border border-sky-100 rounded-2xl p-3">
                    <div className="flex items-center justify-between gap-3">
                      <div className="font-black text-slate-700 text-sm flex items-center gap-2">
                        <Target size={16} className="text-sky-600"/> „Å§„Åé„ÅØ <span className="text-sky-700">{nextProgress.levelName}</span>
                      </div>
                      <div className="text-xs font-black text-slate-500">{nextProgress.done}/{nextProgress.total}</div>
                    </div>
                    <div className="mt-2"><ProgressBar pct={nextProgress.pct} /></div>
                  </div>
                </div>
              )}
            </div>
          </header>

          {/* „É°„Ç§„É≥ */}
          <main className="max-w-2xl mx-auto px-4 py-6 space-y-6 min-h-[72vh]">

            {/* Á¥ö„Ç¢„ÉÉ„Éó„ÅäÁ•ù„ÅÑ */}
            {showConfetti && (
              <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                <div className="bg-white p-8 rounded-3xl shadow-pop border-4 border-yellow-400 text-center relative max-w-sm w-full animate-popIn overflow-hidden">
                  <button onClick={()=>{ tap('click'); setShowConfetti(false); }} className="absolute top-3 right-3 text-slate-400 hover:text-slate-600 bg-slate-100 rounded-full p-2 z-10 active:scale-95">
                    <X size={24} />
                  </button>
                  <div className="absolute inset-0 bg-confetti opacity-30 pointer-events-none"></div>
                  <Trophy size={80} className="mx-auto text-yellow-500 mb-4 drop-shadow-md relative z-10" />
                  <h2 className="text-3xl font-black text-pink-500 mb-2 relative z-10">„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ</h2>
                  <div className="text-4xl font-black text-slate-800 mb-6 relative z-10">
                    {currentBestLevel?.name} <span className="text-xl">ÂêàÊ†º</span>
                  </div>
                  <button onClick={()=>{ tap('success'); setShowConfetti(false); }} className="bg-pink-500 hover:bg-pink-600 text-white font-black py-3 px-8 rounded-2xl shadow-soft transition-all active:scale-95 relative z-10">
                    „ÇÑ„Å£„Åü„Å≠ÔºÅ
                  </button>
                </div>
              </div>
            )}

            {/* Ë°®Á¥ô */}
            {activeTab==='home' && (
              <div className="space-y-4">
                <div className="bg-white rounded-3xl shadow-pop border-4 border-sky-100 overflow-hidden relative">
                  <div className="bg-sky-50 p-4 text-center border-b border-sky-100 relative">
                    <div className="inline-block bg-white p-2 rounded-2xl shadow-soft mb-2 text-sky-500">
                      <School size={26} />
                    </div>
                    <h2 className="text-xl font-black text-slate-800 tracking-tight">„Å™„Çè„Å®„Å≥Ê§úÂÆö„Ç´„Éº„Éâ</h2>
                    <p className="text-[11px] text-slate-500 mt-1 font-bold">
                      „Åß„Åç„ÅüÔºÅ„Åå„Åµ„Åà„Çã / ÁõÆÊ®ô„Åå„Åø„Åà„Çã / „Åü„ÅÆ„Åó„Åè„Å§„Å•„Åè
                    </p>
                  </div>

                  <div className="p-4">
                    {/* „Éó„É≠„Éï„Ç£„Éº„É´ */}
                    <div className="bg-sky-50/60 p-4 rounded-2xl border-2 border-sky-100 mb-4">
                      <div className="flex items-center justify-between gap-2 mb-2">
                        <div className="flex items-center gap-2 text-sky-700">
                          <Pencil size={14} />
                          <span className="text-xs font-black">„Åì„Åì„Å´ „Å™„Åæ„Åà „Çí „Åã„ÅÑ„Å¶„Å≠</span>
                        </div>
                        <button
                          onClick={()=>{ tap('click'); setShowOnboard(true); }}
                          className="text-[11px] font-black text-slate-500 bg-white border border-slate-200 px-3 py-1.5 rounded-full hover:bg-slate-50 active:scale-95"
                          title="„Åã„Çì„Åü„ÇìË™¨Êòé"
                        >
                          „Å§„Åã„ÅÑ„Åã„Åü
                        </button>
                      </div>

                      <div className="flex gap-2 flex-wrap">
                        <div className="w-24">
                          <select
                            value={user.grade}
                            onChange={(e)=>{ tap('click'); setUser(prev=>({ ...prev, grade: parseInt(e.target.value) })); }}
                            className="w-full p-2 rounded-xl border border-sky-200 bg-white text-base font-black focus:border-sky-400 focus:outline-none select-text"
                          >
                            {[1,2,3,4,5,6].map(g=><option key={g} value={g}>{g} Âπ¥</option>)}
                          </select>
                        </div>
                        <div className="w-16">
                          <input type="text" value={user.classVal} onChange={(e)=>setUser(prev=>({ ...prev, classVal:e.target.value }))}
                            placeholder="ÁµÑ" className="w-full p-2 rounded-xl border border-sky-200 bg-white text-base font-black focus:border-sky-400 focus:outline-none text-center select-text" />
                        </div>
                        <div className="w-16">
                          <input type="text" value={user.number} onChange={(e)=>setUser(prev=>({ ...prev, number:e.target.value }))}
                            placeholder="Áï™" className="w-full p-2 rounded-xl border border-sky-200 bg-white text-base font-black focus:border-sky-400 focus:outline-none text-center select-text" />
                        </div>
                        <div className="flex-1 min-w-[180px]">
                          <input type="text" value={user.name} onChange={(e)=>setUser(prev=>({ ...prev, name:e.target.value }))}
                            placeholder="„Å™„Åæ„Åà" className="w-full p-2 rounded-xl border border-sky-200 bg-white text-base font-black focus:border-sky-400 focus:outline-none select-text" />
                        </div>
                      </div>
                    </div>

                    {/* „Å§„Åé„ÅÆÁ¥ö„Ç´„Éº„ÉâÔºà„Çà„ÇäÊ•Ω„Åó„ÅÑË¶ã„ÅõÊñπÔºâ */}
                    {nextTargetLevel && (
                      <div className="mb-4 bg-gradient-to-b from-white to-sky-50 border-2 border-sky-100 rounded-3xl p-4 shadow-soft">
                        <div className="flex items-center justify-between gap-3">
                          <div className="font-black text-slate-800 flex items-center gap-2">
                            <Sparkles size={18} className="text-sky-500"/> „Å§„Åé„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏
                          </div>
                          <div className="text-sm font-black text-sky-700 bg-white border border-sky-200 px-3 py-1 rounded-full">
                            {nextProgress.levelName}
                          </div>
                        </div>
                        <div className="mt-2">
                          <ProgressBar pct={nextProgress.pct} />
                          <div className="mt-2 flex flex-wrap gap-2">
                            {nextProgress.items.slice(0,3).map(it=>(
                              <span key={it.trickId} className={`text-[11px] font-black px-2 py-1 rounded-full border ${it.ok?'bg-emerald-50 text-emerald-700 border-emerald-200':'bg-white text-slate-600 border-slate-200'}`}>
                                {it.label}:{it.have}/{it.need}
                              </span>
                            ))}
                            {nextProgress.items.length>3 && (
                              <span className="text-[11px] font-black px-2 py-1 rounded-full border bg-white text-slate-500 border-slate-200">
                                „Åª„Åã {nextProgress.items.length-3}„Åì
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                    )}

                    {/* „É°„Éã„É•„Éº */}
                    <div className="grid grid-cols-1 gap-3">
                      <button onClick={()=>{ tap('click'); setActiveTab('input'); }}
                        className="flex items-center gap-3 p-3 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-3xl transition-all active:scale-95 group shadow-soft hover:shadow-pop">
                        <div className="w-11 h-11 bg-blue-500 text-white rounded-2xl flex items-center justify-center shadow-soft group-hover:scale-110 transition-transform flex-shrink-0">
                          <RefreshCw size={20} />
                        </div>
                        <div className="text-left">
                          <div className="text-lg font-black text-blue-800 leading-tight">„Åç„Çç„Åè „Çí „Å§„Åë„Çã</div>
                          <div className="text-[11px] text-blue-600 font-black">„Åï„ÅÑ„Åì„ÅÜ „Åç„Çç„Åè „Å´ „ÉÅ„É£„É¨„É≥„Ç∏ÔºÅ</div>
                        </div>
                      </button>

                      <button onClick={()=>{ tap('click'); setActiveTab('stats'); }}
                        className="flex items-center gap-3 p-3 bg-orange-50 hover:bg-orange-100 border-2 border-orange-200 rounded-3xl transition-all active:scale-95 group shadow-soft hover:shadow-pop">
                        <div className="w-11 h-11 bg-orange-500 text-white rounded-2xl flex items-center justify-center shadow-soft group-hover:scale-110 transition-transform flex-shrink-0">
                          <BarChart3 size={20} />
                        </div>
                        <div className="text-left">
                          <div className="text-lg font-black text-orange-800 leading-tight">„Åî„ÅÜ„Åë„ÅÑ „Å® „ÇÇ„Åè„Å≤„Çá„ÅÜ</div>
                          <div className="text-[11px] text-orange-700 font-black">„Åü„Å£„Åõ„ÅÑ „Åß „Å§„Åé„ÅÆ „ÇÇ„Åè„Å≤„Çá„ÅÜÔºÅ</div>
                        </div>
                      </button>

                      <button onClick={()=>{ tap('click'); setActiveTab('cert'); }}
                        className="flex items-center gap-3 p-3 bg-pink-50 hover:bg-pink-100 border-2 border-pink-200 rounded-3xl transition-all active:scale-95 group shadow-soft hover:shadow-pop">
                        <div className="w-11 h-11 bg-pink-500 text-white rounded-2xl flex items-center justify-center shadow-soft group-hover:scale-110 transition-transform flex-shrink-0">
                          <Award size={20} />
                        </div>
                        <div className="text-left">
                          <div className="text-lg font-black text-pink-800 leading-tight">„Å´„Çì„Å¶„ÅÑ„Åó„Çá„ÅÜ</div>
                          <div className="text-[11px] text-pink-700 font-black">„ÅÑ„Åæ„ÅÆ „Åç„ÇÖ„ÅÜ „Çí „Åã„Åè„Å´„Çì</div>
                        </div>
                      </button>

                      <button onClick={()=>{ tap('click'); setActiveTab('history'); }}
                        className="flex items-center gap-3 p-3 bg-emerald-50 hover:bg-emerald-100 border-2 border-emerald-200 rounded-3xl transition-all active:scale-95 group shadow-soft hover:shadow-pop">
                        <div className="w-11 h-11 bg-emerald-500 text-white rounded-2xl flex items-center justify-center shadow-soft group-hover:scale-110 transition-transform flex-shrink-0">
                          <ClipboardList size={20} />
                        </div>
                        <div className="text-left">
                          <div className="text-lg font-black text-emerald-800 leading-tight">„Åå„Çì„Å∞„ÇäË°®</div>
                          <div className="text-[11px] text-emerald-700 font-black">„Çå„Çì„Åó„ÇÖ„ÅÜ „ÅÆ „ÅÑ„Å°„Çâ„Çì„Éª„Ç≥„Éî„Éº</div>
                        </div>
                      </button>
                    </div>

                    <div className="mt-4 text-center">
                      <button onClick={handleReset} className="text-[11px] text-slate-300 hover:text-red-500 underline font-black flex items-center justify-center gap-1 mx-auto">
                        <RotateCcw size={12} /> „Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶ÊúÄÂàù„Åã„Çâ
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Ë®òÈå≤ÂÖ•Âäõ */}
            {activeTab==='input' && (
              <div className="space-y-4">
                <div className="bg-white rounded-3xl p-4 shadow-soft border-2 border-slate-100">
                  <div className="flex justify-between items-end mb-3 gap-3">
                    <h2 className="text-lg font-black text-slate-800 flex items-center gap-2">
                      <RefreshCw size={20} className="text-sky-500" />
                      „Åç„Çç„Åè„Çí„ÅÑ„Çå„Çà„ÅÜ
                    </h2>

                    <div className="flex flex-col items-end gap-1">
                      <span className="text-[11px] text-sky-600 font-black">„Å≤„Å•„Åë„Çí„Åà„Çâ„Çì„Åß„Å≠</span>
                      <div className="flex gap-2">
                        <div className="relative">
                          <input type="date" value={targetDate} onChange={(e)=>{ tap('click'); setTargetDate(e.target.value); }}
                            className="pl-9 pr-2 py-2 rounded-2xl border border-slate-200 text-xs font-black text-slate-700 focus:outline-none focus:border-sky-400 bg-white" />
                          <CalendarDays className="absolute left-3 top-2.5 text-slate-400 pointer-events-none" size={14} />
                        </div>

                        <button onClick={handleCopyToClipboard}
                          className="flex items-center gap-1 bg-emerald-50 hover:bg-emerald-100 text-emerald-700 border border-emerald-200 px-3 py-2 rounded-2xl text-xs font-black transition-all active:scale-95">
                          <Copy size={14} /><span>„Ç≥„Éî„Éº</span>
                        </button>
                      </div>
                    </div>
                  </div>

                  <div className="text-xs text-slate-500 font-bold mb-3">
                    „Å≤„Å£„Åã„Åã„Çâ„Åö„Å´ <span className="text-pink-500 font-black">„Çå„Çì„Åû„Åè</span> „Åß„Å®„Åπ„ÅüÂõûÊï∞
                  </div>

                  <div className="space-y-3">
                    {displayTricks.map(trick=>{
                      const currentCount=records[trick.id]||0;
                      const currentCountNum=parseInt(currentCount||0);
                      const savedCount=dailyRecords[targetDate]?.[trick.id];
                      const savedCountNum=parseInt(savedCount||0);
                      const isSaved=currentCountNum===savedCountNum;

                      const currentMax=maxRecords[trick.id]||0;
                      const bestLevel=getTrickLevel(trick.id);

                      return (
                        <div key={trick.id} className={`flex items-center justify-between p-3 rounded-3xl bg-white border-2 hover:border-sky-300 transition-colors ${trick.color.replace('text','border').split(' ')[2]} shadow-soft`}>
                          <div className="flex items-center gap-3">
                            <div className={`w-11 h-11 rounded-2xl flex items-center justify-center font-black text-sm shadow-soft ${trick.color}`}>
                              {trick.label.substring(0,1)}
                            </div>
                            <div>
                              <div className="font-black text-slate-800 flex flex-wrap items-center gap-x-2 gap-y-1">
                                <span>{trick.label}</span>
                                <span className="text-xs text-orange-700 font-black bg-orange-50 px-2 py-0.5 rounded-full border border-orange-200">
                                  ÊúÄÈ´ò:{currentMax}
                                </span>
                                {bestLevel && (
                                  <span className="bg-yellow-100 text-yellow-800 text-xs px-2 py-0.5 rounded-full border border-yellow-300 font-black whitespace-nowrap">
                                    {bestLevel}Á¥ö
                                  </span>
                                )}
                                <span className="text-[11px] text-slate-600 font-black bg-slate-50 px-2 py-0.5 rounded-full border border-slate-200">
                                  ÂêàË®à:{totals[trick.id]||0}/{goals[trick.id]||defaultGoalForTrick(trick.id)}
                                </span>
                              </div>
                            </div>
                          </div>

                          <div className="flex items-center gap-2">
                            <button onClick={()=>updateRecord(trick.id, Math.max(0,(parseInt(records[trick.id]||0)-1)))}
                              className="w-10 h-10 rounded-2xl bg-slate-50 border border-slate-200 text-slate-500 flex items-center justify-center active:scale-95 hover:bg-slate-100">
                              <ChevronDown size={20} />
                            </button>

                            <input
                              type="number"
                              inputMode="numeric"
                              pattern="\d*"
                              className={`w-16 text-center font-black text-2xl bg-transparent border-b-2 focus:outline-none p-1 select-text ${isSaved?'text-sky-700 border-sky-300':'text-slate-900 border-slate-200 focus:border-sky-500'}`}
                              value={parseInt(records[trick.id]||0)>0 ? records[trick.id] : ''}
                              placeholder="0"
                              onFocus={(e)=>requestAnimationFrame(()=>e.target.select())}
                              onChange={(e)=>updateRecord(trick.id,e.target.value)}
                            />

                            <span className="text-xs font-black text-slate-400 mt-2 whitespace-nowrap">Âõû</span>

                            <button onClick={()=>updateRecord(trick.id,(parseInt(records[trick.id]||0)+1))}
                              className="w-10 h-10 rounded-2xl bg-sky-100 text-sky-700 flex items-center justify-center active:scale-95 shadow-soft hover:bg-sky-200">
                              <ChevronUp size={20} />
                            </button>

                            <button onClick={()=>handleConfirmRecord(trick.id)}
                              className={`ml-1 text-xs font-black py-2.5 px-3 rounded-2xl shadow-soft active:scale-95 transition-all flex flex-col items-center leading-none ${
                                isSaved ? 'bg-sky-50 text-sky-700 border-2 border-sky-200' : 'bg-emerald-500 hover:bg-emerald-600 text-white animate-pulse'
                              }`}>
                              {isSaved ? (<><CheckCircle size={16} className="mb-0.5"/><span>‰øùÂ≠òÊ∏à</span></>) : (<><Check size={16} className="mb-0.5"/><span>„Åë„Å£„Å¶„ÅÑ</span></>)}
                            </button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}

            {/* ÂêàË®à„Å®ÁõÆÊ®ô */}
            {activeTab==='stats' && (
              <div className="space-y-4">
                <div className="bg-white rounded-3xl p-5 shadow-soft border-2 border-slate-100">
                  <div className="flex items-center justify-between gap-2 mb-3">
                    <h2 className="text-lg font-black text-orange-600 flex items-center gap-2">
                      <BarChart3 size={20} /> ÂêàË®à„Å®ÁõÆÊ®ô
                    </h2>

                    <div className="flex items-center gap-2">
                      <button onClick={()=>{ tap('click'); setShowGoalSettings(true); }}
                        className="bg-orange-100 hover:bg-orange-200 text-orange-800 text-xs font-black px-3 py-2 rounded-full transition flex items-center gap-1 shadow-soft border border-orange-200 active:scale-95">
                        <Settings size={14} /> ÁõÆÊ®ô„ÅÆË®≠ÂÆö
                      </button>
                    </div>
                  </div>

                  <div className="text-[11px] text-slate-500 font-black mb-4 flex items-center gap-2">
                    <Sparkles size={14} className="text-orange-500"/> ÂêàË®à„ÅåÁõÆÊ®ô„Å´Â±ä„Åè„Å®„ÄåÊ¨°„ÅÆÁõÆÊ®ôÔºà+20%Ôºâ„Äç„ÅåÂá∫„Åæ„Åô„ÄÇ
                  </div>

                  <div className="space-y-3">
                    {displayTricks.map(trick=>{
                      const total=totals[trick.id]||0;
                      const goal=goals[trick.id]||defaultGoalForTrick(trick.id);
                      const pct=goal>0?Math.min(100,Math.floor((total/goal)*100)):0;
                      const achieved=total>=goal;

                      return (
                        <div key={trick.id} className="p-4 rounded-3xl border border-slate-200 bg-white shadow-soft">
                          <div className="flex items-center justify-between gap-3">
                            <div className="flex items-center gap-3">
                              <div className={`w-11 h-11 rounded-2xl flex items-center justify-center font-black text-sm shadow-soft ${trick.color}`}>
                                {trick.label.substring(0,1)}
                              </div>
                              <div>
                                <div className="font-black text-slate-800">{trick.label}</div>
                                <div className="text-xs text-slate-500 font-black">
                                  ÂêàË®à <span className="text-slate-900">{total}</span> Ôºè ÁõÆÊ®ô <span className="text-slate-900">{goal}</span>
                                </div>
                              </div>
                            </div>

                            <div className={`text-xs font-black px-3 py-1 rounded-full border ${achieved?'bg-yellow-50 text-yellow-800 border-yellow-300':'bg-slate-50 text-slate-600 border-slate-200'}`}>
                              {achieved ? 'ÈÅîÊàêÔºÅ' : `${pct}%`}
                            </div>
                          </div>

                          <div className="mt-3"><ProgressBar pct={pct} /></div>

                          <div className="mt-3 flex items-center justify-between text-xs">
                            <button onClick={()=>{ tap('click'); checkAndTriggerGoalUpdate(trick.id,total); }}
                              className="text-orange-700 font-black underline active:scale-95">
                              ÁõÆÊ®ô„ÉÅ„Çß„ÉÉ„ÇØ
                            </button>
                            <div className="text-slate-400 font-black flex items-center gap-1">
                              <Volume2 size={14} /> ÂäπÊûúÈü≥Ôºö{soundOn?'ON':'OFF'}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* ÁõÆÊ®ôË®≠ÂÆö„É¢„Éº„ÉÄ„É´ */}
                {showGoalSettings && (
                  <div className="fixed inset-0 z-[9999] bg-black/50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl p-6 w-full max-w-md border-4 border-sky-200 shadow-pop max-h-[90vh] flex flex-col animate-popIn">
                      <div className="flex justify-between items-center mb-3">
                        <h3 className="text-xl font-black text-sky-700 flex items-center gap-2">
                          <Settings size={18}/> Á®ÆÁõÆ„Å®ÁõÆÊ®ô„ÅÆË®≠ÂÆö
                        </h3>
                        <button onClick={()=>{ tap('click'); setShowGoalSettings(false); }} className="text-slate-400 hover:text-slate-600 text-2xl font-black active:scale-95">√ó</button>
                      </div>
                      <p className="text-xs text-slate-500 mb-2 font-bold">ÁõÆÊ®ôÂõûÊï∞„ÇíÂ§â„Åà„Çâ„Çå„Åæ„ÅôÔºàÂêàË®à„Å´ÂØæ„Åô„ÇãÁõÆÊ®ô„Åß„ÅôÔºâ„ÄÇ</p>

                      <div className="space-y-3 overflow-y-auto flex-1 pr-1">
                        {displayTricks.map(trick=>(
                          <div key={trick.id} className="bg-sky-50 p-3 rounded-2xl border border-sky-100 flex items-center justify-between gap-3">
                            <div className="font-black text-slate-800">{trick.label}</div>
                            <div className="flex items-center gap-2">
                              <input
                                type="number"
                                value={goals[trick.id]||defaultGoalForTrick(trick.id)}
                                onChange={(e)=>setGoals(prev=>({ ...prev, [trick.id]: Math.max(1, parseInt(e.target.value||0)) }))}
                                className="w-28 text-right font-black p-2 rounded-2xl border border-sky-200 bg-white"
                              />
                              <span className="text-xs font-black text-slate-500">Âõû</span>
                            </div>
                          </div>
                        ))}
                      </div>

                      <div className="flex gap-2 mt-4">
                        <button onClick={()=>{ tap('click'); setShowGoalSettings(false); }} className="flex-1 bg-slate-200 text-slate-700 font-extrabold py-3 rounded-2xl hover:bg-slate-300 active:scale-95">Èñâ„Åò„Çã</button>
                        <button onClick={saveGoalSettings} className="flex-1 bg-sky-500 text-white font-extrabold py-3 rounded-2xl hover:bg-sky-600 shadow-soft active:scale-95">‰øùÂ≠ò</button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Ë™çÂÆöË®º */}
            {activeTab==='cert' && (
              <div className="space-y-6">
                {user.grade<=2 && (
                  <div className="bg-white rounded-3xl p-6 shadow-pop border-4 border-pink-200 relative overflow-hidden text-center">
                    <div className="absolute top-0 left-0 w-full h-4 bg-pink-200"></div>
                    <div className="mt-4 mb-2">
                      <div className="inline-block p-3 bg-pink-100 rounded-2xl text-pink-500 mb-2"><Star size={32} fill="currentColor" /></div>
                      <h2 className="text-2xl font-black text-pink-500">„Å´„Çì„Å¶„ÅÑ„Åó„Çá„ÅÜ</h2>
                    </div>
                    <div className="text-lg font-black text-slate-800 mb-4">
                      {user.grade}„Å≠„Çì {user.classVal}„Åè„Åø {user.number}„Å∞„Çì<br/>
                      <span className="text-2xl border-b-2 border-pink-300 px-2">{user.name?user.name:'Ôºà„Å™„Åæ„ÅàÔºâ'}</span> „Åï„Çì
                    </div>
                    <div className="bg-pink-50 rounded-2xl p-4 mb-4">
                      <p className="text-sm text-pink-400 font-black mb-1">„ÅÇ„Å™„Åü„ÅØ</p>
                      <p className="text-5xl font-black text-pink-600 tracking-tight my-2">{currentBestLevel?currentBestLevel.name:'„Åå„Çì„Å∞„Çä‰∏≠'}</p>
                      <p className="text-sm text-pink-400 font-black">„Å´„Åî„ÅÜ„Åã„Åè„Åó„Åæ„Åó„ÅüÔºÅ</p>
                    </div>
                    <div className="text-xs text-slate-400 font-black">„Çà„Åè„Åå„Çì„Å∞„Çä„Åæ„Åó„Åü</div>
                    <div className="absolute -bottom-6 -right-6 w-24 h-24 bg-yellow-200 rounded-full opacity-50"></div>
                    <div className="absolute -bottom-6 -left-6 w-20 h-20 bg-blue-200 rounded-full opacity-50"></div>
                  </div>
                )}

                {(user.grade===3 || user.grade===4) && (
                  <div className="bg-white rounded-3xl p-8 shadow-pop border-2 border-sky-200 relative text-center">
                    <div className="border-4 border-double border-sky-100 p-6 rounded-2xl">
                      <div className="mb-4">
                        <Award size={48} className="mx-auto text-sky-500" />
                        <h2 className="text-3xl font-black text-sky-800 mt-2">Ë™çÂÆöË®º</h2>
                      </div>
                      <div className="text-left bg-sky-50/60 p-4 rounded-2xl mb-6 text-slate-800 font-bold">
                        <p className="mb-2">Á¨¨ {user.grade} Â≠¶Âπ¥ {user.classVal} ÁµÑ {user.number} Áï™</p>
                        <p className="text-2xl font-black border-b border-sky-300 pb-1 mb-4 inline-block min-w-[200px] text-center">{user.name?user.name:'ÔºàÂêçÂâçÔºâ'} ÊÆø</p>
                        <p className="leading-relaxed text-sm">
                          „ÅÇ„Å™„Åü„ÅØ„ÄÅ„Å™„Çè„Å®„Å≥Ê§úÂÆö„Å´„Åä„ÅÑ„Å¶<br/>
                          È†≠Êõ∏„ÅÆÊàêÁ∏æ„ÇíÂèé„ÇÅ„Çâ„Çå„Åæ„Åó„Åü„ÄÇ<br/>
                          „Çà„Å£„Å¶„Åì„Åì„Å´„Åì„Çå„ÇíË®º„Åó„Åæ„Åô„ÄÇ
                        </p>
                      </div>
                      <div className="text-center">
                        <p className="text-sm font-black text-sky-600">Ë™çÂÆöÁ¥ö</p>
                        <p className="text-4xl font-black text-sky-900 border-2 border-sky-600 inline-block px-8 py-2 rounded-2xl mt-1 bg-white">
                          {currentBestLevel?currentBestLevel.name:'‚Äï'}
                        </p>
                      </div>
                    </div>
                  </div>
                )}

                {user.grade>=5 && (
                  <div className="bg-slate-50 rounded-2xl p-8 shadow-pop border-t-8 relative text-center" style={{borderColor:'#d4af37'}}>
                    <div className="absolute top-4 right-4 text-xs text-slate-400 font-mono">ID: {localStorage.getItem(STORAGE.certId)}</div>
                    <div className="mb-8 mt-2">
                      <div className="text-xs tracking-[0.2em] text-slate-500 uppercase font-black mb-1">Certificate of Achievement</div>
                      <h2 className="text-4xl font-black text-slate-900 border-b-2 border-slate-300 inline-block pb-2 px-4">Ë®òÈå≤Ë®º</h2>
                    </div>

                    <div className="flex justify-between items-end mb-8 px-4">
                      <div className="text-left">
                        <p className="text-sm text-slate-500 font-bold">Name</p>
                        <p className="text-xl font-black text-slate-900">{user.name?user.name:'__________'}</p>
                      </div>
                      <div className="text-right">
                        <p className="text-sm text-slate-500 font-bold">Grade</p>
                        <p className="text-xl font-black text-slate-900">{user.grade} - {user.classVal} - {user.number}</p>
                      </div>
                    </div>

                    <div className="bg-white border border-slate-200 p-8 rounded-2xl shadow-inner mb-6">
                      <p className="text-sm text-slate-500 font-bold mb-2">Achieved Level</p>
                      <p className="text-5xl font-black" style={{color:'#d4af37', textShadow:'1px 1px 0px rgba(0,0,0,0.08)'}}>
                        {currentBestLevel?currentBestLevel.name:'Unranked'}
                      </p>
                    </div>

                    <div className="text-left text-xs text-slate-400 mt-8 border-t border-slate-200 pt-2">
                      Â§ßÈò™„Å™„Çè„Å®„Å≥Á¥öÂà§ÂÆöÂü∫Ê∫ñÊ∫ñÊã†<br/>
                      Osaka Jump Rope Assessment Standards
                    </div>
                  </div>
                )}

                {/* Ê¨°„ÅÆÁõÆÊ®ôÔºàÁ¥öË¶Å‰ª∂Ôºâ */}
                <div className="bg-white rounded-3xl p-4 shadow-soft border-2 border-slate-100">
                  <h3 className="font-black text-slate-800 mb-3 text-sm flex items-center gap-2">
                    <Target size={18} className="text-red-500" /> {goalTitle}
                  </h3>

                  <div className="space-y-2">
                    {nextLevels.length>0 ? (
                      nextLevels.map(lvl=>(
                        <div key={lvl.level} className="p-3 rounded-2xl border border-slate-100 bg-white text-slate-600 text-xs flex items-start justify-between">
                          <div className="flex items-start gap-3">
                            <span className="font-black text-sm text-slate-400 whitespace-nowrap">{lvl.name}</span>
                            <div className="flex flex-wrap gap-1">
                              {Object.entries(lvl.reqs||{}).map(([trickId,count])=>{
                                const trick=displayTricks.find(t=>t.id===trickId);
                                if(!trick||!count) return null;
                                return (
                                  <span key={trickId} className="px-2 py-1 rounded-full border bg-slate-50 border-slate-200 font-bold">
                                    {trick.label}: {count}Âõû
                                  </span>
                                );
                              })}
                            </div>
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="text-center p-6 bg-yellow-50 rounded-3xl border border-yellow-200">
                        <Trophy size={40} className="mx-auto text-yellow-500 mb-2" />
                        <div className="text-lg font-black text-yellow-700">„Åô„Åπ„Å¶„ÅÆÁ¥ö„Çí„ÇØ„É™„Ç¢ÔºÅ</div>
                        <div className="text-xs font-black text-yellow-600">„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ</div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* „Åå„Çì„Å∞„ÇäË°® */}
            {activeTab==='history' && (
              <div className="space-y-4">
                <div className="bg-white rounded-3xl p-6 shadow-soft border-2 border-slate-100 text-center">
                  <Calendar size={48} className="mx-auto text-emerald-500 mb-2" />
                  <h2 className="text-lg font-black text-slate-800">„Åå„Çì„Å∞„ÇäË°®</h2>

                  <div className="flex gap-2 justify-center mt-3 flex-wrap">
                    <button onClick={exportAllAsTSV}
                      className="bg-sky-100 hover:bg-sky-200 text-sky-800 font-black px-4 py-2 rounded-full text-xs border border-sky-200 flex items-center gap-1 active:scale-95">
                      <Copy size={14}/> ‰∏ÄË¶ß„Çí„Ç≥„Éî„Éº
                    </button>
                    <button onClick={()=>{ tap('click'); setShowImportModal(true); }}
                      className="bg-emerald-100 hover:bg-emerald-200 text-emerald-800 font-black px-4 py-2 rounded-full text-xs border border-emerald-200 flex items-center gap-1 active:scale-95">
                      <Upload size={14}/> Âæ©ÂÖÉÔºàË≤º„Çä‰ªò„ÅëÔºâ
                    </button>
                  </div>

                  <div className="bg-orange-100 border-2 border-orange-200 rounded-3xl p-4 mb-6 text-center mt-5">
                    <div className="flex items-center justify-center gap-2 mb-1">
                      <span className="text-2xl">üî•</span>
                      <span className="text-lg font-black text-orange-700">„Çå„Çì„Åû„ÅèË®òÈå≤</span>
                      <span className="text-2xl">üî•</span>
                    </div>
                    <div className="text-3xl font-black text-orange-600">
                      {streak.count}<span className="text-base">Êó•</span>
                      <div className="text-xs text-orange-500 font-black mt-1">
                        {streak.count>0 ? (streak.isTodayDone ? "„Åô„Åî„ÅÑÔºÅ „Åç„Çá„ÅÜ„ÇÇ „Åü„Å£„Åõ„ÅÑÔºÅ" : "„Åç„ÅÆ„ÅÜ„Åæ„Åß „Å§„Å•„ÅÑ„Å¶„Çã„ÇàÔºÅ") : "„Åç„Çá„ÅÜ„Åã„Çâ „ÉÅ„É£„É¨„É≥„Ç∏ÔºÅ"}
                      </div>
                    </div>
                  </div>

                  {/* Áõ¥Ëøë14Êó• */}
                  <div className="grid grid-cols-7 gap-2 max-w-sm mx-auto mt-4">
                    {[...Array(14)].map((_,i)=>{
                      const d=new Date(); d.setDate(d.getDate()-(13-i));
                      const dateKey=toLocalDateKey(d);
                      const dayNum=d.getDate();
                      const hasHistory=history[dateKey];
                      const isToday=toLocalDateKey(new Date())===dateKey;
                      return (
                        <div key={i} className="flex flex-col items-center gap-1">
                          <div className="text-[10px] text-slate-400 font-bold">{d.getMonth()+1}/{dayNum}</div>
                          <div className={`w-10 h-10 rounded-2xl flex items-center justify-center border-2 transition-all
                            ${hasHistory?'bg-emerald-100 border-emerald-500 text-emerald-700 scale-110':'bg-slate-50 border-slate-100 text-slate-300'}
                            ${isToday?'ring-2 ring-offset-2 ring-sky-300':''}
                          `}>
                            {hasHistory ? <Medal size={20} fill="currentColor" /> : <div className="w-2 h-2 rounded-full bg-slate-200" />}
                          </div>
                        </div>
                      );
                    })}
                  </div>

                  {/* Êó•Âà•‰∏ÄË¶ß */}
                  <div className="mt-8 text-left">
                    <div className="font-black text-slate-800 flex items-center gap-2 mb-2">
                      <ClipboardList size={18} className="text-emerald-600"/> Êó•Âà•„Åç„Çç„Åè‰∏ÄË¶ß
                    </div>

                    <div className="bg-white rounded-3xl shadow-soft border-2 border-slate-100 overflow-hidden">
                      <div className="overflow-x-auto custom-scrollbar">
                        <table className="min-w-[700px] w-full text-xs border-collapse">
                          <thead className="sticky-header">
                            <tr className="bg-emerald-50 text-emerald-900">
                              <th className="sticky-corner p-2 text-center min-w-[130px] border-b border-slate-200">Êó•‰ªò</th>
                              {displayTricks.map(t=>(
                                <th key={t.id} className="p-2 text-center min-w-[90px] border-b border-slate-200">{t.label}</th>
                              ))}
                              <th className="p-2 text-center min-w-[80px] border-b border-slate-200">ÂêàË®à</th>
                            </tr>
                          </thead>
                          <tbody>
                            {sortedDates.length===0 ? (
                              <tr><td colSpan={displayTricks.length+2} className="p-4 text-center text-slate-400 font-black">„Åæ„Å†Êó•Âà•„ÅÆË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</td></tr>
                            ) : (
                              sortedDates.map(dateKey=>{
                                const dayObj=dailyRecords[dateKey]||{};
                                const rowTotal=displayTricks.reduce((sum,t)=>sum+(parseInt(dayObj[t.id]||0)||0),0);
                                return (
                                  <tr key={dateKey} className="hover:bg-slate-50 border-b border-slate-100">
                                    <td className="sticky-col p-2 bg-white border-b border-slate-100">
                                      <div className="flex items-center justify-between gap-2">
                                        <button onClick={()=>openDateEdit(dateKey)} className="text-slate-800 font-black underline decoration-dotted" title="Êó•‰ªò„ÇíÂ§âÊõ¥">
                                          {dateKey}
                                        </button>
                                        <div className="flex items-center gap-1">
                                          <button onClick={()=>{ tap('click'); setTargetDate(dateKey); setActiveTab('input'); }}
                                            className="text-xs font-black px-2 py-1 rounded-xl bg-sky-50 text-sky-800 border border-sky-200 active:scale-95">
                                            Á∑®ÈõÜ
                                          </button>
                                          <button onClick={()=>openDeleteDay(dateKey)}
                                            className="p-1.5 rounded-xl bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 active:scale-95" title="ÂâäÈô§">
                                            <Trash2 size={14}/>
                                          </button>
                                        </div>
                                      </div>
                                    </td>
                                    {displayTricks.map(t=>(
                                      <td key={t.id} className="p-2 text-center border-b border-slate-100">
                                        <span className={`font-black ${(parseInt(dayObj[t.id]||0)||0)>0?'text-slate-800':'text-slate-300'}`}>
                                          {parseInt(dayObj[t.id]||0)||0}
                                        </span>
                                      </td>
                                    ))}
                                    <td className="p-2 text-center border-b border-slate-100 font-black text-slate-800">{rowTotal}</td>
                                  </tr>
                                );
                              })
                            )}
                          </tbody>

                          {sortedDates.length>0 && (
                            <tfoot>
                              <tr className="bg-slate-50 border-t border-slate-200">
                                <td className="sticky-col p-2 font-black text-slate-700">ÂêàË®à</td>
                                {displayTricks.map(t=>(
                                  <td key={t.id} className="p-2 text-center font-black text-slate-800">{totals[t.id]||0}</td>
                                ))}
                                <td className="p-2 text-center font-black text-slate-800">
                                  {displayTricks.reduce((s,t)=>s+(totals[t.id]||0),0)}
                                </td>
                              </tr>
                            </tfoot>
                          )}
                        </table>
                      </div>
                    </div>

                    <p className="text-center text-xs text-slate-400 mt-2 font-bold">
                      Êó•‰ªò„ÇíÊäº„Åô„Å®Êó•‰ªòÂ§âÊõ¥ / „ÄåÁ∑®ÈõÜ„Äç„Åß„Åù„ÅÆÊó•„ÅÆÂÖ•Âäõ„Å∏ / „Äå‰∏ÄË¶ß„Çí„Ç≥„Éî„Éº„Äç„ÅßË≤º„Çä‰ªò„Åë„Åß„Åç„Åæ„Åô„ÄÇ
                    </p>
                  </div>

                  <div className="mt-6 bg-emerald-50 p-4 rounded-3xl border border-emerald-100 text-left">
                    <div className="flex items-center gap-3 mb-2">
                      <User className="text-emerald-600" size={20}/>
                      <span className="font-black text-emerald-900">{user.name?user.name:'ÂêçÁÑ°„Åó'} „Åï„Çì„ÅÆ„Åç„Çç„Åè</span>
                    </div>
                    <div className="text-xs text-emerald-800 font-bold">{user.isRegistered ? 'Ë®òÈå≤‰∏≠' : 'Êú™ÁôªÈå≤'}</div>
                  </div>
                </div>
              </div>
            )}

          </main>

          {/* „Éú„Éà„É†„Éä„ÉìÔºàÂ≠ê„Å©„ÇÇ„ÅåËø∑„Çè„Å™„ÅÑÔºÅÔºâ */}
          <footer className="fixed bottom-0 left-0 right-0 z-50">
            <div className="bg-white/88 backdrop-blur-md border-t border-slate-200">
              <div className="max-w-2xl mx-auto px-3 py-2">
                <div className="grid" style={{gridTemplateColumns:`repeat(${navItems.length}, minmax(0, 1fr))`}}>
                  {navItems.map(item=>{
                    const Icon=item.icon;
                    const active=activeTab===item.id;
                    return (
                      <button
                        key={item.id}
                        onClick={()=>{ tap('click'); setActiveTab(item.id); }}
                        className={`py-2 rounded-2xl flex flex-col items-center justify-center gap-1 transition active:scale-95 ${
                          active ? 'bg-sky-50 border border-sky-200' : 'hover:bg-slate-50'
                        }`}
                      >
                        <Icon size={20} className={active ? 'text-sky-600' : 'text-slate-500'} />
                        <div className={`text-[10px] font-black ${active?'text-sky-700':'text-slate-500'}`}>{item.label}</div>
                      </button>
                    );
                  })}
                </div>
                <div className="mt-1 text-[10px] text-slate-400 font-bold text-center">
                  ¬©2026 Takayuki WAYAMA / „Å™„Çè„Å®„Å≥Ê§úÂÆö„Ç´„Éº„Éâ
                </div>
              </div>
              <div style={{height:'env(safe-area-inset-bottom)'}} />
            </div>
          </footer>

        </div>
      );
    }

    const root=createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
