<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ãªã‚ã¨ã³ãƒã‚¹ã‚¿ãƒ¼ï½œæ¤œå®šã‚«ãƒ¼ãƒ‰</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800;900&display=swap" rel="stylesheet">

  <!-- React (UMD) + Babel  â€»importç¦æ­¢ã§ç¢ºå®Ÿã«å‹•ã‹ã™ -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root { --safe-bottom: env(safe-area-inset-bottom, 0px); }
    body{
      font-family: 'M PLUS Rounded 1c', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
    .custom-scrollbar::-webkit-scrollbar { height: 10px; width: 10px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* sticky */
    .sticky-col{
      position: sticky;
      left: 0;
      z-index: 12;
      background: white;
      border-right: 3px double #94a3b8;
    }
    .sticky-header{
      position: sticky;
      top: 0;
      z-index: 11;
    }
    .sticky-corner{
      position: sticky;
      left: 0;
      top: 0;
      z-index: 20;
      background: #fff7ed;
      border-right: 3px double #94a3b8;
    }

    /* input number spinner off */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    input[type="number"]{ -moz-appearance: textfield; }

    /* confetti canvas */
    #confetti-canvas{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
    }

    /* small animations */
    @keyframes popIn { 0%{transform:scale(.9);opacity:0} 100%{transform:scale(1);opacity:1} }
    .animate-popIn{ animation: popIn .25s ease-out both; }
    @keyframes fadeUp { 0%{transform:translateY(10px);opacity:0} 100%{transform:translateY(0);opacity:1} }
    .animate-fadeUp{ animation: fadeUp .25s ease-out both; }
  </style>
</head>

<body class="bg-sky-50 text-slate-800 select-none">
  <canvas id="confetti-canvas"></canvas>
  <div id="root"></div>

  <!-- â˜… å…ç«¥é…ä»˜ç”¨ã«æ›¸ãå‡ºã™ã¨ã€ã“ã®JSONã«ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãŒåŸ‹ã‚è¾¼ã¾ã‚Œã¾ã™ -->
  <script id="embedded-config" type="application/json">
  {
    "teacherMode": true
  }
  </script>

  <script>
    // ========== Sound (æ—§ã‚³ãƒ¼ãƒ‰ã®é›°å›²æ°—) ==========
    window.__sound = (function(){
      let ctx = null;
      function getCtx(){
        if(!ctx){
          const AC = window.AudioContext || window.webkitAudioContext;
          if(!AC) return null;
          ctx = new AC();
        }
        if(ctx.state === 'suspended') ctx.resume();
        return ctx;
      }
      function tone(freq, type, duration){
        const c = getCtx(); if(!c) return;
        const osc = c.createOscillator();
        const gain = c.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, c.currentTime);
        gain.gain.setValueAtTime(0.12, c.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, c.currentTime + duration);
        osc.connect(gain); gain.connect(c.destination);
        osc.start();
        osc.stop(c.currentTime + duration);
      }
      return {
        click: ()=> tone(650,'sine',0.08),
        success: ()=> { tone(880,'sine',0.10); setTimeout(()=>tone(1320,'triangle',0.18), 80); },
        fanfare: ()=> {
          const notes=[523.25,659.25,783.99,1046.50];
          notes.forEach((f,i)=>setTimeout(()=>tone(f,'triangle',0.35), i*120));
        }
      };
    })();

    // ========== Confetti (æ—§ã‚³ãƒ¼ãƒ‰ã®é›°å›²æ°—) ==========
    window.__confetti = (function(){
      const canvas = document.getElementById('confetti-canvas');
      const ctx = canvas.getContext('2d');
      let particles = [];
      let anim = null;

      function resize(){
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      window.addEventListener('resize', resize);
      resize();

      function spawn(){
        const colors = ['#FF6B6B','#4ECDC4','#FFE66D','#FF9F43','#54A0FF','#A78BFA'];
        const cx = canvas.width/2, cy = canvas.height/2;
        for(let i=0;i<120;i++){
          particles.push({
            x: cx, y: cy,
            vx: (Math.random()-0.5)*12,
            vy: (Math.random()-0.7)*14,
            size: Math.random()*8+4,
            color: colors[(Math.random()*colors.length)|0],
            rot: Math.random()*Math.PI*2,
            vr: (Math.random()-0.5)*0.25
          });
        }
      }

      function step(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        particles = particles.filter(p => p.y < canvas.height + 40);
        particles.forEach(p=>{
          p.x += p.vx; p.y += p.vy;
          p.vy += 0.28;
          p.rot += p.vr;
          ctx.save();
          ctx.translate(p.x,p.y);
          ctx.rotate(p.rot);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size);
          ctx.restore();
        });
        if(particles.length===0){ cancelAnimationFrame(anim); anim=null; return; }
        anim = requestAnimationFrame(step);
      }

      return {
        start: ()=>{
          spawn();
          if(!anim) step();
        },
        clear: ()=>{
          particles=[];
          ctx.clearRect(0,0,canvas.width,canvas.height);
          if(anim){ cancelAnimationFrame(anim); anim=null; }
        }
      };
    })();
  </script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    // ========= helpers =========
    const pad = (n)=> String(n).padStart(2,'0');
    const toKey = (d)=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const fromKey = (k)=> new Date(`${k}T00:00:00`);
    const todayKey = ()=> toKey(new Date());

    // --- æ—¥æœ¬ã®ç¥æ—¥ï¼ˆç°¡æ˜“ï¼‰ ---
    function isJapaneseHoliday(date) {
      const y = date.getFullYear();
      const m = date.getMonth() + 1;
      const d = date.getDate();
      const w = date.getDay(); // 0=Sun,1=Mon

      if (m === 1 && d === 1) return true;
      if (m === 2 && d === 11) return true;
      if (m === 2 && d === 23) return true;
      if (m === 3 && d === Math.floor(20.8431 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4))) return true;
      if (m === 4 && d === 29) return true;
      if (m === 5 && d === 3) return true;
      if (m === 5 && d === 4) return true;
      if (m === 5 && d === 5) return true;
      if (m === 8 && d === 11) return true;
      if (m === 9 && d === Math.floor(23.2488 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4))) return true;
      if (m === 11 && d === 3) return true;
      if (m === 11 && d === 23) return true;

      const isNthMonday = (n) => (w === 1) && (Math.floor((d - 1) / 7) === (n - 1));
      if (m === 1 && isNthMonday(2)) return true;
      if (m === 7 && isNthMonday(3)) return true;
      if (m === 9 && isNthMonday(3)) return true;
      if (m === 10 && isNthMonday(2)) return true;

      if (w === 1) {
        const yesterday = new Date(date);
        yesterday.setDate(d - 1);
        if (isJapaneseHoliday(yesterday)) return true;
      }
      return false;
    }

    // ========= å›ºå®šå®šç¾© =========
    const TRICK_IDS = [
      'mae','ushiro','kataashi','kakeashi','kakeashi_ushiro',
      'nibyoushi','aya','aya_ushiro','kousa','kousa_ushiro',
      'niju','aya_niju','sokushin','kousa_niju','niju_ushiro',
      'zengo_kousa','sanju'
    ];

    const TRICK_COLORS = {
      mae: 'bg-blue-100 text-blue-700 border-blue-200',
      ushiro: 'bg-indigo-100 text-indigo-700 border-indigo-200',
      kataashi: 'bg-teal-100 text-teal-700 border-teal-200',
      kakeashi: 'bg-green-100 text-green-700 border-green-200',
      kakeashi_ushiro: 'bg-emerald-100 text-emerald-700 border-emerald-200',
      nibyoushi: 'bg-cyan-100 text-cyan-700 border-cyan-200',
      aya: 'bg-yellow-100 text-yellow-800 border-yellow-200',
      aya_ushiro: 'bg-amber-100 text-amber-800 border-amber-200',
      kousa: 'bg-orange-100 text-orange-700 border-orange-200',
      kousa_ushiro: 'bg-red-100 text-red-700 border-red-200',
      niju: 'bg-pink-100 text-pink-700 border-pink-200',
      aya_niju: 'bg-purple-100 text-purple-700 border-purple-200',
      sokushin: 'bg-lime-100 text-lime-800 border-lime-200',
      kousa_niju: 'bg-rose-100 text-rose-700 border-rose-200',
      niju_ushiro: 'bg-fuchsia-100 text-fuchsia-700 border-fuchsia-200',
      zengo_kousa: 'bg-violet-100 text-violet-700 border-violet-200',
      sanju: 'bg-slate-100 text-slate-700 border-slate-200'
    };

    const DEFAULT_TRICK_NAMES = {
      low: {
        mae:'ã‚Šã‚‡ã†ã‚ã—ã¨ã³', ushiro:'ã‚Šã‚‡ã†ã‚ã—ã¨ã³ï¼ˆã†ã—ã‚ï¼‰', kataashi:'ã‹ãŸã‚ã—ã¨ã³', kakeashi:'ã‹ã‘ã‚ã—ã¨ã³', kakeashi_ushiro:'ã‹ã‘ã‚ã—ã¨ã³ï¼ˆã†ã—ã‚ï¼‰',
        nibyoushi:'ï¼’ã³ã‚‡ã†ã—ã¨ã³', aya:'ã‚ã‚„ã¨ã³', aya_ushiro:'ã‚ã‚„ã¨ã³ï¼ˆã†ã—ã‚ï¼‰', kousa:'ã“ã†ã•ã¨ã³', kousa_ushiro:'ã“ã†ã•ã¨ã³ï¼ˆã†ã—ã‚ï¼‰',
        niju:'ï¼’ã˜ã‚…ã†ã¨ã³', aya_niju:'ã‚ã‚„ï¼’ã˜ã‚…ã†ã¨ã³', sokushin:'ããã—ã‚“ã¨ã³', kousa_niju:'ã“ã†ã•ï¼’ã˜ã‚…ã†ã¨ã³', niju_ushiro:'ï¼’ã˜ã‚…ã†ã¨ã³ï¼ˆã†ã—ã‚ï¼‰',
        zengo_kousa:'ãœã‚“ã”ã“ã†ã•ã¨ã³', sanju:'ï¼“ã˜ã‚…ã†ã¨ã³'
      },
      mid: {
        mae:'ã‚Šã‚‡ã†è¶³ã¨ã³', ushiro:'ã‚Šã‚‡ã†è¶³ã¨ã³ï¼ˆå¾Œã‚ï¼‰', kataashi:'ã‹ãŸè¶³ã¨ã³', kakeashi:'ã‹ã‘è¶³ã¨ã³', kakeashi_ushiro:'ã‹ã‘è¶³ã¨ã³ï¼ˆå¾Œã‚ï¼‰',
        nibyoushi:'ï¼’ã³ã‚‡ã†ã—ã¨ã³', aya:'ã‚ã‚„ã¨ã³', aya_ushiro:'ã‚ã‚„ã¨ã³ï¼ˆå¾Œã‚ï¼‰', kousa:'äº¤ã•ã¨ã³', kousa_ushiro:'äº¤ã•ã¨ã³ï¼ˆå¾Œã‚ï¼‰',
        niju:'ï¼’ã˜ã‚…ã†ã¨ã³', aya_niju:'ã‚ã‚„ï¼’ã˜ã‚…ã†ã¨ã³', sokushin:'å´æŒ¯ã¨ã³', kousa_niju:'äº¤ã•ï¼’ã˜ã‚…ã†ã¨ã³', niju_ushiro:'ï¼’ã˜ã‚…ã†ã¨ã³ï¼ˆå¾Œã‚ï¼‰',
        zengo_kousa:'å‰å¾Œäº¤ã•ã¨ã³', sanju:'ï¼“ã˜ã‚…ã†ã¨ã³'
      },
      high: {
        mae:'ä¸¡è¶³ã¨ã³', ushiro:'ä¸¡è¶³ã¨ã³ï¼ˆå¾Œã‚ï¼‰', kataashi:'ç‰‡è¶³ã¨ã³', kakeashi:'ã‹ã‘è¶³ã¨ã³', kakeashi_ushiro:'ã‹ã‘è¶³ã¨ã³ï¼ˆå¾Œã‚ï¼‰',
        nibyoushi:'ï¼’ã³ã‚‡ã†ã—ã¨ã³', aya:'ã‚ã‚„ã¨ã³', aya_ushiro:'ã‚ã‚„ã¨ã³ï¼ˆå¾Œã‚ï¼‰', kousa:'äº¤å·®ã¨ã³', kousa_ushiro:'äº¤å·®ã¨ã³ï¼ˆå¾Œã‚ï¼‰',
        niju:'ï¼’é‡ã¨ã³', aya_niju:'ã‚ã‚„ï¼’é‡ã¨ã³', sokushin:'å´ã—ã‚“ã¨ã³', kousa_niju:'äº¤å·®ï¼’é‡ã¨ã³', niju_ushiro:'ï¼’é‡ã¨ã³ã†ã—ã‚',
        zengo_kousa:'å‰å¾Œäº¤å·®ã¨ã³', sanju:'ï¼“é‡ã¨ã³'
      }
    };

    // â€»ç¾ã‚³ãƒ¼ãƒ‰ã®ç´šãƒ‡ãƒ¼ã‚¿ï¼ˆãã®ã¾ã¾ï¼‰
    const DEFAULT_LEVELS_DATA = {
      low: [
        { level: 20, reqs: { mae: 1, kataashi: 1 } },
        { level: 19, reqs: { mae: 5, kataashi: 4 } },
        { level: 18, reqs: { mae: 10, ushiro: 1, kataashi: 8, kakeashi: 2 } },
        { level: 17, reqs: { mae: 15, ushiro: 3, kataashi: 12, kakeashi: 8 } },
        { level: 16, reqs: { mae: 20, ushiro: 5, kataashi: 16, kakeashi: 16 } },
        { level: 15, reqs: { mae: 25, ushiro: 7, kataashi: 20, kakeashi: 24 } },
        { level: 14, reqs: { mae: 30, ushiro: 10, kakeashi: 30, kakeashi_ushiro: 2, nibyoushi: 4 } },
        { level: 13, reqs: { mae: 35, ushiro: 12, kakeashi: 35, kakeashi_ushiro: 4, nibyoushi: 8 } },
        { level: 12, reqs: { mae: 40, ushiro: 15, kakeashi: 40, kakeashi_ushiro: 8, nibyoushi: 12 } },
        { level: 11, reqs: { mae: 45, ushiro: 20, kakeashi: 45, kakeashi_ushiro: 12, nibyoushi: 16 } },
        { level: 10, reqs: { mae: 50, ushiro: 25, kakeashi: 50, kakeashi_ushiro: 16, nibyoushi: 20 } },
        { level: 9, reqs: { mae: 55, ushiro: 30, kakeashi: 55, kakeashi_ushiro: 20, nibyoushi: 24 } },
        { level: 8, reqs: { mae: 60, ushiro: 35, kakeashi: 60, kakeashi_ushiro: 24, nibyoushi: 28 } },
        { level: 7, reqs: { mae: 65, ushiro: 40, kakeashi: 65, kousa: 1, niju: 1, aya: 2 } },
        { level: 6, reqs: { mae: 70, ushiro: 45, kakeashi: 70, kousa: 2, niju: 2, aya: 4 } },
        { level: 5, reqs: { mae: 75, ushiro: 50, kakeashi: 75, kousa: 3, niju: 3, aya: 6 } },
        { level: 4, reqs: { mae: 80, ushiro: 55, kakeashi: 80, kousa: 4, niju: 4, aya: 8 } },
        { level: 3, reqs: { mae: 85, ushiro: 60, kakeashi: 85, kousa: 6, niju: 5, aya: 12 } },
        { level: 2, reqs: { mae: 90, ushiro: 65, kakeashi: 90, kousa: 8, niju: 6, aya: 16 } },
        { level: 1, reqs: { mae: 100, ushiro: 70, kakeashi: 100, kousa: 10, niju: 7, aya: 24 } }
      ],
      mid: [
        { level: 20, reqs: { mae: 2, nibyoushi: 4 } },
        { level: 19, reqs: { mae: 7, nibyoushi: 8 } },
        { level: 18, reqs: { mae: 10, ushiro: 1, nibyoushi: 12, kakeashi: 4 } },
        { level: 17, reqs: { mae: 15, ushiro: 3, nibyoushi: 16, kakeashi: 10 } },
        { level: 16, reqs: { mae: 20, ushiro: 5, nibyoushi: 20, kakeashi: 20 } },
        { level: 15, reqs: { mae: 30, ushiro: 10, nibyoushi: 40, kakeashi: 30 } },
        { level: 14, reqs: { mae: 40, ushiro: 20, kakeashi: 40, kakeashi_ushiro: 2, aya: 2 } },
        { level: 13, reqs: { mae: 50, ushiro: 30, kakeashi: 50, kakeashi_ushiro: 8, aya: 4 } },
        { level: 12, reqs: { mae: 60, ushiro: 40, kakeashi: 60, kakeashi_ushiro: 12, aya: 6 } },
        { level: 11, reqs: { mae: 70, ushiro: 50, kakeashi: 70, kakeashi_ushiro: 16, aya: 8 } },
        { level: 10, reqs: { mae: 80, ushiro: 60, kakeashi: 80, kakeashi_ushiro: 20, aya: 10 } },
        { level: 9, reqs: { mae: 90, ushiro: 80, kakeashi: 90, kakeashi_ushiro: 24, aya: 12 } },
        { level: 8, reqs: { mae: 100, ushiro: 100, kakeashi: 100, kakeashi_ushiro: 28, aya: 14 } },
        { level: 7, reqs: { mae: 110, ushiro: 110, kousa: 1, kousa_ushiro: 1, niju: 1, aya_ushiro: 2, aya_niju: 1 } },
        { level: 6, reqs: { mae: 120, ushiro: 120, kousa: 5, kousa_ushiro: 3, niju: 2, aya_ushiro: 4, aya_niju: 2 } },
        { level: 5, reqs: { mae: 130, ushiro: 130, kousa: 10, kousa_ushiro: 5, niju: 5, aya_ushiro: 6, aya_niju: 3 } },
        { level: 4, reqs: { mae: 140, ushiro: 140, kousa: 15, kousa_ushiro: 8, niju: 8, aya_ushiro: 8, aya_niju: 4 } },
        { level: 3, reqs: { mae: 160, ushiro: 160, kousa: 20, kousa_ushiro: 10, niju: 10, aya_ushiro: 10, aya_niju: 6 } },
        { level: 2, reqs: { mae: 180, ushiro: 180, kousa: 25, kousa_ushiro: 15, niju: 12, aya_ushiro: 12, aya_niju: 8 } },
        { level: 1, reqs: { mae: 200, ushiro: 200, kousa_ushiro: 30, niju: 20, aya_niju: 20, kousa_niju: 3, niju_ushiro: 7, sanju: 3 } }
      ],
      high: [
        { level: 20, reqs: { mae: 3, nibyoushi: 4, kakeashi: 3 } },
        { level: 19, reqs: { mae: 8, nibyoushi: 8, kakeashi: 8 } },
        { level: 18, reqs: { mae: 15, ushiro: 3, nibyoushi: 12, kakeashi: 15, aya: 2 } },
        { level: 17, reqs: { mae: 20, ushiro: 8, nibyoushi: 20, kakeashi: 20, aya: 4 } },
        { level: 16, reqs: { mae: 30, ushiro: 15, nibyoushi: 40, kakeashi: 30, aya: 8 } },
        { level: 15, reqs: { mae: 40, ushiro: 20, nibyoushi: 60, kakeashi: 40, aya: 14 } },
        { level: 14, reqs: { mae: 50, ushiro: 30, kakeashi: 50, kakeashi_ushiro: 10, aya: 20, kousa: 1, niju: 2, aya_ushiro: 2 } },
        { level: 13, reqs: { mae: 60, ushiro: 40, kakeashi: 60, kakeashi_ushiro: 20, aya: 25, kousa: 5, niju: 4, aya_ushiro: 4 } },
        { level: 12, reqs: { mae: 70, ushiro: 50, kakeashi: 70, kakeashi_ushiro: 30, aya: 30, kousa: 10, niju: 8, aya_ushiro: 8 } },
        { level: 11, reqs: { mae: 80, ushiro: 60, kakeashi: 80, kakeashi_ushiro: 40, aya: 35, kousa: 15, niju: 12, aya_ushiro: 12 } },
        { level: 10, reqs: { mae: 90, ushiro: 70, kakeashi: 90, kakeashi_ushiro: 60, aya: 40, kousa: 20, kousa_ushiro: 1, niju: 16, aya_ushiro: 16 } },
        { level: 9, reqs: { mae: 100, ushiro: 80, kakeashi: 100, kakeashi_ushiro: 80, aya: 45, kousa: 25, kousa_ushiro: 3, niju: 20, aya_ushiro: 20 } },
        { level: 8, reqs: { mae: 120, ushiro: 100, kakeashi: 120, kakeashi_ushiro: 100, aya: 50, kousa: 30, kousa_ushiro: 5, niju: 24, aya_ushiro: 24 } },
        { level: 7, reqs: { mae: 140, ushiro: 110, kousa_ushiro: 3, niju: 8, aya_niju: 1, sokushin: 4, niju_ushiro: 1, zengo_kousa: 1 } },
        { level: 6, reqs: { mae: 150, ushiro: 120, kousa_ushiro: 5, niju: 10, aya_niju: 3, sokushin: 8, niju_ushiro: 2, zengo_kousa: 5 } },
        { level: 5, reqs: { mae: 160, ushiro: 130, kousa_ushiro: 8, niju: 12, aya_niju: 5, sokushin: 12, niju_ushiro: 3, zengo_kousa: 10 } },
        { level: 4, reqs: { mae: 170, ushiro: 140, kousa_ushiro: 10, niju: 14, aya_niju: 8, sokushin: 24, niju_ushiro: 4, zengo_kousa: 20 } },
        { level: 3, reqs: { mae: 180, ushiro: 160, kousa_ushiro: 15, niju: 16, aya_niju: 10, kousa_niju: 1, niju_ushiro: 5, sanju: 1 } },
        { level: 2, reqs: { mae: 190, ushiro: 180, kousa_ushiro: 20, niju: 18, aya_niju: 15, kousa_niju: 2, niju_ushiro: 6, sanju: 2 } },
        { level: 1, reqs: { mae: 200, ushiro: 200, kousa_ushiro: 30, niju: 20, aya_niju: 20, kousa_niju: 3, niju_ushiro: 7, sanju: 3 } }
      ]
    };

    // åˆè¨ˆç›®æ¨™ï¼ˆæ—§ã‚³ãƒ¼ãƒ‰ã®ã€Œåˆè¨ˆã¨ç›®æ¨™ã€ç™ºæƒ³ã‚’ç§»æ¤ï¼‰
    const DEFAULT_GOALS = {
      mae: 5000,
      ushiro: 2000,
      kataashi: 1500,
      kakeashi: 2000,
      kakeashi_ushiro: 800,
      nibyoushi: 1500,
      aya: 1500,
      aya_ushiro: 800,
      kousa: 1000,
      kousa_ushiro: 600,
      niju: 300,
      aya_niju: 200,
      sokushin: 600,
      kousa_niju: 150,
      niju_ushiro: 150,
      zengo_kousa: 200,
      sanju: 50
    };

    // ========= Calendar Modal =========
    function CalendarModal({ open, onClose, onPick, disabledKeys = new Set(), initialKey }) {
      const init = initialKey ? fromKey(initialKey) : new Date();
      const [y, setY] = useState(init.getFullYear());
      const [m, setM] = useState(init.getMonth()); // 0-11

      useEffect(()=>{
        if(open){
          const d = initialKey ? fromKey(initialKey) : new Date();
          setY(d.getFullYear());
          setM(d.getMonth());
        }
      }, [open, initialKey]);

      if(!open) return null;

      const first = new Date(y, m, 1).getDay();
      const daysInMonth = new Date(y, m+1, 0).getDate();
      const tKey = todayKey();

      const cells = [];
      for(let i=0;i<first;i++) cells.push(null);
      for(let d=1; d<=daysInMonth; d++){
        const key = `${y}-${pad(m+1)}-${pad(d)}`;
        cells.push({ d, key });
      }

      return (
        <div className="fixed inset-0 z-[9990] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4" onMouseDown={onClose}>
          <div className="bg-white w-full max-w-sm rounded-3xl p-5 border-4 border-orange-200 shadow-2xl animate-popIn" onMouseDown={(e)=>e.stopPropagation()}>
            <div className="flex items-center justify-between mb-3">
              <div className="font-black text-orange-600 text-lg flex items-center gap-2">
                <span className="text-2xl">ğŸ“…</span> æ—¥ä»˜ã‚’ãˆã‚‰ã¶
              </div>
              <button className="w-9 h-9 rounded-full bg-slate-100 hover:bg-slate-200 font-black text-slate-500" onClick={onClose}>Ã—</button>
            </div>

            <div className="flex items-center justify-between bg-orange-50 border border-orange-100 rounded-2xl px-3 py-2 mb-3">
              <button className="text-orange-500 font-black text-lg px-2 py-1 rounded hover:bg-orange-100" onClick={()=>{ const nm=m-1; if(nm<0){setM(11); setY(y-1);} else setM(nm); }}>â—€</button>
              <div className="font-black text-slate-700 tracking-wider">{y}å¹´ {m+1}æœˆ</div>
              <button className="text-orange-500 font-black text-lg px-2 py-1 rounded hover:bg-orange-100" onClick={()=>{ const nm=m+1; if(nm>11){setM(0); setY(y+1);} else setM(nm); }}>â–¶</button>
            </div>

            <div className="grid grid-cols-7 gap-1 text-center text-xs font-black text-slate-400 mb-2">
              <div className="text-red-400">æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div className="text-blue-400">åœŸ</div>
            </div>

            <div className="grid grid-cols-7 gap-1 text-center font-black text-slate-600">
              {cells.map((c, idx)=>{
                if(!c) return <div key={idx} />;
                const isToday = c.key===tKey;
                const disabled = disabledKeys.has(c.key);
                return (
                  <button
                    key={c.key}
                    disabled={disabled}
                    onClick={()=> onPick(c.key)}
                    className={[
                      "p-2 rounded-xl transition border-2",
                      disabled ? "opacity-30 bg-slate-100 border-slate-200 cursor-not-allowed" : "hover:bg-orange-100 border-slate-100",
                      isToday ? "bg-orange-50 border-orange-300 text-orange-700" : "bg-white"
                    ].join(" ")}
                  >
                    {c.d}
                  </button>
                );
              })}
            </div>

            <div className="mt-4 text-[11px] text-slate-400 font-bold">
              â€»ã™ã§ã«ã‚ã‚‹æ—¥ä»˜ã¯é¸ã¹ãªã„ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ï¼ˆä¸Šæ›¸ãäº‹æ•…é˜²æ­¢ï¼‰ã€‚
            </div>
          </div>
        </div>
      );
    }

    // ========= App =========
    function App(){
      // embedded config
      const embedded = useMemo(()=>{
        try{
          const el = document.getElementById('embedded-config');
          if(!el) return {};
          return JSON.parse(el.textContent || "{}");
        }catch{ return {}; }
      }, []);

      // teacher mode
      const isTeacherMode = useMemo(()=>{
        const qs = new URLSearchParams(location.search);
        if(qs.get('teacher') === '1') return true;
        if(embedded && embedded.teacherMode === false) return false;
        return true;
      }, [embedded]);

      const [activeTab, setActiveTab] = useState('home'); // home,input,cert,totals,history,settings
      const [totalsSub, setTotalsSub] = useState('graph'); // graph/table

      const [user, setUser] = useState({ grade: 1, classVal: '', number: '', name: '' });

      const [levelsData, setLevelsData] = useState(DEFAULT_LEVELS_DATA);
      const [trickNames, setTrickNames] = useState(DEFAULT_TRICK_NAMES);
      const [goals, setGoals] = useState(DEFAULT_GOALS);

      const [dailyRecords, setDailyRecords] = useState({});
      const [targetDate, setTargetDate] = useState(todayKey());
      const [records, setRecords] = useState({}); // input screen buffer

      // æ—§ã‚³ãƒ¼ãƒ‰è¦ç´ ï¼šé”æˆæ¸ˆã¿ç›®æ¨™key
      const [achievements, setAchievements] = useState([]);

      // modals
      const [showLevelUp, setShowLevelUp] = useState(false);
      const [levelUpMsg, setLevelUpMsg] = useState({ title: "ãŠã‚ã§ã¨ã†ï¼", sub: "" });

      const [showGoalModal, setShowGoalModal] = useState(false);
      const [pendingGoal, setPendingGoal] = useState(null); // {trickId, oldGoal, newGoal}

      const [showImportModal, setShowImportModal] = useState(false);
      const [importText, setImportText] = useState("");

      const [showCalendar, setShowCalendar] = useState(false);
      const [calendarDisabled, setCalendarDisabled] = useState(new Set());
      const [calendarInitial, setCalendarInitial] = useState(todayKey());
      const [calendarOnPick, setCalendarOnPick] = useState(()=>()=>{});

      const [settingTab, setSettingTab] = useState('low'); // settings grade tab

      // ========= load =========
      useEffect(()=>{
        try{
          const savedUser = localStorage.getItem('nawatobi_user');
          const savedDaily = localStorage.getItem('nawatobi_daily_records');
          const savedLevels = localStorage.getItem('nawatobi_levels');
          const savedNames  = localStorage.getItem('nawatobi_trick_names');
          const savedGoals  = localStorage.getItem('nawatobi_goals');
          const savedAch    = localStorage.getItem('nawatobi_achievements');

          if(savedUser) setUser(JSON.parse(savedUser));
          if(savedDaily) setDailyRecords(JSON.parse(savedDaily));
          if(savedLevels) setLevelsData(JSON.parse(savedLevels));
          if(savedNames) setTrickNames(JSON.parse(savedNames));
          if(savedGoals) setGoals(JSON.parse(savedGoals));
          if(savedAch) setAchievements(JSON.parse(savedAch));

          // targetDate åˆæœŸ
          const t = todayKey();
          setTargetDate(t);

        }catch(e){
          console.error(e);
          alert("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
      }, []);

      // ========= save =========
      useEffect(()=> localStorage.setItem('nawatobi_user', JSON.stringify(user)), [user]);
      useEffect(()=> localStorage.setItem('nawatobi_daily_records', JSON.stringify(dailyRecords)), [dailyRecords]);
      useEffect(()=> localStorage.setItem('nawatobi_levels', JSON.stringify(levelsData)), [levelsData]);
      useEffect(()=> localStorage.setItem('nawatobi_trick_names', JSON.stringify(trickNames)), [trickNames]);
      useEffect(()=> localStorage.setItem('nawatobi_goals', JSON.stringify(goals)), [goals]);
      useEffect(()=> localStorage.setItem('nawatobi_achievements', JSON.stringify(achievements)), [achievements]);

      // date change => load buffer
      useEffect(()=>{
        const rec = dailyRecords[targetDate] || {};
        setRecords({ ...rec });
      }, [targetDate, dailyRecords]);

      // ========= derived =========
      const gradeCategory = useMemo(()=>{
        if(user.grade <= 2) return 'low';
        if(user.grade <= 4) return 'mid';
        return 'high';
      }, [user.grade]);

      const currentLevelSet = useMemo(()=>{
        return (levelsData[gradeCategory] || [])
          .map(l => ({...l, name: (l.name!==undefined ? l.name : `${l.level}ç´š`)}))
          .filter(l => l.name !== '');
      }, [levelsData, gradeCategory]);

      const displayTricks = useMemo(()=>{
        const active = new Set();
        (levelsData[gradeCategory] || []).forEach(l=>{
          if(l.name==='') return;
          if(!l.reqs) return;
          Object.entries(l.reqs).forEach(([k,v])=>{
            if((v||0) > 0) active.add(k);
          });
        });
        return TRICK_IDS
          .filter(id => active.has(id))
          .map(id => ({
            id,
            label: (trickNames[gradeCategory]?.[id] || DEFAULT_TRICK_NAMES[gradeCategory]?.[id] || id),
            color: TRICK_COLORS[id] || 'bg-slate-100 text-slate-700 border-slate-200'
          }));
      }, [levelsData, trickNames, gradeCategory]);

      // totals across days (æ—§ã‚³ãƒ¼ãƒ‰ã®åˆè¨ˆ)
      const totals = useMemo(()=>{
        const t = {};
        displayTricks.forEach(s=> t[s.id]=0);
        Object.values(dailyRecords).forEach(rec=>{
          displayTricks.forEach(s=>{
            t[s.id] += (parseInt(rec?.[s.id]) || 0);
          });
        });
        return t;
      }, [dailyRecords, displayTricks]);

      // max records across daysï¼ˆç¾ã‚³ãƒ¼ãƒ‰ã®æœ€é«˜ï¼‰
      const maxRecords = useMemo(()=>{
        const mx = {};
        displayTricks.forEach(s=> mx[s.id]=0);
        Object.values(dailyRecords).forEach(rec=>{
          displayTricks.forEach(s=>{
            const v = (parseInt(rec?.[s.id]) || 0);
            if(v > (mx[s.id]||0)) mx[s.id]=v;
          });
        });
        return mx;
      }, [dailyRecords, displayTricks]);

      // history derived
      const history = useMemo(()=>{
        const h = {};
        Object.entries(dailyRecords).forEach(([k, rec])=>{
          const any = Object.values(rec||{}).some(v => (parseInt(v)||0) > 0);
          if(any) h[k] = true;
        });
        return h;
      }, [dailyRecords]);

      // streak (ç¾ã‚³ãƒ¼ãƒ‰ã®é ‘å¼µã‚Šï¼‹ä¼‘æ—¥ã‚¹ã‚­ãƒƒãƒ—)
      const streak = useMemo(()=>{
        const now = new Date();
        const t = toKey(now);
        let count = 0;
        let d = new Date(now);

        const isWeH = (dateObj)=>{
          const w = dateObj.getDay();
          return w===0 || w===6 || isJapaneseHoliday(dateObj);
        };

        // ä»Šæ—¥ã§ãã¦ã‚‹ãªã‚‰ä»Šæ—¥ã‹ã‚‰
        if(history[t]){
          count = 1;
          while(true){
            d.setDate(d.getDate()-1);
            const k = toKey(d);
            if(history[k]){ count++; continue; }
            if(isWeH(d)) continue;
            break;
          }
          return { count, msg: "ã™ã”ã„ï¼ãã‚‡ã†ã‚‚ ãŸã£ã›ã„ï¼" };
        }

        // ä»Šæ—¥ã§ãã¦ãªã„ãªã‚‰ã€æ˜¨æ—¥ã‹ã‚‰
        d = new Date(now); d.setDate(d.getDate()-1);
        while(true){
          const k = toKey(d);
          if(history[k]){ count++; d.setDate(d.getDate()-1); continue; }
          if(isWeH(d)){ d.setDate(d.getDate()-1); continue; }
          break;
        }
        return { count, msg: count>0 ? "ãã®ã†ã¾ã§ ã¤ã¥ã„ã¦ã‚‹ã‚ˆï¼" : "ãã‚‡ã†ã‹ã‚‰ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼" };
      }, [history]);

      // level judgement uses maxRecords
      const clearedLevels = useMemo(()=>{
        return currentLevelSet
          .filter(lvl =>
            Object.entries(lvl.reqs || {}).every(([trickId, need])=>{
              if(!need || need<=0) return true;
              return (maxRecords[trickId] || 0) >= need;
            })
          )
          .map(l=>l.level);
      }, [currentLevelSet, maxRecords]);

      const currentBestLevel = useMemo(()=>{
        if(clearedLevels.length===0) return null;
        const minLevel = Math.min(...clearedLevels);
        return currentLevelSet.find(l=>l.level===minLevel) || null;
      }, [clearedLevels, currentLevelSet]);

      const nextLevels = useMemo(()=>{
        const all = currentLevelSet.slice().sort((a,b)=> b.level - a.level); // 20 -> 1 ã®é †ï¼ˆæ•°å­—å¤§â†’å°ï¼‰
        return all.filter(l => !clearedLevels.includes(l.level));
      }, [currentLevelSet, clearedLevels]);

      const goalTitle = useMemo(()=>{
        return (user.grade<=2) ? "ã¤ãã® ã‚‚ãã²ã‚‡ã†ï¼ˆãã‚…ã† ã¨ ã‚ã–ï¼‰" : "æ¬¡ã®ç›®æ¨™ï¼ˆç´šã¨æŠ€ï¼‰";
      }, [user.grade]);

      // æŠ€ã”ã¨ã®æœ€é«˜åˆ°é”ç´šï¼ˆç¾ã‚³ãƒ¼ãƒ‰ã®ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºç”¨ï¼‰
      const getTrickLevel = useCallback((trickId)=>{
        const count = maxRecords[trickId] || 0;
        if(count<=0) return null;
        const levels = (levelsData[gradeCategory] || []).filter(l => (l.name!=='')); // æœ‰åŠ¹
        const passed = levels.filter(l=>{
          if(!l.reqs) return false;
          const need = l.reqs[trickId];
          return need>0 && count>=need;
        });
        if(passed.length===0) return null;
        return Math.min(...passed.map(l=>l.level));
      }, [maxRecords, levelsData, gradeCategory]);

      // ========= actions =========
      const clamp0 = (n)=> Math.max(0, n);

      const updateRecord = (trickId, v)=>{
        // ç©ºã¯è¨±å®¹ï¼ˆå…¥åŠ›ä¸­ï¼‰
        if(v === ''){ setRecords(prev=>({ ...prev, [trickId]: '' })); return; }
        const num = clamp0(parseInt(v || 0));
        setRecords(prev=>({ ...prev, [trickId]: num }));
      };

      const calculateBestLevelFor = useCallback((mxObj, category)=>{
        const levels = (levelsData[category] || [])
          .map(l => ({...l, name:(l.name!==undefined?l.name:`${l.level}ç´š`)}))
          .filter(l => l.name !== '');
        const cleared = levels.filter(l=>{
          if(!l.reqs) return true;
          return Object.entries(l.reqs).every(([id, need])=>{
            if(!need || need<=0) return true;
            return (mxObj[id] || 0) >= need;
          });
        }).map(l=>l.level);
        if(cleared.length===0) return 999;
        return Math.min(...cleared);
      }, [levelsData]);

      const handleConfirmRecord = (trickId)=>{
        const val = clamp0(parseInt(records[trickId] || 0));
        const beforeBest = calculateBestLevelFor(maxRecords, gradeCategory);

        const nextDaily = { ...dailyRecords };
        if(!nextDaily[targetDate]) nextDaily[targetDate] = {};
        nextDaily[targetDate] = { ...nextDaily[targetDate], [trickId]: val };
        setDailyRecords(nextDaily);

        window.__sound?.success?.();

        // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ¼”å‡ºï¼ˆmaxRecordsã¯useMemoæ›´æ–°ãªã®ã§ã€å…ˆã«æ¦‚ç®—ã§åˆ¤å®šï¼‰
        // ä»®maxã‚’ä½œã‚‹ï¼ˆã“ã®æ—¥ã®å…¥åŠ›ãŒmaxã‚’æ›´æ–°ã—ãŸå¯èƒ½æ€§ï¼‰
        const tmpMax = { ...maxRecords, [trickId]: Math.max(maxRecords[trickId]||0, val) };
        const afterBest = calculateBestLevelFor(tmpMax, gradeCategory);

        if(afterBest < beforeBest){
          window.__confetti?.start?.();
          window.__sound?.fanfare?.();
          setLevelUpMsg({
            title: "ãŠã‚ã§ã¨ã†ï¼",
            sub: `${(currentLevelSet.find(l=>l.level===afterBest)?.name)||(`${afterBest}ç´š`)} ã« ã‚ãŒã£ãŸï¼`
          });
          setShowLevelUp(true);
        }
      };

      const handleCopyTSV = async ()=>{
        // æ—§ã‚³ãƒ¼ãƒ‰ã®ã€Œè¡¨ã‚³ãƒ”ãƒ¼ã€ï¼šæ—¥ä»˜Ã—æŠ€
        const dates = Object.keys(dailyRecords).sort((a,b)=> new Date(a)-new Date(b));
        const header = ['æ—¥ä»˜', ...displayTricks.map(s=>s.label)];
        const lines = [header.join('\t')];

        const sumRow = {};
        displayTricks.forEach(s=> sumRow[s.id]=0);

        dates.forEach(date=>{
          const rec = dailyRecords[date] || {};
          const row = [date];
          displayTricks.forEach(s=>{
            const v = parseInt(rec[s.id]) || 0;
            sumRow[s.id] += v;
            row.push(v);
          });
          lines.push(row.join('\t'));
        });

        const totalLine = ['åˆè¨ˆ', ...displayTricks.map(s=>sumRow[s.id]||0)];
        lines.push(totalLine.join('\t'));

        const tsv = lines.join('\n');

        try{
          if(navigator.clipboard && window.isSecureContext){
            await navigator.clipboard.writeText(tsv);
          }else{
            const ta=document.createElement('textarea');
            ta.value=tsv;
            ta.style.position='fixed';
            ta.style.left='-9999px';
            document.body.appendChild(ta);
            ta.focus(); ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
          }
          window.__sound?.success?.();
          alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
        }catch(e){
          console.error(e);
          alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      };

      const openImport = ()=>{
        setImportText("");
        setShowImportModal(true);
        window.__sound?.click?.();
      };

      const executeImport = ()=>{
        const text = (importText || "").trim();
        if(!text){ alert("è²¼ã‚Šä»˜ã‘ãŒç©ºã§ã™ã€‚"); return; }

        try{
          const lines = text.split(/\r?\n/).filter(l=>l.trim()!=="");
          if(lines.length < 2){ alert("è¡ŒãŒè¶³ã‚Šã¾ã›ã‚“ã€‚ãƒ˜ãƒƒãƒ€ãƒ¼ï¼‹ãƒ‡ãƒ¼ã‚¿è¡ŒãŒå¿…è¦ã§ã™ã€‚"); return; }

          const headers = lines[0].split('\t');
          const labelToId = {};
          displayTricks.forEach(s=>{
            labelToId[s.label] = s.id;
            labelToId[s.id] = s.id; // idã§ã‚‚OKã«
          });

          const colMap = {};
          headers.forEach((h, idx)=>{
            const id = labelToId[h];
            if(id) colMap[id]=idx;
          });

          let imported = 0;
          const nextDaily = { ...dailyRecords };

          for(let i=1;i<lines.length;i++){
            const cols = lines[i].split('\t');
            const date = cols[0];
            if(!/^\d{4}-\d{2}-\d{2}$/.test(date)) continue;
            if(!nextDaily[date]) nextDaily[date] = {};
            Object.entries(colMap).forEach(([id, idx])=>{
              const v = parseInt(cols[idx]) || 0;
              nextDaily[date][id] = v;
            });
            imported++;
          }

          setDailyRecords(nextDaily);
          setShowImportModal(false);
          window.__sound?.success?.();
          alert(`${imported}ä»¶ èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼`);
        }catch(e){
          console.error(e);
          alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
      };

      const handleResetAll = ()=>{
        if(!confirm("ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆåå‰ãƒ»è¨˜éŒ²ãƒ»è¨­å®šï¼‰ãŒæ¶ˆãˆã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        [
          'nawatobi_user','nawatobi_daily_records','nawatobi_levels','nawatobi_trick_names',
          'nawatobi_goals','nawatobi_achievements'
        ].forEach(k=>localStorage.removeItem(k));
        location.reload();
      };

      // ========= Goal check (æ—§ã‚³ãƒ¼ãƒ‰ã®ã€Œåˆè¨ˆé”æˆâ†’æ¬¡ç›®æ¨™ã€) =========
      useEffect(()=>{
        // åˆè¨ˆãŒç›®æ¨™ã‚’è¶…ãˆãŸã‚‰1å›ã ã‘å‡ºã™ï¼ˆachievementsã§æŠ‘æ­¢ï¼‰
        for(const s of displayTricks){
          const total = totals[s.id] || 0;
          const goal = parseInt(goals[s.id] || DEFAULT_GOALS[s.id] || 1000);
          if(goal<=0) continue;
          if(total >= goal){
            const key = `${s.id}:${goal}`;
            if(!achievements.includes(key)){
              // é”æˆæ¸ˆã¿ã«å…¥ã‚Œã‚‹ï¼ˆä½•åº¦ã‚‚å‡ºãªã„ï¼‰
              setAchievements(prev=> [...prev, key]);
              // ãƒ¢ãƒ¼ãƒ€ãƒ«
              const nextGoal = Math.ceil(goal * 1.2);
              setPendingGoal({ trickId: s.id, oldGoal: goal, newGoal: nextGoal, label: s.label });
              setShowGoalModal(true);
              window.__confetti?.start?.();
              window.__sound?.fanfare?.();
              break;
            }
          }
        }
      }, [totals, goals, achievements, displayTricks]);

      const confirmGoalUpdate = ()=>{
        if(!pendingGoal) return;
        setGoals(prev=> ({ ...prev, [pendingGoal.trickId]: pendingGoal.newGoal }));
        setShowGoalModal(false);
        setPendingGoal(null);
        window.__sound?.success?.();
      };
      const declineGoalUpdate = ()=>{
        setShowGoalModal(false);
        setPendingGoal(null);
        window.__sound?.click?.();
      };

      // ========= Table view helpers =========
      const sortedDates = useMemo(()=> Object.keys(dailyRecords).sort((a,b)=> new Date(a)-new Date(b)), [dailyRecords]);

      const openAddDay = ()=>{
        // æ—¢å­˜æ—¥ä»˜ã¯é¸ã¹ãªã„
        const dis = new Set(sortedDates);
        setCalendarDisabled(dis);
        setCalendarInitial(todayKey());
        setCalendarOnPick(()=> (k)=>{
          if(dis.has(k)){ return; }
          const next = { ...dailyRecords };
          if(!next[k]) next[k] = {};
          setDailyRecords(next);
          setShowCalendar(false);
          window.__sound?.success?.();
        });
        setShowCalendar(true);
        window.__sound?.click?.();
      };

      const updateCell = (dateKey, trickId, v)=>{
        const num = (v === '') ? '' : clamp0(parseInt(v || 0));
        const next = { ...dailyRecords };
        if(!next[dateKey]) next[dateKey] = {};
        next[dateKey] = { ...next[dateKey], [trickId]: num };
        setDailyRecords(next);
      };

      const deleteDate = (dateKey)=>{
        if(!confirm(`${dateKey} ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        const next = { ...dailyRecords };
        delete next[dateKey];
        setDailyRecords(next);
        window.__sound?.success?.();
      };

      // ========= Teacher: settings =========
      const handleLevelReqChange = (category, idx, trickId, value)=>{
        const next = { ...levelsData };
        const val = parseInt(value);
        if(isNaN(val) || val<=0){
          if(next[category][idx].reqs) delete next[category][idx].reqs[trickId];
        }else{
          if(!next[category][idx].reqs) next[category][idx].reqs = {};
          next[category][idx].reqs[trickId] = val;
        }
        setLevelsData(next);
      };
      const handleLevelNameChange = (category, idx, name)=>{
        const next = { ...levelsData };
        next[category][idx].name = name;
        setLevelsData(next);
      };
      const handleTrickNameChange = (category, trickId, name)=>{
        const next = { ...trickNames };
        next[category] = { ...(next[category]||{}), [trickId]: name };
        setTrickNames(next);
      };

      const handleGoalsChange = (trickId, v)=>{
        const val = clamp0(parseInt(v||0));
        setGoals(prev=> ({ ...prev, [trickId]: val }));
      };

      const downloadJson = ()=>{
        const data = { levelsData, trickNames, goals };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `nawatobi-settings-${todayKey()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const uploadJson = (file)=>{
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          try{
            const data = JSON.parse(reader.result);
            if(data.levelsData) setLevelsData(data.levelsData);
            if(data.trickNames) setTrickNames(data.trickNames);
            if(data.goals) setGoals(data.goals);
            alert("è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");
            window.__sound?.success?.();
          }catch(e){
            console.error(e);
            alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          }
        };
        reader.readAsText(file);
      };

      const exportStudentHtml = ()=>{
        // ä»Šé–‹ã„ã¦ã„ã‚‹HTMLã‚’ä¸¸ã”ã¨è¤‡è£½ã—ã€embedded-configã ã‘å·®ã—æ›¿ãˆã¦ teacherMode:false ã«ã™ã‚‹
        const cfg = {
          teacherMode: false,
          levelsData,
          trickNames,
          goals
        };
        const html = document.documentElement.outerHTML;
        const replaced = html.replace(
          /<script id="embedded-config" type="application\/json">[\s\S]*?<\/script>/,
          `<script id="embedded-config" type="application/json">\n${JSON.stringify(cfg, null, 2)}\n</script>`
        );
        const blob = new Blob([replaced], { type:'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `nawatobi-student-${todayKey()}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      // ========= UI =========
      const TabButton = ({ id, emoji, label }) => (
        <button
          onClick={()=>{ setActiveTab(id); window.__sound?.click?.(); }}
          className={[
            "flex-1 flex flex-col items-center justify-center gap-1 py-2 rounded-2xl transition",
            activeTab===id ? "text-orange-600" : "text-slate-400 hover:text-slate-500"
          ].join(" ")}
        >
          <div className={[
            "w-12 h-8 rounded-full flex items-center justify-center transition-all",
            activeTab===id ? "bg-orange-100 -translate-y-1" : "bg-transparent"
          ].join(" ")}>
            <span className="text-2xl">{emoji}</span>
          </div>
          <div className="text-[11px] font-black">{label}</div>
        </button>
      );

      // ========= screens =========
      const Header = (
        <header className="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-sky-100">
          <div className="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
            <div className="flex items-center gap-2">
              <div className="w-10 h-10 rounded-2xl bg-yellow-300 flex items-center justify-center shadow-sm">
                <span className="text-2xl">â°</span>
              </div>
              <div>
                <div className="text-sm font-black text-sky-700 leading-tight">ãªã‚ã¨ã³ãƒã‚¹ã‚¿ãƒ¼</div>
                <div className="text-[10px] text-slate-400 font-bold">æ¤œå®šã‚«ãƒ¼ãƒ‰ & åˆè¨ˆãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
              </div>
            </div>

            <div className="text-right">
              <div className="text-[10px] text-slate-400 font-black">ã’ã‚“ã–ã„ã®ãã‚…ã†</div>
              <div className="text-xl font-black text-pink-500 leading-none">
                {currentBestLevel ? currentBestLevel.name : "â€•"}
              </div>
            </div>
          </div>
        </header>
      );

      // Home
      const Home = (
        <div className="space-y-4 animate-fadeUp">
          <div className="bg-white rounded-3xl shadow-xl border-4 border-sky-100 overflow-hidden">
            <div className="bg-sky-50 border-b border-sky-100 p-4 text-center relative">
              <div className="text-2xl font-black text-slate-700">ãªã‚ã¨ã³æ¤œå®šã‚«ãƒ¼ãƒ‰</div>
              <div className="text-[11px] text-slate-400 font-bold mt-1">
                ã€Œãã‚ãã€â†’ã€Œãã‚…ã†ã€â†’ã€Œã”ã†ã‘ã„ã€ã§ ãã‚“ãã‚“ä¸Šé”ï¼
              </div>
              {isTeacherMode && (
                <button
                  onClick={()=>setActiveTab('settings')}
                  className="absolute right-3 top-3 text-xs font-black px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50"
                >
                  âš™ï¸ å…ˆç”Ÿè¨­å®š
                </button>
              )}
            </div>

            <div className="p-4">
              {/* profile */}
              <div className="bg-sky-50/60 border-2 border-sky-100 rounded-2xl p-3">
                <div className="flex items-center gap-2 text-sky-700 font-black text-sm mb-2">
                  âœï¸ ã“ã“ã« ãªã¾ãˆ ã‚’ ã‹ã„ã¦ã­
                </div>
                <div className="flex gap-2">
                  <select
                    value={user.grade}
                    onChange={(e)=>setUser(prev=>({ ...prev, grade: parseInt(e.target.value) }))}
                    className="w-24 p-2 rounded-xl border border-sky-200 bg-white font-black"
                  >
                    {[1,2,3,4,5,6].map(g=><option key={g} value={g}>{g}å¹´</option>)}
                  </select>
                  <input
                    value={user.classVal}
                    onChange={(e)=>setUser(prev=>({ ...prev, classVal: e.target.value }))}
                    placeholder="çµ„"
                    className="w-20 p-2 rounded-xl border border-sky-200 bg-white font-black text-center select-text"
                  />
                  <input
                    value={user.number}
                    onChange={(e)=>setUser(prev=>({ ...prev, number: e.target.value }))}
                    placeholder="ç•ª"
                    className="w-20 p-2 rounded-xl border border-sky-200 bg-white font-black text-center select-text"
                  />
                  <input
                    value={user.name}
                    onChange={(e)=>setUser(prev=>({ ...prev, name: e.target.value }))}
                    placeholder="ãªã¾ãˆ"
                    className="flex-1 p-2 rounded-xl border border-sky-200 bg-white font-black select-text"
                  />
                </div>
              </div>

              {/* quick cards */}
              <div className="grid sm:grid-cols-2 gap-3 mt-4">
                <button onClick={()=>setActiveTab('input')} className="p-4 rounded-3xl border-2 border-blue-200 bg-blue-50 hover:bg-blue-100 active:scale-[0.99] transition text-left">
                  <div className="text-2xl font-black text-blue-700 flex items-center gap-2"><span>ğŸ“</span> ãã‚ãã™ã‚‹</div>
                  <div className="text-[11px] text-blue-600 font-bold mt-1">ä»Šæ—¥ã®å›æ•°ã‚’å…¥ã‚Œã¦ã€Œã‘ã£ã¦ã„ã€ï¼</div>
                </button>

                <button onClick={()=>setActiveTab('cert')} className="p-4 rounded-3xl border-2 border-pink-200 bg-pink-50 hover:bg-pink-100 active:scale-[0.99] transition text-left">
                  <div className="text-2xl font-black text-pink-700 flex items-center gap-2"><span>ğŸ…</span> ãã‚…ã†ã‚’ã¿ã‚‹</div>
                  <div className="text-[11px] text-pink-600 font-bold mt-1">ã„ã¾ã®ç´šã¨ã€æ¬¡ã®ç›®æ¨™ï¼</div>
                </button>

                <button onClick={()=>{ setActiveTab('totals'); setTotalsSub('graph'); }} className="p-4 rounded-3xl border-2 border-orange-200 bg-orange-50 hover:bg-orange-100 active:scale-[0.99] transition text-left">
                  <div className="text-2xl font-black text-orange-700 flex items-center gap-2"><span>ğŸ†</span> ã”ã†ã‘ã„</div>
                  <div className="text-[11px] text-orange-600 font-bold mt-1">åˆè¨ˆãŒç›®æ¨™ã‚’è¶…ãˆãŸã‚‰ã”ã»ã†ã³ï¼</div>
                </button>

                <button onClick={()=>setActiveTab('history')} className="p-4 rounded-3xl border-2 border-emerald-200 bg-emerald-50 hover:bg-emerald-100 active:scale-[0.99] transition text-left">
                  <div className="text-2xl font-black text-emerald-700 flex items-center gap-2"><span>ğŸ”¥</span> ãŒã‚“ã°ã‚Š</div>
                  <div className="text-[11px] text-emerald-600 font-bold mt-1">ã‚Œã‚“ããæ—¥æ•°ã‚’ã®ã°ãã†ï¼</div>
                </button>
              </div>

              <div className="mt-4 text-center">
                <button onClick={handleResetAll} className="text-[11px] font-black text-slate-300 hover:text-red-500 underline">
                  ğŸ—‘ï¸ ãœã‚“ã¶ãƒªã‚»ãƒƒãƒˆ
                </button>
              </div>
            </div>
          </div>
        </div>
      );

      // Input
      const Input = (
        <div className="space-y-4 animate-fadeUp">
          <div className="bg-white rounded-3xl p-4 shadow border-2 border-slate-100">
            <div className="flex flex-wrap items-end justify-between gap-3">
              <div>
                <div className="text-xl font-black text-sky-700 flex items-center gap-2"><span>ğŸ“</span> ãã‚ãã‚’ã„ã‚Œã‚ˆã†</div>
                <div className="text-[11px] text-slate-400 font-bold">ã²ã£ã‹ã‹ã‚‰ãšã« ã‚Œã‚“ããã§ ã¨ã¹ãŸå›æ•°</div>
              </div>
              <div className="flex items-center gap-2">
                <div className="text-[11px] font-black text-sky-600">ãã‚ãã™ã‚‹æ—¥</div>
                <input
                  type="date"
                  value={targetDate}
                  onChange={(e)=>setTargetDate(e.target.value)}
                  className="px-3 py-2 rounded-2xl border border-slate-200 font-black text-slate-700 bg-white"
                />
              </div>
            </div>

            <div className="mt-3 text-center text-[12px] font-black text-orange-600 bg-orange-50 border border-orange-200 rounded-2xl py-2">
              æ•°å­—ã‚’ã‹ãˆãŸã‚‰ã€Œã‘ã£ã¦ã„ã€ã‚’ãŠã—ã¦ã­ï¼
            </div>

            <div className="space-y-3 mt-4">
              {displayTricks.map(tr=>{
                const current = records[tr.id] ?? '';
                const saved = dailyRecords[targetDate]?.[tr.id];
                const isSaved = (parseInt(current||0) === (parseInt(saved||0)));
                const maxV = maxRecords[tr.id] || 0;
                const bestLvl = getTrickLevel(tr.id);

                return (
                  <div key={tr.id} className={`p-3 rounded-3xl border-2 bg-white hover:border-sky-300 transition ${tr.color.replace('text','border').split(' ')[2] || 'border-slate-200'}`}>
                    <div className="flex items-center justify-between gap-3">
                      <div className="flex items-center gap-3">
                        <div className={`w-11 h-11 rounded-2xl flex items-center justify-center font-black shadow-sm border ${tr.color}`}>
                          {tr.label.slice(0,1)}
                        </div>
                        <div>
                          <div className="font-black text-slate-800 flex flex-wrap items-center gap-2">
                            <span>{tr.label}</span>
                            <span className="text-[11px] font-black text-orange-700 bg-orange-50 border border-orange-200 px-2 py-0.5 rounded-full">
                              ğŸ‘‘ æœ€é«˜ {maxV}
                            </span>
                            {bestLvl && (
                              <span className="text-[11px] font-black text-yellow-800 bg-yellow-100 border border-yellow-300 px-2 py-0.5 rounded-full">
                                {bestLvl}ç´š
                              </span>
                            )}
                          </div>
                        </div>
                      </div>

                      <div className="flex items-center gap-2">
                        <button
                          onClick={()=>updateRecord(tr.id, clamp0((parseInt(records[tr.id]||0))-1))}
                          className="w-10 h-10 rounded-full bg-slate-50 border border-slate-200 text-slate-500 font-black active:scale-95"
                        >âˆ’</button>

                        <input
                          type="number"
                          inputMode="numeric"
                          pattern="\d*"
                          value={(parseInt(current||0) > 0) ? current : ''}
                          placeholder="0"
                          onFocus={(e)=> requestAnimationFrame(()=>e.target.select())}
                          onChange={(e)=> updateRecord(tr.id, e.target.value)}
                          className={`w-16 text-center text-2xl font-black bg-transparent border-b-2 p-1 focus:outline-none focus:border-sky-500 select-text ${isSaved?'text-sky-600':'text-slate-800'}`}
                        />

                        <div className="text-[12px] font-black text-slate-400">å›</div>

                        <button
                          onClick={()=>updateRecord(tr.id, clamp0((parseInt(records[tr.id]||0))+1))}
                          className="w-10 h-10 rounded-full bg-sky-100 border border-sky-200 text-sky-700 font-black active:scale-95"
                        >ï¼‹</button>

                        <button
                          onClick={()=>handleConfirmRecord(tr.id)}
                          className={[
                            "ml-1 px-3 py-2 rounded-2xl font-black text-xs border-2 shadow-sm active:scale-95 transition",
                            isSaved ? "bg-sky-100 text-sky-700 border-sky-200" : "bg-green-500 text-white border-green-400 animate-pulse"
                          ].join(" ")}
                        >
                          {isSaved ? "âœ… ä¿å­˜æ¸ˆ" : "ğŸŸ© ã‘ã£ã¦ã„"}
                        </button>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          <button onClick={()=>setActiveTab('home')} className="w-full bg-slate-100 hover:bg-slate-200 border-2 border-slate-200 rounded-3xl py-4 font-black text-slate-700">
            ğŸ  è¡¨ç´™ã«ã‚‚ã©ã‚‹
          </button>
        </div>
      );

      // Cert (èªå®šè¨¼ + æ¬¡ã®ç›®æ¨™)
      const Cert = (
        <div className="space-y-4 animate-fadeUp">
          {/* èªå®šè¨¼ï¼ˆå­¦å¹´åˆ¥ã«é›°å›²æ°—ã‚’å¤‰ãˆã‚‹ï¼‰ */}
          {user.grade<=2 && (
            <div className="bg-white rounded-3xl p-6 shadow-lg border-4 border-pink-200 text-center relative overflow-hidden">
              <div className="absolute -bottom-10 -right-10 w-40 h-40 bg-yellow-200 rounded-full opacity-50"></div>
              <div className="absolute -bottom-10 -left-10 w-32 h-32 bg-blue-200 rounded-full opacity-50"></div>
              <div className="text-6xl">ğŸŒŸ</div>
              <div className="text-3xl font-black text-pink-600">ã«ã‚“ã¦ã„ã—ã‚‡ã†</div>
              <div className="mt-2 text-lg font-black text-slate-700">
                {user.grade}ã­ã‚“ {user.classVal}ãã¿ {user.number}ã°ã‚“<br/>
                <span className="border-b-2 border-pink-300 px-2">{user.name || "ï¼ˆãªã¾ãˆï¼‰"}</span> ã•ã‚“
              </div>
              <div className="mt-4 bg-pink-50 border border-pink-200 rounded-2xl p-4">
                <div className="text-[12px] font-black text-pink-500">ã‚ãªãŸã¯</div>
                <div className="text-5xl font-black text-pink-700 my-2">{currentBestLevel ? currentBestLevel.name : "ãŒã‚“ã°ã‚Šä¸­"}</div>
                <div className="text-[12px] font-black text-pink-500">ã« ã”ã†ã‹ãã—ã¾ã—ãŸï¼</div>
              </div>
              <div className="mt-2 text-[12px] font-black text-slate-400">ã‚ˆããŒã‚“ã°ã‚Šã¾ã—ãŸï¼</div>
            </div>
          )}

          {(user.grade===3 || user.grade===4) && (
            <div className="bg-white rounded-3xl p-6 shadow-lg border-4 border-sky-200 text-center">
              <div className="text-5xl">ğŸ…</div>
              <div className="text-3xl font-black text-sky-700">èªå®šè¨¼</div>
              <div className="mt-3 text-left bg-sky-50 border border-sky-200 rounded-2xl p-4 font-bold text-slate-700">
                <div>ç¬¬ {user.grade} å­¦å¹´ {user.classVal} çµ„ {user.number} ç•ª</div>
                <div className="mt-2 text-2xl font-black border-b border-sky-300 inline-block min-w-[220px] text-center">
                  {user.name || "ï¼ˆåå‰ï¼‰"} æ®¿
                </div>
                <div className="mt-3 text-sm leading-relaxed">
                  ã‚ãªãŸã¯ã€ãªã‚ã¨ã³æ¤œå®šã«ãŠã„ã¦<br/>
                  ã™ã°ã‚‰ã—ã„è¨˜éŒ²ã‚’ãŠã•ã‚ã¾ã—ãŸã€‚<br/>
                  ã‚ˆã£ã¦ã“ã“ã«ã“ã‚Œã‚’è¨¼ã—ã¾ã™ã€‚
                </div>
              </div>
              <div className="mt-4">
                <div className="text-[12px] font-black text-sky-600">èªå®šç´š</div>
                <div className="inline-block mt-1 px-8 py-3 rounded-2xl border-2 border-sky-500 bg-white text-4xl font-black text-sky-800">
                  {currentBestLevel ? currentBestLevel.name : "â€•"}
                </div>
              </div>
            </div>
          )}

          {user.grade>=5 && (
            <div className="bg-slate-50 rounded-3xl p-6 shadow-xl border-t-8 text-center" style={{borderColor:'#d4af37'}}>
              <div className="text-xs font-mono text-slate-400 text-right">ID: {Math.random().toString(36).slice(2,9).toUpperCase()}</div>
              <div className="text-[11px] font-black tracking-[0.18em] text-slate-500 uppercase">Certificate</div>
              <div className="text-4xl font-black text-slate-800 inline-block border-b-2 border-slate-300 px-4 pb-2">è¨˜éŒ²è¨¼</div>

              <div className="mt-5 grid grid-cols-2 gap-3 text-left">
                <div className="bg-white border border-slate-200 rounded-2xl p-3">
                  <div className="text-[11px] font-black text-slate-400">Name</div>
                  <div className="text-lg font-black text-slate-800">{user.name || "__________"}</div>
                </div>
                <div className="bg-white border border-slate-200 rounded-2xl p-3">
                  <div className="text-[11px] font-black text-slate-400">Grade</div>
                  <div className="text-lg font-black text-slate-800">{user.grade} - {user.classVal} - {user.number}</div>
                </div>
              </div>

              <div className="mt-4 bg-white border border-slate-200 rounded-2xl p-6 shadow-inner">
                <div className="text-[12px] font-black text-slate-400 italic">Achieved Level</div>
                <div className="text-5xl font-black mt-1" style={{color:'#d4af37', textShadow:'1px 1px 0 rgba(0,0,0,.08)'}}>
                  {currentBestLevel ? currentBestLevel.name : "Unranked"}
                </div>
              </div>

              <div className="mt-3 text-[11px] font-black text-slate-400 text-left">
                å¤§é˜ªãªã‚ã¨ã³ç´šåˆ¤å®šåŸºæº–æº–æ‹  / Osaka Jump Rope Assessment
              </div>
            </div>
          )}

          {/* æ¬¡ã®ç›®æ¨™ */}
          <div className="bg-white rounded-3xl p-4 shadow border-2 border-slate-100">
            <div className="font-black text-slate-700 flex items-center gap-2">
              ğŸ¯ {goalTitle}
            </div>

            <div className="mt-3 space-y-2">
              {nextLevels.length>0 ? nextLevels.map(lvl=>(
                <div key={lvl.level} className="p-3 rounded-2xl border border-slate-100 bg-white text-slate-700">
                  <div className="font-black text-slate-600">{lvl.name}</div>
                  <div className="mt-1 flex flex-wrap gap-1 text-[12px] font-bold text-slate-500">
                    {Object.entries(lvl.reqs||{}).map(([id, need])=>{
                      const tr = displayTricks.find(t=>t.id===id);
                      if(!tr || !need) return null;
                      return (
                        <span key={id} className="px-2 py-1 rounded-xl border bg-slate-50 border-slate-200">
                          {tr.label}ï¼š{need}å›
                        </span>
                      );
                    })}
                  </div>
                </div>
              )) : (
                <div className="text-center bg-yellow-50 border border-yellow-200 rounded-3xl p-6">
                  <div className="text-5xl">ğŸ†</div>
                  <div className="text-xl font-black text-yellow-700 mt-2">ãœã‚“ã¶ã‚¯ãƒªã‚¢ï¼</div>
                  <div className="text-[12px] font-black text-yellow-700">ãŠã‚ã§ã¨ã†ï¼ï¼</div>
                </div>
              )}
            </div>
          </div>

          <button onClick={()=>setActiveTab('home')} className="w-full bg-slate-100 hover:bg-slate-200 border-2 border-slate-200 rounded-3xl py-4 font-black text-slate-700">
            ğŸ  è¡¨ç´™ã«ã‚‚ã©ã‚‹
          </button>
        </div>
      );

      // Totals: graph + table + copy/import
      const Totals = (
        <div className="space-y-4 animate-fadeUp">
          <div className="bg-white rounded-3xl p-4 shadow border-2 border-slate-100">
            <div className="flex items-center justify-between gap-2 flex-wrap">
              <div>
                <div className="text-xl font-black text-orange-700 flex items-center gap-2"><span>ğŸ†</span> ã”ã†ã‘ã„ ã¨ ã‚‚ãã²ã‚‡ã†</div>
                <div className="text-[11px] text-slate-400 font-bold">åˆè¨ˆãŒç›®æ¨™ã‚’ã“ãˆã‚‹ã¨ã€Œæ¬¡ã®ç›®æ¨™ã€ã‚’ææ¡ˆï¼</div>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={()=>setTotalsSub('graph')} className={`px-4 py-2 rounded-2xl font-black text-sm border-2 ${totalsSub==='graph'?'bg-orange-100 border-orange-200 text-orange-700':'bg-white border-slate-200 text-slate-500'}`}>
                  ğŸ“Š ãƒãƒ¼
                </button>
                <button onClick={()=>setTotalsSub('table')} className={`px-4 py-2 rounded-2xl font-black text-sm border-2 ${totalsSub==='table'?'bg-orange-100 border-orange-200 text-orange-700':'bg-white border-slate-200 text-slate-500'}`}>
                  ğŸ§¾ ã²ã‚‡ã†
                </button>
              </div>
            </div>

            <div className="mt-3 flex flex-wrap gap-2">
              <button onClick={handleCopyTSV} className="px-4 py-2 rounded-2xl font-black text-sm bg-sky-500 hover:bg-sky-600 text-white shadow-sm active:scale-95">
                ğŸ“‹ è¡¨ã‚’ã‚³ãƒ”ãƒ¼
              </button>
              <button onClick={openImport} className="px-4 py-2 rounded-2xl font-black text-sm bg-green-500 hover:bg-green-600 text-white shadow-sm active:scale-95">
                ğŸ“¥ å¾©å…ƒï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰
              </button>
              <button onClick={openAddDay} className="px-4 py-2 rounded-2xl font-black text-sm bg-orange-500 hover:bg-orange-600 text-white shadow-sm active:scale-95">
                âœï¸ æ—¥ã‚’è¿½åŠ 
              </button>
              {isTeacherMode && (
                <button onClick={()=>setActiveTab('settings')} className="px-4 py-2 rounded-2xl font-black text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 border border-slate-200">
                  âš™ï¸ å…ˆç”Ÿè¨­å®š
                </button>
              )}
            </div>

            {totalsSub === 'graph' ? (
              <div className="mt-5 space-y-6">
                {displayTricks.map(skill=>{
                  const total = totals[skill.id] || 0;
                  const goal = parseInt(goals[skill.id] || DEFAULT_GOALS[skill.id] || 1000);
                  const pct = goal>0 ? Math.min(100, (total/goal)*100) : 0;
                  const maxV = maxRecords[skill.id] || 0;

                  return (
                    <div key={skill.id}>
                      <div className="flex items-end justify-between gap-2">
                        <div className={`text-sm font-black px-3 py-1 rounded-2xl border ${skill.color}`}>
                          {skill.label}
                        </div>
                        <div className="flex items-baseline gap-3">
                          <div className="text-[12px] font-black text-orange-600 bg-orange-50 border border-orange-200 px-2 py-1 rounded-xl">
                            ğŸ‘‘ æœ€é«˜ {maxV}
                          </div>
                          <div className="text-2xl font-black text-slate-800">
                            {total}<span className="text-[12px] text-slate-400 font-bold ml-1">å›</span>
                          </div>
                        </div>
                      </div>

                      <div className="mt-2 relative h-9 rounded-2xl bg-slate-200 border border-slate-200 overflow-hidden shadow-inner">
                        <div className="absolute inset-0 opacity-30"></div>
                        <div className="h-full rounded-2xl flex items-center justify-end pr-3 font-black text-white transition-all duration-700"
                             style={{ width: `${pct}%`, background: 'linear-gradient(90deg, rgba(251,146,60,.95), rgba(14,165,233,.95))' }}>
                          {pct>=100 ? "â˜…" : ""}
                        </div>
                      </div>

                      <div className="mt-1 flex items-center justify-between text-[10px] font-black text-slate-400">
                        <div>0</div>
                        <div>ç›®æ¨™ï¼š{goal}</div>
                      </div>

                      {isTeacherMode && (
                        <div className="mt-2 flex items-center gap-2 text-[11px] font-black">
                          <span className="text-slate-400">ç›®æ¨™ã‚’å¤‰æ›´ï¼š</span>
                          <input
                            type="number"
                            value={goals[skill.id] ?? goal}
                            onChange={(e)=>handleGoalsChange(skill.id, e.target.value)}
                            className="w-28 px-3 py-2 rounded-2xl border border-slate-200 bg-white select-text"
                          />
                          <span className="text-slate-400">å›</span>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            ) : (
              <div className="mt-5 bg-white border border-slate-300 rounded-2xl overflow-hidden">
                <div className="overflow-x-auto custom-scrollbar" style={{WebkitOverflowScrolling:'touch'}}>
                  <table className="border-collapse whitespace-nowrap text-sm">
                    <thead className="bg-orange-50 text-orange-800">
                      <tr>
                        <th className="sticky-corner p-3 min-w-[150px] text-left font-black border border-slate-400">ç¨®ç›® \\ æ—¥ä»˜</th>
                        {sortedDates.map(date=>{
                          const d = fromKey(date);
                          const disp = d.toLocaleDateString('ja-JP', { month:'numeric', day:'numeric', weekday:'short' });
                          const isToday = date === todayKey();
                          return (
                            <th key={date} className={`sticky-header p-2 min-w-[92px] text-center font-black border border-slate-400 ${isToday?'bg-orange-100':'bg-orange-50'}`}>
                              <div className="leading-tight">
                                <div className="text-xs">{disp}</div>
                                {isToday && <div className="text-[10px] text-red-500 font-black">ä»Šæ—¥</div>}
                              </div>
                              <button onClick={()=>deleteDate(date)} className="mt-1 text-[10px] font-black text-red-500 hover:underline">å‰Šé™¤</button>
                            </th>
                          );
                        })}
                      </tr>
                    </thead>

                    <tbody>
                      {displayTricks.map(skill=>(
                        <tr key={skill.id} className="hover:bg-slate-50">
                          <th className={`sticky-col p-2 min-w-[150px] text-left font-black border border-slate-400 ${skill.color}`}>
                            <span className="mr-2">â—</span>{skill.label}
                          </th>
                          {sortedDates.map(date=>{
                            const v = dailyRecords[date]?.[skill.id] ?? '';
                            const isToday = date === todayKey();
                            return (
                              <td key={date} className={`p-0 border border-slate-400 text-center ${isToday?'bg-orange-50/40':''}`}>
                                <input
                                  type="number"
                                  inputMode="numeric"
                                  value={(parseInt(v||0)>0)?v:''}
                                  placeholder=""
                                  onFocus={(e)=>e.target.select()}
                                  onChange={(e)=>updateCell(date, skill.id, e.target.value)}
                                  className="w-full h-full min-h-[44px] px-1 font-black text-slate-700 bg-transparent outline-none select-text"
                                />
                              </td>
                            );
                          })}
                        </tr>
                      ))}
                    </tbody>

                    <tfoot>
                      <tr className="bg-slate-50">
                        <th className="sticky-col p-2 min-w-[150px] text-left font-black border border-slate-400 text-slate-600">
                          åˆè¨ˆï¼ˆãã®æ—¥ï¼‰
                        </th>
                        {sortedDates.map(date=>{
                          const sum = displayTricks.reduce((acc,s)=> acc + (parseInt(dailyRecords[date]?.[s.id])||0), 0);
                          return (
                            <td key={date} className="p-2 text-center font-black border border-slate-400 text-slate-700">
                              {sum}
                            </td>
                          );
                        })}
                      </tr>
                    </tfoot>
                  </table>
                </div>
                <div className="p-3 text-center text-[11px] font-bold text-slate-400">
                  å³ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã¨æœ€æ–°ã®æ—¥ä»˜ãŒã‚ã‚Šã¾ã™ã€‚
                </div>
              </div>
            )}
          </div>

          <button onClick={()=>setActiveTab('home')} className="w-full bg-slate-100 hover:bg-slate-200 border-2 border-slate-200 rounded-3xl py-4 font-black text-slate-700">
            ğŸ  è¡¨ç´™ã«ã‚‚ã©ã‚‹
          </button>
        </div>
      );

      // History
      const History = (
        <div className="space-y-4 animate-fadeUp">
          <div className="bg-white rounded-3xl p-6 shadow border-2 border-slate-100 text-center">
            <div className="text-5xl">ğŸ”¥</div>
            <div className="text-2xl font-black text-emerald-700">ã‚Œã‚“ããè¨˜éŒ²</div>

            <div className="mt-4 bg-orange-100 border-2 border-orange-200 rounded-3xl p-4">
              <div className="text-xl font-black text-orange-700">ã‚Œã‚“ãã {streak.count} æ—¥</div>
              <div className="text-[12px] font-black text-orange-600 mt-1">{streak.msg}</div>
            </div>

            <div className="mt-5 grid grid-cols-7 gap-2 max-w-sm mx-auto">
              {[...Array(21)].map((_, i)=>{
                const d = new Date();
                d.setDate(d.getDate() - (20 - i));
                const k = toKey(d);
                const has = !!history[k];
                const isToday = k === todayKey();
                return (
                  <div key={k} className="flex flex-col items-center gap-1">
                    <div className="text-[10px] font-bold text-slate-400">{d.getMonth()+1}/{d.getDate()}</div>
                    <div className={[
                      "w-10 h-10 rounded-full border-2 flex items-center justify-center transition",
                      has ? "bg-emerald-100 border-emerald-500 text-emerald-700 scale-110" : "bg-slate-50 border-slate-200 text-slate-300",
                      isToday ? "ring-2 ring-sky-300 ring-offset-2" : ""
                    ].join(" ")}>
                      {has ? "ğŸ…" : "ãƒ»"}
                    </div>
                  </div>
                );
              })}
            </div>

            <div className="mt-5 text-left bg-emerald-50 border border-emerald-200 rounded-3xl p-4">
              <div className="font-black text-emerald-800">{user.name || "åç„¡ã—"} ã•ã‚“</div>
              <div className="text-[11px] font-bold text-emerald-700">{user.grade}å¹´ {user.classVal}çµ„ {user.number}ç•ª</div>
            </div>
          </div>

          <button onClick={()=>setActiveTab('home')} className="w-full bg-slate-100 hover:bg-slate-200 border-2 border-slate-200 rounded-3xl py-4 font-black text-slate-700">
            ğŸ  è¡¨ç´™ã«ã‚‚ã©ã‚‹
          </button>
        </div>
      );

      // Settings (teacher only)
      const Settings = (
        <div className="space-y-4 animate-fadeUp">
          <div className="bg-white rounded-3xl p-4 shadow border-2 border-slate-100">
            <div className="flex flex-wrap items-center justify-between gap-2">
              <div>
                <div className="text-xl font-black text-slate-800">âš™ï¸ å…ˆç”Ÿç”¨ è¨­å®š</div>
                <div className="text-[11px] font-bold text-slate-400">æ¤œå®šè¡¨ï¼ˆå›æ•°ï¼‰ã¨æŠ€åã€åˆè¨ˆç›®æ¨™ã‚’ç·¨é›†ã§ãã¾ã™ã€‚</div>
              </div>
              <div className="flex flex-wrap gap-2">
                <label className="px-4 py-2 rounded-2xl font-black text-sm bg-green-500 hover:bg-green-600 text-white cursor-pointer">
                  ğŸ“¥ è¨­å®šèª­è¾¼(JSON)
                  <input type="file" accept=".json" className="hidden" onChange={(e)=>{ uploadJson(e.target.files?.[0]); e.target.value=''; }} />
                </label>
                <button onClick={downloadJson} className="px-4 py-2 rounded-2xl font-black text-sm bg-sky-500 hover:bg-sky-600 text-white">ğŸ“¦ è¨­å®šä¿å­˜(JSON)</button>
                <button onClick={exportStudentHtml} className="px-4 py-2 rounded-2xl font-black text-sm bg-orange-500 hover:bg-orange-600 text-white">ğŸ“„ å…ç«¥é…ä»˜HTMLæ›¸ãå‡ºã—</button>
              </div>
            </div>

            <div className="mt-4 flex gap-2 overflow-x-auto custom-scrollbar pb-2">
              {[
                {id:'low', label:'1ãƒ»2å¹´'},
                {id:'mid', label:'3ãƒ»4å¹´'},
                {id:'high',label:'5ãƒ»6å¹´'}
              ].map(t=>(
                <button key={t.id}
                  onClick={()=>setSettingTab(t.id)}
                  className={`px-5 py-2 rounded-full font-black whitespace-nowrap border-2 ${settingTab===t.id?'bg-slate-800 text-white border-slate-800':'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}
                >
                  {t.label}
                </button>
              ))}
            </div>

            <div className="mt-3 text-[11px] font-bold text-slate-500 bg-slate-50 border border-slate-200 rounded-2xl p-3">
              ãƒ»ç´šã®åå‰ã‚’ç©ºæ¬„ã«ã™ã‚‹ã¨ã€ãã®ç´šã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ï¼ˆç„¡åŠ¹åŒ–ï¼‰<br/>
              ãƒ»æŠ€åã‚‚å¤‰æ›´ã§ãã¾ã™ï¼ˆè¦‹å‡ºã—ã®å…¥åŠ›æ¬„ï¼‰
            </div>
          </div>

          <div className="bg-white rounded-3xl shadow border border-slate-200 overflow-hidden">
            <div className="overflow-x-auto custom-scrollbar">
              <table className="w-full text-sm border-collapse">
                <thead className="bg-slate-100 text-slate-700 font-black sticky-header">
                  <tr>
                    <th className="p-3 min-w-[90px] text-center sticky-col border-b border-slate-200">ç´š</th>
                    {TRICK_IDS.map(id=>(
                      <th key={id} className="p-2 min-w-[120px] border-b border-r border-slate-200 align-bottom">
                        <input
                          value={trickNames[settingTab]?.[id] ?? DEFAULT_TRICK_NAMES[settingTab]?.[id] ?? id}
                          onChange={(e)=>handleTrickNameChange(settingTab, id, e.target.value)}
                          className="w-full bg-transparent border-b border-dashed border-slate-300 focus:border-sky-500 focus:outline-none text-center font-black text-xs py-1 select-text"
                        />
                      </th>
                    ))}
                  </tr>
                </thead>

                <tbody>
                  {(levelsData[settingTab]||[]).map((lvl, idx)=>(
                    <tr key={lvl.level} className="hover:bg-slate-50 border-b border-slate-100">
                      <td className="p-2 text-center sticky-col bg-white">
                        <input
                          value={(lvl.name!==undefined)?lvl.name:`${lvl.level}ç´š`}
                          onChange={(e)=>handleLevelNameChange(settingTab, idx, e.target.value)}
                          placeholder={`${lvl.level}ç´š`}
                          className={`w-full text-center font-black bg-transparent border-b border-transparent focus:border-sky-500 focus:outline-none select-text ${lvl.name===''?'bg-red-50 text-red-300':''}`}
                        />
                      </td>

                      {TRICK_IDS.map(id=>{
                        const val = (lvl.reqs && lvl.reqs[id]) ? lvl.reqs[id] : '';
                        return (
                          <td key={id} className="p-1 text-center border-r border-slate-100">
                            <input
                              type="number"
                              value={val}
                              onChange={(e)=>handleLevelReqChange(settingTab, idx, id, e.target.value)}
                              className={`w-full text-center p-1 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-300 focus:outline-none select-text ${val ? 'font-black text-sky-700 bg-sky-50' : 'text-slate-300'}`}
                              placeholder="-"
                            />
                          </td>
                        );
                      })}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <div className="p-4 text-center">
              <button onClick={()=>{ setLevelsData(DEFAULT_LEVELS_DATA); setTrickNames(DEFAULT_TRICK_NAMES); setGoals(DEFAULT_GOALS); alert("åˆæœŸå€¤ã«æˆ»ã—ã¾ã—ãŸ"); }} className="text-[11px] font-black text-red-500 hover:underline">
                â†©ï¸ åˆæœŸè¨­å®šã«æˆ»ã™ï¼ˆå¤§é˜ªåºœãƒ¢ãƒ‡ãƒ«ï¼‰
              </button>
            </div>
          </div>

          <button onClick={()=>setActiveTab('home')} className="w-full bg-slate-100 hover:bg-slate-200 border-2 border-slate-200 rounded-3xl py-4 font-black text-slate-700">
            ğŸ  è¡¨ç´™ã«ã‚‚ã©ã‚‹
          </button>
        </div>
      );

      // ========= modals =========
      const LevelUpModal = showLevelUp && (
        <div className="fixed inset-0 z-[9995] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4" onMouseDown={()=>setShowLevelUp(false)}>
          <div className="bg-white w-full max-w-sm rounded-3xl p-6 border-4 border-yellow-300 shadow-2xl text-center animate-popIn relative overflow-hidden" onMouseDown={(e)=>e.stopPropagation()}>
            <div className="absolute inset-0 opacity-20" style={{backgroundImage:'radial-gradient(#FCD34D 20%, transparent 20%), radial-gradient(#60A5FA 20%, transparent 20%)', backgroundPosition:'0 0, 50px 50px', backgroundSize:'100px 100px'}}></div>
            <div className="relative">
              <div className="text-6xl">ğŸ†</div>
              <div className="text-3xl font-black text-pink-600 mt-2">{levelUpMsg.title}</div>
              <div className="text-lg font-black text-slate-700 mt-2">{levelUpMsg.sub}</div>
              <button className="mt-5 w-full bg-pink-500 hover:bg-pink-600 text-white font-black py-3 rounded-2xl shadow active:scale-95"
                      onClick={()=>setShowLevelUp(false)}>
                ã‚„ã£ãŸã­ï¼
              </button>
            </div>
          </div>
        </div>
      );

      const GoalModal = showGoalModal && pendingGoal && (
        <div className="fixed inset-0 z-[9994] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" onMouseDown={declineGoalUpdate}>
          <div className="bg-white w-full max-w-sm rounded-3xl p-6 border-4 border-yellow-300 shadow-2xl text-center animate-popIn relative overflow-hidden" onMouseDown={(e)=>e.stopPropagation()}>
            <div className="absolute inset-0 bg-yellow-50"></div>
            <div className="relative">
              <div className="text-6xl">ğŸŠ</div>
              <div className="text-2xl font-black text-orange-600">ç›®æ¨™é”æˆï¼</div>
              <div className="mt-2 text-sm font-black text-slate-700">ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</div>

              <div className="mt-4 bg-white rounded-2xl border border-orange-200 p-4 shadow-sm">
                <div className="text-[12px] font-black text-slate-500">æ¬¡ã®ç›®æ¨™</div>
                <div className="text-lg font-black text-sky-700 mt-1">{pendingGoal.label}</div>
                <div className="mt-2 flex items-center justify-center gap-2 font-black text-orange-700">
                  <span className="line-through text-slate-400">{pendingGoal.oldGoal}</span>
                  <span>â†’</span>
                  <span className="text-3xl">{pendingGoal.newGoal}</span>
                  <span className="text-sm">å›</span>
                </div>
                <div className="text-[11px] font-black text-orange-400 mt-1">ï¼ˆ20% UP!ï¼‰</div>
              </div>

              <div className="mt-4 text-sm font-black text-slate-600">å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ</div>

              <div className="mt-4 flex gap-3">
                <button onClick={declineGoalUpdate} className="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-black py-3 rounded-2xl">ã„ã„ãˆ</button>
                <button onClick={confirmGoalUpdate} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-black py-3 rounded-2xl shadow active:scale-95">ã¯ã„</button>
              </div>
            </div>
          </div>
        </div>
      );

      const ImportModal = showImportModal && (
        <div className="fixed inset-0 z-[9993] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4" onMouseDown={()=>setShowImportModal(false)}>
          <div className="bg-white w-full max-w-lg rounded-3xl p-6 border-4 border-green-300 shadow-2xl animate-popIn" onMouseDown={(e)=>e.stopPropagation()}>
            <div className="text-center">
              <div className="text-5xl">ğŸ“¥</div>
              <div className="text-xl font-black text-green-700 mt-2">è¨˜éŒ²ã‚’å¾©å…ƒï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰</div>
              <div className="text-[11px] font-bold text-slate-400 mt-1">
                è¡¨ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸTSVã‚’ã“ã“ã«è²¼ã£ã¦ãã ã•ã„ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œå¿…é ˆï¼‰
              </div>
            </div>
            <textarea
              value={importText}
              onChange={(e)=>setImportText(e.target.value)}
              className="mt-4 w-full h-44 rounded-2xl border-2 border-slate-200 bg-slate-50 p-3 text-xs font-mono select-text outline-none focus:ring-2 focus:ring-green-300"
              placeholder="æ—¥ä»˜\tç¨®ç›®1\tç¨®ç›®2...\n2026-01-14\t10\t0..."
            />
            <div className="mt-4 flex gap-3">
              <button onClick={()=>setShowImportModal(false)} className="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-black py-3 rounded-2xl">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              <button onClick={executeImport} className="flex-1 bg-green-500 hover:bg-green-600 text-white font-black py-3 rounded-2xl shadow active:scale-95">èª­ã¿è¾¼ã‚€</button>
            </div>
          </div>
        </div>
      );

      const Main = (
        <main className="max-w-3xl mx-auto px-4 py-6 pb-28">
          {activeTab==='home' && Home}
          {activeTab==='input' && Input}
          {activeTab==='cert' && Cert}
          {activeTab==='totals' && Totals}
          {activeTab==='history' && History}
          {activeTab==='settings' && (isTeacherMode ? Settings : Home)}
        </main>
      );

      const BottomNav = (
        <nav className="fixed bottom-0 left-0 right-0 z-50 bg-white/95 backdrop-blur border-t border-slate-200 shadow-[0_-6px_10px_-8px_rgba(0,0,0,0.20)]"
             style={{ paddingBottom: "calc(8px + var(--safe-bottom))" }}>
          <div className="max-w-3xl mx-auto px-2">
            <div className="flex items-center gap-2 h-20">
              <TabButton id="home" emoji="ğŸ " label="è¡¨ç´™" />
              <div className="w-px h-10 bg-slate-100"></div>
              <TabButton id="input" emoji="ğŸ“" label="è¨˜éŒ²" />
              <div className="w-px h-10 bg-slate-100"></div>
              <TabButton id="cert" emoji="ğŸ…" label="ç´š" />
              <div className="w-px h-10 bg-slate-100"></div>
              <TabButton id="totals" emoji="ğŸ†" label="åˆè¨ˆ" />
              <div className="w-px h-10 bg-slate-100"></div>
              <TabButton id="history" emoji="ğŸ”¥" label="ãŒã‚“ã°ã‚Š" />
            </div>
          </div>
        </nav>
      );

      return (
        <div className="min-h-screen">
          {Header}

          {/* Calendar Modal (shared) */}
          <CalendarModal
            open={showCalendar}
            onClose={()=>setShowCalendar(false)}
            onPick={(k)=>calendarOnPick(k)}
            disabledKeys={calendarDisabled}
            initialKey={calendarInitial}
          />

          {LevelUpModal}
          {GoalModal}
          {ImportModal}

          {Main}

          <footer className="fixed left-0 right-0 bottom-[96px] z-40 text-center text-[10px] font-bold text-slate-400 pointer-events-none">
            Â©2026 Takayuki WAYAMA ãªã‚ã¨ã³æ¤œå®šã‚«ãƒ¼ãƒ‰
          </footer>

          {BottomNav}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>

