<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ãªã‚ã¨ã³æ¤œå®šã‚¢ãƒ—ãƒªï¼ˆã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯¾å¿œç‰ˆï¼‰</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fontsï¼ˆæ—§ã‚³ãƒ¼ãƒ‰ã®é›°å›²æ°—ã‚’çµ±åˆï¼‰ -->
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">

  <!-- Babel for JSX transformation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Import Map for module resolution -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
  </script>

  <style>
    body{
      font-family: 'M PLUS Rounded 1c', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
      padding-bottom: 96px;
      touch-action: manipulation;
    }

    /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã®ã‚¹ãƒ†ã‚£ãƒƒã‚­ãƒ¼åˆ—è¨­å®š */
    .sticky-col {
      position: sticky;
      left: 0;
      background-color: white;
      z-index: 10;
      border-right: 2px solid #e2e8f0;
    }
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: #f8fafc;
    }
    .sticky-corner {
      position: sticky;
      left: 0;
      top: 0;
      z-index: 30;
      background: #f8fafc;
      border-right: 2px solid #e2e8f0;
    }

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
    .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    .animate-popIn { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

    /* èŠ±å¹é›ªã®ã‚ˆã†ãªèƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç°¡æ˜“ç‰ˆï¼‰ */
    @keyframes confetti { 0% { background-position: 0 0; } 100% { background-position: 100px 100px; } }
    .bg-confetti {
      background-image: radial-gradient(#FCD34D 20%, transparent 20%), radial-gradient(#F87171 20%, transparent 20%);
      background-color: #ffffff;
      background-position: 0 0, 50px 50px;
      background-size: 100px 100px;
      animation: confetti 4s linear infinite;
    }

    /* input type="number" ã®ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™ */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }

    /* Canvas (ç´™å¹é›ª) */
    #confetti-canvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9998;
    }
  </style>
</head>

<body class="bg-sky-50 text-slate-800 select-none">
  <canvas id="confetti-canvas"></canvas>
  <div id="root"></div>

  <script type="text/babel" data-type="module" id="app-script">
    import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import {
      Trophy, Medal, Star, Calendar, Activity, RefreshCw, ChevronUp, ChevronDown, CheckCircle,
      User, Award, School, Home, ArrowLeft, RotateCcw, Pencil, Settings, Save, AlertCircle,
      Download, FileDown, Target, X, Copy, Flame, CalendarDays, Upload, Check, Trash2,
      Volume2, ClipboardList, BarChart3, Sparkles
    } from 'lucide-react';

    // --- å®šæ•°å®šç¾© ---

    // å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°ï¼ˆæ›¸ãå‡ºã—æ™‚ã«falseã«æ›¸ãæ›ãˆã‚‰ã‚Œã‚‹ï¼‰
    const IS_TEACHER_MODE = true;

    // ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
    const DATA_VERSION = "2024-v8-custom-level-names";

    // æŠ€IDå®šç¾© (å†…éƒ¨IDã¯å›ºå®š)
    const TRICK_IDS = [
      'mae', 'ushiro', 'kataashi', 'kakeashi', 'kakeashi_ushiro',
      'nibyoushi', 'aya', 'aya_ushiro', 'kousa', 'kousa_ushiro',
      'niju', 'aya_niju', 'sokushin', 'kousa_niju', 'niju_ushiro',
      'zengo_kousa', 'sanju'
    ];

    // æŠ€ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºåå®šç¾©
    const DEFAULT_TRICK_NAMES = {
      low: { // 1ãƒ»2å¹´
        mae: 'ã‚Šã‚‡ã†ã‚ã—ã¨ã³', ushiro: 'ã‚Šã‚‡ã†ã‚ã—ã¨ã³ï¼ˆã†ã—ã‚ï¼‰', kataashi: 'ã‹ãŸã‚ã—ã¨ã³', kakeashi: 'ã‹ã‘ã‚ã—ã¨ã³', kakeashi_ushiro: 'ã‹ã‘ã‚ã—ã¨ã³ï¼ˆã†ã—ã‚ï¼‰',
        nibyoushi: 'ï¼’ã³ã‚‡ã†ã—ã¨ã³', aya: 'ã‚ã‚„ã¨ã³', aya_ushiro: 'ã‚ã‚„ã¨ã³ï¼ˆã†ã—ã‚ï¼‰', kousa: 'ã“ã†ã•ã¨ã³', kousa_ushiro: 'ã“ã†ã•ã¨ã³ï¼ˆã†ã—ã‚ï¼‰',
        niju: 'ï¼’ã˜ã‚…ã†ã¨ã³', aya_niju: 'ã‚ã‚„ï¼’ã˜ã‚…ã†ã¨ã³', sokushin: 'ããã—ã‚“ã¨ã³', kousa_niju: 'ã“ã†ã•ï¼’ã˜ã‚…ã†ã¨ã³', niju_ushiro: 'ï¼’ã˜ã‚…ã†ã¨ã³ï¼ˆã†ã—ã‚ï¼‰',
        zengo_kousa: 'ãœã‚“ã”ã“ã†ã•ã¨ã³', sanju: 'ï¼“ã˜ã‚…ã†ã¨ã³'
      },
      mid: { // 3ãƒ»4å¹´
        mae: 'ã‚Šã‚‡ã†è¶³ã¨ã³', ushiro: 'ã‚Šã‚‡ã†è¶³ã¨ã³ï¼ˆå¾Œã‚ï¼‰', kataashi: 'ã‹ãŸè¶³ã¨ã³', kakeashi: 'ã‹ã‘è¶³ã¨ã³', kakeashi_ushiro: 'ã‹ã‘è¶³ã¨ã³ï¼ˆå¾Œã‚ï¼‰',
        nibyoushi: 'ï¼’ã³ã‚‡ã†ã—ã¨ã³', aya: 'ã‚ã‚„ã¨ã³', aya_ushiro: 'ã‚ã‚„ã¨ã³ï¼ˆå¾Œã‚ï¼‰', kousa: 'äº¤ã•ã¨ã³', kousa_ushiro: 'äº¤ã•ã¨ã³ï¼ˆå¾Œã‚ï¼‰',
        niju: 'ï¼’ã˜ã‚…ã†ã¨ã³', aya_niju: 'ã‚ã‚„ï¼’ã˜ã‚…ã†ã¨ã³', sokushin: 'å´æŒ¯ã¨ã³', kousa_niju: 'äº¤ã•ï¼’ã˜ã‚…ã†ã¨ã³', niju_ushiro: 'ï¼’ã˜ã‚…ã†ã¨ã³ï¼ˆå¾Œã‚ï¼‰',
        zengo_kousa: 'å‰å¾Œäº¤ã•ã¨ã³', sanju: 'ï¼“ã˜ã‚…ã†ã¨ã³'
      },
      high: { // 5ãƒ»6å¹´
        mae: 'ä¸¡è¶³ã¨ã³', ushiro: 'ä¸¡è¶³ã¨ã³ï¼ˆå¾Œã‚ï¼‰', kataashi: 'ç‰‡è¶³ã¨ã³', kakeashi: 'ã‹ã‘è¶³ã¨ã³', kakeashi_ushiro: 'ã‹ã‘è¶³ã¨ã³ï¼ˆå¾Œã‚ï¼‰',
        nibyoushi: 'ï¼’ã³ã‚‡ã†ã—ã¨ã³', aya: 'ã‚ã‚„ã¨ã³', aya_ushiro: 'ã‚ã‚„ã¨ã³ï¼ˆå¾Œã‚ï¼‰', kousa: 'äº¤å·®ã¨ã³', kousa_ushiro: 'äº¤å·®ã¨ã³ï¼ˆå¾Œã‚ï¼‰',
        niju: 'ï¼’é‡ã¨ã³', aya_niju: 'ã‚ã‚„ï¼’é‡ã¨ã³', sokushin: 'å´ã—ã‚“ã¨ã³', kousa_niju: 'äº¤å·®ï¼’é‡ã¨ã³', niju_ushiro: 'ï¼’é‡ã¨ã³ã†ã—ã‚',
        zengo_kousa: 'å‰å¾Œäº¤å·®ã¨ã³', sanju: 'ï¼“é‡ã¨ã³'
      }
    };

    // æŠ€ã®è‰²è¨­å®š (å›ºå®š)
    const TRICK_COLORS = {
      mae: 'bg-blue-100 text-blue-600 border-blue-200',
      ushiro: 'bg-indigo-100 text-indigo-600 border-indigo-200',
      kataashi: 'bg-teal-100 text-teal-600 border-teal-200',
      kakeashi: 'bg-green-100 text-green-600 border-green-200',
      kakeashi_ushiro: 'bg-emerald-100 text-emerald-600 border-emerald-200',
      nibyoushi: 'bg-cyan-100 text-cyan-600 border-cyan-200',
      aya: 'bg-yellow-100 text-yellow-700 border-yellow-200',
      aya_ushiro: 'bg-amber-100 text-amber-700 border-amber-200',
      kousa: 'bg-orange-100 text-orange-600 border-orange-200',
      kousa_ushiro: 'bg-red-100 text-red-600 border-red-200',
      niju: 'bg-pink-100 text-pink-600 border-pink-200',
      aya_niju: 'bg-purple-100 text-purple-600 border-purple-200',
      sokushin: 'bg-lime-100 text-lime-600 border-lime-200',
      kousa_niju: 'bg-rose-100 text-rose-600 border-rose-200',
      niju_ushiro: 'bg-fuchsia-100 text-fuchsia-600 border-fuchsia-200',
      zengo_kousa: 'bg-violet-100 text-violet-600 border-violet-200',
      sanju: 'bg-slate-100 text-slate-600 border-slate-200',
    };

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç´šåˆ¤å®šãƒ‡ãƒ¼ã‚¿
    const DEFAULT_LEVELS_DATA = {
      low: [
        { level: 20, reqs: { mae: 1, kataashi: 1 } },
        { level: 19, reqs: { mae: 5, kataashi: 4 } },
        { level: 18, reqs: { mae: 10, ushiro: 1, kataashi: 8, kakeashi: 2 } },
        { level: 17, reqs: { mae: 15, ushiro: 3, kataashi: 12, kakeashi: 8 } },
        { level: 16, reqs: { mae: 20, ushiro: 5, kataashi: 16, kakeashi: 16 } },
        { level: 15, reqs: { mae: 25, ushiro: 7, kataashi: 20, kakeashi: 24 } },
        { level: 14, reqs: { mae: 30, ushiro: 10, kakeashi: 30, kakeashi_ushiro: 2, nibyoushi: 4 } },
        { level: 13, reqs: { mae: 35, ushiro: 12, kakeashi: 35, kakeashi_ushiro: 4, nibyoushi: 8 } },
        { level: 12, reqs: { mae: 40, ushiro: 15, kakeashi: 40, kakeashi_ushiro: 8, nibyoushi: 12 } },
        { level: 11, reqs: { mae: 45, ushiro: 20, kakeashi: 45, kakeashi_ushiro: 12, nibyoushi: 16 } },
        { level: 10, reqs: { mae: 50, ushiro: 25, kakeashi: 50, kakeashi_ushiro: 16, nibyoushi: 20 } },
        { level: 9, reqs: { mae: 55, ushiro: 30, kakeashi: 55, kakeashi_ushiro: 20, nibyoushi: 24 } },
        { level: 8, reqs: { mae: 60, ushiro: 35, kakeashi: 60, kakeashi_ushiro: 24, nibyoushi: 28 } },
        { level: 7, reqs: { mae: 65, ushiro: 40, kakeashi: 65, kousa: 1, niju: 1, aya: 2 } },
        { level: 6, reqs: { mae: 70, ushiro: 45, kakeashi: 70, kousa: 2, niju: 2, aya: 4 } },
        { level: 5, reqs: { mae: 75, ushiro: 50, kakeashi: 75, kousa: 3, niju: 3, aya: 6 } },
        { level: 4, reqs: { mae: 80, ushiro: 55, kakeashi: 80, kousa: 4, niju: 4, aya: 8 } },
        { level: 3, reqs: { mae: 85, ushiro: 60, kakeashi: 85, kousa: 6, niju: 5, aya: 12 } },
        { level: 2, reqs: { mae: 90, ushiro: 65, kakeashi: 90, kousa: 8, niju: 6, aya: 16 } },
        { level: 1, reqs: { mae: 100, ushiro: 70, kakeashi: 100, kousa: 10, niju: 7, aya: 24 } },
      ],
      mid: [
        { level: 20, reqs: { mae: 2, nibyoushi: 4 } },
        { level: 19, reqs: { mae: 7, nibyoushi: 8 } },
        { level: 18, reqs: { mae: 10, ushiro: 1, nibyoushi: 12, kakeashi: 4 } },
        { level: 17, reqs: { mae: 15, ushiro: 3, nibyoushi: 16, kakeashi: 10 } },
        { level: 16, reqs: { mae: 20, ushiro: 5, nibyoushi: 20, kakeashi: 20 } },
        { level: 15, reqs: { mae: 30, ushiro: 10, nibyoushi: 40, kakeashi: 30 } },
        { level: 14, reqs: { mae: 40, ushiro: 20, kakeashi: 40, kakeashi_ushiro: 2, aya: 2 } },
        { level: 13, reqs: { mae: 50, ushiro: 30, kakeashi: 50, kakeashi_ushiro: 8, aya: 4 } },
        { level: 12, reqs: { mae: 60, ushiro: 40, kakeashi: 60, kakeashi_ushiro: 12, aya: 6 } },
        { level: 11, reqs: { mae: 70, ushiro: 50, kakeashi: 70, kakeashi_ushiro: 16, aya: 8 } },
        { level: 10, reqs: { mae: 80, ushiro: 60, kakeashi: 80, kakeashi_ushiro: 20, aya: 10 } },
        { level: 9, reqs: { mae: 90, ushiro: 80, kakeashi: 90, kakeashi_ushiro: 24, aya: 12 } },
        { level: 8, reqs: { mae: 100, ushiro: 100, kakeashi: 100, kakeashi_ushiro: 28, aya: 14 } },
        { level: 7, reqs: { mae: 110, ushiro: 110, kousa: 1, kousa_ushiro: 1, niju: 1, aya_ushiro: 2, aya_niju: 1 } },
        { level: 6, reqs: { mae: 120, ushiro: 120, kousa: 5, kousa_ushiro: 3, niju: 2, aya_ushiro: 4, aya_niju: 2 } },
        { level: 5, reqs: { mae: 130, ushiro: 130, kousa: 10, kousa_ushiro: 5, niju: 5, aya_ushiro: 6, aya_niju: 3 } },
        { level: 4, reqs: { mae: 140, ushiro: 140, kousa: 15, kousa_ushiro: 8, niju: 8, aya_ushiro: 8, aya_niju: 4 } },
        { level: 3, reqs: { mae: 160, ushiro: 160, kousa: 20, kousa_ushiro: 10, niju: 10, aya_ushiro: 10, aya_niju: 6 } },
        { level: 2, reqs: { mae: 180, ushiro: 180, kousa: 25, kousa_ushiro: 15, niju: 12, aya_ushiro: 12, aya_niju: 8 } },
        { level: 1, reqs: { mae: 200, ushiro: 200, kousa_ushiro: 30, niju: 20, aya_niju: 20, kousa_niju: 3, niju_ushiro: 7, sanju: 3 } },
      ],
      high: [
        { level: 20, reqs: { mae: 3, nibyoushi: 4, kakeashi: 3 } },
        { level: 19, reqs: { mae: 8, nibyoushi: 8, kakeashi: 8 } },
        { level: 18, reqs: { mae: 15, ushiro: 3, nibyoushi: 12, kakeashi: 15, aya: 2 } },
        { level: 17, reqs: { mae: 20, ushiro: 8, nibyoushi: 20, kakeashi: 20, aya: 4 } },
        { level: 16, reqs: { mae: 30, ushiro: 15, nibyoushi: 40, kakeashi: 30, aya: 8 } },
        { level: 15, reqs: { mae: 40, ushiro: 20, nibyoushi: 60, kakeashi: 40, aya: 14 } },
        { level: 14, reqs: { mae: 50, ushiro: 30, kakeashi: 50, kakeashi_ushiro: 10, aya: 20, kousa: 1, niju: 2, aya_ushiro: 2 } },
        { level: 13, reqs: { mae: 60, ushiro: 40, kakeashi: 60, kakeashi_ushiro: 20, aya: 25, kousa: 5, niju: 4, aya_ushiro: 4 } },
        { level: 12, reqs: { mae: 70, ushiro: 50, kakeashi: 70, kakeashi_ushiro: 30, aya: 30, kousa: 10, niju: 8, aya_ushiro: 8 } },
        { level: 11, reqs: { mae: 80, ushiro: 60, kakeashi: 80, kakeashi_ushiro: 40, aya: 35, kousa: 15, niju: 12, aya_ushiro: 12 } },
        { level: 10, reqs: { mae: 90, ushiro: 70, kakeashi: 90, kakeashi_ushiro: 60, aya: 40, kousa: 20, kousa_ushiro: 1, niju: 16, aya_ushiro: 16 } },
        { level: 9, reqs: { mae: 100, ushiro: 80, kakeashi: 100, kakeashi_ushiro: 80, aya: 45, kousa: 25, kousa_ushiro: 3, niju: 20, aya_ushiro: 20 } },
        { level: 8, reqs: { mae: 120, ushiro: 100, kakeashi: 120, kakeashi_ushiro: 100, aya: 50, kousa: 30, kousa_ushiro: 5, niju: 24, aya_ushiro: 24 } },
        { level: 7, reqs: { mae: 140, ushiro: 110, kousa_ushiro: 3, niju: 8, aya_niju: 1, sokushin: 4, niju_ushiro: 1, zengo_kousa: 1 } },
        { level: 6, reqs: { mae: 150, ushiro: 120, kousa_ushiro: 5, niju: 10, aya_niju: 3, sokushin: 8, niju_ushiro: 2, zengo_kousa: 5 } },
        { level: 5, reqs: { mae: 160, ushiro: 130, kousa_ushiro: 8, niju: 12, aya_niju: 5, sokushin: 12, niju_ushiro: 3, zengo_kousa: 10 } },
        { level: 4, reqs: { mae: 170, ushiro: 140, kousa_ushiro: 10, niju: 14, aya_niju: 8, sokushin: 24, niju_ushiro: 4, zengo_kousa: 20 } },
        { level: 3, reqs: { mae: 180, ushiro: 160, kousa_ushiro: 15, niju: 16, aya_niju: 10, kousa_niju: 1, niju_ushiro: 5, sanju: 1 } },
        { level: 2, reqs: { mae: 190, ushiro: 180, kousa_ushiro: 20, niju: 18, aya_niju: 15, kousa_niju: 2, niju_ushiro: 6, sanju: 2 } },
        { level: 1, reqs: { mae: 200, ushiro: 200, kousa_ushiro: 30, niju: 20, aya_niju: 20, kousa_niju: 3, niju_ushiro: 7, sanju: 3 } },
      ],
    };

    // --- æ—¥æœ¬ã®ç¥æ—¥ãƒ»ä¼‘æ—¥åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (ç°¡æ˜“å®Ÿè£…) ---
    function isJapaneseHoliday(date) {
      const y = date.getFullYear();
      const m = date.getMonth() + 1;
      const d = date.getDate();
      const w = date.getDay(); // 0=Sun, 1=Mon

      // å›ºå®šã®ç¥æ—¥
      if (m === 1 && d === 1) return true; // å…ƒæ—¥
      if (m === 2 && d === 11) return true; // å»ºå›½è¨˜å¿µã®æ—¥
      if (m === 2 && d === 23) return true; // å¤©çš‡èª•ç”Ÿæ—¥
      if (m === 3 && d === Math.floor(20.8431 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4))) return true; // æ˜¥åˆ†ã®æ—¥
      if (m === 4 && d === 29) return true; // æ˜­å’Œã®æ—¥
      if (m === 5 && d === 3) return true; // æ†²æ³•è¨˜å¿µæ—¥
      if (m === 5 && d === 4) return true; // ã¿ã©ã‚Šã®æ—¥
      if (m === 5 && d === 5) return true; // ã“ã©ã‚‚ã®æ—¥
      if (m === 8 && d === 11) return true; // å±±ã®æ—¥ï¼ˆæ¨™æº–æ—¥ï¼‰
      if (m === 9 && d === Math.floor(23.2488 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4))) return true; // ç§‹åˆ†ã®æ—¥
      if (m === 11 && d === 3) return true; // æ–‡åŒ–ã®æ—¥
      if (m === 11 && d === 23) return true; // å‹¤åŠ´æ„Ÿè¬ã®æ—¥

      // ãƒãƒƒãƒ”ãƒ¼ãƒãƒ³ãƒ‡ãƒ¼
      const isNthMonday = (n) => {
        if (w !== 1) return false;
        return Math.floor((d - 1) / 7) === (n - 1);
      };
      if (m === 1 && isNthMonday(2)) return true; // æˆäººã®æ—¥
      if (m === 7 && isNthMonday(3)) return true; // æµ·ã®æ—¥
      if (m === 9 && isNthMonday(3)) return true; // æ•¬è€ã®æ—¥
      if (m === 10 && isNthMonday(2)) return true; // ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥

      // æŒ¯æ›¿ä¼‘æ—¥ï¼ˆç°¡æ˜“ï¼‰
      if (w === 1) {
        const yesterday = new Date(date);
        yesterday.setDate(d - 1);
        if (isJapaneseHoliday(yesterday)) return true;
      }
      return false;
    }

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã‚­ãƒ¼ï¼ˆæ—§ã‚³ãƒ¼ãƒ‰ã®UTCã‚ºãƒ¬å¯¾ç­–ã‚‚çµ±åˆï¼‰ ---
    const toLocalDateKey = (d = new Date()) => {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    };

    // --- ğŸµ Soundï¼ˆæ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’çµ±åˆï¼‰ ---
    const createSound = () => {
      let audioCtx = null;
      const getCtx = () => {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        return audioCtx;
      };
      const playTone = (freq, type, duration) => {
        try {
          const ctx = getCtx();
          if (ctx.state === 'suspended') ctx.resume();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = type;
          osc.frequency.setValueAtTime(freq, ctx.currentTime);
          gain.gain.setValueAtTime(0.08, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.start();
          osc.stop(ctx.currentTime + duration);
        } catch(e) {}
      };
      return {
        click: () => playTone(600, 'sine', 0.08),
        success: () => { playTone(800, 'sine', 0.08); setTimeout(() => playTone(1200, 'sine', 0.14), 90); },
        fanfare: () => {
          const notes = [523.25, 659.25, 783.99, 1046.50];
          notes.forEach((f, i) => setTimeout(() => playTone(f, 'triangle', 0.5), i * 140));
        }
      };
    };

    // --- ğŸ‰ Confetti Canvasï¼ˆæ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’çµ±åˆï¼‰ ---
    class ConfettiEffect {
      constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas?.getContext('2d');
        this.particles = [];
        this.isAnimating = false;
        this._onResize = this.resize.bind(this);
        this.resize();
        window.addEventListener('resize', this._onResize);
      }
      resize() {
        if (!this.canvas) return;
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
      }
      destroy() {
        window.removeEventListener('resize', this._onResize);
        this.particles = [];
        this.isAnimating = false;
        if (this.ctx) this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
      }
      createParticles() {
        const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#FF9F43', '#54A0FF', '#A78BFA'];
        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2;
        for (let i = 0; i < 120; i++) {
          this.particles.push({
            x: cx, y: cy,
            vx: (Math.random() - 0.5) * 12,
            vy: (Math.random() - 0.5) * 12 - 6,
            size: Math.random() * 7 + 4,
            color: colors[Math.floor(Math.random() * colors.length)],
            rotation: Math.random() * 360,
            dr: (Math.random() - 0.5) * 12
          });
        }
      }
      animate() {
        if (!this.ctx || !this.canvas) return;
        if (this.particles.length === 0) {
          this.isAnimating = false;
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
          return;
        }
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        for (let i = this.particles.length - 1; i >= 0; i--) {
          const p = this.particles[i];
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.22;
          p.rotation += p.dr;

          this.ctx.save();
          this.ctx.translate(p.x, p.y);
          this.ctx.rotate(p.rotation * Math.PI / 180);
          this.ctx.fillStyle = p.color;
          this.ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
          this.ctx.restore();

          if (p.y > this.canvas.height + 40) this.particles.splice(i, 1);
        }
        requestAnimationFrame(() => this.animate());
      }
      start() {
        this.createParticles();
        if (!this.isAnimating) {
          this.isAnimating = true;
          this.animate();
        }
      }
    }

    // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
    function App() {
      // --- State ---
      const [user, setUser] = useState({ grade: 1, classVal: '', number: '', name: '', isRegistered: true });

      const [records, setRecords] = useState({});
      const [dailyRecords, setDailyRecords] = useState({}); // æ—¥ã”ã¨ã®å…¨è¨˜éŒ²ã‚’ä¿å­˜
      const [maxRecords, setMaxRecords] = useState({}); // è‡ªå·±ãƒ™ã‚¹ãƒˆè¨˜éŒ²
      const [history, setHistory] = useState({});
      const [activeTab, setActiveTab] = useState('home');

      const [showConfetti, setShowConfetti] = useState(false); // ç´šã‚¢ãƒƒãƒ—
      const [targetDate, setTargetDate] = useState(toLocalDateKey(new Date())); // è¨˜éŒ²å¯¾è±¡æ—¥ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰

      // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºç”¨State
      const [levelsData, setLevelsData] = useState(DEFAULT_LEVELS_DATA);
      const [trickNames, setTrickNames] = useState(DEFAULT_TRICK_NAMES);

      // è¨­å®šç”»é¢ç”¨State
      const [settingTab, setSettingTab] = useState('low'); // low, mid, high

      // æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šåˆè¨ˆã¨ç›®æ¨™ï¼ˆã‚´ãƒ¼ãƒ«ï¼‰
      const [goals, setGoals] = useState({});
      const [achievements, setAchievements] = useState([]); // goal-<trickId>-<goal>

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼‰
      const [showGoalSettings, setShowGoalSettings] = useState(false);
      const [pendingGoalUpdate, setPendingGoalUpdate] = useState(null); // {trickId, oldGoal, newGoal}
      const [showImportModal, setShowImportModal] = useState(false);
      const [importText, setImportText] = useState('');
      const [showCopyModal, setShowCopyModal] = useState(false);
      const [copyModalMessage, setCopyModalMessage] = useState('');
      const [deleteTargetDate, setDeleteTargetDate] = useState(null);
      const [showDeleteModal, setShowDeleteModal] = useState(false);
      const [dateEditTarget, setDateEditTarget] = useState(null); // {oldDate, newDate}
      const [showDateEditModal, setShowDateEditModal] = useState(false);

      const fileInputRef = useRef(null); // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç”¨ï¼ˆå…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ï¼šæ¤œå®šè¡¨è¨­å®šï¼‰
      const soundRef = useRef(null);
      const confettiRef = useRef(null);

      // --- åˆæœŸåŒ– & ãƒ‡ãƒ¼ã‚¿ä¿å­˜ ---
      useEffect(() => {
        soundRef.current = createSound();
        const canvas = document.getElementById('confetti-canvas');
        confettiRef.current = new ConfettiEffect(canvas);

        const savedUser = localStorage.getItem('nawatobi_user');
        const savedDailyRecords = localStorage.getItem('nawatobi_daily_records');
        const savedMaxRecords = localStorage.getItem('nawatobi_max_records');
        const savedHistory = localStorage.getItem('nawatobi_history');
        const savedLevels = localStorage.getItem('nawatobi_levels');
        const savedNames = localStorage.getItem('nawatobi_trick_names');
        const savedVersion = localStorage.getItem('nawatobi_version');

        // æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šç›®æ¨™ãƒ‡ãƒ¼ã‚¿
        const savedGoals = localStorage.getItem('nawatobi_goals');
        const savedAchievements = localStorage.getItem('nawatobi_achievements');

        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
        const isOldVersion = savedVersion !== DATA_VERSION;

        if (savedUser) setUser({ ...JSON.parse(savedUser), isRegistered: true });
        if (savedHistory) setHistory(JSON.parse(savedHistory));

        // dailyRecordsã®åˆæœŸåŒ–ã¨ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã§ï¼‰
        let initialDailyRecords = {};
        if (savedDailyRecords) {
          initialDailyRecords = JSON.parse(savedDailyRecords);
          setDailyRecords(initialDailyRecords);
        }

        // UTCã‚ºãƒ¬æ•‘æ¸ˆï¼ˆéå»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ toISOString ã‚’ä½¿ã£ã¦ã„ãŸå ´åˆã«å‚™ãˆã¦ã€ä»Šæ—¥ã®ã‚ºãƒ¬ã‚’æ‹¾ã†ï¼‰
        const localToday = toLocalDateKey(new Date());
        const utcToday = new Date().toISOString().split('T')[0];
        if (utcToday !== localToday) {
          // dailyRecords
          if (initialDailyRecords[utcToday] && !initialDailyRecords[localToday]) {
            initialDailyRecords[localToday] = initialDailyRecords[utcToday];
            delete initialDailyRecords[utcToday];
            setDailyRecords({ ...initialDailyRecords });
            localStorage.setItem('nawatobi_daily_records', JSON.stringify(initialDailyRecords));
          }
          // history
          const h = savedHistory ? JSON.parse(savedHistory) : {};
          if (h[utcToday] && !h[localToday]) {
            h[localToday] = true;
            delete h[utcToday];
            setHistory({ ...h });
            localStorage.setItem('nawatobi_history', JSON.stringify(h));
          }
        }

        // åˆæœŸè¡¨ç¤ºæ™‚ï¼ˆä»Šæ—¥ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
        if (initialDailyRecords[localToday]) {
          setRecords(initialDailyRecords[localToday]);
        }

        // maxRecordsã®åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯
        if (savedMaxRecords) {
          setMaxRecords(JSON.parse(savedMaxRecords));
        } else if (localStorage.getItem('nawatobi_records')) {
          const initialMax = JSON.parse(localStorage.getItem('nawatobi_records'));
          setMaxRecords(initialMax);
          localStorage.setItem('nawatobi_max_records', JSON.stringify(initialMax));
        }

        if (isOldVersion) {
          setLevelsData(DEFAULT_LEVELS_DATA);
          setTrickNames(DEFAULT_TRICK_NAMES);
          localStorage.setItem('nawatobi_levels', JSON.stringify(DEFAULT_LEVELS_DATA));
          localStorage.setItem('nawatobi_trick_names', JSON.stringify(DEFAULT_TRICK_NAMES));
          localStorage.setItem('nawatobi_version', DATA_VERSION);
        } else {
          if (savedLevels) setLevelsData(JSON.parse(savedLevels));
          if (savedNames) setTrickNames(JSON.parse(savedNames));
        }

        // goals/achievements
        if (savedGoals) setGoals(JSON.parse(savedGoals));
        if (savedAchievements) setAchievements(JSON.parse(savedAchievements));

        return () => {
          confettiRef.current?.destroy?.();
        };
      }, []);

      // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
      useEffect(() => localStorage.setItem('nawatobi_user', JSON.stringify(user)), [user]);
      useEffect(() => localStorage.setItem('nawatobi_daily_records', JSON.stringify(dailyRecords)), [dailyRecords]);
      useEffect(() => localStorage.setItem('nawatobi_records', JSON.stringify(records)), [records]);
      useEffect(() => localStorage.setItem('nawatobi_max_records', JSON.stringify(maxRecords)), [maxRecords]);
      useEffect(() => localStorage.setItem('nawatobi_history', JSON.stringify(history)), [history]);
      useEffect(() => localStorage.setItem('nawatobi_goals', JSON.stringify(goals)), [goals]);
      useEffect(() => localStorage.setItem('nawatobi_achievements', JSON.stringify(achievements)), [achievements]);

      // targetDateãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã®å‡¦ç†ï¼ˆé‡è¦ï¼‰
      useEffect(() => {
        if (dailyRecords[targetDate]) setRecords(dailyRecords[targetDate]);
        else setRecords({});
      }, [targetDate, dailyRecords]);

      const sound = useCallback((type) => {
        try {
          if (!soundRef.current) return;
          if (type === 'click') soundRef.current.click();
          if (type === 'success') soundRef.current.success();
          if (type === 'fanfare') soundRef.current.fanfare();
        } catch(e){}
      }, []);

      // --- åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
      const gradeCategory = useMemo(() => {
        if (user.grade <= 2) return 'low';
        if (user.grade <= 4) return 'mid';
        return 'high';
      }, [user.grade]);

      const currentLevelSet = useMemo(() => {
        return levelsData[gradeCategory]
          .map(l => {
            const name = l.name !== undefined ? l.name : `${l.level}ç´š`;
            return { ...l, name };
          })
          .filter(l => l.name !== '');
      }, [gradeCategory, levelsData]);

      const displayTricks = useMemo(() => {
        const activeTricks = new Set();
        levelsData[gradeCategory].forEach(l => {
          if (l.name === '') return;
          if (l.reqs) {
            Object.entries(l.reqs).forEach(([key, val]) => {
              if (val > 0) activeTricks.add(key);
            });
          }
        });

        return TRICK_IDS
          .filter(id => activeTricks.has(id))
          .map(id => ({
            id,
            color: TRICK_COLORS[id],
            label: trickNames[gradeCategory][id] || DEFAULT_TRICK_NAMES[gradeCategory][id],
            name: id
          }));
      }, [gradeCategory, trickNames, levelsData]);

      // --- ç´šåˆ¤å®šã«ã¯ maxRecords ã‚’ä½¿ç”¨ã™ã‚‹ ---
      const clearedLevels = useMemo(() => {
        return currentLevelSet.filter(lvl => {
          return Object.entries(lvl.reqs).every(([trickId, requiredCount]) => {
            const currentCount = maxRecords[trickId] || 0;
            if (!requiredCount || requiredCount <= 0) return true;
            return currentCount >= requiredCount;
          });
        }).map(l => l.level);
      }, [maxRecords, currentLevelSet]);

      const nextLevels = useMemo(() => {
        const allLevels = levelsData[gradeCategory]
          .map(l => ({ ...l, name: l.name !== undefined ? l.name : `${l.level}ç´š` }))
          .filter(l => l.name !== '');
        return allLevels.filter(lvl => !clearedLevels.includes(lvl.level));
      }, [gradeCategory, levelsData, clearedLevels]);

      const currentBestLevel = useMemo(() => {
        if (clearedLevels.length === 0) return null;
        const minLevel = Math.min(...clearedLevels);
        return currentLevelSet.find(l => l.level === minLevel);
      }, [clearedLevels, currentLevelSet]);

      const goalTitle = useMemo(() => {
        if (user.grade <= 2) return "ã¤ãã® ã‚‚ãã²ã‚‡ã† ï¼ˆãã‚…ã† ã¨ ã‚ã– ã® ã‹ã„ã™ã†ï¼‰";
        return "æ¬¡ã® ç›®æ¨™ ï¼ˆç´šã¨ æŠ€ã® å›æ•°ï¼‰";
      }, [user.grade]);

      const getTrickLevel = useCallback((trickId) => {
        const count = maxRecords[trickId] || 0;
        if (!count || count <= 0) return null;
        const levels = levelsData[gradeCategory];
        if (!levels) return null;

        const passedLevels = levels.filter(l => {
          if (l.name === '') return false;
          if (!l.reqs) return false;
          const required = l.reqs[trickId];
          return required !== undefined && required !== null && required > 0 && count >= required;
        });

        if (passedLevels.length === 0) return null;
        return Math.min(...passedLevels.map(l => l.level));
      }, [levelsData, gradeCategory, maxRecords]);

      const calculateBestLevel = (currentRecords, category) => {
        if (!levelsData || !levelsData[category]) return 999;
        const levels = levelsData[category];
        const cleared = levels.filter(lvl => {
          if (lvl.name === '') return false;
          if (!lvl.reqs) return true;
          return Object.entries(lvl.reqs).every(([trickId, requiredCount]) => {
            const count = currentRecords[trickId] || 0;
            if (!requiredCount || requiredCount <= 0) return true;
            return count >= requiredCount;
          });
        }).map(l => l.level);

        if (cleared.length === 0) return 999;
        return Math.min(...cleared);
      };

      const calculateLevelForCount = useCallback((trickId, count) => {
        if (!count || count <= 0) return null;
        const levels = levelsData[gradeCategory];
        if (!levels) return null;

        const passedLevels = levels.filter(l => {
          if (l.name === '') return false;
          if (!l.reqs) return false;
          const required = l.reqs[trickId];
          return required !== undefined && required !== null && required > 0 && count >= required;
        });

        if (passedLevels.length === 0) return null;
        return Math.min(...passedLevels.map(l => l.level));
      }, [levelsData, gradeCategory]);

      // --- æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šåˆè¨ˆï¼ˆTotalsï¼‰ & ç›®æ¨™ï¼ˆGoalsï¼‰ ---
      const totals = useMemo(() => {
        const t = {};
        displayTricks.forEach(s => (t[s.id] = 0));
        Object.values(dailyRecords).forEach(dayObj => {
          if (!dayObj) return;
          displayTricks.forEach(s => {
            const v = parseInt(dayObj[s.id] || 0);
            t[s.id] += isNaN(v) ? 0 : v;
          });
        });
        return t;
      }, [dailyRecords, displayTricks]);

      const defaultGoalForTrick = useCallback((trickId) => {
        // ãã®å­¦å¹´ã‚«ãƒ†ã‚´ãƒªã§ã®ã€Œæœ€å¤§è¦ä»¶ã€ã‚’æ‹¾ã£ã¦ã€20å€ã‚’åˆæœŸç›®æ¨™ã«ï¼ˆæ—§ã‚³ãƒ¼ãƒ‰ã®â€œåˆè¨ˆã§ä¼¸ã°ã™â€æ€æƒ³ã‚’çµ±åˆï¼‰
        try {
          const levels = levelsData[gradeCategory] || [];
          let maxReq = 0;
          levels.forEach(l => {
            if (l.name === '') return;
            const req = l?.reqs?.[trickId];
            if (req && req > maxReq) maxReq = req;
          });
          let g = Math.max(200, maxReq * 20); // æœ€ä½200
          g = Math.min(10000, g);
          return g || 1000;
        } catch(e) {
          return 1000;
        }
      }, [levelsData, gradeCategory]);

      // displayTricks ãŒå¤‰ã‚ã£ãŸæ™‚ã€æœªè¨­å®šã® goal ã‚’è‡ªå‹•è£œå®Œ
      useEffect(() => {
        if (!displayTricks || displayTricks.length === 0) return;
        setGoals(prev => {
          const next = { ...prev };
          let changed = false;
          displayTricks.forEach(s => {
            if (!next[s.id] || next[s.id] <= 0) {
              next[s.id] = defaultGoalForTrick(s.id);
              changed = true;
            }
          });
          return changed ? next : prev;
        });
      }, [displayTricks, defaultGoalForTrick]);

      const isGoalAchievedOnce = useCallback((trickId, goalValue) => {
        const key = `goal-${trickId}-${goalValue}`;
        return achievements.includes(key);
      }, [achievements]);

      const markGoalAchieved = useCallback((trickId, goalValue) => {
        const key = `goal-${trickId}-${goalValue}`;
        setAchievements(prev => (prev.includes(key) ? prev : [...prev, key]));
      }, []);

      const checkAndTriggerGoalUpdate = useCallback((trickId, totalValue) => {
        const currentGoal = goals[trickId] || defaultGoalForTrick(trickId);
        if (totalValue >= currentGoal) {
          if (!isGoalAchievedOnce(trickId, currentGoal)) {
            markGoalAchieved(trickId, currentGoal);
            sound('fanfare');
            confettiRef.current?.start?.();

            const nextGoal = Math.ceil(currentGoal * 1.2);
            setPendingGoalUpdate({ trickId, oldGoal: currentGoal, newGoal: nextGoal });
          }
        }
      }, [goals, defaultGoalForTrick, isGoalAchievedOnce, markGoalAchieved, sound]);

      // --- ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ï¼ˆå…¥åŠ›ä¸­ã®æ—¥ã®â€œ1è¡Œã‚³ãƒ”ãƒ¼â€ï¼‰ ---
      const handleCopyToClipboard = () => {
        sound('click');
        const header = ['åå‰', 'ç¾åœ¨ã®ç´š', ...displayTricks.map(t => t.label)].join('\t');
        const currentLevelName = currentBestLevel ? currentBestLevel.name : 'ãªã—';

        const rowData = [
          (user.name || 'åç„¡ã—'),
          currentLevelName
        ];

        displayTricks.forEach(trick => {
          const count = records[trick.id] || 0;
          const level = calculateLevelForCount(trick.id, parseInt(count || 0));
          const cellData = level ? `${count}(${level}ç´š)` : `${count}`;
          rowData.push(cellData);
        });

        const textToCopy = header + '\n' + rowData.join('\t');

        const doCopyFallback = () => {
          const textArea = document.createElement("textarea");
          textArea.value = textToCopy;
          textArea.style.position = "fixed";
          textArea.style.left = "-9999px";
          textArea.style.top = "0";
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          try {
            const ok = document.execCommand('copy');
            document.body.removeChild(textArea);
            if (ok) {
              setCopyModalMessage('è¨˜éŒ²ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nExcelã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
              setShowCopyModal(true);
              sound('success');
            } else {
              alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
          } catch (err) {
            document.body.removeChild(textArea);
            alert('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
          }
        };

        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(textToCopy)
            .then(() => {
              setCopyModalMessage('è¨˜éŒ²ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nExcelã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
              setShowCopyModal(true);
              sound('success');
            })
            .catch(() => doCopyFallback());
        } else {
          doCopyFallback();
        }
      };

      // --- æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šä¸€è¦§è¡¨ï¼ˆå…¨æ—¥ï¼‰ã‚³ãƒ”ãƒ¼ ---
      const exportAllAsTSV = useCallback(() => {
        sound('click');
        const dates = Object.keys(dailyRecords).sort((a,b) => new Date(a) - new Date(b));
        if (dates.length === 0) {
          alert('æ—¥åˆ¥ã®è¨˜éŒ²ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚');
          return;
        }

        const headers = ['æ—¥ä»˜', ...displayTricks.map(t => t.label)];
        const rows = [headers.join('\t')];

        const totalRow = {};
        displayTricks.forEach(t => totalRow[t.id] = 0);

        dates.forEach(dateKey => {
          const dayObj = dailyRecords[dateKey] || {};
          const row = [dateKey];
          displayTricks.forEach(t => {
            const v = parseInt(dayObj[t.id] || 0) || 0;
            totalRow[t.id] += v;
            row.push(v);
          });
          rows.push(row.join('\t'));
        });

        const totalLine = ['åˆè¨ˆ'];
        displayTricks.forEach(t => totalLine.push(totalRow[t.id] || 0));
        rows.push(totalLine.join('\t'));

        const textToCopy = rows.join('\n');

        const doCopyFallback = () => {
          const ta = document.createElement('textarea');
          ta.value = textToCopy;
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          try {
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            if (ok) {
              setCopyModalMessage('ä¸€è¦§è¡¨ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ Ctrl+Vï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰ã—ã¦ãã ã•ã„ã€‚');
              setShowCopyModal(true);
              sound('success');
            } else {
              alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
          } catch (e) {
            document.body.removeChild(ta);
            alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        };

        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(textToCopy)
            .then(() => {
              setCopyModalMessage('ä¸€è¦§è¡¨ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ Ctrl+Vï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰ã—ã¦ãã ã•ã„ã€‚');
              setShowCopyModal(true);
              sound('success');
            })
            .catch(() => doCopyFallback());
        } else {
          doCopyFallback();
        }
      }, [dailyRecords, displayTricks, sound]);

      // --- æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆTSVè²¼ã‚Šä»˜ã‘ï¼‰ ---
      const executeImport = useCallback(() => {
        sound('click');
        const text = importText;
        if (!text.trim()) {
          alert('ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
          return;
        }

        try {
          const lines = text.trim().split(/\r?\n/);
          if (lines.length < 2) {
            alert('ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ããªã„ã‚ˆã†ã§ã™ï¼ˆè¡Œæ•°ãŒè¶³ã‚Šã¾ã›ã‚“ï¼‰ã€‚');
            return;
          }

          const headers = lines[0].split('\t');

          // 1åˆ—ç›®ã¯æ—¥ä»˜æƒ³å®šã€‚2åˆ—ç›®ä»¥é™ã¯ç¨®ç›®åã€‚
          const idxByTrick = {};
          displayTricks.forEach(trick => {
            const idx = headers.indexOf(trick.label);
            if (idx !== -1) idxByTrick[trick.id] = idx;
          });

          let newDaily = { ...dailyRecords };
          let newMax = { ...maxRecords };
          let newHistory = { ...history };

          let importedCount = 0;

          for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split('\t');
            const dateStr = cols[0];

            if (!dateStr || dateStr.includes('åˆè¨ˆ')) continue;
            if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) continue;

            if (!newDaily[dateStr]) newDaily[dateStr] = {};
            let anyPositive = false;

            displayTricks.forEach(trick => {
              const idx = idxByTrick[trick.id];
              if (idx === undefined) return;
              if (idx < cols.length) {
                const val = parseInt(cols[idx]);
                if (!isNaN(val)) {
                  newDaily[dateStr][trick.id] = val;
                  if (val > 0) anyPositive = true;
                  if ((newMax[trick.id] || 0) < val) newMax[trick.id] = val;
                }
              }
            });

            if (anyPositive) newHistory[dateStr] = true;
            importedCount++;
          }

          setDailyRecords(newDaily);
          setMaxRecords(newMax);
          setHistory(newHistory);
          localStorage.setItem('nawatobi_daily_records', JSON.stringify(newDaily));
          localStorage.setItem('nawatobi_max_records', JSON.stringify(newMax));
          localStorage.setItem('nawatobi_history', JSON.stringify(newHistory));

          setShowImportModal(false);
          setImportText('');
          alert(`${importedCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼`);
          sound('success');

        } catch (e) {
          console.error(e);
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
      }, [importText, displayTricks, dailyRecords, maxRecords, history, sound]);

      // --- ã€Œã‘ã£ã¦ã„ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†ï¼ˆã“ã“ã§ç´šåˆ¤å®š + æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šç›®æ¨™ãƒã‚§ãƒƒã‚¯ã‚‚è¡Œã†ï¼‰ ---
      const handleConfirmRecord = (trickId) => {
        sound('click');

        const currentCount = parseInt(records[trickId] || 0);
        const currentMax = maxRecords[trickId] || 0;

        const currentCategory = user.grade <= 2 ? 'low' : user.grade <= 4 ? 'mid' : 'high';
        const oldBestLevel = calculateBestLevel(maxRecords, currentCategory);

        let nextMaxRecords = { ...maxRecords };
        let isNewRecord = false;

        // æ—¥ã”ã¨ã®è¨˜éŒ²ï¼ˆdailyRecordsï¼‰ã‚’æ›´æ–°
        const newDailyRecords = { ...dailyRecords };
        if (!newDailyRecords[targetDate]) newDailyRecords[targetDate] = {};
        newDailyRecords[targetDate][trickId] = currentCount;

        setDailyRecords(newDailyRecords);
        localStorage.setItem('nawatobi_daily_records', JSON.stringify(newDailyRecords));

        // è‡ªå·±ãƒ™ã‚¹ãƒˆæ›´æ–°ãƒã‚§ãƒƒã‚¯
        if (currentCount > currentMax) {
          nextMaxRecords[trickId] = currentCount;
          setMaxRecords(nextMaxRecords);
          localStorage.setItem('nawatobi_max_records', JSON.stringify(nextMaxRecords));
          isNewRecord = true;
        }

        // å±¥æ­´ã®æ›´æ–°
        const newHistory = { ...history, [targetDate]: true };
        setHistory(newHistory);
        localStorage.setItem('nawatobi_history', JSON.stringify(newHistory));

        // ç´šåˆ¤å®šï¼ˆæ–°ã—ã„çŠ¶æ…‹ã§ã®ãƒ™ã‚¹ãƒˆç´šï¼‰
        const newBestLevel = calculateBestLevel(nextMaxRecords, currentCategory);

        // æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šåˆè¨ˆç›®æ¨™ãƒã‚§ãƒƒã‚¯ï¼ˆä»Šå›ã®æŠ€ã ã‘ãƒã‚§ãƒƒã‚¯ï¼‰
        const newTotal = (() => {
          let t = 0;
          Object.values(newDailyRecords).forEach(dayObj => {
            if (!dayObj) return;
            t += (parseInt(dayObj[trickId] || 0) || 0);
          });
          return t;
        })();
        checkAndTriggerGoalUpdate(trickId, newTotal);

        // ç´šãŒä¸ŠãŒã£ãŸå ´åˆ
        if (newBestLevel < oldBestLevel) {
          setShowConfetti(true);
          sound('fanfare');
          confettiRef.current?.start?.();
        } else if (isNewRecord) {
          const t = displayTricks.find(x => x.id === trickId);
          sound('success');
          alert(`ã€Œ${t ? t.label : trickId}ã€ã® è‡ªå·±ãƒ™ã‚¹ãƒˆ(${currentCount}å›) ã‚’ ã“ã†ã—ã‚“ ã—ã¾ã—ãŸï¼`);
        } else {
          sound('success');
        }
      };

      // --- ãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°æ™‚ï¼ˆå…¥åŠ›ä¸­ã¯å…¥åŠ›å€¤ã®ã¿æ›´æ–°ï¼‰ ---
      const updateRecord = (trickId, count) => {
        const newRecords = { ...records, [trickId]: count };
        setRecords(newRecords);
      };

      // --- è¨­å®šå¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©ï¼ˆå…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ï¼šæ¤œå®šè¡¨ï¼‰ ---
      const handleSaveSettings = () => {
        localStorage.setItem('nawatobi_levels', JSON.stringify(levelsData));
        localStorage.setItem('nawatobi_trick_names', JSON.stringify(trickNames));
        localStorage.setItem('nawatobi_version', DATA_VERSION);
        alert('è¨­å®šã‚’ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸï¼\nç”Ÿå¾’ã«é…ã‚‹å ´åˆã¯ã€Œå…ç«¥é…ä»˜ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãå‡ºã—ã€ãƒœã‚¿ãƒ³ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚');
        sound('success');
      };

      const handleDownloadJson = () => {
        sound('click');
        const data = { levelsData, trickNames, version: DATA_VERSION };
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `nawatobi-settings-${toLocalDateKey(new Date())}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const handleUploadJson = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        sound('click');
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (data.levelsData && data.trickNames) {
              setLevelsData(data.levelsData);
              setTrickNames(data.trickNames);
              localStorage.setItem('nawatobi_levels', JSON.stringify(data.levelsData));
              localStorage.setItem('nawatobi_trick_names', JSON.stringify(data.trickNames));
              localStorage.setItem('nawatobi_version', DATA_VERSION);
              alert('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€å¾©å…ƒã—ã¾ã—ãŸï¼');
              sound('success');
            } else {
              alert('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚');
            }
          } catch (error) {
            console.error(error);
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        };
        reader.readAsText(file);
        event.target.value = '';
      };

      const handleExportHtml = () => {
        sound('click');
        const scriptContent = document.getElementById('app-script').textContent;

        const newLevelsDataStr = 'const DEFAULT_LEVELS_DATA = ' + JSON.stringify(levelsData, null, 2) + ';';
        const newTrickNamesStr = 'const DEFAULT_TRICK_NAMES = ' + JSON.stringify(trickNames, null, 2) + ';';
        const newVersionStr = 'const DATA_VERSION = "' + DATA_VERSION + '-custom-' + Date.now() + '";';

        let newScriptContent = scriptContent
          .replace(/const DEFAULT_LEVELS_DATA = \{[\s\S]*?\};/, newLevelsDataStr)
          .replace(/const DEFAULT_TRICK_NAMES = \{[\s\S]*?\};/, newTrickNamesStr)
          .replace(/const DATA_VERSION = ".*?";/, newVersionStr)
          .replace('const IS_TEACHER_MODE = true;', 'const IS_TEACHER_MODE = false;');

        // â€»æ—§ã‚³ãƒ¼ãƒ‰çµ±åˆã«ã‚ˆã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã‚­ãƒ¼é–¢æ•°ãªã©ã‚‚å«ã‚ã¦ãã®ã¾ã¾æ›¸ãå‡ºã•ã‚Œã¾ã™ã€‚

        const htmlContent =
'<!DOCTYPE html>\n' +
'<html lang="ja">\n' +
'<head>\n' +
'  <meta charset="UTF-8">\n' +
'  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
'  <title>ãªã‚ã¨ã³æ¤œå®šã‚¢ãƒ—ãƒªï¼ˆ' + new Date().toLocaleDateString() + 'ç‰ˆï¼‰</title>\n' +
'  <script src="https://cdn.tailwindcss.com"><\/script>\n' +
'  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">\n' +
'  <script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>\n' +
'  <script type="importmap">\n' +
'    {\n' +
'      "imports": {\n' +
'        "react": "https://esm.sh/react@18.2.0",\n' +
'        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",\n' +
'        "lucide-react": "https://esm.sh/lucide-react@0.292.0"\n' +
'      }\n' +
'    }\n' +
'  <\/script>\n' +
'  <style>\n' +
'    body{font-family:\'M PLUS Rounded 1c\', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom:96px; touch-action:manipulation;}\n' +
'    .sticky-col{position:sticky;left:0;background-color:white;z-index:10;border-right:2px solid #e2e8f0;}\n' +
'    .sticky-header{position:sticky;top:0;z-index:20;background:#f8fafc;}\n' +
'    .sticky-corner{position:sticky;left:0;top:0;z-index:30;background:#f8fafc;border-right:2px solid #e2e8f0;}\n' +
'    .custom-scrollbar::-webkit-scrollbar{height:8px;width:8px;}\n' +
'    .custom-scrollbar::-webkit-scrollbar-track{background:#f1f5f9;}\n' +
'    .custom-scrollbar::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:4px;}\n' +
'    .custom-scrollbar::-webkit-scrollbar-thumb:hover{background:#94a3b8;}\n' +
'    @keyframes popIn{0%{transform:scale(0.8);opacity:0;}100%{transform:scale(1);opacity:1;}}\n' +
'    .animate-popIn{animation:popIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275) forwards;}\n' +
'    @keyframes confetti{0%{background-position:0 0;}100%{background-position:100px 100px;}}\n' +
'    .bg-confetti{background-image:radial-gradient(#FCD34D 20%, transparent 20%), radial-gradient(#F87171 20%, transparent 20%); background-color:#fff; background-position:0 0, 50px 50px; background-size:100px 100px; animation:confetti 4s linear infinite;}\n' +
'    input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}\n' +
'    input[type="number"]{-moz-appearance:textfield;}\n' +
'    #confetti-canvas{position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:9998;}\n' +
'  </style>\n' +
'</head>\n' +
'<body class="bg-sky-50 text-slate-800 select-none">\n' +
'  <canvas id="confetti-canvas"></canvas>\n' +
'  <div id="root"></div>\n' +
'  <script type="text/babel" data-type="module" id="app-script">\n' +
newScriptContent + '\n' +
'  <\/script>\n' +
'</body>\n' +
'</html>';

        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `nawatobi-custom-${toLocalDateKey(new Date())}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const handleResetSettings = () => {
        sound('click');
        if (window.confirm('æœ¬å½“ã«åˆæœŸè¨­å®šï¼ˆå¤§é˜ªåºœãƒ¢ãƒ‡ãƒ«ï¼‰ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸå†…å®¹ã¯æ¶ˆãˆã¦ã—ã¾ã„ã¾ã™ã€‚')) {
          setLevelsData(DEFAULT_LEVELS_DATA);
          setTrickNames(DEFAULT_TRICK_NAMES);
          localStorage.removeItem('nawatobi_levels');
          localStorage.removeItem('nawatobi_trick_names');
          localStorage.removeItem('nawatobi_version');
          alert('åˆæœŸè¨­å®šã«æˆ»ã—ã¾ã—ãŸã€‚');
          window.location.reload();
        }
      };

      // ç¾ã‚³ãƒ¼ãƒ‰ã®ãƒªã‚»ãƒƒãƒˆï¼ˆè¨˜éŒ²ã ã‘ï¼‰
      const handleReset = () => {
        sound('click');
        if (window.confirm('æœ¬å½“ã«è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿè¨­å®šã¯ä¿æŒã•ã‚Œã¾ã™ã€‚')) {
          setRecords({});
          setDailyRecords({});
          setMaxRecords({});
          setHistory({});
          localStorage.removeItem('nawatobi_records');
          localStorage.removeItem('nawatobi_daily_records');
          localStorage.removeItem('nawatobi_max_records');
          localStorage.removeItem('nawatobi_history');
          localStorage.removeItem('nawatobi_goals');
          localStorage.removeItem('nawatobi_achievements');
          window.location.reload();
        }
      };

      // --- æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šæ—¥ä»˜å¤‰æ›´ï¼ˆä¸€è¦§è¡¨ã§ä½¿ã†ï¼‰ ---
      const sortedDates = useMemo(() => {
        return Object.keys(dailyRecords).sort((a,b) => new Date(a) - new Date(b));
      }, [dailyRecords]);

      const openDateEdit = (oldDate) => {
        sound('click');
        setDateEditTarget({ oldDate, newDate: oldDate });
        setShowDateEditModal(true);
      };

      const applyDateEdit = () => {
        sound('click');
        const oldDate = dateEditTarget?.oldDate;
        const newDate = dateEditTarget?.newDate;
        if (!oldDate || !newDate) return;

        if (oldDate === newDate) {
          setShowDateEditModal(false);
          return;
        }
        if (dailyRecords[newDate]) {
          alert('ãã®æ—¥ä»˜ã¯ã™ã§ã«å­˜åœ¨ã—ã¾ã™ï¼ˆä¸Šæ›¸ãé˜²æ­¢ï¼‰ã€‚\nå…ˆã«æ—¢å­˜ã®è¨˜éŒ²ã‚’æ¶ˆã™ã‹ã€åˆ¥ã®æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
          return;
        }

        const nextDaily = { ...dailyRecords };
        nextDaily[newDate] = nextDaily[oldDate];
        delete nextDaily[oldDate];

        const nextHistory = { ...history };
        if (nextHistory[oldDate]) {
          nextHistory[newDate] = true;
          delete nextHistory[oldDate];
        }

        setDailyRecords(nextDaily);
        setHistory(nextHistory);

        // targetDateãŒå½“æ—¥ãªã‚‰è¿½å¾“
        if (targetDate === oldDate) setTargetDate(newDate);

        setShowDateEditModal(false);
        sound('success');
      };

      // --- æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šæ—¥ä»˜å‰Šé™¤ï¼ˆä¸€è¦§è¡¨ã§ä½¿ã†ï¼‰ ---
      const openDeleteDay = (dateKey) => {
        sound('click');
        setDeleteTargetDate(dateKey);
        setShowDeleteModal(true);
      };

      const executeDeleteDay = () => {
        sound('click');
        const d = deleteTargetDate;
        if (!d) return;

        const nextDaily = { ...dailyRecords };
        delete nextDaily[d];

        const nextHistory = { ...history };
        delete nextHistory[d];

        setDailyRecords(nextDaily);
        setHistory(nextHistory);

        // recordsè¡¨ç¤ºä¸­ã®æ—¥ä»˜ãªã‚‰ãƒªã‚»ãƒƒãƒˆ
        if (targetDate === d) {
          const today = toLocalDateKey(new Date());
          setTargetDate(today);
        }

        setShowDeleteModal(false);
        setDeleteTargetDate(null);
        sound('success');
      };

      // --- è¨­å®šï¼ˆæ¤œå®šè¡¨ï¼‰ç·¨é›† ---
      const handleLevelReqChange = (category, levelIndex, trickId, value) => {
        const newData = { ...levelsData };
        const val = parseInt(value);

        if (isNaN(val) || val <= 0) {
          if (newData[category][levelIndex].reqs) {
            delete newData[category][levelIndex].reqs[trickId];
          }
        } else {
          if (!newData[category][levelIndex].reqs) newData[category][levelIndex].reqs = {};
          newData[category][levelIndex].reqs[trickId] = val;
        }
        setLevelsData(newData);
      };

      const handleTrickNameChange = (category, trickId, newName) => {
        const newNames = { ...trickNames };
        newNames[category][trickId] = newName;
        setTrickNames(newNames);
      };

      const handleLevelNameChange = (category, levelIndex, newName) => {
        const newData = { ...levelsData };
        newData[category][levelIndex].name = newName;
        setLevelsData(newData);
      };

      // --- æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šç›®æ¨™è¨­å®šï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ ---
      const saveGoalSettings = () => {
        sound('success');
        setShowGoalSettings(false);
      };

      // --- æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šç›®æ¨™æ›´æ–°ï¼ˆ20%UPï¼‰ ---
      const confirmGoalUpdate = () => {
        if (!pendingGoalUpdate) return;
        sound('success');
        setGoals(prev => ({ ...prev, [pendingGoalUpdate.trickId]: pendingGoalUpdate.newGoal }));
        setPendingGoalUpdate(null);
      };
      const closeGoalUpdate = () => {
        sound('click');
        setPendingGoalUpdate(null);
      };

      // ---------------------------
      // è¨­å®šç”»é¢ï¼ˆå…ˆç”Ÿç”¨ï¼‰
      // ---------------------------
      if (activeTab === 'settings' && IS_TEACHER_MODE) {
        return (
          <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-20">
            <header className="bg-slate-800 text-white p-4 sticky top-0 z-30 shadow-md flex items-center justify-between">
              <div className="flex items-center gap-2">
                <button onClick={() => { sound('click'); setActiveTab('home'); }} className="p-2 hover:bg-slate-700 rounded-full transition-colors">
                  <ArrowLeft size={20} />
                </button>
                <h1 className="text-lg font-bold flex items-center gap-2">
                  <Settings size={20} />
                  æ¤œå®šè¡¨ä½œæˆï¼ˆå…ˆç”Ÿç”¨ï¼‰
                </h1>
              </div>
              <div className="flex gap-2">
                <input
                  type="file"
                  ref={fileInputRef}
                  style={{ display: 'none' }}
                  accept=".json"
                  onChange={handleUploadJson}
                />
                <button onClick={() => { sound('click'); fileInputRef.current.click(); }} className="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-2 rounded-lg font-bold flex items-center gap-1 shadow-sm active:scale-95 transition-all text-xs sm:text-sm">
                  <Upload size={18} />
                  <span className="hidden sm:inline">è¨­å®šèª­è¾¼(JSON)</span>
                </button>
                <button onClick={handleDownloadJson} className="bg-orange-600 hover:bg-orange-500 text-white px-3 py-2 rounded-lg font-bold flex items-center gap-1 shadow-sm active:scale-95 transition-all text-xs sm:text-sm">
                  <Download size={18} />
                  <span className="hidden sm:inline">è¨­å®šä¿å­˜(JSON)</span>
                </button>
                <button onClick={handleExportHtml} className="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded-lg font-bold flex items-center gap-1 shadow-sm active:scale-95 transition-all text-xs sm:text-sm">
                  <FileDown size={18} />
                  <span className="hidden sm:inline">å…ç«¥é…ä»˜ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’</span>æ›¸ãå‡ºã—
                </button>
                <button onClick={handleSaveSettings} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-sm active:scale-95 transition-all text-sm">
                  <Save size={18} /> ä¿å­˜
                </button>
              </div>
            </header>

            <main className="p-4 max-w-full overflow-hidden">
              <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                  {[{id: 'low', label: '1ãƒ»2å¹´ç”¨'}, {id: 'mid', label: '3ãƒ»4å¹´ç”¨'}, {id: 'high', label: '5ãƒ»6å¹´ç”¨'}].map(tab => (
                    <button
                      key={tab.id}
                      onClick={() => { sound('click'); setSettingTab(tab.id); }}
                      className={`px-4 py-2 rounded-full font-bold whitespace-nowrap transition-colors ${settingTab === tab.id ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                    >
                      {tab.label}
                    </button>
                  ))}
                </div>

                <div className="text-sm text-slate-500 mb-2 flex items-center gap-2">
                  <AlertCircle size={16} />
                  <span>
                    ç¸¦è»¸ãŒç´šã€æ¨ªè»¸ãŒæŠ€ã§ã™ã€‚å¿…è¦ãªå›æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºæ¬„ã¯ã€Œãªã—ã€ï¼‰ã€‚<br/>
                    <strong>ç´šã®åå‰ï¼ˆä¾‹ï¼š20ç´šï¼‰ã‚’ç©ºæ¬„ã«ã™ã‚‹ã¨ã€ãã®ç´šã¯ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œãªããªã‚Šã¾ã™ï¼ˆç„¡åŠ¹åŒ–ï¼‰ã€‚</strong><br/>
                    æŠ€ã®åå‰ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ã‚‚ã‚¯ãƒªãƒƒã‚¯ã—ã¦å¤‰æ›´ã§ãã¾ã™ã€‚
                  </span>
                </div>
              </div>

              <div className="bg-white rounded-xl shadow border border-slate-200 overflow-hidden relative">
                <div className="overflow-x-auto custom-scrollbar">
                  <table className="w-full text-sm text-left border-collapse">
                    <thead className="bg-slate-100 text-slate-700 font-bold sticky top-0 z-20">
                      <tr>
                        <th className="p-3 border-b border-slate-200 min-w-[80px] text-center sticky-col">ç´š</th>
                        {TRICK_IDS.map(trickId => (
                          <th key={trickId} className="p-2 border-b border-r border-slate-200 min-w-[100px] align-bottom">
                            <div className="flex flex-col gap-1">
                              <input
                                type="text"
                                value={trickNames[settingTab][trickId]}
                                onChange={(e) => handleTrickNameChange(settingTab, trickId, e.target.value)}
                                className="bg-transparent border-b border-dashed border-slate-300 focus:border-blue-500 focus:outline-none text-center w-full font-bold text-xs py-1 select-text"
                              />
                            </div>
                          </th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {levelsData[settingTab].map((levelData, idx) => (
                        <tr key={levelData.level} className="hover:bg-slate-50 border-b border-slate-100 last:border-0">
                          <td className="p-2 font-bold text-center bg-slate-50 sticky-col text-slate-600">
                            <input
                              type="text"
                              value={levelData.name !== undefined ? levelData.name : `${levelData.level}ç´š`}
                              onChange={(e) => handleLevelNameChange(settingTab, idx, e.target.value)}
                              className={`w-full bg-transparent text-center focus:outline-none border-b border-transparent focus:border-blue-500 transition-colors select-text ${levelData.name === '' ? 'bg-red-50 text-red-300' : ''}`}
                              placeholder={`${levelData.level}ç´š`}
                            />
                          </td>
                          {TRICK_IDS.map(trickId => {
                            const count = levelData.reqs && levelData.reqs[trickId] ? levelData.reqs[trickId] : '';
                            return (
                              <td key={trickId} className="p-1 border-r border-slate-100 text-center">
                                <input
                                  type="number"
                                  min="0"
                                  value={count}
                                  onChange={(e) => handleLevelReqChange(settingTab, idx, trickId, e.target.value)}
                                  className={`w-full text-center p-1 rounded focus:outline-none focus:ring-2 focus:ring-blue-400 ${count ? 'font-bold text-blue-600 bg-blue-50/50' : 'text-slate-300'} select-text`}
                                  placeholder="-"
                                />
                              </td>
                            );
                          })}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              <div className="mt-8 text-center">
                <button onClick={handleResetSettings} className="text-red-400 hover:text-red-600 underline text-xs flex items-center justify-center gap-1 mx-auto">
                  <RotateCcw size={12} /> è¨­å®šã‚’åˆæœŸå€¤ã«æˆ»ã™
                </button>
              </div>
            </main>
          </div>
        );
      }

      // ---------------------------
      // ãƒ¡ã‚¤ãƒ³ç”»é¢
      // ---------------------------
      return (
        <div className="min-h-screen bg-sky-50 font-sans text-slate-800 pb-24 selection:bg-yellow-200">

          {/* âœ… æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šã‚³ãƒ”ãƒ¼æˆåŠŸãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {showCopyModal && (
            <div className="fixed inset-0 z-[9999] bg-black/50 flex items-center justify-center p-4">
              <div className="bg-white rounded-3xl p-6 w-full max-w-sm border-4 border-sky-300 shadow-2xl relative text-center animate-popIn">
                <div className="text-5xl mb-3">ğŸ“‹</div>
                <h3 className="text-xl font-extrabold text-sky-600 mb-2">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</h3>
                <p className="text-sm text-slate-600 mb-5 font-bold leading-relaxed whitespace-pre-line">
                  {copyModalMessage || 'è²¼ã‚Šä»˜ã‘ã¦ä½¿ã£ã¦ãã ã•ã„ã€‚'}
                </p>
                <button onClick={() => { sound('click'); setShowCopyModal(false); }} className="bg-sky-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-sky-600 transition w-full">
                  OK
                </button>
              </div>
            </div>
          )}

          {/* âœ… æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šç›®æ¨™é”æˆâ†’æ¬¡ç›®æ¨™ææ¡ˆãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {pendingGoalUpdate && (
            <div className="fixed inset-0 z-[9999] bg-black/60 flex items-center justify-center p-4">
              <div className="bg-white rounded-3xl p-6 w-full max-w-sm border-4 border-yellow-300 shadow-2xl relative overflow-hidden animate-popIn">
                <div className="absolute inset-0 bg-yellow-50 -z-10"></div>
                <button onClick={closeGoalUpdate} className="absolute top-3 right-3 text-slate-400 hover:text-slate-600 bg-slate-100 rounded-full p-2">
                  <X size={20} />
                </button>
                <div className="text-6xl mb-4 text-center">ğŸŠ</div>
                <h3 className="text-2xl font-extrabold text-orange-600 mb-2 text-center">ç›®æ¨™é”æˆï¼</h3>
                <p className="text-center font-bold text-slate-700 mb-4">ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</p>

                <div className="bg-white p-4 rounded-xl border border-orange-200 mb-5 text-center shadow-sm">
                  <div className="text-sm text-slate-500 font-bold mb-1">æ¬¡ã®ç›®æ¨™</div>
                  <div className="text-lg font-bold text-sky-600 mb-2">
                    {displayTricks.find(t => t.id === pendingGoalUpdate.trickId)?.label || 'ã“ã®ç¨®ç›®'}
                  </div>
                  <div className="flex items-center justify-center gap-2 text-xl font-extrabold text-orange-600">
                    <span className="line-through text-slate-400 text-base">{pendingGoalUpdate.oldGoal}</span>
                    <span>â†’</span>
                    <span className="text-3xl">{pendingGoalUpdate.newGoal}</span>
                    <span className="text-sm">å›</span>
                  </div>
                  <div className="text-xs text-orange-400 font-bold mt-1">(20% UP!)</div>
                </div>

                <p className="text-center font-bold text-slate-600 mb-4">ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ</p>
                <div className="flex gap-3">
                  <button onClick={closeGoalUpdate} className="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-3 rounded-xl transition">ã„ã„ãˆ</button>
                  <button onClick={confirmGoalUpdate} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl shadow-lg transition">ã¯ã„</button>
                </div>
              </div>
            </div>
          )}

          {/* âœ… æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {showImportModal && (
            <div className="fixed inset-0 z-[9999] bg-black/50 flex items-center justify-center p-4">
              <div className="bg-white rounded-3xl p-6 w-full max-w-lg border-4 border-green-300 shadow-2xl relative flex flex-col max-h-[90vh] animate-popIn">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-xl font-extrabold text-green-600">ğŸ“¥ è¨˜éŒ²ã‚’å¾©å…ƒï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰</h3>
                  <button onClick={() => { sound('click'); setShowImportModal(false); }} className="text-slate-400 hover:text-slate-600 text-2xl font-bold bg-slate-100 rounded-full w-8 h-8 flex items-center justify-center">Ã—</button>
                </div>
                <p className="text-xs text-slate-500 mb-2">
                  ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ï¼ˆ<span className="font-bold">æ—¥ä»˜</span>ï¼‹<span className="font-bold">ç¨®ç›®åˆ—</span>ï¼‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
                </p>
                <textarea
                  value={importText}
                  onChange={(e) => setImportText(e.target.value)}
                  className="w-full h-44 border-2 border-slate-200 rounded-xl p-3 text-xs font-mono bg-slate-50 mb-4 focus:ring-2 focus:ring-green-400 outline-none resize-none"
                  placeholder="ï¼ˆä¾‹ï¼‰&#10;æ—¥ä»˜\tã¾ãˆã¨ã³\tã†ã—ã‚ã¨ã³&#10;2026-01-10\t10\t5&#10;2026-01-11\t12\t0"
                />
                <div className="flex gap-3 shrink-0">
                  <button onClick={() => { sound('click'); setShowImportModal(false); }} className="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-3 rounded-xl transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                  <button onClick={executeImport} className="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg transition">èª­ã¿è¾¼ã‚€</button>
                </div>
              </div>
            </div>
          )}

          {/* âœ… æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šæ—¥ä»˜å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {showDeleteModal && (
            <div className="fixed inset-0 z-[9999] bg-black/50 flex items-center justify-center p-4">
              <div className="bg-white rounded-3xl p-6 w-full max-w-xs border-4 border-slate-200 shadow-xl animate-popIn">
                <h3 className="text-lg font-bold text-slate-700 mb-3 text-center">ã“ã®æ—¥ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h3>
                <p className="text-sm text-slate-500 mb-5 text-center">ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
                <div className="flex gap-3">
                  <button onClick={() => { sound('click'); setShowDeleteModal(false); setDeleteTargetDate(null); }} className="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-2 rounded-xl">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                  <button onClick={executeDeleteDay} className="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-xl shadow-md">æ¶ˆã™</button>
                </div>
              </div>
            </div>
          )}

          {/* âœ… æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šæ—¥ä»˜å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {showDateEditModal && dateEditTarget && (
            <div className="fixed inset-0 z-[9999] bg-black/50 flex items-center justify-center p-4">
              <div className="bg-white rounded-3xl p-6 w-full max-w-sm border-4 border-orange-200 shadow-2xl animate-popIn">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-xl font-bold text-orange-600 flex items-center gap-2">
                    <CalendarDays size={18}/> æ—¥ä»˜ã‚’å¤‰æ›´
                  </h3>
                  <button onClick={() => { sound('click'); setShowDateEditModal(false); }} className="text-slate-400 hover:text-slate-600 text-2xl font-bold bg-slate-100 rounded-full w-8 h-8 flex items-center justify-center">Ã—</button>
                </div>
                <div className="text-xs text-slate-500 font-bold mb-2">ç¾åœ¨ï¼š{dateEditTarget.oldDate}</div>
                <div className="bg-orange-50 border border-orange-200 rounded-xl p-3 mb-4">
                  <input
                    type="date"
                    value={dateEditTarget.newDate}
                    onChange={(e) => setDateEditTarget(prev => ({ ...prev, newDate: e.target.value }))}
                    className="w-full px-3 py-2 rounded-lg border border-slate-200 font-bold text-slate-700"
                  />
                  <div className="text-[11px] text-orange-600 font-bold mt-2">
                    â€» ã™ã§ã«ã‚ã‚‹æ—¥ä»˜ã«ã¯å¤‰æ›´ã§ãã¾ã›ã‚“ï¼ˆä¸Šæ›¸ãé˜²æ­¢ï¼‰
                  </div>
                </div>
                <div className="flex gap-3">
                  <button onClick={() => { sound('click'); setShowDateEditModal(false); }} className="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-3 rounded-xl">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                  <button onClick={applyDateEdit} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl shadow-lg">å¤‰æ›´ã™ã‚‹</button>
                </div>
              </div>
            </div>
          )}

          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          <header className="bg-white shadow-sm sticky top-0 z-10 border-b border-sky-100">
            <div className="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-2">
                {activeTab !== 'home' ? (
                  <button
                    onClick={() => { sound('click'); setActiveTab('home'); }}
                    className="flex items-center gap-1.5 text-sky-600 bg-sky-50 hover:bg-sky-100 px-3 py-1.5 rounded-lg font-bold transition-all active:scale-95 border border-sky-200"
                  >
                    <Home size={18} />
                    <span>è¡¨ç´™ã¸</span>
                  </button>
                ) : (
                  <div className="flex items-center gap-2">
                    <div className="bg-yellow-400 p-2 rounded-full text-white shadow-sm">
                      <Activity size={20} strokeWidth={2.5} />
                    </div>
                    <div>
                      <h1 className="text-base font-bold text-sky-600 leading-tight">ãªã‚ã¨ã³ãƒã‚¹ã‚¿ãƒ¼</h1>
                    </div>
                  </div>
                )}
              </div>
              <div className="text-right">
                <div className="text-[10px] text-slate-400 font-bold">ã’ã‚“ã–ã„ã®ãã‚…ã†</div>
                <div className="text-xl font-black text-pink-500 leading-none">
                  {currentBestLevel ? currentBestLevel.name : 'â€•'}
                </div>
              </div>
            </div>
          </header>

          {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
          <main className="max-w-2xl mx-auto px-4 py-6 space-y-6 h-full flex flex-col justify-center min-h-[80vh]">

            {/* ç¥è³€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆç´šã‚¢ãƒƒãƒ—ï¼‰ */}
            {showConfetti && (
              <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fadeIn p-4">
                <div className="bg-white p-8 rounded-3xl shadow-2xl border-4 border-yellow-400 text-center relative max-w-sm w-full animate-popIn overflow-hidden">
                  <button onClick={() => { sound('click'); setShowConfetti(false); }} className="absolute top-3 right-3 text-slate-400 hover:text-slate-600 bg-slate-100 rounded-full p-2 z-10">
                    <X size={24} />
                  </button>
                  <div className="absolute inset-0 bg-confetti opacity-30 pointer-events-none"></div>

                  <Trophy size={80} className="mx-auto text-yellow-500 mb-4 drop-shadow-md relative z-10" />
                  <h2 className="text-3xl font-black text-pink-500 mb-2 relative z-10">ãŠã‚ã§ã¨ã†ï¼</h2>
                  <div className="text-4xl font-black text-slate-700 mb-6 relative z-10">{currentBestLevel?.name} <span className="text-xl">åˆæ ¼</span></div>

                  <button onClick={() => { sound('success'); setShowConfetti(false); }} className="bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition-all active:scale-95 relative z-10">
                    ã‚„ã£ãŸã­ï¼
                  </button>
                </div>
              </div>
            )}

            {/* è¡¨ç´™ */}
            {activeTab === 'home' && (
              <div className="space-y-4 animate-fadeIn">
                <div className="bg-white rounded-2xl shadow-xl border-4 border-sky-100 overflow-hidden relative">
                  <div className="bg-sky-50 p-4 text-center border-b border-sky-100 relative">
                    {IS_TEACHER_MODE && (
                      <div className="absolute top-3 right-3">
                        <button onClick={() => { sound('click'); setActiveTab('settings'); }} className="flex items-center gap-1 p-1.5 text-sky-400 hover:text-sky-600 hover:bg-sky-50 rounded-lg transition-all text-xs font-bold" title="è¨­å®šï¼ˆå…ˆç”Ÿç”¨ï¼‰">
                          <Settings size={16} />
                          <span>æ¤œå®šè¡¨ã‚’ç·¨é›†</span>
                        </button>
                      </div>
                    )}
                    <div className="inline-block bg-white p-2 rounded-full shadow-sm mb-1 text-sky-500">
                      <School size={24} />
                    </div>
                    <h2 className="text-xl font-black text-slate-700 tracking-tight">ãªã‚ã¨ã³æ¤œå®šã‚«ãƒ¼ãƒ‰</h2>
                    <p className="text-[10px] text-slate-400 mt-0.5">å…¨å›½ã®æ¤œå®šè¡¨ã‚’å‚ç…§ãƒ»çµ±åˆã—ãŸæ¨™æº–ãƒ¢ãƒ‡ãƒ«ï¼ˆ20ç´šï½1ç´šï¼‰</p>
                  </div>

                  <div className="p-4">
                    {/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å…¥åŠ› */}
                    <div className="bg-sky-50/50 p-3 rounded-lg border-2 border-sky-100 mb-4">
                      <div className="flex items-center gap-2 text-sky-600 mb-2">
                        <Pencil size={14} />
                        <span className="text-xs font-bold">ã“ã“ã« ãªã¾ãˆ ã‚’ ã‹ã„ã¦ã­</span>
                      </div>

                      <div className="flex gap-2 flex-wrap">
                        <div className="w-24">
                          <select
                            value={user.grade}
                            onChange={(e) => { sound('click'); setUser(prev => ({ ...prev, grade: parseInt(e.target.value) })); }}
                            className="w-full p-2 rounded-md border border-sky-200 bg-white text-base font-bold focus:border-sky-400 focus:outline-none select-text"
                          >
                            {[1,2,3,4,5,6].map(g => <option key={g} value={g}>{g} å¹´</option>)}
                          </select>
                        </div>
                        <div className="w-16">
                          <input
                            type="text"
                            value={user.classVal}
                            onChange={(e) => setUser(prev => ({ ...prev, classVal: e.target.value }))}
                            placeholder="çµ„"
                            className="w-full p-2 rounded-md border border-sky-200 bg-white text-base font-bold focus:border-sky-400 focus:outline-none text-center select-text"
                          />
                        </div>
                        <div className="w-16">
                          <input
                            type="text"
                            value={user.number}
                            onChange={(e) => setUser(prev => ({ ...prev, number: e.target.value }))}
                            placeholder="ç•ª"
                            className="w-full p-2 rounded-md border border-sky-200 bg-white text-base font-bold focus:border-sky-400 focus:outline-none text-center select-text"
                          />
                        </div>
                        <div className="flex-1 min-w-[180px]">
                          <input
                            type="text"
                            value={user.name}
                            onChange={(e) => setUser(prev => ({ ...prev, name: e.target.value }))}
                            placeholder="ãªã¾ãˆ"
                            className="w-full p-2 rounded-md border border-sky-200 bg-white text-base font-bold focus:border-sky-400 focus:outline-none select-text"
                          />
                        </div>
                      </div>
                    </div>

                    <div className="grid grid-cols-1 gap-3">
                      <button
                        onClick={() => { sound('click'); setActiveTab('input'); }}
                        className="flex items-center gap-3 p-3 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-xl transition-all active:scale-95 group shadow-sm hover:shadow-md"
                      >
                        <div className="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center shadow-md group-hover:scale-110 transition-transform flex-shrink-0">
                          <RefreshCw size={20} />
                        </div>
                        <div className="text-left">
                          <div className="text-lg font-black text-blue-700 leading-tight">ãã‚ã ã‚’ ã¤ã‘ã‚‹</div>
                          <div className="text-[10px] text-blue-500 font-bold">ã•ã„ã“ã† ãã‚ã ã« ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼</div>
                        </div>
                      </button>

                      {/* âœ… æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šåˆè¨ˆã¨ç›®æ¨™ */}
                      <button
                        onClick={() => { sound('click'); setActiveTab('stats'); }}
                        className="flex items-center gap-3 p-3 bg-orange-50 hover:bg-orange-100 border-2 border-orange-200 rounded-xl transition-all active:scale-95 group shadow-sm hover:shadow-md"
                      >
                        <div className="w-10 h-10 bg-orange-500 text-white rounded-full flex items-center justify-center shadow-md group-hover:scale-110 transition-transform flex-shrink-0">
                          <BarChart3 size={20} />
                        </div>
                        <div className="text-left">
                          <div className="text-lg font-black text-orange-700 leading-tight">ã”ã†ã‘ã„ ã¨ ã‚‚ãã²ã‚‡ã†</div>
                          <div className="text-[10px] text-orange-600 font-bold">ãŸã£ã›ã„ ã§ ã¤ãã® ã‚‚ãã²ã‚‡ã†ï¼</div>
                        </div>
                      </button>

                      <button
                        onClick={() => { sound('click'); setActiveTab('cert'); }}
                        className="flex items-center gap-3 p-3 bg-pink-50 hover:bg-pink-100 border-2 border-pink-200 rounded-xl transition-all active:scale-95 group shadow-sm hover:shadow-md"
                      >
                        <div className="w-10 h-10 bg-pink-500 text-white rounded-full flex items-center justify-center shadow-md group-hover:scale-110 transition-transform flex-shrink-0">
                          <Award size={20} />
                        </div>
                        <div className="text-left">
                          <div className="text-lg font-black text-pink-700 leading-tight">ã«ã‚“ã¦ã„ã—ã‚‡ã†</div>
                          <div className="text-[10px] text-pink-500 font-bold">ã„ã¾ã® ãã‚…ã† ã‚’ ã‹ãã«ã‚“</div>
                        </div>
                      </button>

                      <button
                        onClick={() => { sound('click'); setActiveTab('history'); }}
                        className="flex items-center gap-3 p-3 bg-green-50 hover:bg-green-100 border-2 border-green-200 rounded-xl transition-all active:scale-95 group shadow-sm hover:shadow-md"
                      >
                        <div className="w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center shadow-md group-hover:scale-110 transition-transform flex-shrink-0">
                          <ClipboardList size={20} />
                        </div>
                        <div className="text-left">
                          <div className="text-lg font-black text-green-700 leading-tight">ãŒã‚“ã°ã‚Šè¡¨</div>
                          <div className="text-[10px] text-green-500 font-bold">ã‚Œã‚“ã—ã‚…ã† ã® ã„ã¡ã‚‰ã‚“ãƒ»ã‚³ãƒ”ãƒ¼</div>
                        </div>
                      </button>
                    </div>

                    <div className="mt-4 text-center">
                      <button
                        onClick={handleReset}
                        className="text-[10px] text-slate-300 hover:text-red-400 underline flex items-center justify-center gap-1 mx-auto"
                      >
                        <RotateCcw size={10} />
                        ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰å§‹ã‚ã‚‹
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* è¨˜éŒ²å…¥åŠ› */}
            {activeTab === 'input' && (
              <div className="space-y-4 animate-fadeIn">
                <div className="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
                  <div className="flex justify-between items-end mb-2">
                    <h2 className="text-lg font-bold text-slate-700 flex items-center gap-2 mb-1">
                      <RefreshCw size={20} className="text-sky-500" />
                      ãã‚ãã‚’ã„ã‚Œã‚ˆã†
                    </h2>

                    <div className="flex flex-col items-end gap-1">
                      <span className="text-[10px] text-sky-500 font-bold">ãã‚ãã™ã‚‹ã²ã‚’ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ ãˆã‚‰ã‚“ã§ã­</span>
                      <div className="flex gap-2">
                        <div className="relative">
                          <input
                            type="date"
                            value={targetDate}
                            onChange={(e) => { sound('click'); setTargetDate(e.target.value); }}
                            className="pl-8 pr-2 py-1.5 rounded-lg border border-slate-200 text-xs font-bold text-slate-600 focus:outline-none focus:border-sky-400"
                          />
                          <CalendarDays className="absolute left-2 top-1.5 text-slate-400 pointer-events-none" size={14} />
                        </div>

                        <button
                          onClick={handleCopyToClipboard}
                          className="flex items-center gap-1 bg-emerald-50 hover:bg-emerald-100 text-emerald-600 border border-emerald-200 px-3 py-1.5 rounded-lg text-xs font-bold transition-all active:scale-95"
                        >
                          <Copy size={14} />
                          <span>ã‚³ãƒ”ãƒ¼</span>
                        </button>
                      </div>
                    </div>
                  </div>

                  {(targetDate !== toLocalDateKey(new Date()) || Object.keys(records).length > 0) && (
                    <div className="text-xs text-orange-500 bg-orange-50 p-2 rounded mb-2 border border-orange-200 text-center font-bold">
                      æ•°å­—ã‚’ã‹ãˆãŸã‚‰ã‘ã£ã¦ã„ãƒœã‚¿ãƒ³ã‚’ãŠã—ã¾ã™
                    </div>
                  )}

                  <p className="text-xs text-slate-400 mb-4 ml-7">
                    ã²ã£ã‹ã‹ã‚‰ãšã« <span className="text-pink-500 font-bold">ã‚Œã‚“ãã</span> ã§ã¨ã¹ãŸå›æ•°
                  </p>

                  <div className="space-y-3">
                    {displayTricks.map((trick) => {
                      const currentCount = records[trick.id] || 0;
                      const currentCountNum = parseInt(currentCount || 0);

                      const savedCount = dailyRecords[targetDate]?.[trick.id];
                      const savedCountNum = parseInt(savedCount || 0);
                      const isSaved = currentCountNum === savedCountNum;

                      const currentMax = maxRecords[trick.id] || 0;
                      const bestLevel = getTrickLevel(trick.id);

                      return (
                        <div key={trick.id} className={`flex items-center justify-between p-3 rounded-xl bg-white border-2 hover:border-sky-300 transition-colors ${trick.color.replace('text', 'border').split(' ')[2]}`}>
                          <div className="flex items-center gap-3">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm shadow-sm ${trick.color}`}>
                              {trick.label.substring(0, 1)}
                            </div>
                            <div>
                              <div className="font-bold text-slate-700 flex flex-wrap items-center gap-x-2 gap-y-1">
                                <span>{trick.label}</span>

                                <span className="text-xs text-orange-600 font-bold bg-orange-50 px-1.5 py-0.5 rounded border border-orange-200">
                                  æœ€é«˜:{currentMax}
                                </span>

                                {bestLevel && (
                                  <span className="bg-yellow-100 text-yellow-700 text-xs px-2 py-0.5 rounded-full border border-yellow-300 font-black whitespace-nowrap">
                                    {bestLevel}ç´š
                                  </span>
                                )}

                                {/* âœ… æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šåˆè¨ˆ/ç›®æ¨™ï¼ˆãƒŸãƒ‹è¡¨ç¤ºï¼‰ */}
                                <span className="text-[11px] text-slate-500 font-bold bg-slate-50 px-2 py-0.5 rounded border border-slate-200">
                                  åˆè¨ˆ:{totals[trick.id] || 0}/{goals[trick.id] || defaultGoalForTrick(trick.id)}
                                </span>
                              </div>
                              <div className="text-xs text-slate-400 opacity-0 h-0 overflow-hidden">{trick.label}</div>
                            </div>
                          </div>

                          <div className="flex items-center gap-2">
                            <button
                              onClick={() => updateRecord(trick.id, Math.max(0, (parseInt(records[trick.id] || 0) - 1)))}
                              className="w-10 h-10 rounded-full bg-slate-50 border border-slate-200 text-slate-400 flex items-center justify-center active:scale-95 touch-manipulation hover:bg-slate-100"
                            >
                              <ChevronDown size={20} />
                            </button>

                            <input
                              type="number"
                              inputMode="numeric"
                              pattern="\d*"
                              className={`w-16 text-center font-black text-2xl bg-transparent border-b-2 border-slate-200 focus:border-sky-500 focus:outline-none p-1 select-text ime-active ${isSaved ? 'text-sky-600' : 'text-slate-800'}`}
                              value={parseInt(records[trick.id] || 0) > 0 ? records[trick.id] : ''}
                              placeholder="0"
                              onFocus={(e) => {
                                const target = e.target;
                                requestAnimationFrame(() => target.select());
                              }}
                              onChange={(e) => updateRecord(trick.id, e.target.value)}
                            />

                            <span className="text-xs font-bold text-slate-400 mt-2 whitespace-nowrap">å›</span>

                            <button
                              onClick={() => updateRecord(trick.id, (parseInt(records[trick.id] || 0) + 1))}
                              className="w-10 h-10 rounded-full bg-sky-100 text-sky-600 flex items-center justify-center active:scale-95 shadow-sm touch-manipulation hover:bg-sky-200"
                            >
                              <ChevronUp size={20} />
                            </button>

                            <button
                              onClick={() => handleConfirmRecord(trick.id)}
                              className={`ml-1 text-xs font-bold py-2 px-3 rounded-lg shadow-sm active:scale-95 transition-all flex flex-col items-center leading-none ${
                                isSaved
                                ? 'bg-sky-100 text-sky-600 border-2 border-sky-200'
                                : 'bg-green-500 hover:bg-green-600 text-white animate-pulse'
                              }`}
                            >
                              {isSaved ? (
                                <>
                                  <CheckCircle size={16} className="mb-0.5" />
                                  <span>ä¿å­˜æ¸ˆ</span>
                                </>
                              ) : (
                                <>
                                  <Check size={16} className="mb-0.5" />
                                  <span>ã‘ã£ã¦ã„</span>
                                </>
                              )}
                            </button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                <button
                  onClick={() => { sound('click'); setActiveTab('home'); }}
                  className="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-4 rounded-xl transition-all flex items-center justify-center gap-2 mt-6 border-2 border-slate-200"
                >
                  <Home size={20} />
                  è¡¨ç´™ï¼ˆãƒ›ãƒ¼ãƒ ï¼‰ã«ã‚‚ã©ã‚‹
                </button>
              </div>
            )}

            {/* âœ… æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šåˆè¨ˆã¨ç›®æ¨™ï¼ˆstatsï¼‰ */}
            {activeTab === 'stats' && (
              <div className="space-y-4 animate-fadeIn">
                <div className="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                  <div className="flex items-center justify-between gap-2 mb-3">
                    <h2 className="text-lg font-black text-orange-600 flex items-center gap-2">
                      <BarChart3 size={20} />
                      åˆè¨ˆã¨ç›®æ¨™
                    </h2>

                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => { sound('click'); setShowGoalSettings(true); }}
                        className="bg-orange-100 hover:bg-orange-200 text-orange-700 text-xs font-bold px-3 py-2 rounded-full transition flex items-center gap-1 shadow-sm border border-orange-200"
                      >
                        <Settings size={14} />
                        ç›®æ¨™ã®è¨­å®š
                      </button>

                      <button
                        onClick={() => { sound('click'); setActiveTab('input'); }}
                        className="bg-sky-100 hover:bg-sky-200 text-sky-700 text-xs font-bold px-3 py-2 rounded-full transition flex items-center gap-1 shadow-sm border border-sky-200"
                      >
                        <Pencil size={14}/>
                        è¨˜éŒ²ã™ã‚‹
                      </button>
                    </div>
                  </div>

                  <div className="text-[11px] text-slate-500 font-bold mb-4 flex items-center gap-2">
                    <Sparkles size={14} className="text-orange-500"/>
                    åˆè¨ˆãŒç›®æ¨™ã«å±Šãã¨ã€Œæ¬¡ã®ç›®æ¨™ï¼ˆ+20%ï¼‰ã€ãŒå‡ºã¾ã™ã€‚
                  </div>

                  <div className="space-y-3">
                    {displayTricks.map(trick => {
                      const total = totals[trick.id] || 0;
                      const goal = goals[trick.id] || defaultGoalForTrick(trick.id);
                      const pct = goal > 0 ? Math.min(100, Math.floor((total / goal) * 100)) : 0;
                      const achieved = total >= goal;

                      return (
                        <div key={trick.id} className="p-4 rounded-2xl border border-slate-200 bg-white">
                          <div className="flex items-center justify-between gap-3">
                            <div className="flex items-center gap-3">
                              <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm shadow-sm ${trick.color}`}>
                                {trick.label.substring(0,1)}
                              </div>
                              <div>
                                <div className="font-black text-slate-700">{trick.label}</div>
                                <div className="text-xs text-slate-400 font-bold">
                                  åˆè¨ˆ <span className="text-slate-700">{total}</span> ï¼ ç›®æ¨™ <span className="text-slate-700">{goal}</span>
                                </div>
                              </div>
                            </div>

                            <div className={`text-xs font-black px-3 py-1 rounded-full border ${achieved ? 'bg-yellow-50 text-yellow-700 border-yellow-300' : 'bg-slate-50 text-slate-500 border-slate-200'}`}>
                              {achieved ? 'é”æˆï¼' : `${pct}%`}
                            </div>
                          </div>

                          <div className="mt-3">
                            <div className="w-full h-3 bg-slate-100 rounded-full overflow-hidden border border-slate-200">
                              <div className="h-full bg-orange-400" style={{ width: `${pct}%` }}></div>
                            </div>
                          </div>

                          <div className="mt-3 flex items-center justify-between text-xs">
                            <button
                              onClick={() => { sound('click'); checkAndTriggerGoalUpdate(trick.id, total); }}
                              className="text-orange-600 font-bold underline"
                              title="ä»Šã®åˆè¨ˆã§ç›®æ¨™ãƒã‚§ãƒƒã‚¯ï¼ˆæ‰‹å‹•ï¼‰"
                            >
                              ç›®æ¨™ãƒã‚§ãƒƒã‚¯
                            </button>
                            <div className="text-slate-400 font-bold flex items-center gap-1">
                              <Volume2 size={14} />
                              åŠ¹æœéŸ³ï¼šONï¼ˆç«¯æœ«è¨­å®šã§ãƒŸãƒ¥ãƒ¼ãƒˆå¯ï¼‰
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* âœ… ç›®æ¨™è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */}
                {showGoalSettings && (
                  <div className="fixed inset-0 z-[9999] bg-black/50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl p-6 w-full max-w-md border-4 border-sky-200 shadow-2xl max-h-[90vh] flex flex-col animate-popIn">
                      <div className="flex justify-between items-center mb-3">
                        <h3 className="text-xl font-black text-sky-600 flex items-center gap-2">
                          <Settings size={18}/> ç¨®ç›®ã¨ç›®æ¨™ã®è¨­å®š
                        </h3>
                        <button onClick={() => { sound('click'); setShowGoalSettings(false); }} className="text-slate-400 hover:text-slate-600 text-2xl font-bold">Ã—</button>
                      </div>
                      <p className="text-xs text-slate-500 mb-2">ç›®æ¨™å›æ•°ã‚’å¤‰ãˆã‚‰ã‚Œã¾ã™ï¼ˆåˆè¨ˆã«å¯¾ã™ã‚‹ç›®æ¨™ã§ã™ï¼‰ã€‚</p>

                      <div className="space-y-3 overflow-y-auto flex-1 pr-1">
                        {displayTricks.map(trick => (
                          <div key={trick.id} className="bg-sky-50 p-3 rounded-xl border border-sky-100 flex items-center justify-between gap-3">
                            <div className="font-bold text-slate-700">{trick.label}</div>
                            <div className="flex items-center gap-2">
                              <input
                                type="number"
                                value={goals[trick.id] || defaultGoalForTrick(trick.id)}
                                onChange={(e) => setGoals(prev => ({ ...prev, [trick.id]: Math.max(1, parseInt(e.target.value || 0)) }))}
                                className="w-28 text-right font-black p-2 rounded-lg border border-sky-200 bg-white"
                              />
                              <span className="text-xs font-bold text-slate-500">å›</span>
                            </div>
                          </div>
                        ))}
                      </div>

                      <div className="flex gap-2 mt-4">
                        <button onClick={() => { sound('click'); setShowGoalSettings(false); }} className="flex-1 bg-slate-200 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-300">é–‰ã˜ã‚‹</button>
                        <button onClick={saveGoalSettings} className="flex-1 bg-sky-500 text-white font-bold py-3 rounded-xl hover:bg-sky-600 shadow-md">ä¿å­˜</button>
                      </div>
                    </div>
                  </div>
                )}

                <button
                  onClick={() => { sound('click'); setActiveTab('home'); }}
                  className="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-4 rounded-xl transition-all flex items-center justify-center gap-2 mt-2 border-2 border-slate-200"
                >
                  <Home size={20} />
                  è¡¨ç´™ï¼ˆãƒ›ãƒ¼ãƒ ï¼‰ã«ã‚‚ã©ã‚‹
                </button>
              </div>
            )}

            {/* èªå®šè¨¼ï¼ˆç¾ã‚³ãƒ¼ãƒ‰ã®ã¾ã¾ï¼‰ */}
            {activeTab === 'cert' && (
              <div className="space-y-6 animate-fadeIn">

                {user.grade <= 2 && (
                  <div className="bg-white rounded-3xl p-6 shadow-lg border-4 border-pink-200 relative overflow-hidden text-center">
                    <div className="absolute top-0 left-0 w-full h-4 bg-pink-200"></div>
                    <div className="mt-4 mb-2">
                      <div className="inline-block p-3 bg-pink-100 rounded-full text-pink-500 mb-2"><Star size={32} fill="currentColor" /></div>
                      <h2 className="text-2xl font-black text-pink-500">ã«ã‚“ã¦ã„ã—ã‚‡ã†</h2>
                    </div>
                    <div className="text-lg font-bold text-slate-700 mb-4">
                      {user.grade}ã­ã‚“ {user.classVal}ãã¿ {user.number}ã°ã‚“<br/>
                      <span className="text-2xl border-b-2 border-pink-300 px-2">{user.name ? user.name : 'ï¼ˆãªã¾ãˆï¼‰'}</span> ã•ã‚“
                    </div>
                    <div className="bg-pink-50 rounded-xl p-4 mb-4">
                      <p className="text-sm text-pink-400 font-bold mb-1">ã‚ãªãŸã¯</p>
                      <p className="text-5xl font-black text-pink-600 tracking-tight my-2">
                        {currentBestLevel ? currentBestLevel.name : 'ãŒã‚“ã°ã‚Šä¸­'}
                      </p>
                      <p className="text-sm text-pink-400 font-bold">ã«ã”ã†ã‹ãã—ã¾ã—ãŸï¼</p>
                    </div>
                    <div className="text-xs text-slate-400 font-bold">ã‚ˆããŒã‚“ã°ã‚Šã¾ã—ãŸ</div>
                    <div className="absolute -bottom-6 -right-6 w-24 h-24 bg-yellow-200 rounded-full opacity-50"></div>
                    <div className="absolute -bottom-6 -left-6 w-20 h-20 bg-blue-200 rounded-full opacity-50"></div>
                  </div>
                )}

                {(user.grade === 3 || user.grade === 4) && (
                  <div className="bg-white rounded-xl p-8 shadow-lg border border-sky-200 relative text-center">
                    <div className="border-4 border-double border-sky-100 p-6 rounded-lg">
                      <div className="mb-4">
                        <Award size={48} className="mx-auto text-sky-500" />
                        <h2 className="text-3xl font-serif font-black text-sky-700 mt-2">èªå®šè¨¼</h2>
                      </div>
                      <div className="text-left bg-sky-50/50 p-4 rounded-lg mb-6 text-slate-700 font-serif">
                        <p className="mb-2">ç¬¬ {user.grade} å­¦å¹´ {user.classVal} çµ„ {user.number} ç•ª</p>
                        <p className="text-2xl font-bold border-b border-sky-300 pb-1 mb-4 inline-block min-w-[200px] text-center">{user.name ? user.name : 'ï¼ˆåå‰ï¼‰'} æ®¿</p>
                        <p className="leading-relaxed text-sm">
                          ã‚ãªãŸã¯ã€ãªã‚ã¨ã³æ¤œå®šã«ãŠã„ã¦<br/>
                          é ­æ›¸ã®æˆç¸¾ã‚’åã‚ã‚‰ã‚Œã¾ã—ãŸã€‚<br/>
                          ã‚ˆã£ã¦ã“ã“ã«ã“ã‚Œã‚’è¨¼ã—ã¾ã™ã€‚
                        </p>
                      </div>
                      <div className="text-center">
                        <p className="text-sm font-bold text-sky-500">èªå®šç´š</p>
                        <p className="text-4xl font-black text-sky-800 border-2 border-sky-600 inline-block px-8 py-2 rounded-md mt-1 bg-white">
                          {currentBestLevel ? currentBestLevel.name : 'â€•'}
                        </p>
                      </div>
                    </div>
                  </div>
                )}

                {user.grade >= 5 && (
                  <div className="bg-slate-50 rounded-sm p-8 shadow-xl border-t-8 border-gold-500 relative text-center" style={{borderColor: '#d4af37'}}>
                    <div className="absolute top-4 right-4 text-xs text-slate-400 font-mono">ID: {Math.random().toString(36).substr(2, 9).toUpperCase()}</div>
                    <div className="mb-8 mt-2">
                      <div className="text-xs tracking-[0.2em] text-slate-500 uppercase font-bold mb-1">Certificate of Achievement</div>
                      <h2 className="text-4xl font-serif font-bold text-slate-800 border-b-2 border-slate-300 inline-block pb-2 px-4">è¨˜éŒ²è¨¼</h2>
                    </div>

                    <div className="flex justify-between items-end mb-8 px-4">
                      <div className="text-left">
                        <p className="text-sm text-slate-500">Name</p>
                        <p className="text-xl font-bold text-slate-800">{user.name ? user.name : '__________'}</p>
                      </div>
                      <div className="text-right">
                        <p className="text-sm text-slate-500">Grade</p>
                        <p className="text-xl font-bold text-slate-800">{user.grade} - {user.classVal} - {user.number}</p>
                      </div>
                    </div>

                    <div className="bg-white border border-slate-200 p-8 rounded-sm shadow-inner mb-6">
                      <p className="text-sm text-slate-500 font-serif italic mb-2">Achieved Level</p>
                      <p className="text-5xl font-serif font-bold text-[#d4af37]" style={{textShadow: '1px 1px 0px rgba(0,0,0,0.1)'}}>
                        {currentBestLevel ? currentBestLevel.name : 'Unranked'}
                      </p>
                    </div>

                    <div className="text-left text-xs text-slate-400 mt-8 border-t border-slate-200 pt-2">
                      å¤§é˜ªãªã‚ã¨ã³ç´šåˆ¤å®šåŸºæº–æº–æ‹ <br/>
                      Osaka Jump Rope Assessment Standards
                    </div>
                  </div>
                )}

                {/* å…±é€š: é€²æ—ãƒªã‚¹ãƒˆï¼ˆé”æˆæ¸ˆã¿ã¯éè¡¨ç¤ºï¼‰ */}
                <div className="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
                  <h3 className="font-bold text-slate-700 mb-3 text-sm flex items-center gap-2">
                    <Target size={18} className="text-red-500" />
                    {goalTitle}
                  </h3>
                  <div className="space-y-2">
                    {nextLevels.length > 0 ? (
                      nextLevels.map((lvl) => (
                        <div key={lvl.level} className="p-3 rounded-lg border border-slate-100 bg-white text-slate-500 text-xs flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <span className="font-bold text-sm text-slate-400">{lvl.name}</span>
                            <div className="flex flex-wrap gap-1">
                              {Object.entries(lvl.reqs).map(([trickId, count]) => {
                                const trick = displayTricks.find(t => t.id === trickId);
                                if (!trick || !count) return null;
                                return (
                                  <span key={trickId} className="px-1.5 py-0.5 rounded border bg-slate-50 border-slate-200">
                                    {trick.label}: {count}å›
                                  </span>
                                );
                              })}
                            </div>
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="text-center p-6 bg-yellow-50 rounded-xl border border-yellow-200">
                        <Trophy size={40} className="mx-auto text-yellow-500 mb-2" />
                        <div className="text-lg font-bold text-yellow-600">ã™ã¹ã¦ã®ç´šã‚’ã‚¯ãƒªã‚¢ï¼</div>
                        <div className="text-xs text-yellow-600">ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</div>
                      </div>
                    )}
                  </div>
                </div>

                <button
                  onClick={() => { sound('click'); setActiveTab('home'); }}
                  className="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-4 rounded-xl transition-all flex items-center justify-center gap-2 mt-6 border-2 border-slate-200"
                >
                  <Home size={20} />
                  è¡¨ç´™ï¼ˆãƒ›ãƒ¼ãƒ ï¼‰ã«ã‚‚ã©ã‚‹
                </button>
              </div>
            )}

            {/* ãŒã‚“ã°ã‚Šè¡¨ï¼ˆæ—§ã‚³ãƒ¼ãƒ‰ã®ä¸€è¦§è¡¨æ©Ÿèƒ½ã‚‚çµ±åˆï¼‰ */}
            {activeTab === 'history' && (
              <div className="space-y-4 animate-fadeIn">
                <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 text-center">
                  <Calendar size={48} className="mx-auto text-green-500 mb-2" />
                  <h2 className="text-lg font-bold text-slate-700">ãŒã‚“ã°ã‚Šè¡¨</h2>

                  {/* æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šæ“ä½œãƒœã‚¿ãƒ³ï¼ˆã‚³ãƒ”ãƒ¼/å¾©å…ƒï¼‰ */}
                  <div className="flex gap-2 justify-center mt-3 flex-wrap">
                    <button
                      onClick={exportAllAsTSV}
                      className="bg-sky-100 hover:bg-sky-200 text-sky-700 font-bold px-4 py-2 rounded-full text-xs border border-sky-200 flex items-center gap-1"
                    >
                      <Copy size={14}/> ä¸€è¦§ã‚’ã‚³ãƒ”ãƒ¼
                    </button>
                    <button
                      onClick={() => { sound('click'); setShowImportModal(true); }}
                      className="bg-green-100 hover:bg-green-200 text-green-700 font-bold px-4 py-2 rounded-full text-xs border border-green-200 flex items-center gap-1"
                    >
                      <Upload size={14}/> å¾©å…ƒï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰
                    </button>
                  </div>

                  {/* é€£ç¶šæ—¥æ•°è¡¨ç¤º */}
                  <div className="bg-orange-100 border-2 border-orange-200 rounded-xl p-4 mb-6 text-center mt-5">
                    <div className="flex items-center justify-center gap-2 mb-1">
                      <span className="text-2xl">ğŸ”¥</span>
                      <span className="text-lg font-black text-orange-600">ã‚Œã‚“ããè¨˜éŒ²</span>
                      <span className="text-2xl">ğŸ”¥</span>
                    </div>
                    <div className="text-3xl font-black text-orange-500">
                      {(() => {
                        const toKey = (d) => toLocalDateKey(d);
                        const now = new Date();
                        let count = 0;
                        let isTodayDone = false;
                        const todayKey = toKey(now);

                        if (history[todayKey]) {
                          count = 1; isTodayDone = true;
                          const d = new Date(now);
                          while(true) {
                            d.setDate(d.getDate() - 1);
                            const isDone = history[toKey(d)];
                            if (isDone) {
                              count++;
                            } else {
                              const isWeH = d.getDay() === 0 || d.getDay() === 6 || isJapaneseHoliday(d);
                              if (!isWeH) break;
                            }
                          }
                        } else {
                          const d = new Date(now); d.setDate(d.getDate() - 1);
                          let checkDate = new Date(d);
                          while(true) {
                            const isDone = history[toKey(checkDate)];
                            if (isDone) {
                              count++;
                            } else {
                              const isWeH = checkDate.getDay() === 0 || checkDate.getDay() === 6 || isJapaneseHoliday(checkDate);
                              if (!isWeH) break;
                            }
                            checkDate.setDate(checkDate.getDate() - 1);
                          }
                        }

                        return (
                          <>
                            {count}<span className="text-base">æ—¥</span>
                            <div className="text-xs text-orange-400 font-bold mt-1">
                              {count > 0 ? (isTodayDone ? "ã™ã”ã„ï¼ ãã‚‡ã†ã‚‚ ãŸã£ã›ã„ï¼" : "ãã®ã†ã¾ã§ ã¤ã¥ã„ã¦ã‚‹ã‚ˆï¼") : "ãã‚‡ã†ã‹ã‚‰ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼"}
                            </div>
                          </>
                        );
                      })()}
                    </div>
                  </div>

                  {/* ç›´è¿‘14æ—¥ */}
                  <div className="grid grid-cols-7 gap-2 max-w-sm mx-auto mt-4">
                    {[...Array(14)].map((_, i) => {
                      const d = new Date();
                      d.setDate(d.getDate() - (13 - i));
                      const dateKey = toLocalDateKey(d);
                      const dayNum = d.getDate();
                      const hasHistory = history[dateKey];
                      const isToday = toLocalDateKey(new Date()) === dateKey;

                      return (
                        <div key={i} className="flex flex-col items-center gap-1">
                          <div className="text-[10px] text-slate-400">{d.getMonth()+1}/{dayNum}</div>
                          <div className={`
                            w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all
                            ${hasHistory ? 'bg-green-100 border-green-500 text-green-600 scale-110' : 'bg-slate-50 border-slate-100 text-slate-300'}
                            ${isToday ? 'ring-2 ring-offset-2 ring-sky-300' : ''}
                          `}>
                            {hasHistory ? <Medal size={20} fill="currentColor" /> : <div className="w-2 h-2 rounded-full bg-slate-200" />}
                          </div>
                        </div>
                      );
                    })}
                  </div>

                  {/* âœ… æ—§ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼šæ—¥åˆ¥ä¸€è¦§è¡¨ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‹æ—¥ä»˜å¤‰æ›´ï¼‹å‰Šé™¤ï¼‰ */}
                  <div className="mt-8 text-left">
                    <div className="flex items-center justify-between gap-2 mb-2">
                      <div className="font-black text-slate-700 flex items-center gap-2">
                        <ClipboardList size={18} className="text-green-600"/>
                        æ—¥åˆ¥ãã‚ãä¸€è¦§
                      </div>
                      <button
                        onClick={() => { sound('click'); setActiveTab('input'); setTargetDate(toLocalDateKey(new Date())); }}
                        className="bg-orange-500 hover:bg-orange-600 text-white font-bold px-4 py-2 rounded-full text-xs shadow-md border-4 border-white"
                        title="ä»Šæ—¥ã®è¨˜éŒ²ã¸"
                      >
                        âœï¸ ãã‚‡ã†ã®è¨˜éŒ²ã¸
                      </button>
                    </div>

                    <div className="bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
                      <div className="overflow-x-auto custom-scrollbar">
                        <table className="min-w-[700px] w-full text-xs border-collapse">
                          <thead className="sticky-header">
                            <tr className="bg-green-50 text-green-800">
                              <th className="sticky-corner p-2 text-center min-w-[130px] border-b border-slate-200">æ—¥ä»˜</th>
                              {displayTricks.map(t => (
                                <th key={t.id} className="p-2 text-center min-w-[90px] border-b border-slate-200">
                                  {t.label}
                                </th>
                              ))}
                              <th className="p-2 text-center min-w-[80px] border-b border-slate-200">åˆè¨ˆ</th>
                            </tr>
                          </thead>
                          <tbody>
                            {sortedDates.length === 0 ? (
                              <tr>
                                <td colSpan={displayTricks.length + 2} className="p-4 text-center text-slate-400 font-bold">
                                  ã¾ã æ—¥åˆ¥ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
                                </td>
                              </tr>
                            ) : (
                              sortedDates.map(dateKey => {
                                const dayObj = dailyRecords[dateKey] || {};
                                const rowTotal = displayTricks.reduce((sum, t) => sum + (parseInt(dayObj[t.id] || 0) || 0), 0);

                                return (
                                  <tr key={dateKey} className="hover:bg-slate-50 border-b border-slate-100">
                                    <td className="sticky-col p-2 bg-white border-b border-slate-100">
                                      <div className="flex items-center justify-between gap-2">
                                        <button
                                          onClick={() => openDateEdit(dateKey)}
                                          className="text-slate-700 font-black underline decoration-dotted"
                                          title="æ—¥ä»˜ã‚’å¤‰æ›´"
                                        >
                                          {dateKey}
                                        </button>
                                        <div className="flex items-center gap-1">
                                          <button
                                            onClick={() => { sound('click'); setTargetDate(dateKey); setActiveTab('input'); }}
                                            className="text-xs font-bold px-2 py-1 rounded-lg bg-sky-50 text-sky-700 border border-sky-200"
                                            title="ã“ã®æ—¥ã®å…¥åŠ›ã¸"
                                          >
                                            ç·¨é›†
                                          </button>
                                          <button
                                            onClick={() => openDeleteDay(dateKey)}
                                            className="p-1.5 rounded-lg bg-red-50 text-red-600 border border-red-200 hover:bg-red-100"
                                            title="å‰Šé™¤"
                                          >
                                            <Trash2 size={14}/>
                                          </button>
                                        </div>
                                      </div>
                                    </td>

                                    {displayTricks.map(t => (
                                      <td key={t.id} className="p-2 text-center border-b border-slate-100">
                                        <span className={`font-black ${ (parseInt(dayObj[t.id] || 0) || 0) > 0 ? 'text-slate-700' : 'text-slate-300'}`}>
                                          {parseInt(dayObj[t.id] || 0) || 0}
                                        </span>
                                      </td>
                                    ))}

                                    <td className="p-2 text-center border-b border-slate-100 font-black text-slate-700">
                                      {rowTotal}
                                    </td>
                                  </tr>
                                );
                              })
                            )}
                          </tbody>

                          {sortedDates.length > 0 && (
                            <tfoot>
                              <tr className="bg-slate-50 border-t border-slate-200">
                                <td className="sticky-col p-2 font-black text-slate-600">åˆè¨ˆ</td>
                                {displayTricks.map(t => (
                                  <td key={t.id} className="p-2 text-center font-black text-slate-700">
                                    {totals[t.id] || 0}
                                  </td>
                                ))}
                                <td className="p-2 text-center font-black text-slate-700">
                                  {displayTricks.reduce((s, t) => s + (totals[t.id] || 0), 0)}
                                </td>
                              </tr>
                            </tfoot>
                          )}
                        </table>
                      </div>
                    </div>

                    <p className="text-center text-xs text-slate-400 mt-2">
                      æ—¥ä»˜ã‚’æŠ¼ã™ã¨æ—¥ä»˜å¤‰æ›´ / ã€Œç·¨é›†ã€ã§ãã®æ—¥ã®å…¥åŠ›ã¸ / ã€Œä¸€è¦§ã‚’ã‚³ãƒ”ãƒ¼ã€ã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è²¼ã‚Šä»˜ã‘ã§ãã¾ã™ã€‚
                    </p>
                  </div>

                  <div className="mt-6 bg-green-50 p-4 rounded-xl border border-green-100 text-left">
                    <div className="flex items-center gap-3 mb-2">
                      <User className="text-green-600" size={20}/>
                      <span className="font-bold text-green-800">{user.name ? user.name : 'åç„¡ã—'} ã•ã‚“ã®ãã‚ã</span>
                    </div>
                    <div className="text-xs text-green-700">
                      {user.isRegistered ? 'è¨˜éŒ²ä¸­' : 'æœªç™»éŒ²'}
                    </div>
                  </div>
                </div>

                <button
                  onClick={() => { sound('click'); setActiveTab('home'); }}
                  className="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-4 rounded-xl transition-all flex items-center justify-center gap-2 mt-6 border-2 border-slate-200"
                >
                  <Home size={20} />
                  è¡¨ç´™ï¼ˆãƒ›ãƒ¼ãƒ ï¼‰ã«ã‚‚ã©ã‚‹
                </button>
              </div>
            )}

          </main>

          <footer className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-sm border-t border-slate-200 py-2 text-center text-xs text-slate-400 z-50">
            <div>å…¨å›½ã®æ¤œå®šè¡¨ã‚’å‚ç…§ãƒ»çµ±åˆã—ãŸæ¨™æº–ãƒ¢ãƒ‡ãƒ«ï¼ˆ20ç´šï½1ç´šï¼‰</div>
            <div className="mt-1">Â©2026 Takayuki WAYAMA ãªã‚ã¨ã³æ¤œå®šã‚«ãƒ¼ãƒ‰</div>
          </footer>

          <style>{`
            @keyframes fadeIn {
              from { opacity: 0; transform: translateY(10px); }
              to { opacity: 1; transform: translateY(0); }
            }
            .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
          `}</style>
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
