<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>なわとび検定カード（最高版）</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts（やわらかくて子ども向け） -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">

  <!-- Babel for JSX transformation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Import Map for module resolution -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
  </script>

  <style>
    :root{
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    body{
      font-family: "M PLUS Rounded 1c", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      padding-bottom: calc(96px + var(--safe-bottom));
    }

    /* input type="number" のスピンボタンを消す */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Sticky column */
    .sticky-col {
      position: sticky;
      left: 0;
      z-index: 10;
      background: white;
      border-right: 2px solid #e2e8f0;
    }
    .sticky-corner {
      position: sticky;
      left: 0;
      top: 0;
      z-index: 30;
      background: #f8fafc;
      border-right: 2px solid #e2e8f0;
      border-bottom: 2px solid #e2e8f0;
    }

    /* Animations */
    @keyframes popIn {
      0% { transform: scale(0.92); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .animate-popIn { animation: popIn 0.28s cubic-bezier(0.175, 0.885, 0.32, 1.2) both; }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeInUp { animation: fadeInUp 0.25s ease-out both; }

    /* Confetti-like background (backup) */
    @keyframes confettiBg {
      0% { background-position: 0 0; }
      100% { background-position: 120px 120px; }
    }
    .bg-confetti {
      background-image:
        radial-gradient(#FCD34D 22%, transparent 22%),
        radial-gradient(#FB7185 22%, transparent 22%),
        radial-gradient(#60A5FA 22%, transparent 22%);
      background-color: #ffffff;
      background-position: 0 0, 60px 30px, 30px 60px;
      background-size: 120px 120px;
      animation: confettiBg 4s linear infinite;
    }
  </style>
</head>

<body class="bg-sky-50 text-slate-800 select-none">
  <div id="root"></div>

  <script type="text/babel" data-type="module" id="app-script">
    import React, { useEffect, useMemo, useRef, useState, useCallback } from "react";
    import { createRoot } from "react-dom/client";
    import {
      Activity, Award, Calendar, CalendarDays, Check, CheckCircle, ChevronDown, ChevronUp,
      Copy, Download, FileDown, Flame, Home, List, Medal, Pencil, RefreshCw,
      RotateCcw, Save, Settings, Sparkles, Star, Target, Trophy, Upload, User, Volume2, VolumeX, X, Trash2
    } from "lucide-react";

    // =========================
    // 先生モード（配付用に false に書き換える）
    // =========================
    const IS_TEACHER_MODE = true;

    // バージョン
    const DATA_VERSION = "2026-v1-ultimate-nawatobi";

    // =========================
    // 技ID（内部固定）
    // =========================
    const TRICK_IDS = [
      "mae", "ushiro", "kataashi", "kakeashi", "kakeashi_ushiro",
      "nibyoushi", "aya", "aya_ushiro", "kousa", "kousa_ushiro",
      "niju", "aya_niju", "sokushin", "kousa_niju", "niju_ushiro",
      "zengo_kousa", "sanju"
    ];

    // 技名デフォルト
    const DEFAULT_TRICK_NAMES = {
      low: {
        mae: "りょうあしとび", ushiro: "りょうあしとび（うしろ）", kataashi: "かたあしとび", kakeashi: "かけあしとび", kakeashi_ushiro: "かけあしとび（うしろ）",
        nibyoushi: "２びょうしとび", aya: "あやとび", aya_ushiro: "あやとび（うしろ）", kousa: "こうさとび", kousa_ushiro: "こうさとび（うしろ）",
        niju: "２じゅうとび", aya_niju: "あや２じゅうとび", sokushin: "そくしんとび", kousa_niju: "こうさ２じゅうとび", niju_ushiro: "２じゅうとび（うしろ）",
        zengo_kousa: "ぜんごこうさとび", sanju: "３じゅうとび"
      },
      mid: {
        mae: "りょう足とび", ushiro: "りょう足とび（後ろ）", kataashi: "かた足とび", kakeashi: "かけ足とび", kakeashi_ushiro: "かけ足とび（後ろ）",
        nibyoushi: "２びょうしとび", aya: "あやとび", aya_ushiro: "あやとび（後ろ）", kousa: "交さとび", kousa_ushiro: "交さとび（後ろ）",
        niju: "２じゅうとび", aya_niju: "あや２じゅうとび", sokushin: "側振とび", kousa_niju: "交さ２じゅうとび", niju_ushiro: "２じゅうとび（後ろ）",
        zengo_kousa: "前後交さとび", sanju: "３じゅうとび"
      },
      high: {
        mae: "両足とび", ushiro: "両足とび（後ろ）", kataashi: "片足とび", kakeashi: "かけ足とび", kakeashi_ushiro: "かけ足とび（後ろ）",
        nibyoushi: "２びょうしとび", aya: "あやとび", aya_ushiro: "あやとび（後ろ）", kousa: "交差とび", kousa_ushiro: "交差とび（後ろ）",
        niju: "２重とび", aya_niju: "あや２重とび", sokushin: "側しんとび", kousa_niju: "交差２重とび", niju_ushiro: "２重とびうしろ",
        zengo_kousa: "前後交差とび", sanju: "３重とび"
      }
    };

    // 技の色（固定）
    const TRICK_COLORS = {
      mae: "bg-blue-100 text-blue-600 border-blue-200",
      ushiro: "bg-indigo-100 text-indigo-600 border-indigo-200",
      kataashi: "bg-teal-100 text-teal-600 border-teal-200",
      kakeashi: "bg-green-100 text-green-600 border-green-200",
      kakeashi_ushiro: "bg-emerald-100 text-emerald-600 border-emerald-200",
      nibyoushi: "bg-cyan-100 text-cyan-600 border-cyan-200",
      aya: "bg-yellow-100 text-yellow-700 border-yellow-200",
      aya_ushiro: "bg-amber-100 text-amber-700 border-amber-200",
      kousa: "bg-orange-100 text-orange-600 border-orange-200",
      kousa_ushiro: "bg-red-100 text-red-600 border-red-200",
      niju: "bg-pink-100 text-pink-600 border-pink-200",
      aya_niju: "bg-purple-100 text-purple-600 border-purple-200",
      sokushin: "bg-lime-100 text-lime-600 border-lime-200",
      kousa_niju: "bg-rose-100 text-rose-600 border-rose-200",
      niju_ushiro: "bg-fuchsia-100 text-fuchsia-600 border-fuchsia-200",
      zengo_kousa: "bg-violet-100 text-violet-600 border-violet-200",
      sanju: "bg-slate-100 text-slate-600 border-slate-200"
    };

    // =========================
    // デフォルト級判定データ（現コードのまま）
    // =========================
    const DEFAULT_LEVELS_DATA = {
      low: [
        { level: 20, reqs: { mae: 1, kataashi: 1 } },
        { level: 19, reqs: { mae: 5, kataashi: 4 } },
        { level: 18, reqs: { mae: 10, ushiro: 1, kataashi: 8, kakeashi: 2 } },
        { level: 17, reqs: { mae: 15, ushiro: 3, kataashi: 12, kakeashi: 8 } },
        { level: 16, reqs: { mae: 20, ushiro: 5, kataashi: 16, kakeashi: 16 } },
        { level: 15, reqs: { mae: 25, ushiro: 7, kataashi: 20, kakeashi: 24 } },
        { level: 14, reqs: { mae: 30, ushiro: 10, kakeashi: 30, kakeashi_ushiro: 2, nibyoushi: 4 } },
        { level: 13, reqs: { mae: 35, ushiro: 12, kakeashi: 35, kakeashi_ushiro: 4, nibyoushi: 8 } },
        { level: 12, reqs: { mae: 40, ushiro: 15, kakeashi: 40, kakeashi_ushiro: 8, nibyoushi: 12 } },
        { level: 11, reqs: { mae: 45, ushiro: 20, kakeashi: 45, kakeashi_ushiro: 12, nibyoushi: 16 } },
        { level: 10, reqs: { mae: 50, ushiro: 25, kakeashi: 50, kakeashi_ushiro: 16, nibyoushi: 20 } },
        { level: 9, reqs: { mae: 55, ushiro: 30, kakeashi: 55, kakeashi_ushiro: 20, nibyoushi: 24 } },
        { level: 8, reqs: { mae: 60, ushiro: 35, kakeashi: 60, kakeashi_ushiro: 24, nibyoushi: 28 } },
        { level: 7, reqs: { mae: 65, ushiro: 40, kakeashi: 65, kousa: 1, niju: 1, aya: 2 } },
        { level: 6, reqs: { mae: 70, ushiro: 45, kakeashi: 70, kousa: 2, niju: 2, aya: 4 } },
        { level: 5, reqs: { mae: 75, ushiro: 50, kakeashi: 75, kousa: 3, niju: 3, aya: 6 } },
        { level: 4, reqs: { mae: 80, ushiro: 55, kakeashi: 80, kousa: 4, niju: 4, aya: 8 } },
        { level: 3, reqs: { mae: 85, ushiro: 60, kakeashi: 85, kousa: 6, niju: 5, aya: 12 } },
        { level: 2, reqs: { mae: 90, ushiro: 65, kakeashi: 90, kousa: 8, niju: 6, aya: 16 } },
        { level: 1, reqs: { mae: 100, ushiro: 70, kakeashi: 100, kousa: 10, niju: 7, aya: 24 } }
      ],
      mid: [
        { level: 20, reqs: { mae: 2, nibyoushi: 4 } },
        { level: 19, reqs: { mae: 7, nibyoushi: 8 } },
        { level: 18, reqs: { mae: 10, ushiro: 1, nibyoushi: 12, kakeashi: 4 } },
        { level: 17, reqs: { mae: 15, ushiro: 3, nibyoushi: 16, kakeashi: 10 } },
        { level: 16, reqs: { mae: 20, ushiro: 5, nibyoushi: 20, kakeashi: 20 } },
        { level: 15, reqs: { mae: 30, ushiro: 10, nibyoushi: 40, kakeashi: 30 } },
        { level: 14, reqs: { mae: 40, ushiro: 20, kakeashi: 40, kakeashi_ushiro: 2, aya: 2 } },
        { level: 13, reqs: { mae: 50, ushiro: 30, kakeashi: 50, kakeashi_ushiro: 8, aya: 4 } },
        { level: 12, reqs: { mae: 60, ushiro: 40, kakeashi: 60, kakeashi_ushiro: 12, aya: 6 } },
        { level: 11, reqs: { mae: 70, ushiro: 50, kakeashi: 70, kakeashi_ushiro: 16, aya: 8 } },
        { level: 10, reqs: { mae: 80, ushiro: 60, kakeashi: 80, kakeashi_ushiro: 20, aya: 10 } },
        { level: 9, reqs: { mae: 90, ushiro: 80, kakeashi: 90, kakeashi_ushiro: 24, aya: 12 } },
        { level: 8, reqs: { mae: 100, ushiro: 100, kakeashi: 100, kakeashi_ushiro: 28, aya: 14 } },
        { level: 7, reqs: { mae: 110, ushiro: 110, kousa: 1, kousa_ushiro: 1, niju: 1, aya_ushiro: 2, aya_niju: 1 } },
        { level: 6, reqs: { mae: 120, ushiro: 120, kousa: 5, kousa_ushiro: 3, niju: 2, aya_ushiro: 4, aya_niju: 2 } },
        { level: 5, reqs: { mae: 130, ushiro: 130, kousa: 10, kousa_ushiro: 5, niju: 5, aya_ushiro: 6, aya_niju: 3 } },
        { level: 4, reqs: { mae: 140, ushiro: 140, kousa: 15, kousa_ushiro: 8, niju: 8, aya_ushiro: 8, aya_niju: 4 } },
        { level: 3, reqs: { mae: 160, ushiro: 160, kousa: 20, kousa_ushiro: 10, niju: 10, aya_ushiro: 10, aya_niju: 6 } },
        { level: 2, reqs: { mae: 180, ushiro: 180, kousa: 25, kousa_ushiro: 15, niju: 12, aya_ushiro: 12, aya_niju: 8 } },
        { level: 1, reqs: { mae: 200, ushiro: 200, kousa_ushiro: 30, niju: 20, aya_niju: 20, kousa_niju: 3, niju_ushiro: 7, sanju: 3 } }
      ],
      high: [
        { level: 20, reqs: { mae: 3, nibyoushi: 4, kakeashi: 3 } },
        { level: 19, reqs: { mae: 8, nibyoushi: 8, kakeashi: 8 } },
        { level: 18, reqs: { mae: 15, ushiro: 3, nibyoushi: 12, kakeashi: 15, aya: 2 } },
        { level: 17, reqs: { mae: 20, ushiro: 8, nibyoushi: 20, kakeashi: 20, aya: 4 } },
        { level: 16, reqs: { mae: 30, ushiro: 15, nibyoushi: 40, kakeashi: 30, aya: 8 } },
        { level: 15, reqs: { mae: 40, ushiro: 20, nibyoushi: 60, kakeashi: 40, aya: 14 } },
        { level: 14, reqs: { mae: 50, ushiro: 30, kakeashi: 50, kakeashi_ushiro: 10, aya: 20, kousa: 1, niju: 2, aya_ushiro: 2 } },
        { level: 13, reqs: { mae: 60, ushiro: 40, kakeashi: 60, kakeashi_ushiro: 20, aya: 25, kousa: 5, niju: 4, aya_ushiro: 4 } },
        { level: 12, reqs: { mae: 70, ushiro: 50, kakeashi: 70, kakeashi_ushiro: 30, aya: 30, kousa: 10, niju: 8, aya_ushiro: 8 } },
        { level: 11, reqs: { mae: 80, ushiro: 60, kakeashi: 80, kakeashi_ushiro: 40, aya: 35, kousa: 15, niju: 12, aya_ushiro: 12 } },
        { level: 10, reqs: { mae: 90, ushiro: 70, kakeashi: 90, kakeashi_ushiro: 60, aya: 40, kousa: 20, kousa_ushiro: 1, niju: 16, aya_ushiro: 16 } },
        { level: 9, reqs: { mae: 100, ushiro: 80, kakeashi: 100, kakeashi_ushiro: 80, aya: 45, kousa: 25, kousa_ushiro: 3, niju: 20, aya_ushiro: 20 } },
        { level: 8, reqs: { mae: 120, ushiro: 100, kakeashi: 120, kakeashi_ushiro: 100, aya: 50, kousa: 30, kousa_ushiro: 5, niju: 24, aya_ushiro: 24 } },
        { level: 7, reqs: { mae: 140, ushiro: 110, kousa_ushiro: 3, niju: 8, aya_niju: 1, sokushin: 4, niju_ushiro: 1, zengo_kousa: 1 } },
        { level: 6, reqs: { mae: 150, ushiro: 120, kousa_ushiro: 5, niju: 10, aya_niju: 3, sokushin: 8, niju_ushiro: 2, zengo_kousa: 5 } },
        { level: 5, reqs: { mae: 160, ushiro: 130, kousa_ushiro: 8, niju: 12, aya_niju: 5, sokushin: 12, niju_ushiro: 3, zengo_kousa: 10 } },
        { level: 4, reqs: { mae: 170, ushiro: 140, kousa_ushiro: 10, niju: 14, aya_niju: 8, sokushin: 24, niju_ushiro: 4, zengo_kousa: 20 } },
        { level: 3, reqs: { mae: 180, ushiro: 160, kousa_ushiro: 15, niju: 16, aya_niju: 10, kousa_niju: 1, niju_ushiro: 5, sanju: 1 } },
        { level: 2, reqs: { mae: 190, ushiro: 180, kousa_ushiro: 20, niju: 18, aya_niju: 15, kousa_niju: 2, niju_ushiro: 6, sanju: 2 } },
        { level: 1, reqs: { mae: 200, ushiro: 200, kousa_ushiro: 30, niju: 20, aya_niju: 20, kousa_niju: 3, niju_ushiro: 7, sanju: 3 } }
      ]
    };

    // =========================
    // 日付ユーティリティ（ローカル日付で確実に）
    // =========================
    function pad2(n){ return String(n).padStart(2,"0"); }
    function toLocalKey(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function todayKeyLocal(){
      return toLocalKey(new Date());
    }
    function utcKey(d){
      // 互換用：旧ロジック(toISOString)のキー
      return d.toISOString().split("T")[0];
    }

    // =========================
    // 祝日判定（現コードの簡易版）
    // =========================
    function isJapaneseHoliday(date) {
      const y = date.getFullYear();
      const m = date.getMonth() + 1;
      const d = date.getDate();
      const w = date.getDay(); // 0=Sun, 1=Mon

      if (m === 1 && d === 1) return true;
      if (m === 2 && d === 11) return true;
      if (m === 2 && d === 23) return true;
      if (m === 3 && d === Math.floor(20.8431 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4))) return true;
      if (m === 4 && d === 29) return true;
      if (m === 5 && d === 3) return true;
      if (m === 5 && d === 4) return true;
      if (m === 5 && d === 5) return true;
      if (m === 8 && d === 11) return true;
      if (m === 9 && d === Math.floor(23.2488 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4))) return true;
      if (m === 11 && d === 3) return true;
      if (m === 11 && d === 23) return true;

      const isNthMonday = (n) => (w === 1 && Math.floor((d - 1) / 7) === (n - 1));
      if (m === 1 && isNthMonday(2)) return true;
      if (m === 7 && isNthMonday(3)) return true;
      if (m === 9 && isNthMonday(3)) return true;
      if (m === 10 && isNthMonday(2)) return true;

      if (w === 1) {
        const yesterday = new Date(date);
        yesterday.setDate(d - 1);
        if (isJapaneseHoliday(yesterday)) return true;
      }
      return false;
    }

    // =========================
    // Sound（旧コードの「気持ちよさ」を移植）
    // =========================
    function createSound(){
      let audioCtx = null;
      const ensure = () => {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === "suspended") audioCtx.resume();
        return audioCtx;
      };
      const tone = (freq, type, duration, gainVal=0.08) => {
        const ctx = ensure();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, ctx.currentTime);
        gain.gain.setValueAtTime(gainVal, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0008, ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + duration);
      };
      return {
        click: () => tone(650, "sine", 0.08, 0.06),
        success: () => { tone(900, "triangle", 0.10, 0.07); setTimeout(()=>tone(1200,"triangle",0.18,0.07), 90); },
        fanfare: () => {
          const notes = [523.25, 659.25, 783.99, 1046.5];
          notes.forEach((f, i)=> setTimeout(()=>tone(f,"triangle",0.5,0.07), i*130));
        }
      };
    }

    // =========================
    // Confetti Canvas（旧コードの紙吹雪を移植）
    // =========================
    function useConfetti(){
      const canvasRef = useRef(null);
      const rafRef = useRef(null);
      const particlesRef = useRef([]);
      const runningRef = useRef(false);

      const resize = useCallback(() => {
        const c = canvasRef.current;
        if (!c) return;
        const dpr = window.devicePixelRatio || 1;
        c.width  = Math.floor(window.innerWidth * dpr);
        c.height = Math.floor(window.innerHeight * dpr);
        c.style.width = "100%";
        c.style.height = "100%";
        const ctx = c.getContext("2d");
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }, []);

      useEffect(() => {
        resize();
        window.addEventListener("resize", resize);
        return () => window.removeEventListener("resize", resize);
      }, [resize]);

      const start = useCallback(() => {
        const c = canvasRef.current;
        if (!c) return;
        const ctx = c.getContext("2d");
        const colors = ["#FF6B6B", "#4ECDC4", "#FFE66D", "#FF9F43", "#54A0FF", "#A78BFA"];
        const W = window.innerWidth;
        const H = window.innerHeight;

        particlesRef.current = Array.from({length: 120}).map(() => ({
          x: W/2,
          y: H/2,
          vx: (Math.random()-0.5)*10,
          vy: (Math.random()-0.5)*10 - 6,
          s: Math.random()*7 + 4,
          r: Math.random()*360,
          dr:(Math.random()-0.5)*10,
          col: colors[Math.floor(Math.random()*colors.length)]
        }));

        const startTime = performance.now();
        runningRef.current = true;

        const tick = (t) => {
          if (!runningRef.current) return;
          ctx.clearRect(0,0,W,H);

          const elapsed = t - startTime;
          particlesRef.current.forEach((p) => {
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.18;
            p.r += p.dr;

            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate((p.r*Math.PI)/180);
            ctx.fillStyle = p.col;
            ctx.fillRect(-p.s/2, -p.s/2, p.s, p.s);
            ctx.restore();
          });

          // particle remove
          particlesRef.current = particlesRef.current.filter(p => p.y < H + 40);

          if (elapsed > 2200 || particlesRef.current.length === 0){
            runningRef.current = false;
            ctx.clearRect(0,0,W,H);
            return;
          }
          rafRef.current = requestAnimationFrame(tick);
        };

        if (rafRef.current) cancelAnimationFrame(rafRef.current);
        rafRef.current = requestAnimationFrame(tick);
      }, []);

      const stop = useCallback(() => {
        runningRef.current = false;
        if (rafRef.current) cancelAnimationFrame(rafRef.current);
        const c = canvasRef.current;
        if (!c) return;
        const ctx = c.getContext("2d");
        ctx.clearRect(0,0,window.innerWidth, window.innerHeight);
      }, []);

      return { canvasRef, start, stop };
    }

    // =========================
    // Main App
    // =========================
    function App(){
      // ---------- Core states ----------
      const [user, setUser] = useState({ grade: 1, classVal: "", number: "", name: "", isRegistered: true });

      const [records, setRecords] = useState({});             // 入力中（targetDateの分）
      const [dailyRecords, setDailyRecords] = useState({});   // 日ごと
      const [maxRecords, setMaxRecords] = useState({});       // 自己ベスト
      const [history, setHistory] = useState({});             // やった日

      const [activeTab, setActiveTab] = useState("home");     // home, input, stats, cert, history, settings
      const [historyView, setHistoryView] = useState("calendar"); // calendar | table

      const [targetDate, setTargetDate] = useState(todayKeyLocal());

      // customization
      const [levelsData, setLevelsData] = useState(DEFAULT_LEVELS_DATA);
      const [trickNames, setTrickNames] = useState(DEFAULT_TRICK_NAMES);
      const [settingTab, setSettingTab] = useState("low");

      // old-features: goals + achievements + import/export modal
      const [goals, setGoals] = useState({});
      const [goalAchievements, setGoalAchievements] = useState([]); // keys: `${trickId}-${goalValue}`
      const [goalModalOpen, setGoalModalOpen] = useState(false);
      const [goalUpdateModal, setGoalUpdateModal] = useState(null); // {trickId, oldGoal, newGoal}
      const [importModalOpen, setImportModalOpen] = useState(false);
      const [importText, setImportText] = useState("");
      const [deleteModal, setDeleteModal] = useState(null); // {type:'date'|'all', dateKey?}

      const [copyToast, setCopyToast] = useState(false);

      // sound toggle
      const [soundEnabled, setSoundEnabled] = useState(true);
      const soundRef = useRef(null);

      // confetti
      const confetti = useConfetti();

      // ---------- Storage Keys ----------
      const LS = {
        user: "nawatobi_user",
        records: "nawatobi_records",
        daily: "nawatobi_daily_records",
        max: "nawatobi_max_records",
        hist: "nawatobi_history",
        levels: "nawatobi_levels",
        names: "nawatobi_trick_names",
        ver: "nawatobi_version",
        goals: "nawatobi_goals",
        goalAch: "nawatobi_goal_achievements",
        sound: "nawatobi_sound_enabled"
      };

      // ---------- Init ----------
      useEffect(() => {
        soundRef.current = createSound();

        const savedUser = localStorage.getItem(LS.user);
        const savedDaily = localStorage.getItem(LS.daily);
        const savedMax = localStorage.getItem(LS.max);
        const savedHistory = localStorage.getItem(LS.hist);
        const savedLevels = localStorage.getItem(LS.levels);
        const savedNames = localStorage.getItem(LS.names);
        const savedVersion = localStorage.getItem(LS.ver);

        const savedGoals = localStorage.getItem(LS.goals);
        const savedGoalAch = localStorage.getItem(LS.goalAch);
        const savedSound = localStorage.getItem(LS.sound);

        if (savedUser){
          try{ setUser(prev => ({...prev, ...JSON.parse(savedUser), isRegistered:true})); }catch(e){}
        }

        let initialDaily = {};
        if (savedDaily){
          try{ initialDaily = JSON.parse(savedDaily); setDailyRecords(initialDaily); }catch(e){}
        }

        if (savedHistory){
          try{ setHistory(JSON.parse(savedHistory)); }catch(e){}
        }

        // maxRecords（旧互換）
        if (savedMax){
          try{ setMaxRecords(JSON.parse(savedMax)); }catch(e){}
        } else {
          const compat = localStorage.getItem(LS.records);
          if (compat){
            try{
              const old = JSON.parse(compat);
              setMaxRecords(old);
              localStorage.setItem(LS.max, JSON.stringify(old));
            }catch(e){}
          }
        }

        // settings version
        const isOldVersion = savedVersion !== DATA_VERSION;
        if (isOldVersion){
          setLevelsData(DEFAULT_LEVELS_DATA);
          setTrickNames(DEFAULT_TRICK_NAMES);
          localStorage.setItem(LS.levels, JSON.stringify(DEFAULT_LEVELS_DATA));
          localStorage.setItem(LS.names, JSON.stringify(DEFAULT_TRICK_NAMES));
          localStorage.setItem(LS.ver, DATA_VERSION);
        } else {
          if (savedLevels){
            try{ setLevelsData(JSON.parse(savedLevels)); }catch(e){}
          }
          if (savedNames){
            try{ setTrickNames(JSON.parse(savedNames)); }catch(e){}
          }
        }

        if (savedGoals){
          try{ setGoals(JSON.parse(savedGoals)); }catch(e){}
        }
        if (savedGoalAch){
          try{ setGoalAchievements(JSON.parse(savedGoalAch)); }catch(e){}
        }
        if (savedSound !== null){
          setSoundEnabled(savedSound === "true");
        } else {
          setSoundEnabled(true);
        }

        // 今日キーのUTC→ローカル移行（今日分だけ安全に）
        const todayLocal = todayKeyLocal();
        const todayUTC = utcKey(new Date());
        if (initialDaily && initialDaily[todayUTC] && !initialDaily[todayLocal]){
          const migrated = {...initialDaily, [todayLocal]: initialDaily[todayUTC]};
          delete migrated[todayUTC];
          setDailyRecords(migrated);
          localStorage.setItem(LS.daily, JSON.stringify(migrated));

          // historyも移行
          const h = savedHistory ? (JSON.parse(savedHistory) || {}) : {};
          if (h[todayUTC] && !h[todayLocal]){
            const mh = {...h, [todayLocal]: true};
            delete mh[todayUTC];
            setHistory(mh);
            localStorage.setItem(LS.hist, JSON.stringify(mh));
          }
        }

        // 初期表示のrecords
        const initKey = todayKeyLocal();
        setTargetDate(initKey);
      }, []);

      // ---------- Persist ----------
      useEffect(() => localStorage.setItem(LS.user, JSON.stringify(user)), [user]);
      useEffect(() => localStorage.setItem(LS.daily, JSON.stringify(dailyRecords)), [dailyRecords]);
      useEffect(() => localStorage.setItem(LS.max, JSON.stringify(maxRecords)), [maxRecords]);
      useEffect(() => localStorage.setItem(LS.hist, JSON.stringify(history)), [history]);
      useEffect(() => localStorage.setItem(LS.goals, JSON.stringify(goals)), [goals]);
      useEffect(() => localStorage.setItem(LS.goalAch, JSON.stringify(goalAchievements)), [goalAchievements]);
      useEffect(() => localStorage.setItem(LS.sound, String(soundEnabled)), [soundEnabled]);

      // targetDate change: load records
      useEffect(() => {
        if (dailyRecords[targetDate]) setRecords(dailyRecords[targetDate]);
        else setRecords({});
      }, [targetDate, dailyRecords]);

      // ---------- Derived ----------
      const gradeCategory = useMemo(() => {
        if (user.grade <= 2) return "low";
        if (user.grade <= 4) return "mid";
        return "high";
      }, [user.grade]);

      const currentLevelSet = useMemo(() => {
        return levelsData[gradeCategory]
          .map(l => {
            const name = (l.name !== undefined) ? l.name : `${l.level}級`;
            return { ...l, name };
          })
          .filter(l => l.name !== "");
      }, [levelsData, gradeCategory]);

      const displayTricks = useMemo(() => {
        const active = new Set();
        levelsData[gradeCategory].forEach(l => {
          if (l.name === "") return;
          if (!l.reqs) return;
          Object.entries(l.reqs).forEach(([k, v]) => {
            if (Number(v) > 0) active.add(k);
          });
        });
        return TRICK_IDS
          .filter(id => active.has(id))
          .map(id => ({
            id,
            color: TRICK_COLORS[id],
            label: (trickNames[gradeCategory] && trickNames[gradeCategory][id]) ? trickNames[gradeCategory][id] : DEFAULT_TRICK_NAMES[gradeCategory][id]
          }));
      }, [levelsData, gradeCategory, trickNames]);

      const calculateBestLevel = useCallback((currentRecords, category) => {
        if (!levelsData || !levelsData[category]) return 999;
        const levels = levelsData[category];
        const cleared = levels.filter(lvl => {
          if (lvl.name === "") return false;
          if (!lvl.reqs) return true;
          return Object.entries(lvl.reqs).every(([trickId, requiredCount]) => {
            const cnt = Number(currentRecords[trickId] || 0);
            if (!requiredCount || requiredCount <= 0) return true;
            return cnt >= requiredCount;
          });
        }).map(l => l.level);
        if (cleared.length === 0) return 999;
        return Math.min(...cleared);
      }, [levelsData]);

      const clearedLevels = useMemo(() => {
        return currentLevelSet
          .filter(lvl => Object.entries(lvl.reqs).every(([trickId, requiredCount]) => {
            const currentCount = Number(maxRecords[trickId] || 0);
            if (!requiredCount || requiredCount <= 0) return true;
            return currentCount >= requiredCount;
          }))
          .map(l => l.level);
      }, [currentLevelSet, maxRecords]);

      const currentBestLevel = useMemo(() => {
        if (!clearedLevels.length) return null;
        const min = Math.min(...clearedLevels);
        return currentLevelSet.find(l => l.level === min) || null;
      }, [clearedLevels, currentLevelSet]);

      const nextLevels = useMemo(() => {
        const all = levelsData[gradeCategory]
          .map(l => ({...l, name: (l.name !== undefined) ? l.name : `${l.level}級`}))
          .filter(l => l.name !== "");
        return all.filter(l => !clearedLevels.includes(l.level));
      }, [levelsData, gradeCategory, clearedLevels]);

      const goalTitle = useMemo(() => (user.grade <= 2 ? "つぎの もくひょう（きゅう と わざ）" : "次の目標（級と技）"), [user.grade]);

      const getTrickLevel = useCallback((trickId) => {
        const count = Number(maxRecords[trickId] || 0);
        if (!count) return null;
        const levels = levelsData[gradeCategory];
        const passed = levels.filter(l => {
          if (l.name === "") return false;
          if (!l.reqs) return false;
          const req = l.reqs[trickId];
          return req !== undefined && req !== null && req > 0 && count >= req;
        });
        if (!passed.length) return null;
        return Math.min(...passed.map(l => l.level));
      }, [maxRecords, levelsData, gradeCategory]);

      // 合計（旧コードの「合計と目標」を移植）
      const totalsByTrick = useMemo(() => {
        const totals = {};
        displayTricks.forEach(t => totals[t.id] = 0);
        Object.entries(dailyRecords).forEach(([dateKey, rec]) => {
          if (!rec) return;
          displayTricks.forEach(t => {
            const v = Number(rec[t.id] || 0);
            totals[t.id] += (isNaN(v) ? 0 : v);
          });
        });
        return totals;
      }, [dailyRecords, displayTricks]);

      const totalAll = useMemo(() => {
        return displayTricks.reduce((sum, t)=> sum + Number(totalsByTrick[t.id] || 0), 0);
      }, [displayTricks, totalsByTrick]);

      // goals default init when tricks change
      useEffect(() => {
        if (!displayTricks.length) return;
        setGoals(prev => {
          const next = {...prev};
          let changed = false;
          displayTricks.forEach(t => {
            if (next[t.id] === undefined){
              // それっぽい初期値（低学年は小さめ、高学年は大きめ）
              const base = (user.grade <= 2) ? 50 : (user.grade <= 4) ? 120 : 200;
              next[t.id] = base;
              changed = true;
            }
          });
          // 使われていない技は残してOK（データ互換優先）
          return changed ? next : prev;
        });
      }, [displayTricks, user.grade]);

      // 目標達成 → 次の目標提案（旧コードの20%UP）
      useEffect(() => {
        if (!displayTricks.length) return;
        displayTricks.forEach(t => {
          const g = Number(goals[t.id] || 0);
          const total = Number(totalsByTrick[t.id] || 0);
          if (!g || g <= 0) return;

          if (total >= g){
            const key = `${t.id}-${g}`;
            if (!goalAchievements.includes(key)){
              setGoalAchievements(prev => [...prev, key]);
              const nextGoal = Math.ceil(g * 1.2);
              setGoalUpdateModal({ trickId: t.id, oldGoal: g, newGoal: nextGoal });

              if (soundEnabled) soundRef.current?.fanfare();
              confetti.start();
            }
          }
        });
      }, [totalsByTrick, goals, displayTricks, goalAchievements, soundEnabled, confetti]);

      // ---------- Helpers ----------
      const playClick = () => { if (soundEnabled) soundRef.current?.click(); };
      const playSuccess = () => { if (soundEnabled) soundRef.current?.success(); };

      const clamp0 = (n) => Math.max(0, n);

      const recomputeMaxFromDaily = useCallback((nextDaily) => {
        const nextMax = {};
        Object.values(nextDaily).forEach(rec => {
          if (!rec) return;
          TRICK_IDS.forEach(id => {
            const v = Number(rec[id] || 0);
            if (!isNaN(v)){
              nextMax[id] = Math.max(Number(nextMax[id] || 0), v);
            }
          });
        });
        setMaxRecords(nextMax);
        localStorage.setItem(LS.max, JSON.stringify(nextMax));
      }, []);

      // ---------- Actions ----------
      const updateRecord = (trickId, count) => {
        setRecords(prev => ({ ...prev, [trickId]: count }));
      };

      const handleConfirmRecord = (trickId) => {
        playClick();

        const currentCount = Number(records[trickId] || 0);
        const currentMax = Number(maxRecords[trickId] || 0);

        const category = gradeCategory;
        const oldBest = calculateBestLevel(maxRecords, category);

        // daily
        const nextDaily = { ...dailyRecords };
        if (!nextDaily[targetDate]) nextDaily[targetDate] = {};
        nextDaily[targetDate] = { ...nextDaily[targetDate], [trickId]: currentCount };
        setDailyRecords(nextDaily);
        localStorage.setItem(LS.daily, JSON.stringify(nextDaily));

        // history（日付に1つでも記録が入ったら true）
        const nextHistory = { ...history, [targetDate]: true };
        setHistory(nextHistory);
        localStorage.setItem(LS.hist, JSON.stringify(nextHistory));

        // max
        let nextMax = { ...maxRecords };
        let isNew = false;
        if (currentCount > currentMax){
          nextMax[trickId] = currentCount;
          setMaxRecords(nextMax);
          localStorage.setItem(LS.max, JSON.stringify(nextMax));
          isNew = true;
        }

        // level up?
        const newBest = calculateBestLevel(nextMax, category);
        if (newBest < oldBest){
          playSuccess();
          confetti.start();
          // レベルアップ祝福モーダルは cert画面でも見られるので、ここは軽め（トースト）
          setCopyToast(true);
          setTimeout(()=>setCopyToast(false), 1400);
        } else if (isNew){
          playSuccess();
        }
      };

      // コピー（旧コードの「コピー」＋ 現コードの1行コピーを強化）
      const copyTSV = (tsv) => {
        const ta = document.createElement("textarea");
        ta.value = tsv;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        let ok = false;
        try{ ok = document.execCommand("copy"); }catch(e){}
        document.body.removeChild(ta);
        if (ok){
          setCopyToast(true);
          setTimeout(()=>setCopyToast(false), 1400);
        } else {
          alert("コピーに失敗しました。");
        }
      };

      const handleCopyRowToClipboard = () => {
        playClick();
        const header = ["名前","学年","組","番","現在の級", ...displayTricks.map(t=>t.label)].join("\t");
        const levelName = currentBestLevel ? currentBestLevel.name : "なし";
        const row = [
          user.name || "名無し",
          user.grade,
          user.classVal || "",
          user.number || "",
          levelName,
          ...displayTricks.map(t => {
            const v = Number(records[t.id] || 0);
            const lv = (() => {
              // 任意回数の級（その日の記録の目安）
              const levels = levelsData[gradeCategory];
              const passed = levels.filter(l => {
                if (l.name === "") return false;
                if (!l.reqs) return false;
                const req = l.reqs[t.id];
                return req !== undefined && req !== null && req > 0 && v >= req;
              });
              if (!passed.length) return null;
              return Math.min(...passed.map(l => l.level));
            })();
            return lv ? `${v}(${lv}級)` : `${v}`;
          })
        ].join("\t");
        copyTSV(header + "\n" + row);
      };

      // 旧コードの「日付×種目」テーブルコピー（合計行付き）
      const handleCopyAllRecordsTSV = () => {
        playClick();
        const headers = ["日付", ...displayTricks.map(t=>t.label)];
        const rows = [headers.join("\t")];

        const dates = Object.keys(dailyRecords).sort((a,b)=> new Date(a) - new Date(b));
        const totals = {};
        displayTricks.forEach(t=> totals[t.id]=0);

        dates.forEach(dk => {
          const rec = dailyRecords[dk] || {};
          const row = [dk];
          displayTricks.forEach(t => {
            const v = Number(rec[t.id] || 0);
            totals[t.id] += (isNaN(v)?0:v);
            row.push(String(isNaN(v)?0:v));
          });
          rows.push(row.join("\t"));
        });

        const totalRow = ["合計", ...displayTricks.map(t=>String(totals[t.id] || 0))];
        rows.push(totalRow.join("\t"));

        copyTSV(rows.join("\n"));
      };

      // 旧コードの「復元（貼り付け）」を移植：日付 + 見出し（技名）で読み込む
      const executeImportTSV = () => {
        try{
          const text = (importText || "").trim();
          if (!text){
            alert("データを貼り付けてください。");
            return;
          }
          const lines = text.split(/\r?\n/);
          if (lines.length < 2){
            alert("データ形式が正しくないようです（行数が足りません）。");
            return;
          }
          const headers = lines[0].split("\t").map(s=>s.trim());
          // date column index
          const dateIdx = headers.findIndex(h => h === "日付" || h.toLowerCase() === "date");
          if (dateIdx === -1){
            alert("先頭行に「日付」列が見つかりませんでした。");
            return;
          }

          // trick label -> id
          const map = {};
          displayTricks.forEach(t => {
            const idx = headers.indexOf(t.label);
            if (idx !== -1) map[t.id] = idx;
          });

          let nextDaily = { ...dailyRecords };
          let nextHistory = { ...history };
          let importedCount = 0;

          for (let i=1;i<lines.length;i++){
            const cols = lines[i].split("\t");
            if (!cols.length) continue;
            const dk = (cols[dateIdx] || "").trim();
            if (!dk || dk === "合計") continue;
            if (!/^\d{4}-\d{2}-\d{2}$/.test(dk)) continue;

            if (!nextDaily[dk]) nextDaily[dk] = {};
            Object.entries(map).forEach(([trickId, idx]) => {
              const v = Number((cols[idx] || "0").trim());
              if (!isNaN(v)) nextDaily[dk][trickId] = v;
            });

            nextHistory[dk] = true;
            importedCount++;
          }

          setDailyRecords(nextDaily);
          setHistory(nextHistory);
          localStorage.setItem(LS.daily, JSON.stringify(nextDaily));
          localStorage.setItem(LS.hist, JSON.stringify(nextHistory));

          // max 再計算
          recomputeMaxFromDaily(nextDaily);

          setImportModalOpen(false);
          setImportText("");
          playSuccess();
          alert(`${importedCount}行のデータを読み込みました！`);
        }catch(e){
          console.error(e);
          alert("エラーが発生しました。データ形式を確認してください。");
        }
      };

      // 日付行の削除
      const deleteDateRow = (dk) => {
        playClick();
        const nextDaily = {...dailyRecords};
        delete nextDaily[dk];
        setDailyRecords(nextDaily);
        localStorage.setItem(LS.daily, JSON.stringify(nextDaily));

        const nextHistory = {...history};
        delete nextHistory[dk];
        setHistory(nextHistory);
        localStorage.setItem(LS.hist, JSON.stringify(nextHistory));

        recomputeMaxFromDaily(nextDaily);

        // 今開いている日を消したら、今日へ
        if (targetDate === dk){
          setTargetDate(todayKeyLocal());
        }
      };

      // 全消去（先生モードも想定して2段階）
      const hardResetAll = () => {
        const ok = window.confirm("【最終確認】すべてのデータ（名前・記録・目標・設定）を消します。よろしいですか？");
        if (!ok) return;
        Object.values(LS).forEach(k => localStorage.removeItem(k));
        location.reload();
      };

      const softResetRecordsOnly = () => {
        const ok = window.confirm("記録（がんばり・ベスト・履歴・目標達成履歴）をリセットします。\n検定表（先生設定）は残します。よろしいですか？");
        if (!ok) return;
        setRecords({});
        setDailyRecords({});
        setMaxRecords({});
        setHistory({});
        setGoalAchievements([]);
        localStorage.removeItem(LS.records);
        localStorage.removeItem(LS.daily);
        localStorage.removeItem(LS.max);
        localStorage.removeItem(LS.hist);
        localStorage.removeItem(LS.goalAch);
        setTargetDate(todayKeyLocal());
        setActiveTab("home");
      };

      // ---------- Teacher settings handlers（現コードの機能保持） ----------
      const handleSaveSettings = () => {
        localStorage.setItem(LS.levels, JSON.stringify(levelsData));
        localStorage.setItem(LS.names, JSON.stringify(trickNames));
        localStorage.setItem(LS.ver, DATA_VERSION);
        alert("設定をこのブラウザに保存しました！\n生徒に配る場合は「児童配付用ファイルを書き出し」ボタンを使ってください。");
      };

      const handleDownloadJson = () => {
        const data = { levelsData, trickNames, version: DATA_VERSION };
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `nawatobi-settings-${todayKeyLocal()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const fileInputRef = useRef(null);
      const handleUploadJson = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try{
            const data = JSON.parse(ev.target.result);
            if (data.levelsData && data.trickNames){
              setLevelsData(data.levelsData);
              setTrickNames(data.trickNames);
              localStorage.setItem(LS.levels, JSON.stringify(data.levelsData));
              localStorage.setItem(LS.names, JSON.stringify(data.trickNames));
              localStorage.setItem(LS.ver, DATA_VERSION);
              alert("設定ファイルを読み込み、復元しました！");
            } else {
              alert("無効なファイル形式です。");
            }
          }catch(err){
            console.error(err);
            alert("ファイルの読み込みに失敗しました。");
          }
        };
        reader.readAsText(file);
        e.target.value = "";
      };

      const handleExportHtml = () => {
        // このファイル自体を「児童配付用」に書き出し（先生モードOFFにして、級表/技名の設定を焼き込み）
        const scriptContent = document.getElementById("app-script").textContent;

        const bakedLevels = "const DEFAULT_LEVELS_DATA = " + JSON.stringify(levelsData, null, 2) + ";";
        const bakedNames  = "const DEFAULT_TRICK_NAMES = " + JSON.stringify(trickNames, null, 2) + ";";
        const bakedVer    = 'const DATA_VERSION = "' + DATA_VERSION + "-custom-" + Date.now() + '";';

        let newScript = scriptContent
          .replace(/const DEFAULT_LEVELS_DATA = \{[\s\S]*?\};/, bakedLevels)
          .replace(/const DEFAULT_TRICK_NAMES = \{[\s\S]*?\};/, bakedNames)
          .replace(/const DATA_VERSION = ".*?";/, bakedVer)
          .replace("const IS_TEACHER_MODE = true;", "const IS_TEACHER_MODE = false;");

        const html =
`<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>なわとび検定カード（配付用）</title>
  <script src="https://cdn.tailwindcss.com"><\/script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
  <\/script>
  <style>
    :root{ --safe-bottom: env(safe-area-inset-bottom, 0px); }
    body{
      font-family:"M PLUS Rounded 1c",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      touch-action:manipulation;
      -webkit-tap-highlight-color:transparent;
      padding-bottom:calc(96px + var(--safe-bottom));
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    input[type="number"]{ -moz-appearance:textfield; }
    .custom-scrollbar::-webkit-scrollbar{height:8px;width:8px;}
    .custom-scrollbar::-webkit-scrollbar-track{background:#f1f5f9;}
    .custom-scrollbar::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px;}
    .custom-scrollbar::-webkit-scrollbar-thumb:hover{background:#94a3b8;}
    .sticky-col{position:sticky;left:0;z-index:10;background:white;border-right:2px solid #e2e8f0;}
    .sticky-corner{position:sticky;left:0;top:0;z-index:30;background:#f8fafc;border-right:2px solid #e2e8f0;border-bottom:2px solid #e2e8f0;}
    @keyframes popIn{0%{transform:scale(.92);opacity:0}100%{transform:scale(1);opacity:1}}
    .animate-popIn{animation:popIn .28s cubic-bezier(.175,.885,.32,1.2) both;}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .animate-fadeInUp{animation:fadeInUp .25s ease-out both;}
    @keyframes confettiBg{0%{background-position:0 0}100%{background-position:120px 120px}}
    .bg-confetti{
      background-image:radial-gradient(#FCD34D 22%, transparent 22%),radial-gradient(#FB7185 22%, transparent 22%),radial-gradient(#60A5FA 22%, transparent 22%);
      background-color:#fff;
      background-position:0 0,60px 30px,30px 60px;
      background-size:120px 120px;
      animation:confettiBg 4s linear infinite;
    }
  </style>
</head>
<body class="bg-sky-50 text-slate-800 select-none">
  <div id="root"></div>
  <script type="text/babel" data-type="module" id="app-script">
${newScript}
  <\/script>
</body>
</html>`;

        const blob = new Blob([html], {type:"text/html"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `nawatobi-distribute-${todayKeyLocal()}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const handleLevelReqChange = (category, levelIndex, trickId, value) => {
        const newData = { ...levelsData };
        const val = parseInt(value);
        if (isNaN(val) || val <= 0) {
          if (newData[category][levelIndex].reqs) delete newData[category][levelIndex].reqs[trickId];
        } else {
          if (!newData[category][levelIndex].reqs) newData[category][levelIndex].reqs = {};
          newData[category][levelIndex].reqs[trickId] = val;
        }
        setLevelsData(newData);
      };

      const handleTrickNameChange = (category, trickId, newName) => {
        const newNames = { ...trickNames };
        newNames[category][trickId] = newName;
        setTrickNames(newNames);
      };

      const handleLevelNameChange = (category, levelIndex, newName) => {
        const newData = { ...levelsData };
        newData[category][levelIndex].name = newName;
        setLevelsData(newData);
      };

      const handleResetSettings = () => {
        const ok = window.confirm("本当に初期設定（大阪府モデル）に戻しますか？\nカスタマイズした内容は消えてしまいます。");
        if (!ok) return;
        setLevelsData(DEFAULT_LEVELS_DATA);
        setTrickNames(DEFAULT_TRICK_NAMES);
        localStorage.removeItem(LS.levels);
        localStorage.removeItem(LS.names);
        localStorage.removeItem(LS.ver);
        alert("初期設定に戻しました。");
        location.reload();
      };

      // ---------- UI helpers ----------
      const NavButton = ({id, label, icon: Icon, active, onClick, badge}) => (
        <button
          onClick={onClick}
          className={`flex-1 flex flex-col items-center justify-center gap-1 py-2 rounded-2xl transition active:scale-95 ${
            active ? "text-orange-600" : "text-slate-400 hover:text-slate-600"
          }`}
        >
          <div className={`w-12 h-9 rounded-full flex items-center justify-center transition-all ${
            active ? "bg-orange-100 -translate-y-0.5" : "bg-slate-100"
          }`}>
            <Icon size={22} />
          </div>
          <div className="text-[11px] font-extrabold leading-none">{label}</div>
          {badge ? <div className="text-[10px] font-black text-orange-500">{badge}</div> : null}
        </button>
      );

      // =========================
      // 先生用：検定表作成画面
      // =========================
      if (activeTab === "settings" && IS_TEACHER_MODE){
        return (
          <div className="min-h-screen bg-slate-50 pb-24">
            <header className="sticky top-0 z-40 bg-gradient-to-r from-slate-900 to-slate-700 text-white px-4 py-3 shadow-lg">
              <div className="max-w-5xl mx-auto flex items-center justify-between gap-2 flex-wrap">
                <div className="flex items-center gap-2">
                  <button onClick={() => { playClick(); setActiveTab("home"); }} className="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 font-black text-sm">
                    ← もどる
                  </button>
                  <div className="flex items-center gap-2">
                    <Settings size={18}/>
                    <div className="font-extrabold">検定表作成（先生用）</div>
                  </div>
                </div>

                <div className="flex gap-2 items-center">
                  <input type="file" ref={fileInputRef} accept=".json" onChange={handleUploadJson} className="hidden" />
                  <button onClick={() => { playClick(); fileInputRef.current?.click(); }} className="bg-indigo-600 hover:bg-indigo-500 px-3 py-2 rounded-xl font-black text-xs flex items-center gap-2 shadow">
                    <Upload size={16}/> 設定読込
                  </button>
                  <button onClick={() => { playClick(); handleDownloadJson(); }} className="bg-orange-600 hover:bg-orange-500 px-3 py-2 rounded-xl font-black text-xs flex items-center gap-2 shadow">
                    <Download size={16}/> 設定保存
                  </button>
                  <button onClick={() => { playClick(); handleExportHtml(); }} className="bg-emerald-600 hover:bg-emerald-500 px-3 py-2 rounded-xl font-black text-xs flex items-center gap-2 shadow">
                    <FileDown size={16}/> 児童配付用を書き出し
                  </button>
                  <button onClick={() => { playClick(); handleSaveSettings(); }} className="bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded-xl font-black text-xs flex items-center gap-2 shadow">
                    <Save size={16}/> 保存
                  </button>
                </div>
              </div>
            </header>

            <main className="max-w-5xl mx-auto p-4">
              <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-4">
                <div className="flex items-center justify-between flex-wrap gap-2">
                  <div className="font-extrabold text-slate-700 flex items-center gap-2">
                    <Sparkles className="text-yellow-500" size={18}/>
                    技名・級名・必要回数をカスタマイズ
                  </div>
                  <div className="text-xs text-slate-500 font-bold">
                    ※ 級名を空欄にすると、その級は表示されません（無効化）
                  </div>
                </div>

                <div className="mt-3 flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                  {[
                    {id:"low", label:"1・2年用"},
                    {id:"mid", label:"3・4年用"},
                    {id:"high", label:"5・6年用"}
                  ].map(tab => (
                    <button
                      key={tab.id}
                      onClick={() => { playClick(); setSettingTab(tab.id); }}
                      className={`px-4 py-2 rounded-full font-black whitespace-nowrap transition ${
                        settingTab === tab.id ? "bg-slate-900 text-white" : "bg-slate-100 text-slate-600 hover:bg-slate-200"
                      }`}
                    >
                      {tab.label}
                    </button>
                  ))}
                </div>
              </div>

              <div className="bg-white rounded-2xl shadow border border-slate-200 overflow-hidden">
                <div className="overflow-x-auto custom-scrollbar">
                  <table className="w-full text-sm border-collapse">
                    <thead className="sticky top-0 z-20 bg-slate-100">
                      <tr>
                        <th className="sticky-corner p-3 min-w-[88px] text-center font-black">級</th>
                        {TRICK_IDS.map(trickId => (
                          <th key={trickId} className="p-2 border-b border-slate-200 min-w-[110px]">
                            <input
                              value={trickNames[settingTab][trickId]}
                              onChange={(e) => handleTrickNameChange(settingTab, trickId, e.target.value)}
                              className="w-full bg-transparent text-center font-black text-xs border-b border-dashed border-slate-300 focus:outline-none focus:border-sky-500 select-text py-1"
                            />
                          </th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {levelsData[settingTab].map((lvl, idx) => (
                        <tr key={lvl.level} className="hover:bg-slate-50">
                          <td className="sticky-col p-2 bg-slate-50 text-center font-black text-slate-700">
                            <input
                              value={lvl.name !== undefined ? lvl.name : `${lvl.level}級`}
                              placeholder={`${lvl.level}級`}
                              onChange={(e) => handleLevelNameChange(settingTab, idx, e.target.value)}
                              className={`w-full bg-transparent text-center font-black border-b border-transparent focus:border-sky-500 focus:outline-none select-text ${
                                lvl.name === "" ? "text-red-300 bg-red-50" : ""
                              }`}
                            />
                          </td>
                          {TRICK_IDS.map(trickId => {
                            const v = (lvl.reqs && lvl.reqs[trickId]) ? lvl.reqs[trickId] : "";
                            return (
                              <td key={trickId} className="p-1 border-b border-slate-100">
                                <input
                                  type="number"
                                  value={v}
                                  onChange={(e) => handleLevelReqChange(settingTab, idx, trickId, e.target.value)}
                                  placeholder="-"
                                  className={`w-full text-center rounded-lg p-1 focus:outline-none focus:ring-2 focus:ring-sky-400 select-text ${
                                    v ? "bg-sky-50 text-sky-700 font-black" : "text-slate-300"
                                  }`}
                                />
                              </td>
                            );
                          })}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              <div className="mt-8 text-center">
                <button onClick={() => { playClick(); handleResetSettings(); }} className="text-xs font-black text-red-400 hover:text-red-600 underline inline-flex items-center gap-2">
                  <RotateCcw size={14}/> 設定を初期値に戻す
                </button>
              </div>
            </main>
          </div>
        );
      }

      // =========================
      // UI: 共通ヘッダー（先生ボタン＋音）
      // =========================
      const Header = () => (
        <header className="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-sky-100 shadow-sm">
          <div className="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between gap-2">
            <div className="flex items-center gap-2">
              <div className="bg-gradient-to-br from-sky-400 to-indigo-500 text-white p-2 rounded-2xl shadow">
                <Activity size={20} strokeWidth={2.8}/>
              </div>
              <div>
                <div className="text-[11px] font-extrabold text-slate-400 leading-none">なわとび</div>
                <div className="text-base font-black text-sky-700 leading-tight">検定カード</div>
              </div>
            </div>

            <div className="flex items-center gap-2">
              <button
                onClick={() => { playClick(); setSoundEnabled(v => !v); }}
                className="px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 hover:bg-slate-100 text-slate-600 font-black text-xs flex items-center gap-2 active:scale-95"
                title="サウンドON/OFF"
              >
                {soundEnabled ? <Volume2 size={16}/> : <VolumeX size={16}/>}
                <span className="hidden sm:inline">{soundEnabled ? "サウンドON" : "サウンドOFF"}</span>
              </button>

              <div className="text-right">
                <div className="text-[10px] text-slate-400 font-black">げんざいのきゅう</div>
                <div className="text-xl font-black text-pink-500 leading-none">
                  {currentBestLevel ? currentBestLevel.name : "―"}
                </div>
              </div>
            </div>
          </div>
        </header>
      );

      // =========================
      // HOME
      // =========================
      const HomeView = () => (
        <div className="space-y-4 animate-fadeInUp">
          <div className="bg-white rounded-3xl shadow-xl border-4 border-sky-100 overflow-hidden">
            <div className="relative bg-gradient-to-r from-sky-50 to-indigo-50 p-4 border-b border-sky-100 text-center">
              {IS_TEACHER_MODE && (
                <button
                  onClick={() => { playClick(); setActiveTab("settings"); }}
                  className="absolute top-3 right-3 px-3 py-2 rounded-xl bg-white/70 hover:bg-white border border-sky-100 text-sky-600 font-black text-xs flex items-center gap-2 shadow-sm active:scale-95"
                >
                  <Settings size={16}/> 検定表を編集
                </button>
              )}
              <div className="inline-flex items-center justify-center w-12 h-12 rounded-2xl bg-white shadow-sm border border-sky-100 text-sky-600 mb-2">
                <Sparkles size={26}/>
              </div>
              <div className="text-xl font-black text-slate-800">なわとび検定カード</div>
              <div className="text-[11px] font-bold text-slate-500 mt-1">
                “きろく” と “ごうけい” で、どんどん うまくなる！
              </div>
            </div>

            <div className="p-4">
              <div className="bg-sky-50/70 p-3 rounded-2xl border-2 border-sky-100 mb-4">
                <div className="flex items-center gap-2 text-sky-700 mb-2">
                  <Pencil size={14}/>
                  <div className="text-xs font-black">なまえを かいてね</div>
                </div>

                <div className="grid grid-cols-12 gap-2">
                  <div className="col-span-3">
                    <select
                      value={user.grade}
                      onChange={(e)=> setUser(prev => ({...prev, grade: Number(e.target.value)}))}
                      className="w-full p-2 rounded-xl border border-sky-200 bg-white font-black select-text"
                    >
                      {[1,2,3,4,5,6].map(g => <option key={g} value={g}>{g} 年</option>)}
                    </select>
                  </div>
                  <div className="col-span-3">
                    <input
                      value={user.classVal}
                      onChange={(e)=> setUser(prev => ({...prev, classVal: e.target.value}))}
                      placeholder="組"
                      className="w-full p-2 rounded-xl border border-sky-200 bg-white font-black text-center select-text"
                    />
                  </div>
                  <div className="col-span-3">
                    <input
                      value={user.number}
                      onChange={(e)=> setUser(prev => ({...prev, number: e.target.value}))}
                      placeholder="番"
                      className="w-full p-2 rounded-xl border border-sky-200 bg-white font-black text-center select-text"
                    />
                  </div>
                  <div className="col-span-12 sm:col-span-3">
                    <input
                      value={user.name}
                      onChange={(e)=> setUser(prev => ({...prev, name: e.target.value}))}
                      placeholder="なまえ"
                      className="w-full p-2 rounded-xl border border-sky-200 bg-white font-black select-text"
                    />
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 gap-3">
                <button
                  onClick={()=>{ playClick(); setTargetDate(todayKeyLocal()); setActiveTab("input"); }}
                  className="group flex items-center gap-3 p-3 rounded-2xl border-2 border-blue-200 bg-blue-50 hover:bg-blue-100 shadow-sm hover:shadow-md active:scale-95 transition"
                >
                  <div className="w-11 h-11 rounded-2xl bg-blue-500 text-white flex items-center justify-center shadow group-hover:scale-110 transition">
                    <RefreshCw size={20}/>
                  </div>
                  <div className="text-left">
                    <div className="text-lg font-black text-blue-700 leading-tight">きろく を つける</div>
                    <div className="text-[11px] font-bold text-blue-500">今日もベストにチャレンジ！</div>
                  </div>
                </button>

                <button
                  onClick={()=>{ playClick(); setActiveTab("stats"); }}
                  className="group flex items-center gap-3 p-3 rounded-2xl border-2 border-orange-200 bg-orange-50 hover:bg-orange-100 shadow-sm hover:shadow-md active:scale-95 transition"
                >
                  <div className="w-11 h-11 rounded-2xl bg-orange-500 text-white flex items-center justify-center shadow group-hover:scale-110 transition">
                    <Trophy size={20}/>
                  </div>
                  <div className="text-left">
                    <div className="text-lg font-black text-orange-700 leading-tight">ごうけい と もくひょう</div>
                    <div className="text-[11px] font-bold text-orange-500">たまった回数で目標達成！</div>
                  </div>
                </button>

                <button
                  onClick={()=>{ playClick(); setActiveTab("cert"); }}
                  className="group flex items-center gap-3 p-3 rounded-2xl border-2 border-pink-200 bg-pink-50 hover:bg-pink-100 shadow-sm hover:shadow-md active:scale-95 transition"
                >
                  <div className="w-11 h-11 rounded-2xl bg-pink-500 text-white flex items-center justify-center shadow group-hover:scale-110 transition">
                    <Award size={20}/>
                  </div>
                  <div className="text-left">
                    <div className="text-lg font-black text-pink-700 leading-tight">にんていしょう</div>
                    <div className="text-[11px] font-bold text-pink-500">いまの級をかくにん</div>
                  </div>
                </button>

                <button
                  onClick={()=>{ playClick(); setActiveTab("history"); setHistoryView("calendar"); }}
                  className="group flex items-center gap-3 p-3 rounded-2xl border-2 border-emerald-200 bg-emerald-50 hover:bg-emerald-100 shadow-sm hover:shadow-md active:scale-95 transition"
                >
                  <div className="w-11 h-11 rounded-2xl bg-emerald-500 text-white flex items-center justify-center shadow group-hover:scale-110 transition">
                    <Calendar size={20}/>
                  </div>
                  <div className="text-left">
                    <div className="text-lg font-black text-emerald-700 leading-tight">がんばり</div>
                    <div className="text-[11px] font-bold text-emerald-500">カレンダー / 一覧</div>
                  </div>
                </button>
              </div>

              <div className="mt-4 text-center">
                <button
                  onClick={()=>{ playClick(); setDeleteModal({type:"soft"}); }}
                  className="text-[11px] font-black text-slate-300 hover:text-red-400 underline inline-flex items-center gap-2"
                >
                  <RotateCcw size={12}/> 記録をリセット（設定は残す）
                </button>
                {IS_TEACHER_MODE && (
                  <div className="mt-2">
                    <button
                      onClick={()=>{ playClick(); setDeleteModal({type:"hard"}); }}
                      className="text-[11px] font-black text-red-300 hover:text-red-600 underline inline-flex items-center gap-2"
                    >
                      <Trash2 size={12}/> 完全リセット（設定も消す）
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* 小さな今日のヒント */}
          <div className="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm">
            <div className="flex items-start gap-3">
              <div className="w-10 h-10 rounded-2xl bg-yellow-100 text-yellow-700 flex items-center justify-center border border-yellow-200">
                <Star size={18}/>
              </div>
              <div>
                <div className="font-black text-slate-700">コツ</div>
                <div className="text-sm text-slate-500 font-bold leading-relaxed">
                  「けってい」をおすと、<span className="text-sky-600 font-black">保存</span>されて、<span className="text-orange-600 font-black">ごうけい</span>にもたまるよ。
                </div>
              </div>
            </div>
          </div>
        </div>
      );

      // =========================
      // INPUT
      // =========================
      const InputView = () => {
        const today = todayKeyLocal();
        const hasAny = Object.keys(records || {}).some(k => Number(records[k]||0) > 0);

        return (
          <div className="space-y-4 animate-fadeInUp">
            <div className="bg-white rounded-3xl p-4 shadow-sm border border-slate-100">
              <div className="flex items-end justify-between gap-2 flex-wrap">
                <div>
                  <div className="flex items-center gap-2">
                    <RefreshCw size={20} className="text-sky-500"/>
                    <div className="text-lg font-black text-slate-700">きろく を いれよう</div>
                  </div>
                  <div className="text-[11px] font-bold text-slate-400 mt-1">
                    ひっかからずに <span className="text-pink-500 font-black">れんぞく</span> でとべた回数
                  </div>
                </div>

                <div className="flex items-center gap-2">
                  <div className="relative">
                    <input
                      type="date"
                      value={targetDate}
                      onChange={(e)=> { playClick(); setTargetDate(e.target.value); }}
                      className="pl-9 pr-3 py-2 rounded-xl border border-slate-200 text-xs font-black text-slate-600 focus:outline-none focus:border-sky-400"
                    />
                    <CalendarDays size={16} className="absolute left-3 top-2.5 text-slate-400 pointer-events-none"/>
                  </div>
                  <button
                    onClick={()=>{ playClick(); setTargetDate(today); }}
                    className="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700 font-black text-xs active:scale-95"
                  >
                    今日
                  </button>
                  <button
                    onClick={handleCopyRowToClipboard}
                    className="px-3 py-2 rounded-xl bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 text-emerald-700 font-black text-xs flex items-center gap-2 active:scale-95"
                  >
                    <Copy size={16}/> 1行コピー
                  </button>
                </div>
              </div>

              {(targetDate !== today || hasAny) && (
                <div className="mt-3 bg-orange-50 border border-orange-200 text-orange-600 font-black text-xs text-center py-2 rounded-xl">
                  数字をかえたら「けってい」をおしてね
                </div>
              )}

              <div className="mt-4 space-y-3">
                {displayTricks.map(trick => {
                  const currentVal = records[trick.id];
                  const currentNum = Number(currentVal || 0);

                  const savedVal = dailyRecords[targetDate]?.[trick.id];
                  const savedExists = savedVal !== undefined && savedVal !== null && savedVal !== "";
                  const savedNum = Number(savedVal || 0);

                  const isSaved = savedExists && (currentNum === savedNum);

                  const best = Number(maxRecords[trick.id] || 0);
                  const bestLevel = getTrickLevel(trick.id);

                  const borderClass = trick.color.split(" ").find(s => s.startsWith("border-")) || "border-slate-200";

                  return (
                    <div key={trick.id} className={`p-3 rounded-2xl border-2 ${borderClass} bg-white hover:border-sky-300 transition`}>
                      <div className="flex items-center justify-between gap-3 flex-wrap">
                        <div className="flex items-center gap-3 min-w-[180px]">
                          <div className={`w-11 h-11 rounded-2xl flex items-center justify-center font-black shadow-sm ${trick.color}`}>
                            {trick.label.substring(0,1)}
                          </div>
                          <div>
                            <div className="font-black text-slate-800 flex flex-wrap items-center gap-2">
                              <span>{trick.label}</span>
                              <span className="text-xs font-black text-orange-700 bg-orange-50 border border-orange-200 px-2 py-0.5 rounded-full">
                                最高: {best}
                              </span>
                              {bestLevel && (
                                <span className="text-xs font-black bg-yellow-100 text-yellow-800 border border-yellow-300 px-2 py-0.5 rounded-full">
                                  {bestLevel}級
                                </span>
                              )}
                            </div>
                            <div className="text-[11px] font-bold text-slate-400">
                              今日の記録：{savedExists ? savedNum : "未保存"}
                            </div>
                          </div>
                        </div>

                        <div className="flex items-center gap-2">
                          <button
                            onClick={()=>{ playClick(); updateRecord(trick.id, clamp0(Number(records[trick.id] || 0) - 1)); }}
                            className="w-11 h-11 rounded-2xl bg-slate-50 border border-slate-200 text-slate-400 flex items-center justify-center active:scale-95 hover:bg-slate-100"
                          >
                            <ChevronDown size={22}/>
                          </button>

                          <div className="flex items-end gap-1">
                            <input
                              type="number"
                              inputMode="numeric"
                              pattern="\d*"
                              value={Number(records[trick.id] || 0) > 0 ? records[trick.id] : ""}
                              placeholder="0"
                              onFocus={(e)=> requestAnimationFrame(()=>e.target.select())}
                              onChange={(e)=> updateRecord(trick.id, e.target.value)}
                              className={`w-20 text-center text-3xl font-black bg-transparent border-b-4 focus:outline-none p-1 select-text ${
                                isSaved ? "text-sky-600 border-sky-200" : "text-slate-900 border-slate-200 focus:border-sky-400"
                              }`}
                            />
                            <div className="text-xs font-black text-slate-400 mb-2">回</div>
                          </div>

                          <button
                            onClick={()=>{ playClick(); updateRecord(trick.id, Number(records[trick.id] || 0) + 1); }}
                            className="w-11 h-11 rounded-2xl bg-sky-100 border border-sky-200 text-sky-700 flex items-center justify-center active:scale-95 hover:bg-sky-200"
                          >
                            <ChevronUp size={22}/>
                          </button>

                          <button
                            onClick={()=>handleConfirmRecord(trick.id)}
                            className={`ml-1 w-16 h-11 rounded-2xl font-black text-xs flex flex-col items-center justify-center shadow-sm active:scale-95 transition ${
                              isSaved
                                ? "bg-sky-50 border-2 border-sky-200 text-sky-700"
                                : "bg-emerald-500 hover:bg-emerald-600 text-white animate-pulse"
                            }`}
                          >
                            {isSaved ? (<><CheckCircle size={16}/><span>保存</span></>) : (<><Check size={16}/><span>けってい</span></>)}
                          </button>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        );
      };

      // =========================
      // STATS（旧コードの「合計と目標」）
      // =========================
      const StatsView = () => {
        return (
          <div className="space-y-4 animate-fadeInUp">
            <div className="bg-white rounded-3xl p-5 shadow-md border-4 border-sky-100 relative overflow-hidden">
              <div className="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                <Trophy size={220}/>
              </div>

              <div className="relative z-10 flex items-center justify-between gap-2 flex-wrap">
                <div className="flex items-center gap-2">
                  <Trophy className="text-orange-500" size={22}/>
                  <div className="text-lg font-black text-slate-800">ごうけい と もくひょう</div>
                </div>

                <div className="flex gap-2">
                  <button
                    onClick={()=>{ playClick(); setGoalModalOpen(true); }}
                    className="px-4 py-2 rounded-full bg-sky-100 hover:bg-sky-200 border border-sky-200 text-sky-700 font-black text-xs flex items-center gap-2 shadow-sm active:scale-95"
                  >
                    <Settings size={16}/> 目標の設定
                  </button>
                  <button
                    onClick={()=>{ playClick(); setImportModalOpen(true); }}
                    className="px-4 py-2 rounded-full bg-white hover:bg-slate-50 border border-slate-200 text-slate-700 font-black text-xs flex items-center gap-2 shadow-sm active:scale-95"
                  >
                    <Upload size={16}/> 復元（貼り付け）
                  </button>
                  <button
                    onClick={handleCopyAllRecordsTSV}
                    className="px-4 py-2 rounded-full bg-orange-100 hover:bg-orange-200 border border-orange-200 text-orange-700 font-black text-xs flex items-center gap-2 shadow-sm active:scale-95"
                  >
                    <Copy size={16}/> 全部コピー
                  </button>
                </div>
              </div>

              <div className="relative z-10 mt-4 bg-slate-50 border border-slate-200 rounded-2xl p-4">
                <div className="flex items-center justify-between">
                  <div className="font-black text-slate-600">ぜんぶの ごうけい</div>
                  <div className="text-3xl font-black text-slate-900">{totalAll}</div>
                </div>
                <div className="text-[11px] font-bold text-slate-500 mt-1">
                  たくさん練習すると、どんどん数字がたまるよ！
                </div>
              </div>

              <div className="relative z-10 mt-4 space-y-3">
                {displayTricks.map(t => {
                  const total = Number(totalsByTrick[t.id] || 0);
                  const goal = Number(goals[t.id] || 0);
                  const pct = goal > 0 ? Math.min(100, Math.round((total/goal)*100)) : 0;
                  const done = goal > 0 && total >= goal;

                  return (
                    <div key={t.id} className="bg-white rounded-2xl border border-slate-200 p-3 shadow-sm">
                      <div className="flex items-center justify-between gap-3 flex-wrap">
                        <div className="flex items-center gap-3">
                          <div className={`w-11 h-11 rounded-2xl flex items-center justify-center font-black shadow-sm ${t.color}`}>
                            {t.label.substring(0,1)}
                          </div>
                          <div>
                            <div className="font-black text-slate-800">{t.label}</div>
                            <div className="text-[11px] font-bold text-slate-500">
                              合計：<span className="text-slate-800 font-black">{total}</span>　
                              目標：<span className="text-orange-700 font-black">{goal || "未設定"}</span>
                              {done && <span className="ml-2 inline-flex items-center gap-1 text-emerald-600 font-black"><CheckCircle size={14}/> 達成！</span>}
                            </div>
                          </div>
                        </div>

                        <div className="text-right">
                          <div className="text-xl font-black text-slate-900">{pct}<span className="text-xs">%</span></div>
                          <div className="text-[11px] font-bold text-slate-400">もくひょうまで</div>
                        </div>
                      </div>

                      <div className="mt-3">
                        <div className="w-full h-3 rounded-full bg-slate-100 border border-slate-200 overflow-hidden">
                          <div className="h-full bg-gradient-to-r from-orange-400 to-pink-500" style={{width: `${pct}%`}}></div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            <div className="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm">
              <div className="flex items-start gap-3">
                <div className="w-10 h-10 rounded-2xl bg-orange-100 text-orange-700 flex items-center justify-center border border-orange-200">
                  <Target size={18}/>
                </div>
                <div>
                  <div className="font-black text-slate-700">ポイント</div>
                  <div className="text-sm text-slate-500 font-bold leading-relaxed">
                    目標を達成すると、<span className="text-orange-600 font-black">次の目標（+20%）</span>を提案するよ。
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // =========================
      // CERT
      // =========================
      const CertView = () => (
        <div className="space-y-6 animate-fadeInUp">
          {user.grade <= 2 && (
            <div className="bg-white rounded-3xl p-6 shadow-lg border-4 border-pink-200 relative overflow-hidden text-center">
              <div className="absolute top-0 left-0 w-full h-4 bg-pink-200"></div>
              <div className="mt-3 mb-2">
                <div className="inline-block p-3 bg-pink-100 rounded-full text-pink-500 mb-2">
                  <Star size={32} fill="currentColor"/>
                </div>
                <div className="text-2xl font-black text-pink-500">にんていしょう</div>
              </div>
              <div className="text-lg font-black text-slate-700 mb-4">
                {user.grade}ねん {user.classVal}くみ {user.number}ばん<br/>
                <span className="text-2xl border-b-2 border-pink-300 px-2">
                  {user.name ? user.name : "（なまえ）"}
                </span> さん
              </div>
              <div className="bg-pink-50 rounded-2xl p-4 mb-4 border border-pink-200">
                <div className="text-sm font-black text-pink-400 mb-1">あなたは</div>
                <div className="text-5xl font-black text-pink-600 tracking-tight my-2">
                  {currentBestLevel ? currentBestLevel.name : "がんばり中"}
                </div>
                <div className="text-sm font-black text-pink-400">にごうかくしました！</div>
              </div>
              <div className="text-xs font-black text-slate-400">よく がんばりました</div>
              <div className="absolute -bottom-6 -right-6 w-24 h-24 bg-yellow-200 rounded-full opacity-50"></div>
              <div className="absolute -bottom-6 -left-6 w-20 h-20 bg-blue-200 rounded-full opacity-50"></div>
            </div>
          )}

          {(user.grade === 3 || user.grade === 4) && (
            <div className="bg-white rounded-3xl p-6 shadow-lg border border-sky-200 text-center">
              <div className="border-4 border-double border-sky-100 p-6 rounded-2xl">
                <Award size={48} className="mx-auto text-sky-500"/>
                <div className="text-3xl font-black text-sky-700 mt-2">認定証</div>

                <div className="mt-4 text-left bg-sky-50/70 p-4 rounded-2xl border border-sky-100 text-slate-700">
                  <div className="font-black mb-1">第 {user.grade} 学年 {user.classVal} 組 {user.number} 番</div>
                  <div className="text-2xl font-black border-b border-sky-300 pb-1 mb-3 inline-block min-w-[200px] text-center">
                    {user.name ? user.name : "（名前）"} 殿
                  </div>
                  <div className="text-sm font-bold leading-relaxed">
                    あなたは、なわとび検定において<br/>
                    頭書の成績を収められました。<br/>
                    よってここにこれを証します。
                  </div>
                </div>

                <div className="mt-5">
                  <div className="text-sm font-black text-sky-500">認定級</div>
                  <div className="text-4xl font-black text-sky-800 border-2 border-sky-600 inline-block px-8 py-2 rounded-2xl mt-2 bg-white shadow-sm">
                    {currentBestLevel ? currentBestLevel.name : "―"}
                  </div>
                </div>
              </div>
            </div>
          )}

          {user.grade >= 5 && (
            <div className="bg-slate-50 rounded-2xl p-6 shadow-xl border-t-8 relative text-center" style={{borderColor:"#d4af37"}}>
              <div className="mb-6 mt-2">
                <div className="text-xs tracking-[0.2em] text-slate-500 uppercase font-black mb-1">Certificate of Achievement</div>
                <div className="text-4xl font-black text-slate-800 border-b-2 border-slate-300 inline-block pb-2 px-4">記録証</div>
              </div>

              <div className="flex justify-between items-end mb-6 px-2">
                <div className="text-left">
                  <div className="text-sm font-bold text-slate-500">Name</div>
                  <div className="text-xl font-black text-slate-800">{user.name || "__________"}</div>
                </div>
                <div className="text-right">
                  <div className="text-sm font-bold text-slate-500">Grade</div>
                  <div className="text-xl font-black text-slate-800">{user.grade}-{user.classVal} ({user.number})</div>
                </div>
              </div>

              <div className="bg-white border border-slate-200 p-8 rounded-2xl shadow-inner mb-4">
                <div className="text-sm font-black text-slate-500 mb-2">Achieved Level</div>
                <div className="text-5xl font-black" style={{color:"#d4af37", textShadow:"1px 1px 0 rgba(0,0,0,0.08)"}}>
                  {currentBestLevel ? currentBestLevel.name : "Unranked"}
                </div>
              </div>

              <div className="text-left text-xs text-slate-400 font-bold mt-6 border-t border-slate-200 pt-2">
                大阪なわとび級判定基準 準拠（カスタム可）
              </div>
            </div>
          )}

          {/* 次の目標 */}
          <div className="bg-white rounded-3xl p-4 shadow-sm border border-slate-100">
            <div className="font-black text-slate-700 flex items-center gap-2 mb-3">
              <Target size={18} className="text-red-500"/>
              {goalTitle}
            </div>

            {nextLevels.length ? (
              <div className="space-y-2">
                {nextLevels.map(lvl => (
                  <div key={lvl.level} className="p-3 rounded-2xl border border-slate-100 bg-white text-slate-600 text-xs flex items-center justify-between">
                    <div className="flex items-center gap-3 flex-wrap">
                      <div className="font-black text-sm text-slate-500">{lvl.name}</div>
                      <div className="flex flex-wrap gap-1">
                        {Object.entries(lvl.reqs).map(([trickId, cnt]) => {
                          const trick = displayTricks.find(t => t.id === trickId);
                          if (!trick || !cnt) return null;
                          return (
                            <span key={trickId} className="px-2 py-1 rounded-xl border bg-slate-50 border-slate-200 font-bold">
                              {trick.label}: {cnt}回
                            </span>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center p-6 bg-yellow-50 rounded-2xl border border-yellow-200">
                <Trophy size={44} className="mx-auto text-yellow-500 mb-2"/>
                <div className="text-lg font-black text-yellow-700">すべての級をクリア！</div>
                <div className="text-xs font-bold text-yellow-700">おめでとうございます！</div>
              </div>
            )}
          </div>
        </div>
      );

      // =========================
      // HISTORY（カレンダー＋一覧＝旧コードの表を統合）
      // =========================
      const HistoryView = () => {
        const dates = Object.keys(dailyRecords).sort((a,b)=> new Date(a)-new Date(b));

        // 連続日数（現コードの考え方を継続：土日祝は飛ばしてOK）
        const streak = (() => {
          const now = new Date();
          const today = todayKeyLocal();
          const doneToday = !!history[today];
          let count = 0;

          const isWeekendOrHoliday = (d) => d.getDay() === 0 || d.getDay() === 6 || isJapaneseHoliday(d);

          if (doneToday){
            count = 1;
            const d = new Date(now);
            while(true){
              d.setDate(d.getDate()-1);
              const k = toLocalKey(d);
              if (history[k]) { count++; continue; }
              if (!isWeekendOrHoliday(d)) break;
            }
          } else {
            const d = new Date(now);
            d.setDate(d.getDate()-1);
            while(true){
              const k = toLocalKey(d);
              if (history[k]) { count++; d.setDate(d.getDate()-1); continue; }
              if (!isWeekendOrHoliday(d)) break;
              d.setDate(d.getDate()-1);
            }
          }
          return {count, doneToday};
        })();

        return (
          <div className="space-y-4 animate-fadeInUp">
            <div className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
              <div className="flex items-center justify-between flex-wrap gap-2">
                <div className="flex items-center gap-2">
                  <Calendar className="text-emerald-500" size={22}/>
                  <div className="text-lg font-black text-slate-800">がんばり</div>
                </div>

                <div className="flex gap-2">
                  <button
                    onClick={()=>{ playClick(); setHistoryView("calendar"); }}
                    className={`px-4 py-2 rounded-full font-black text-xs border transition active:scale-95 ${
                      historyView==="calendar" ? "bg-emerald-500 text-white border-emerald-500" : "bg-white text-slate-600 border-slate-200 hover:bg-slate-50"
                    }`}
                  >
                    カレンダー
                  </button>
                  <button
                    onClick={()=>{ playClick(); setHistoryView("table"); }}
                    className={`px-4 py-2 rounded-full font-black text-xs border transition active:scale-95 ${
                      historyView==="table" ? "bg-emerald-500 text-white border-emerald-500" : "bg-white text-slate-600 border-slate-200 hover:bg-slate-50"
                    }`}
                  >
                    一覧
                  </button>
                </div>
              </div>

              {/* streak */}
              <div className="mt-4 bg-orange-100 border-2 border-orange-200 rounded-2xl p-4 text-center">
                <div className="flex items-center justify-center gap-2 mb-1">
                  <Flame className="text-orange-600" size={22}/>
                  <div className="text-lg font-black text-orange-700">れんぞく記録</div>
                  <Flame className="text-orange-600" size={22}/>
                </div>
                <div className="text-4xl font-black text-orange-600">
                  {streak.count}<span className="text-base">日</span>
                </div>
                <div className="text-xs font-black text-orange-500 mt-1">
                  {streak.count>0 ? (streak.doneToday ? "すごい！ きょうも たっせい！" : "きのうまで つづいてるよ！") : "きょうから チャレンジ！"}
                </div>
              </div>

              {historyView === "calendar" ? (
                <div className="mt-5">
                  <div className="grid grid-cols-7 gap-2 max-w-sm mx-auto">
                    {[...Array(14)].map((_, i) => {
                      const d = new Date();
                      d.setDate(d.getDate() - (13 - i));
                      const k = toLocalKey(d);
                      const has = !!history[k];
                      const isToday = (k === todayKeyLocal());
                      return (
                        <div key={i} className="flex flex-col items-center gap-1">
                          <div className="text-[10px] font-bold text-slate-400">{d.getMonth()+1}/{d.getDate()}</div>
                          <div className={`w-11 h-11 rounded-2xl border-2 flex items-center justify-center transition ${
                            has ? "bg-emerald-100 border-emerald-500 text-emerald-700 scale-[1.03]" : "bg-slate-50 border-slate-100 text-slate-300"
                          } ${isToday ? "ring-2 ring-offset-2 ring-sky-300" : ""}`}>
                            {has ? <Medal size={20} fill="currentColor"/> : <div className="w-2 h-2 rounded-full bg-slate-200"></div>}
                          </div>
                        </div>
                      );
                    })}
                  </div>

                  <div className="mt-5 bg-emerald-50 p-4 rounded-2xl border border-emerald-100 text-left">
                    <div className="flex items-center gap-3 mb-2">
                      <User className="text-emerald-600" size={20}/>
                      <div className="font-black text-emerald-800">{user.name || "名無し"} さんのきろく</div>
                    </div>
                    <div className="text-xs font-bold text-emerald-700">
                      {user.isRegistered ? "記録中" : "未登録"}
                    </div>
                    <div className="mt-3 flex gap-2 flex-wrap">
                      <button
                        onClick={()=>{ playClick(); setActiveTab("input"); }}
                        className="px-4 py-2 rounded-2xl bg-white border border-emerald-200 text-emerald-800 font-black text-xs active:scale-95"
                      >
                        きろく を つける
                      </button>
                      <button
                        onClick={()=>{ playClick(); setActiveTab("stats"); }}
                        className="px-4 py-2 rounded-2xl bg-white border border-orange-200 text-orange-700 font-black text-xs active:scale-95"
                      >
                        ごうけい を みる
                      </button>
                    </div>
                  </div>
                </div>
              ) : (
                <div className="mt-5">
                  <div className="flex items-center justify-between flex-wrap gap-2 mb-3">
                    <div className="font-black text-slate-700 flex items-center gap-2">
                      <List size={18}/> きろく一覧（右にスクロール）
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={handleCopyAllRecordsTSV}
                        className="px-4 py-2 rounded-2xl bg-slate-100 hover:bg-slate-200 border border-slate-200 text-slate-700 font-black text-xs flex items-center gap-2 active:scale-95"
                      >
                        <Copy size={16}/> 全部コピー
                      </button>
                      <button
                        onClick={()=>{ playClick(); setImportModalOpen(true); }}
                        className="px-4 py-2 rounded-2xl bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 text-emerald-800 font-black text-xs flex items-center gap-2 active:scale-95"
                      >
                        <Upload size={16}/> 復元
                      </button>
                    </div>
                  </div>

                  <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <div className="overflow-x-auto custom-scrollbar">
                      <table className="w-full text-sm">
                        <thead className="bg-slate-100">
                          <tr>
                            <th className="sticky-corner p-3 text-center font-black min-w-[120px]">日付</th>
                            {displayTricks.map(t => (
                              <th key={t.id} className="p-3 font-black text-slate-700 min-w-[110px] text-center">
                                {t.label}
                              </th>
                            ))}
                            <th className="p-3 font-black text-slate-700 min-w-[140px] text-center">操作</th>
                          </tr>
                        </thead>

                        <tbody>
                          {dates.length ? dates.map(dk => {
                            const rec = dailyRecords[dk] || {};
                            return (
                              <tr key={dk} className="border-b border-slate-100 hover:bg-slate-50">
                                <td className="sticky-col p-3 font-black text-slate-700 min-w-[120px]">
                                  <button
                                    onClick={()=>{ playClick(); setTargetDate(dk); setActiveTab("input"); }}
                                    className="underline decoration-slate-200 hover:decoration-slate-400"
                                    title="この日を編集"
                                  >
                                    {dk}
                                  </button>
                                </td>
                                {displayTricks.map(t => (
                                  <td key={t.id} className="p-3 text-center font-black text-slate-700">
                                    {Number(rec[t.id] || 0)}
                                  </td>
                                ))}
                                <td className="p-3 text-center">
                                  <div className="flex gap-2 justify-center flex-wrap">
                                    <button
                                      onClick={()=>{ playClick(); setTargetDate(dk); setActiveTab("input"); }}
                                      className="px-3 py-2 rounded-xl bg-sky-50 hover:bg-sky-100 border border-sky-200 text-sky-700 font-black text-xs active:scale-95"
                                    >
                                      編集
                                    </button>
                                    <button
                                      onClick={()=>{ setDeleteModal({type:"date", dateKey: dk}); }}
                                      className="px-3 py-2 rounded-xl bg-red-50 hover:bg-red-100 border border-red-200 text-red-700 font-black text-xs active:scale-95"
                                    >
                                      削除
                                    </button>
                                  </div>
                                </td>
                              </tr>
                            );
                          }) : (
                            <tr>
                              <td colSpan={displayTricks.length + 2} className="p-6 text-center text-slate-400 font-black">
                                まだ記録がありません
                              </td>
                            </tr>
                          )}
                        </tbody>

                        {dates.length ? (
                          <tfoot>
                            <tr className="bg-slate-50 border-t border-slate-200">
                              <td className="sticky-col p-3 font-black text-slate-700">合計</td>
                              {displayTricks.map(t => (
                                <td key={t.id} className="p-3 text-center font-black text-slate-700">
                                  {Number(totalsByTrick[t.id] || 0)}
                                </td>
                              ))}
                              <td className="p-3 text-center text-xs font-black text-slate-400">—</td>
                            </tr>
                          </tfoot>
                        ) : null}
                      </table>
                    </div>
                  </div>

                  <div className="mt-3 text-center text-xs font-bold text-slate-400">
                    ※ コピーしたら、スプレッドシートで「貼り付け」できるよ
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      };

      // =========================
      // Modals
      // =========================
      const ModalShell = ({open, onClose, children}) => {
        if (!open) return null;
        return (
          <div className="fixed inset-0 z-[9999] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
            <div className="relative w-full max-w-lg animate-popIn">
              <button onClick={()=>{ playClick(); onClose(); }} className="absolute -top-2 -right-2 w-10 h-10 rounded-full bg-white text-slate-500 hover:text-slate-700 shadow flex items-center justify-center">
                <X/>
              </button>
              {children}
            </div>
          </div>
        );
      };

      // Goal settings modal
      const GoalModal = () => (
        <ModalShell open={goalModalOpen} onClose={()=>setGoalModalOpen(false)}>
          <div className="bg-white rounded-3xl p-6 border-4 border-sky-200 shadow-2xl max-h-[85vh] overflow-hidden flex flex-col">
            <div className="flex items-center justify-between">
              <div className="text-xl font-black text-sky-700 flex items-center gap-2">
                <Settings size={20}/> 目標の設定
              </div>
            </div>
            <div className="text-xs font-bold text-slate-500 mt-1">
              目標は「合計」に対してチェックします（達成すると +20% を提案）
            </div>

            <div className="mt-4 space-y-3 overflow-y-auto pr-1 custom-scrollbar flex-1">
              {displayTricks.map(t => (
                <div key={t.id} className="p-3 rounded-2xl border border-slate-200 bg-slate-50">
                  <div className="flex items-center justify-between gap-2">
                    <div className="flex items-center gap-3">
                      <div className={`w-10 h-10 rounded-2xl flex items-center justify-center font-black ${t.color}`}>
                        {t.label.substring(0,1)}
                      </div>
                      <div className="font-black text-slate-800">{t.label}</div>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="text-xs font-black text-slate-500">目標</div>
                      <input
                        type="number"
                        min="0"
                        value={goals[t.id] ?? ""}
                        onChange={(e)=>{
                          const v = Number(e.target.value);
                          setGoals(prev => ({...prev, [t.id]: (isNaN(v) ? 0 : v)}));
                        }}
                        className="w-28 text-center font-black text-lg rounded-2xl border border-slate-200 bg-white p-2 focus:outline-none focus:ring-2 focus:ring-sky-400 select-text"
                      />
                    </div>
                  </div>
                  <div className="mt-2 text-[11px] font-bold text-slate-500">
                    現在の合計：<span className="font-black text-slate-800">{Number(totalsByTrick[t.id] || 0)}</span>
                  </div>
                </div>
              ))}
            </div>

            <div className="mt-4 flex gap-2">
              <button
                onClick={()=>{ playClick(); setGoalModalOpen(false); }}
                className="flex-1 py-3 rounded-2xl bg-slate-200 hover:bg-slate-300 text-slate-700 font-black"
              >
                閉じる
              </button>
              <button
                onClick={()=>{ playSuccess(); setGoalModalOpen(false); }}
                className="flex-1 py-3 rounded-2xl bg-sky-600 hover:bg-sky-500 text-white font-black shadow"
              >
                保存
              </button>
            </div>
          </div>
        </ModalShell>
      );

      // Goal update modal (達成→次の目標)
      const GoalUpdateModal = () => {
        const data = goalUpdateModal;
        if (!data) return null;
        const trick = displayTricks.find(t => t.id === data.trickId);
        return (
          <ModalShell open={!!goalUpdateModal} onClose={()=>setGoalUpdateModal(null)}>
            <div className="bg-white rounded-3xl p-6 border-4 border-yellow-300 shadow-2xl overflow-hidden relative">
              <div className="absolute inset-0 bg-confetti opacity-30 pointer-events-none"></div>
              <div className="relative z-10 text-center">
                <div className="text-6xl mb-2">🎊</div>
                <div className="text-2xl font-black text-orange-600">目標達成！</div>
                <div className="text-sm font-black text-slate-700 mt-1">{trick ? trick.label : "この技"}</div>

                <div className="mt-4 bg-white rounded-2xl border border-orange-200 p-4 shadow-sm">
                  <div className="text-xs font-black text-slate-500">次の目標</div>
                  <div className="mt-2 flex items-center justify-center gap-2 text-2xl font-black">
                    <span className="text-slate-400 line-through">{data.oldGoal}</span>
                    <span className="text-slate-400">→</span>
                    <span className="text-orange-600 text-4xl">{data.newGoal}</span>
                    <span className="text-sm text-orange-600">回</span>
                  </div>
                  <div className="text-xs font-black text-orange-400 mt-1">(20% UP!)</div>
                </div>

                <div className="mt-4 text-sm font-black text-slate-600">この目標に変更しますか？</div>

                <div className="mt-4 flex gap-3">
                  <button
                    onClick={()=>{ playClick(); setGoalUpdateModal(null); }}
                    className="flex-1 py-3 rounded-2xl bg-slate-200 hover:bg-slate-300 text-slate-700 font-black"
                  >
                    いいえ
                  </button>
                  <button
                    onClick={()=>{
                      playSuccess();
                      setGoals(prev => ({...prev, [data.trickId]: data.newGoal}));
                      setGoalUpdateModal(null);
                    }}
                    className="flex-1 py-3 rounded-2xl bg-orange-500 hover:bg-orange-600 text-white font-black shadow"
                  >
                    はい
                  </button>
                </div>
              </div>
            </div>
          </ModalShell>
        );
      };

      // Import modal
      const ImportModal = () => (
        <ModalShell open={importModalOpen} onClose={()=>setImportModalOpen(false)}>
          <div className="bg-white rounded-3xl p-6 border-4 border-emerald-300 shadow-2xl max-h-[85vh] overflow-hidden flex flex-col">
            <div className="text-xl font-black text-emerald-700 text-center">📥 記録を復元（貼り付け）</div>
            <div className="text-xs font-bold text-slate-500 mt-2">
              スプレッドシートからコピーしたデータを、そのまま貼り付けてください（1行目に「日付」「技名」）
            </div>

            <textarea
              value={importText}
              onChange={(e)=>setImportText(e.target.value)}
              className="mt-3 w-full h-48 rounded-2xl border-2 border-slate-200 bg-slate-50 p-3 text-xs font-mono focus:outline-none focus:ring-2 focus:ring-emerald-400 resize-none custom-scrollbar select-text"
              placeholder={"日付\tまえとび\tうしろとび...\n2026-01-14\t10\t5\t...\n..."}
            />

            <div className="mt-4 flex gap-2">
              <button
                onClick={()=>{ playClick(); setImportModalOpen(false); }}
                className="flex-1 py-3 rounded-2xl bg-slate-200 hover:bg-slate-300 text-slate-700 font-black"
              >
                キャンセル
              </button>
              <button
                onClick={()=>{ playClick(); executeImportTSV(); }}
                className="flex-1 py-3 rounded-2xl bg-emerald-600 hover:bg-emerald-500 text-white font-black shadow"
              >
                読み込む
              </button>
            </div>
          </div>
        </ModalShell>
      );

      // Delete modal (soft/hard/date)
      const DeleteModal = () => {
        if (!deleteModal) return null;
        const type = deleteModal.type;
        const title =
          type==="date" ? "この日の記録を削除しますか？" :
          type==="hard" ? "完全リセットしますか？" :
          "記録をリセットしますか？";
        const msg =
          type==="date" ? "この操作は元に戻せません。" :
          type==="hard" ? "名前・記録・目標・検定表（先生設定）も含め、すべて消えます。" :
          "記録（がんばり・ベスト・履歴・目標達成履歴）を消します。検定表は残ります。";

        const yes = () => {
          if (type==="date") deleteDateRow(deleteModal.dateKey);
          if (type==="soft") softResetRecordsOnly();
          if (type==="hard") hardResetAll();
          setDeleteModal(null);
        };

        return (
          <ModalShell open={!!deleteModal} onClose={()=>setDeleteModal(null)}>
            <div className="bg-white rounded-3xl p-6 border-4 border-slate-200 shadow-2xl">
              <div className="text-lg font-black text-slate-800 text-center">{title}</div>
              <div className="text-sm font-bold text-slate-500 text-center mt-2">{msg}</div>

              {type==="date" && (
                <div className="text-center mt-3 text-xs font-black text-slate-500">
                  対象：<span className="text-slate-800">{deleteModal.dateKey}</span>
                </div>
              )}

              <div className="mt-5 flex gap-3">
                <button
                  onClick={()=>{ playClick(); setDeleteModal(null); }}
                  className="flex-1 py-3 rounded-2xl bg-slate-200 hover:bg-slate-300 text-slate-700 font-black"
                >
                  キャンセル
                </button>
                <button
                  onClick={()=>{ playClick(); yes(); }}
                  className={`flex-1 py-3 rounded-2xl text-white font-black shadow ${
                    type==="hard" || type==="date" ? "bg-red-500 hover:bg-red-600" : "bg-orange-500 hover:bg-orange-600"
                  }`}
                >
                  消す
                </button>
              </div>
            </div>
          </ModalShell>
        );
      };

      // =========================
      // Main layout
      // =========================
      return (
        <div className="min-h-screen">
          {/* Confetti canvas overlay */}
          <canvas ref={confetti.canvasRef} className="fixed inset-0 z-[9998] pointer-events-none"></canvas>

          <Header/>

          <main className="max-w-2xl mx-auto px-4 py-5 space-y-5 min-h-[80vh]">
            {activeTab === "home" && <HomeView/>}
            {activeTab === "input" && <InputView/>}
            {activeTab === "stats" && <StatsView/>}
            {activeTab === "cert" && <CertView/>}
            {activeTab === "history" && <HistoryView/>}
          </main>

          {/* Bottom Nav（旧コードの下ナビを「完成形」に進化） */}
          <nav className="fixed bottom-0 left-0 right-0 z-50 bg-white/90 backdrop-blur border-t border-slate-200 shadow-[0_-8px_16px_-12px_rgba(0,0,0,0.25)]" style={{paddingBottom:"env(safe-area-inset-bottom, 0px)"}}>
            <div className="max-w-2xl mx-auto px-3 py-2 flex items-center gap-2">
              <NavButton
                id="home"
                label="表紙"
                icon={Home}
                active={activeTab==="home"}
                onClick={()=>{ playClick(); setActiveTab("home"); }}
              />
              <NavButton
                id="input"
                label="きろく"
                icon={RefreshCw}
                active={activeTab==="input"}
                onClick={()=>{ playClick(); setActiveTab("input"); }}
                badge={targetDate === todayKeyLocal() ? "今日" : ""}
              />
              <NavButton
                id="stats"
                label="ごうけい"
                icon={Trophy}
                active={activeTab==="stats"}
                onClick={()=>{ playClick(); setActiveTab("stats"); }}
              />
              <NavButton
                id="cert"
                label="認定"
                icon={Award}
                active={activeTab==="cert"}
                onClick={()=>{ playClick(); setActiveTab("cert"); }}
              />
              <NavButton
                id="history"
                label="がんばり"
                icon={Calendar}
                active={activeTab==="history"}
                onClick={()=>{ playClick(); setActiveTab("history"); }}
              />
            </div>
          </nav>

          {/* Toast */}
          {copyToast && (
            <div className="fixed top-16 left-1/2 -translate-x-1/2 z-[9999] animate-popIn">
              <div className="bg-slate-900 text-white px-4 py-2 rounded-full shadow-lg text-xs font-black flex items-center gap-2">
                <CheckCircle size={16}/> OK！
              </div>
            </div>
          )}

          {/* Modals */}
          <GoalModal/>
          <GoalUpdateModal/>
          <ImportModal/>
          <DeleteModal/>

          {/* Footer small */}
          <footer className="hidden sm:block text-center text-xs font-bold text-slate-400 pb-24">
            ©2026 Takayuki WAYAMA なわとび検定カード（最高版）
          </footer>
        </div>
      );
    }

    const root = createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
